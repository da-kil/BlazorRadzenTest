@page "/questionnaire-management"
@using Microsoft.AspNetCore.Components.Authorization
@using Radzen
@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Services
@using ti8m.BeachBreak.Client.Components.Shared
@using ti8m.BeachBreak.Client.Components.Dialogs
@using ti8m.BeachBreak.Client.Layout
@inject DialogService DialogService
@inject NavigationManager NavigationManager
@inject ICategoryApiService CategoryService
@inject IQuestionnaireTemplateService ApiService
@inherits OptimizedTranslatableComponentBase

<PageTitle>@T("nav.questionnaire-management")</PageTitle>

<AuthorizeView Policy="HR">
    <Authorized>
        <PageLayout Title="@T("nav.questionnaire-management")"
                   Description="@T("pages.questionnaire-management-description")">
    <HeaderActions>
        <RadzenButton Text="@T("buttons.create-new")"
                     ButtonStyle="ButtonStyle.Primary"
                     Icon="add"
                     Size="ButtonSize.Medium"
                     Click="@(() => NavigationManager.NavigateTo("/questionnaire-builder"))" />
    </HeaderActions>
    <ChildContent>

    <RadzenTabs>
        <Tabs>
            <RadzenTabsItem Text="@T("tabs.templates")">
                <section class="templates-content">
                    <div class="templates-toolbar d-flex justify-content-between align-items-center mb-3">
                        <div class="filters-group d-flex gap-3">
                            <RadzenDropDown @bind-Value="@categoryFilter"
                                           Data="@categories"
                                           TextProperty="@GetCategoryNameProperty()"
                                           ValueProperty="Id"
                                           Placeholder="@T("filters.filter-by-type")"
                                           AllowClear="true"
                                           Change="@FilterTemplates" />
                            <RadzenTextBox @bind-Value="@searchText"
                                          Placeholder="@T("filters.search-templates")"
                                          @oninput="@OnSearchTextChanged" />
                        </div>
                        <RadzenToggleButton @bind-Value="@showArchivedTemplates"
                                           Text="@T("filters.show-archived")"
                                           Change="@FilterTemplates" />
                    </div>

                        <RadzenDataGrid Data="@filteredTemplates" 
                                       AllowFiltering="true" 
                                       AllowColumnResize="true"
                                       AllowAlternatingRows="true" 
                                       AllowSorting="true" 
                                       PageSize="10" 
                                       AllowPaging="true">
                        <Columns>
                            <RadzenDataGridColumn Title="@T("columns.template-name")" Width="300px" Sortable="false">
                                <Template Context="template">
                                    <div class="template-name-cell">
                                        <RadzenLink Text="@template.GetLocalizedNameWithFallback(CurrentLanguage)"
                                                   Path="@($"/questionnaire-builder/{template.Id}")"
                                                   Style="font-weight: bold" />
                                        <RadzenText TextStyle="TextStyle.Caption" Class="text-muted template-description">
                                            @template.GetLocalizedDescriptionWithFallback(CurrentLanguage)
                                        </RadzenText>
                                    </div>
                                </Template>
                            </RadzenDataGridColumn>

                            <RadzenDataGridColumn Property="@nameof(QuestionnaireTemplate.CategoryId)" Title="@T("columns.category")" Width="150px">
                                <Template Context="template">
                                    <RadzenText TextStyle="TextStyle.Body2">
                                        @(categories.FirstOrDefault(c => c.Id == template.CategoryId)?.NameEn ?? T("labels.uncategorized"))
                                    </RadzenText>
                                </Template>
                            </RadzenDataGridColumn>

                                <RadzenDataGridColumn Property="SectionCount" Title="@T("columns.sections")" Width="100px" TextAlign="TextAlign.Center">
                                    <Template Context="template">
                                        <RadzenBadge Text="@template.Sections.Count.ToString()" BadgeStyle="BadgeStyle.Info" />
                                    </Template>
                                </RadzenDataGridColumn>

                                <RadzenDataGridColumn Property="QuestionCount" Title="@T("columns.questions")" Width="100px" TextAlign="TextAlign.Center">
                                    <Template Context="template">
                                        <RadzenBadge Text="@template.Sections.SelectMany(s => s.Questions).Count().ToString()" BadgeStyle="BadgeStyle.Secondary" />
                                    </Template>
                                </RadzenDataGridColumn>

                                <RadzenDataGridColumn Property="@nameof(QuestionnaireTemplate.Status)" Title="@T("columns.status")" Width="120px">
                                    <Template Context="template">
                                        <RadzenBadge BadgeStyle="@GetStatusBadgeStyle(template.Status)"
                                                   Text="@TemplateStatusHelper.GetStatusText(template.Status)" />
                                    </Template>
                                </RadzenDataGridColumn>

                                <RadzenDataGridColumn Property="@nameof(QuestionnaireTemplate.CreatedDate)" Title="@T("columns.created")" Width="120px" FormatString="{0:dd/MM/yyyy}" />

                                <RadzenDataGridColumn Property="@nameof(QuestionnaireTemplate.LastPublishedDate)" Title="@T("columns.published")" Width="120px" FormatString="{0:dd/MM/yyyy}">
                                    <Template Context="template">
                                        @if (template.LastPublishedDate.HasValue)
                                        {
                                            <RadzenText TextStyle="TextStyle.Body2">@template.LastPublishedDate.Value.ToString("dd/MM/yyyy")</RadzenText>
                                        }
                                        else
                                        {
                                            <RadzenText TextStyle="TextStyle.Body2" Class="text-muted">-</RadzenText>
                                        }
                                    </Template>
                                </RadzenDataGridColumn>

                                <RadzenDataGridColumn Property="@nameof(QuestionnaireTemplate.PublishedByEmployeeName)" Title="@T("columns.published-by")" Width="150px">
                                    <Template Context="template">
                                        @if (!string.IsNullOrEmpty(template.PublishedByEmployeeName))
                                        {
                                            <RadzenText TextStyle="TextStyle.Body2">@template.PublishedByEmployeeName</RadzenText>
                                        }
                                        else
                                        {
                                            <RadzenText TextStyle="TextStyle.Body2" Class="text-muted">-</RadzenText>
                                        }
                                    </Template>
                                </RadzenDataGridColumn>

                            <RadzenDataGridColumn Filterable="false" Sortable="false" Width="240px" TextAlign="TextAlign.Center">
                                <Template Context="template">
                                    <div class="template-actions">
                                        <AsyncButton ButtonStyle="ButtonStyle.Light" Icon="edit" Size="ButtonSize.Small" Title="Edit" Click="@(() => EditTemplate(template))" />
                                        <AsyncButton ButtonStyle="ButtonStyle.Light" ProcessingText="Cloning" Icon="content_copy" Size="ButtonSize.Small" Title="Clone" Click="@(() => CloneTemplate(template))" />
                                        @if (template.Status == TemplateStatus.Draft)
                                        {
                                            <AsyncButton ButtonStyle="ButtonStyle.Success" ProcessingText="Publishing" Icon="publish" Size="ButtonSize.Small" Title="Publish" Click="@(() => PublishTemplate(template))" />
                                        }
                                        else if (template.Status == TemplateStatus.Published)
                                        {
                                            <AsyncButton ButtonStyle="ButtonStyle.Warning" ProcessingText="Unpublishing" Icon="unpublished" Size="ButtonSize.Small" Title="Unpublish" Click="@(() => UnpublishTemplate(template))" />
                                        }
                                        <AsyncButton ButtonStyle="@GetToggleButtonStyle(template.Status)" Icon="@GetToggleButtonIcon(template.Status)" Size="ButtonSize.Small" Title="@GetToggleButtonTitle(template.Status)" Click="@(() => ToggleTemplateStatus(template))" />
                                        @if (template.Status != TemplateStatus.Archived)
                                        {
                                            <AsyncButton ButtonStyle="ButtonStyle.Danger" ProcessingText="Deleting" Icon="delete" Size="ButtonSize.Small" Title="Delete" Click="@(() => DeleteTemplate(template))" />
                                        }
                                    </div>
                                </Template>
                            </RadzenDataGridColumn>
                            </Columns>
                        </RadzenDataGrid>
                </section>
            </RadzenTabsItem>


            <RadzenTabsItem Text="@T("tabs.settings")">
                <section class="settings-content">
                    <h2 class="settings-title">@T("titles.system-settings")</h2>

                    <div class="settings-grid">
                        <div class="settings-card">
                            <h3 class="card-title">@T("titles.email-notifications")</h3>
                            <div class="setting-item">
                                <RadzenCheckBox @bind-Value="@settings.SendAssignmentEmails" Name="assignmentEmails" />
                                <RadzenLabel Text="@T("settings.send-assignment-notifications")" Component="assignmentEmails" Class="ms-2" />
                            </div>
                            <div class="setting-item">
                                <RadzenCheckBox @bind-Value="@settings.SendReminderEmails" Name="reminderEmails" />
                                <RadzenLabel Text="@T("settings.send-reminder-emails")" Component="reminderEmails" Class="ms-2" />
                            </div>
                            <div class="setting-item">
                                <RadzenCheckBox @bind-Value="@settings.SendCompletionEmails" Name="completionEmails" />
                                <RadzenLabel Text="@T("settings.send-completion-confirmations")" Component="completionEmails" Class="ms-2" />
                            </div>
                        </div>

                        <div class="settings-card">
                            <h3 class="card-title">@T("titles.default-settings")</h3>
                            <div class="number-setting">
                                <label class="setting-label">@T("labels.default-due-days")</label>
                                <RadzenNumeric @bind-Value="@settings.DefaultDueDays" Min="1" Max="365" Class="w-100" />
                            </div>
                            <div class="number-setting">
                                <label class="setting-label">@T("labels.reminder-days-before-due")</label>
                                <RadzenNumeric @bind-Value="@settings.ReminderDaysBeforeDue" Min="1" Max="30" Class="w-100" />
                            </div>
                        </div>
                    </div>

                    <div class="settings-actions">
                        <AsyncButton Text="Save Settings"
                                    ProcessingText="Saving"
                                    ButtonStyle="ButtonStyle.Primary"
                                    Icon="save"
                                    Click="@SaveSettings" />
                    </div>
                </section>
            </RadzenTabsItem>
        </Tabs>
    </RadzenTabs>

    </ChildContent>
</PageLayout>
    </Authorized>
    <NotAuthorized>
        <AccessDeniedComponent RequiredRole="HR" PageName="Questionnaire Management" />
    </NotAuthorized>
</AuthorizeView>

@code {

    private List<QuestionnaireTemplate> templates = new();
    private List<QuestionnaireTemplate> filteredTemplates = new();

    private string searchText = "";
    private Guid categoryFilter;
    private bool showArchivedTemplates = false;


    private List<Category> categories = new();


    private SystemSettings settings = new();

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        await ExecuteSafelyAsync(async () =>
        {
            // Load templates and categories in parallel
            var loadTemplatesTask = LoadTemplates();
            var loadCategoriesTask = LoadCategories();

            await Task.WhenAll(loadTemplatesTask, loadCategoriesTask);

            // Load settings synchronously and apply filters
            LoadSettings();
            FilterTemplates();
        }, "InitializeQuestionnaireManagement");
    }

    protected override bool HasStateChanged()
    {
        return HasParameterChanged(nameof(templates), templates.Count) ||
               HasParameterChanged(nameof(searchText), searchText) ||
               HasParameterChanged(nameof(categoryFilter), categoryFilter);
    }

    private async Task LoadTemplates()
    {
        try
        {
            templates = await ApiService.GetAllTemplatesAsync();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load templates: {ex.Message}");
            templates = new List<QuestionnaireTemplate>();
        }
    }

    private async Task LoadCategories()
    {
        try
        {
            categories = await CategoryService.GetAllCategoriesAsync();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load categories: {ex.Message}");
            categories = new List<Category>();
        }
    }

    private void LoadSettings()
    {
        settings = new SystemSettings
        {
            SendAssignmentEmails = true,
            SendReminderEmails = true,
            SendCompletionEmails = false,
            DefaultDueDays = 14,
            ReminderDaysBeforeDue = 3
        };
    }

    private void OnSearchTextChanged(ChangeEventArgs e)
    {
        searchText = e.Value?.ToString() ?? "";
        FilterTemplates();
    }

    private void FilterTemplates()
    {
        filteredTemplates = templates.Where(t =>
            (showArchivedTemplates || t.Status != TemplateStatus.Archived) &&
            (categoryFilter == Guid.Empty || t.CategoryId == categoryFilter) &&
            (string.IsNullOrWhiteSpace(searchText) ||
             t.NameEnglish.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
             t.NameGerman.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
             t.DescriptionEnglish.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
             t.DescriptionGerman.Contains(searchText, StringComparison.OrdinalIgnoreCase))
        ).ToList();

        StateHasChanged();
    }

    private void EditTemplate(QuestionnaireTemplate template)
    {
        NavigationManager.NavigateTo($"/questionnaire-builder/{template.Id}");
    }

    private async Task CloneTemplate(QuestionnaireTemplate template)
    {
        try
        {
            // Show confirmation dialog
            var confirmed = await DialogService.Confirm(
                $"This will create a copy of '{template.GetLocalizedNameWithFallback(CurrentLanguage)}' in Draft status. Continue?",
                "Clone Template",
                new ConfirmOptions
                {
                    OkButtonText = "Clone",
                    CancelButtonText = "Cancel"
                });

            if (confirmed != true)
                return;

            NotificationService.Notify(NotificationSeverity.Info, "Cloning", "Cloning template...");

            // Call service to clone
            var newTemplateId = await ApiService.CloneTemplateAsync(template.Id);

            if (newTemplateId.HasValue)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Cloned", "Template cloned successfully!");

                // Reload templates to show the new cloned template
                await LoadTemplates();
                FilterTemplates();

                // Navigate to the cloned template editor
                NavigationManager.NavigateTo($"/questionnaire-builder/{newTemplateId.Value}");
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to clone template. Please try again.");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Error cloning template: {ex.Message}");
        }
    }

    private async Task ToggleTemplateStatus(QuestionnaireTemplate template)
    {
        try
        {
            var originalStatus = template.Status;
            QuestionnaireTemplate? result;
            string statusAction;

            if (template.Status == TemplateStatus.Archived)
            {
                // Restore from archive
                result = await ApiService.RestoreTemplateAsync(template.Id);
                statusAction = "restored";
            }
            else
            {
                // Archive the template (works for both Draft and Published)
                result = await ApiService.ArchiveTemplateAsync(template.Id);
                statusAction = "archived";
            }

            if (result != null)
            {
                // Update local template status
                template.Status = result.Status;
                NotificationService.Notify(NotificationSeverity.Success, "Status Updated", $"Template '{template.GetLocalizedNameWithFallback(CurrentLanguage)}' has been {statusAction}");
                FilterTemplates();
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to update template status");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to update template: {ex.Message}");
        }
    }

    private async Task PublishTemplate(QuestionnaireTemplate template)
    {
        try
        {
            // Show confirmation dialog
            var confirmed = await DialogService.Confirm(
                $"Publish '{template.GetLocalizedNameWithFallback(CurrentLanguage)}'? It will become available for assignment.",
                "Publish Template",
                new ConfirmOptions
                {
                    OkButtonText = "Publish",
                    CancelButtonText = "Cancel"
                });

            if (confirmed != true)
                return;

            NotificationService.Notify(NotificationSeverity.Info, "Publishing", "Publishing template...");

            // Call API to publish
            var publishedTemplate = await ApiService.PublishTemplateAsync(template.Id);

            if (publishedTemplate != null)
            {
                // Update local template
                template.Status = publishedTemplate.Status;
                template.PublishedDate = publishedTemplate.PublishedDate;
                template.LastPublishedDate = publishedTemplate.LastPublishedDate;

                NotificationService.Notify(NotificationSeverity.Success, "Published", $"Template '{template.GetLocalizedNameWithFallback(CurrentLanguage)}' is now published and available for assignments");
                FilterTemplates();
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to publish template");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to publish template: {ex.Message}");
        }
    }

    private async Task UnpublishTemplate(QuestionnaireTemplate template)
    {
        try
        {
            // Show confirmation dialog
            var confirmed = await DialogService.Confirm(
                $"Unpublish '{template.GetLocalizedNameWithFallback(CurrentLanguage)}'? It will no longer be available for new assignments.",
                "Unpublish Template",
                new ConfirmOptions
                {
                    OkButtonText = "Unpublish",
                    CancelButtonText = "Cancel"
                });

            if (confirmed != true)
                return;

            NotificationService.Notify(NotificationSeverity.Info, "Unpublishing", "Unpublishing template...");

            // Set status back to Draft
            template.Status = TemplateStatus.Draft;

            // Call API to update
            var updatedTemplate = await ApiService.UpdateTemplateAsync(template);

            if (updatedTemplate != null)
            {
                // Update local template
                template.Status = updatedTemplate.Status;

                NotificationService.Notify(NotificationSeverity.Success, "Unpublished", $"Template '{template.GetLocalizedNameWithFallback(CurrentLanguage)}' has been unpublished");
                FilterTemplates();
            }
            else
            {
                // Revert status on failure
                template.Status = TemplateStatus.Published;
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to unpublish template");
            }
        }
        catch (Exception ex)
        {
            // Revert status on exception
            template.Status = TemplateStatus.Published;
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to unpublish template: {ex.Message}");
        }
    }

    private async Task DeleteTemplate(QuestionnaireTemplate template)
    {
        try
        {
            // Show confirmation dialog with warning
            var confirmed = await DialogService.Confirm(
                $"Are you sure you want to permanently delete '{template.GetLocalizedNameWithFallback(CurrentLanguage)}'? " +
                "This action cannot be undone. The template can only be deleted if it has no active assignments.",
                "Delete Template",
                new ConfirmOptions
                {
                    OkButtonText = "Delete",
                    CancelButtonText = "Cancel"
                });

            if (confirmed != true)
                return;

            NotificationService.Notify(NotificationSeverity.Info, "Deleting", "Deleting template...");

            // Call API to delete
            var success = await ApiService.DeleteTemplateAsync(template.Id);

            if (success)
            {
                // Remove from local list
                templates.Remove(template);

                NotificationService.Notify(NotificationSeverity.Success, "Deleted", $"Template '{template.GetLocalizedNameWithFallback(CurrentLanguage)}' has been permanently deleted");
                FilterTemplates();
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error",
                    "Failed to delete template. It may have active assignments or cannot be deleted while archived.");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to delete template: {ex.Message}");
        }
    }

    private async Task SaveSettings()
    {
        // Save to database
        NotificationService.Notify(NotificationSeverity.Success, "Saved", "Settings have been saved successfully");
    }



    // Helper classes
    public class SystemSettings
    {
        public bool SendAssignmentEmails { get; set; }
        public bool SendReminderEmails { get; set; }
        public bool SendCompletionEmails { get; set; }
        public int DefaultDueDays { get; set; }
        public int ReminderDaysBeforeDue { get; set; }
    }

    // Status helper methods
    private BadgeStyle GetStatusBadgeStyle(TemplateStatus status) => status switch
    {
        TemplateStatus.Published => BadgeStyle.Success,
        TemplateStatus.Draft => BadgeStyle.Warning,
        TemplateStatus.Archived => BadgeStyle.Danger,
        _ => BadgeStyle.Secondary
    };

    private ButtonStyle GetToggleButtonStyle(TemplateStatus status) => status switch
    {
        TemplateStatus.Archived => ButtonStyle.Success,
        _ => ButtonStyle.Warning
    };

    private string GetToggleButtonIcon(TemplateStatus status) => status switch
    {
        TemplateStatus.Archived => "restore",
        _ => "archive"
    };

    private string GetToggleButtonTitle(TemplateStatus status) => status switch
    {
        TemplateStatus.Archived => "Restore",
        _ => "Archive"
    };

    private string GetCategoryNameProperty()
    {
        return CurrentLanguage == Language.German ? "NameDe" : "NameEn";
    }
}