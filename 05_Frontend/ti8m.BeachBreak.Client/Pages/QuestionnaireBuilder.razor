@page "/questionnaire-builder"
@page "/questionnaire-builder/{TemplateId:guid?}"
@using Radzen
@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Components
@using ti8m.BeachBreak.Client.Components.QuestionnaireBuilder
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Services

<PageTitle>Questionnaire Builder</PageTitle>

<div class="container-fluid">
	<RadzenCard Class="p-4">
		<div class="d-flex justify-content-between align-items-center mb-4">
			<div>
				<RadzenText TextStyle="TextStyle.H2" Class="text-primary fw-bold mb-2">
					<RadzenIcon Icon="psychology" Class="me-3" />
					@(IsEditMode ? "Questionnaire Editor" : "Questionnaire Builder")
				</RadzenText>
				<RadzenText TextStyle="TextStyle.Body1" Class="text-muted mb-0">
					@(IsEditMode ? "Modify and enhance your assessment with intuitive tools" : "Create comprehensive assessments with our visual editor")
				</RadzenText>
				<RadzenText TextStyle="TextStyle.Caption" Class="text-secondary">
					Build sections, configure questions, and customize your evaluation experience
				</RadzenText>
			</div>
			<div class="d-flex gap-2">
				<RadzenButton Text="Preview"
							  ButtonStyle="ButtonStyle.Info"
							  Icon="preview"
							  Click="@PreviewQuestionnaire" />
				<RadzenButton Text="Save Draft"
							  ButtonStyle="ButtonStyle.Secondary"
							  Icon="save"
							  Click="@SaveQuestionnaire" />
				<RadzenButton Text="Save & Publish"
							  ButtonStyle="ButtonStyle.Success"
							  Icon="publish"
							  Click="@PublishQuestionnaire" />
			</div>
		</div>

		<RadzenTabs TabPosition="TabPosition.Left" Change="@OnTabChanged">
			<Tabs>
				<RadzenTabsItem Text="Basic Info">
					<BasicInfoTab Template="@template" Categories="@categories" />
				</RadzenTabsItem>

				<RadzenTabsItem Text="Questions">
					<QuestionsTab Template="@template"
								  ShowQuestionTypeSelection="@showQuestionTypeSelection"
								  SelectedSectionIndex="@selectedSectionIndex"
								  QuestionTypeLabels="@questionTypeLabels"
								  OnAddSection="@AddSection"
								  OnMoveSectionUp="@MoveSectionUp"
								  OnMoveSectionDown="@MoveSectionDown"
								  OnRemoveSection="@RemoveSection"
								  OnShowAddQuestionDialog="@ShowAddQuestionDialog"
								  OnCancelQuestionTypeSelection="@CancelQuestionTypeSelection"
								  OnAddQuestionOfType="@AddQuestionOfType"
								  OnMoveQuestionUp="@MoveQuestionUp"
								  OnMoveQuestionDown="@MoveQuestionDown"
								  OnRemoveQuestion="@RemoveQuestion" />
				</RadzenTabsItem>

				<RadzenTabsItem Text="Preview">
					<PreviewTab Template="@template" QuestionTypeLabels="@questionTypeLabels" />
				</RadzenTabsItem>
			</Tabs>
		</RadzenTabs>
	</RadzenCard>
</div>

@code {
	[Parameter] public Guid? TemplateId { get; set; }
	[Inject] protected DialogService DialogService { get; set; } = default!;
	[Inject] protected NotificationService NotificationService { get; set; } = default!;
	[Inject] protected NavigationManager NavigationManager { get; set; } = default!;
	[Inject] protected IQuestionnaireApiService ApiService { get; set; } = default!;
	[Inject] protected ICategoryApiService CategoryService { get; set; } = default!;

	private QuestionnaireTemplate template = new();
	private bool IsEditMode => TemplateId.HasValue;

	// Question type selection state
	private bool showQuestionTypeSelection = false;
	private int selectedSectionIndex = -1;
	private QuestionType? selectedQuestionType = null;

	// Editable question type labels
	private Dictionary<QuestionType, string> questionTypeLabels = new()
	{
		{ QuestionType.SelfAssessment, "Self-Assessment" },
		{ QuestionType.GoalAchievement, "Goal Achievement" },
		{ QuestionType.TextQuestion, "Text Question" }
	};

	private List<string> categories = new();

	protected override async Task OnInitializedAsync()
	{
		// Load categories first
		await LoadCategories();

		if (IsEditMode && TemplateId.HasValue)
		{
			await LoadTemplate(TemplateId.Value);
		}
		else
		{
			// Initialize empty template with default values
			template = new QuestionnaireTemplate
			{
				Name = "",
				Description = "",
				Category = "",
				Settings = new QuestionnaireSettings()
			};
		}
	}

	private async Task LoadCategories()
	{
		try
		{
			categories = await CategoryService.GetCategoryNamesAsync();
		}
		catch (Exception ex)
		{
			NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load categories: {ex.Message}");
			// Fallback to default categories if API fails
			categories = new List<string>
			{
				"Performance Review",
				"Employee Feedback",
				"Training Assessment",
				"Goal Setting",
				"Other"
			};
		}
	}

	private async Task LoadTemplate(Guid templateId)
	{
		try
		{
			var loadedTemplate = await ApiService.GetTemplateByIdAsync(templateId);
			if (loadedTemplate != null)
			{
				template = loadedTemplate;
			}
			else
			{
				NotificationService.Notify(NotificationSeverity.Warning, "Not Found", "Template not found. Creating new template.");
				template = new QuestionnaireTemplate();
				// Clear the TemplateId parameter to switch to create mode
				TemplateId = null;
			}
		}
		catch (Exception ex)
		{
			NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load template: {ex.Message}");
			template = new QuestionnaireTemplate();
			TemplateId = null;
		}
	}

	private void OnTabChanged(int index)
	{
		// Handle tab change if needed
	}

	private void AddSection()
	{
		var newSection = new QuestionSection
		{
			Title = $"Section {template.Sections.Count + 1}",
			Order = template.Sections.Count,
			IsRequired = true
		};
		template.Sections.Add(newSection);
	}

	private async Task RemoveSection(int index)
	{
		if (index >= 0 && index < template.Sections.Count)
		{
			var section = template.Sections[index];
			var sectionName = string.IsNullOrWhiteSpace(section.Title) ? $"Section {index + 1}" : section.Title;
			var confirmed = await DialogService.Confirm($"Are you sure you want to delete '{sectionName}'? This will also delete all questions in this section.", "Delete Section",
				new ConfirmOptions() { OkButtonText = "Yes", CancelButtonText = "No" });

			if (confirmed.HasValue && confirmed.Value)
			{
				template.Sections.RemoveAt(index);
				// Reorder remaining sections
				for (int i = 0; i < template.Sections.Count; i++)
				{
					template.Sections[i].Order = i;
				}
			}
		}
	}

	private void MoveSectionUp(int index)
	{
		if (index > 0)
		{
			(template.Sections[index], template.Sections[index - 1]) = (template.Sections[index - 1], template.Sections[index]);
			template.Sections[index].Order = index;
			template.Sections[index - 1].Order = index - 1;
		}
	}

	private void MoveSectionDown(int index)
	{
		if (index < template.Sections.Count - 1)
		{
			(template.Sections[index], template.Sections[index + 1]) = (template.Sections[index + 1], template.Sections[index]);
			template.Sections[index].Order = index;
			template.Sections[index + 1].Order = index + 1;
		}
	}

	private void ShowAddQuestionDialog(int sectionIndex)
	{
		// Show inline question type selection
		showQuestionTypeSelection = true;
		selectedSectionIndex = sectionIndex;
		selectedQuestionType = null;
	}


	// These dialog-based editing methods are no longer needed as editing is now inline
	// Keeping the helper methods for configuration management

	private List<CompetencyDefinition> GetCompetenciesFromConfiguration(QuestionItem question)
	{
		if (question.Configuration.ContainsKey("Competencies"))
		{
			var competenciesObj = question.Configuration["Competencies"];

			// Handle direct cast (when set in editor)
			if (competenciesObj is List<CompetencyDefinition> competencies)
			{
				return competencies;
			}

			// Handle JSON deserialization (when loaded from API)
			if (competenciesObj is System.Text.Json.JsonElement jsonElement)
			{
				try
				{
					if (jsonElement.ValueKind == System.Text.Json.JsonValueKind.Array)
					{
						return System.Text.Json.JsonSerializer.Deserialize<List<CompetencyDefinition>>(jsonElement.GetRawText(), new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true }) ?? new List<CompetencyDefinition>();
					}
				}
				catch (Exception ex)
				{
					Console.WriteLine($"Error deserializing competencies: {ex.Message}");
				}
			}

			// Handle string representation (backup case)
			if (competenciesObj is string jsonString)
			{
				try
				{
					return System.Text.Json.JsonSerializer.Deserialize<List<CompetencyDefinition>>(jsonString) ?? new List<CompetencyDefinition>();
				}
				catch (Exception ex)
				{
					Console.WriteLine($"Error deserializing competencies from string: {ex.Message}");
				}
			}
		}

		// Return default competencies if none exist
		return new List<CompetencyDefinition>();
	}

	private void SaveCompetenciesToConfiguration(QuestionItem question, List<CompetencyDefinition> competencies)
	{
		question.Configuration["Competencies"] = competencies;
	}

	// Goal categories configuration methods - simplified since editing is now inline
	private List<object> GetGoalCategoriesFromConfiguration(QuestionItem question)
	{
		if (question.Configuration.ContainsKey("GoalCategories") && question.Configuration["GoalCategories"] is List<object> categories)
		{
			return categories;
		}

		return new List<object>();
	}

	// Text question helper methods are no longer needed as configuration is inline

	// Text sections configuration methods - simplified since editing is now inline
	private List<object> GetTextSectionsFromConfiguration(QuestionItem question)
	{
		if (question.Configuration.ContainsKey("TextSections") && question.Configuration["TextSections"] is List<object> sections)
		{
			return sections;
		}

		// Check for legacy format and convert
		if (question.Configuration.ContainsKey("SectionTitle") || question.Configuration.ContainsKey("SectionDescription"))
		{
			return new List<object>
			{
				new
				{
					Title = question.Configuration.ContainsKey("SectionTitle") ? question.Configuration["SectionTitle"].ToString() ?? "" : "",
					Description = question.Configuration.ContainsKey("SectionDescription") ? question.Configuration["SectionDescription"].ToString() ?? "" : ""
				}
			};
		}

		return new List<object>();
	}

	private async Task RemoveQuestion(int sectionIndex, int questionIndex)
	{
		var section = template.Sections[sectionIndex];
		if (questionIndex >= 0 && questionIndex < section.Questions.Count)
		{
			var question = section.Questions[questionIndex];
			var questionName = string.IsNullOrWhiteSpace(question.Title) ? $"Question {questionIndex + 1}" : question.Title;
			var confirmed = await DialogService.Confirm($"Are you sure you want to delete '{questionName}'?", "Delete Question",
				new ConfirmOptions() { OkButtonText = "Yes", CancelButtonText = "No" });

			if (confirmed.HasValue && confirmed.Value)
			{
				section.Questions.RemoveAt(questionIndex);
				// Reorder remaining questions
				for (int i = 0; i < section.Questions.Count; i++)
				{
					section.Questions[i].Order = i;
				}
			}
		}
	}

	private void MoveQuestionUp(int sectionIndex, int questionIndex)
	{
		var questions = template.Sections[sectionIndex].Questions;
		if (questionIndex > 0)
		{
			(questions[questionIndex], questions[questionIndex - 1]) = (questions[questionIndex - 1], questions[questionIndex]);
			questions[questionIndex].Order = questionIndex;
			questions[questionIndex - 1].Order = questionIndex - 1;
		}
	}

	private void MoveQuestionDown(int sectionIndex, int questionIndex)
	{
		var questions = template.Sections[sectionIndex].Questions;
		if (questionIndex < questions.Count - 1)
		{
			(questions[questionIndex], questions[questionIndex + 1]) = (questions[questionIndex + 1], questions[questionIndex]);
			questions[questionIndex].Order = questionIndex;
			questions[questionIndex + 1].Order = questionIndex + 1;
		}
	}

	private string GetQuestionTypeIcon(QuestionType type)
	{
		return type switch
		{
			QuestionType.SelfAssessment => "self_improvement",
			QuestionType.GoalAchievement => "track_changes",
			QuestionType.TextQuestion => "psychology",
			_ => "help"
		};
	}

	// Question preview is now handled inline within the QuestionCard component

private async Task PreviewQuestionnaire()
{
	// Open questionnaire in preview mode
	NotificationService.Notify(NotificationSeverity.Info, "Preview", "Preview functionality would open here");
}

private async Task SaveQuestionnaire()
{
	if (string.IsNullOrWhiteSpace(template.Name))
	{
		NotificationService.Notify(NotificationSeverity.Warning, "Validation Error", "Please enter a template name");
		return;
	}

	try
	{
		template.LastModified = DateTime.Now;

		if (IsEditMode)
		{
			var updated = await ApiService.UpdateTemplateAsync(template);
			if (updated != null)
			{
				NotificationService.Notify(NotificationSeverity.Success, "Saved", "Questionnaire template updated successfully");
			}
			else
			{
				NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to update template - no response from server");
			}
		}
		else
		{
			var created = await ApiService.CreateTemplateAsync(template);
			template.Id = created.Id; // Update with the server-generated ID
			NotificationService.Notify(NotificationSeverity.Success, "Saved", "Questionnaire template created successfully");
		}
	}
	catch (Exception ex)
	{
		NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to save template: {ex.Message}");
	}
}

private async Task PublishQuestionnaire()
{
	await SaveQuestionnaire();
	template.IsActive = true;
	// TODO: Additional publish logic
	NotificationService.Notify(NotificationSeverity.Success, "Published", "Questionnaire template published successfully");
}

// Helper methods to avoid section/question directive conflicts
private string GetSectionTitle(QuestionSection section) => section.Title;
private void SetSectionTitle(QuestionSection section, string value) => section.Title = value ?? "";

private string GetSectionDescription(QuestionSection section) => section.Description;
private void SetSectionDescription(QuestionSection section, string value) => section.Description = value ?? "";

private string GetQuestionTitle(QuestionItem question) => question.Title;
private void SetQuestionTitle(QuestionItem question, string value) => question.Title = value ?? "";

private string GetQuestionDescription(QuestionItem question) => question.Description;
private void SetQuestionDescription(QuestionItem question, string value) => question.Description = value ?? "";

private async Task AddQuestionOfType(QuestionType questionType)
{
	if (selectedSectionIndex >= 0 && selectedSectionIndex < template.Sections.Count)
	{
		var section = template.Sections[selectedSectionIndex];
		var newQuestion = new QuestionItem
		{
			Id = Guid.NewGuid(),
			Title = GetDefaultQuestionTitle(questionType),
			Type = questionType,
			Order = section.Questions.Count,
			IsRequired = true
		};

		// Initialize default configuration for each question type
		if (questionType == QuestionType.SelfAssessment)
		{
			// Initialize with one default competency
			var competencies = new List<CompetencyDefinition>
			{
				new CompetencyDefinition("competency_1", "", "", false)
			};
			newQuestion.Configuration["Competencies"] = competencies;
		}
		else if (questionType == QuestionType.GoalAchievement)
		{
			// Initialize with default goal categories structure
			newQuestion.Configuration["GoalCategories"] = new List<object>();
		}
		else if (questionType == QuestionType.TextQuestion)
		{
			// Initialize with one default text section
			newQuestion.Configuration["TextSections"] = new List<object>
			{
				new { Title = "", Description = "" }
			};
		}

		// Add the question to the section
		section.Questions.Add(newQuestion);
	}

	// Reset selection state
	showQuestionTypeSelection = false;
	selectedSectionIndex = -1;
	selectedQuestionType = null;
}

private void CancelQuestionTypeSelection()
{
	showQuestionTypeSelection = false;
	selectedSectionIndex = -1;
	selectedQuestionType = null;
}

private string GetDefaultQuestionTitle(QuestionType type)
{
	return type switch
	{
		QuestionType.SelfAssessment => $"{questionTypeLabels[QuestionType.SelfAssessment]} of Competencies",
		QuestionType.GoalAchievement => $"{questionTypeLabels[QuestionType.GoalAchievement]} Review",
		QuestionType.TextQuestion => "Career Development & Planning",
		_ => "New Question"
	};
}

private string GetQuestionTypeLabel(QuestionItem question)
{
	// Check if question has a custom type label stored in configuration
	if (question.Configuration.ContainsKey("QuestionTitle"))
	{
		var customTitle = question.Configuration["QuestionTitle"].ToString() ?? "";
		if (!string.IsNullOrWhiteSpace(customTitle))
		{
			return customTitle;
		}
	}

	// Fall back to global labels
	return questionTypeLabels[question.Type];
}


// Event handler overloads for the new component structure
private async Task RemoveQuestion((int sectionIndex, int questionIndex) indices)
{
	await RemoveQuestion(indices.sectionIndex, indices.questionIndex);
}

private void MoveQuestionUp((int sectionIndex, int questionIndex) indices)
{
	MoveQuestionUp(indices.sectionIndex, indices.questionIndex);
}

private void MoveQuestionDown((int sectionIndex, int questionIndex) indices)
{
	MoveQuestionDown(indices.sectionIndex, indices.questionIndex);
}
}