@page "/questionnaire-builder"
@page "/questionnaire-builder/{TemplateId:guid?}"
@using Microsoft.AspNetCore.Components.Authorization
@using Radzen
@using Radzen.Blazor
@using System.Text.Json
@using ti8m.BeachBreak.Client.Components
@using ti8m.BeachBreak.Client.Components.QuestionnaireBuilder
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Services
@using ti8m.BeachBreak.Client.Components.Shared
@using ti8m.BeachBreak.Client.Layout
@inject DialogService DialogService
@inject NavigationManager NavigationManager
@inject IQuestionnaireTemplateService ApiService
@inject ICategoryApiService CategoryService
@inject QuestionConfigurationService ConfigurationService
@inject QuestionnaireValidationService ValidationService
@inject ti8m.BeachBreak.Client.Services.QuestionHandlers.QuestionHandlerFactory HandlerFactory
@inject QuestionnaireBuilderState State
@inherits OptimizedTranslatableComponentBase
@implements IDisposable

<PageTitle>@(State.IsEditMode? T("pages.questionnaire-editor") : T("pages.questionnaire-builder"))</PageTitle>

<AuthorizeView Policy="HR">
    <Authorized>
        <PageLayout Title="@(State.IsEditMode ? T("pages.questionnaire-editor") : T("pages.questionnaire-builder"))"
                   Description="@GetStatusDescription()">
            <HeaderActions>
                @{
                    var status = State.IsEditMode ? State.Template.Status : TemplateStatus.Draft;
                    var statusText = State.IsEditMode ? TemplateStatusHelper.GetStatusText(State.Template.Status) : T("labels.new-status");
                    var statusBadgeStyle = GetStatusBadgeStyle(status);
                }
                <RadzenBadge BadgeStyle="@statusBadgeStyle" Text="@statusText" Class="px-3 py-2" />

                @if (lastSavedTime.HasValue && !isSaving)
                {
                    <RadzenText TextStyle="TextStyle.Caption" Class="text-muted d-flex align-items-center">
                        <RadzenIcon Icon="cloud_done" Class="me-1" />
                        @T("labels.last-saved") @lastSavedTime.Value.ToString("HH:mm")
                    </RadzenText>
                }
                @if (isSaving)
                {
                    <RadzenText TextStyle="TextStyle.Caption" Class="text-muted d-flex align-items-center">
                        <RadzenIcon Icon="sync" Class="me-1" Style="animation: rotate 2s linear infinite;" />
                        @T("messages.saving")
                    </RadzenText>
                }

                @{
                    var currentStatus = State.IsEditMode ? State.Template.Status : TemplateStatus.Draft;
                }
                @switch (currentStatus)
                {
                    case TemplateStatus.Draft:
                        <RadzenButton Text="@(isSaving ? T("messages.saving") : T("buttons.save-draft"))" ButtonStyle="ButtonStyle.Light" Icon="save" Click="@SaveQuestionnaire" Disabled="@isSaving" Size="ButtonSize.Medium" />
                        <RadzenButton Text="@T("buttons.publish")" ButtonStyle="ButtonStyle.Primary" Icon="publish" Click="@PublishQuestionnaire" Disabled="@isSaving" Size="ButtonSize.Medium" />
                        break;
                    case TemplateStatus.Published:
                        <RadzenButton Text="@T("buttons.clone")" ButtonStyle="ButtonStyle.Light" Icon="content_copy" Click="@HandleClone" Size="ButtonSize.Medium" />
                        <RadzenButton Text="@T("buttons.unpublish")" ButtonStyle="ButtonStyle.Light" Icon="unpublished" Click="@UnpublishQuestionnaire" Size="ButtonSize.Medium" />
                        break;
                    case TemplateStatus.Archived:
                        <RadzenButton Text="@T("buttons.clone")" ButtonStyle="ButtonStyle.Light" Icon="content_copy" Click="@HandleClone" Size="ButtonSize.Medium" />
                        <RadzenButton Text="@T("buttons.restore")" ButtonStyle="ButtonStyle.Primary" Icon="restore" Click="@RestoreQuestionnaire" Size="ButtonSize.Medium" />
                        break;
                }
            </HeaderActions>
            <ChildContent>

                <ProgressSteps CurrentStep="@State.CurrentStep"
                               OnStepClick="@SetCurrentStep" />

                <!-- Main Content -->
                <!-- Flattened Step Content -->
                @if (State.CurrentStep == 1)
                    {
                        <section class="step-section" data-step="1">
                            <header class="qb-step-header">
                                <h2 class="step-title">@T("steps.template-information")</h2>
                                <p class="step-description">@GetStatusDescription()</p>
                            </header>
                            <BasicInfoTab Template="@State.Template" Categories="@categories" />
                            <nav class="step-navigation">
                                <RadzenButton Text="@T("buttons.next-build-sections")" ButtonStyle="ButtonStyle.Primary" Icon="arrow_forward" Click="@(() => SetCurrentStep(2))" />
                            </nav>
                        </section>
                    }
                    else if (State.CurrentStep == 2)
                    {
                        <section class="step-section" data-step="2">
                            <header class="qb-step-header">
                                <h2 class="step-title">@T("steps.build-sections")</h2>
                                <p class="step-description">@T("steps.build-sections-description")</p>
                            </header>
                            <QuestionsTab Template="@State.Template"
                                          OnAddSectionWithType="@AddSectionWithType"
                                          OnMoveSectionUp="@MoveSectionUp"
                                          OnMoveSectionDown="@MoveSectionDown"
                                          OnRemoveSection="@RemoveSection"
                                          OnAddItemDirectly="@AddItemDirectly"
                                          OnMoveQuestionUp="@MoveQuestionUp"
                                          OnMoveQuestionDown="@MoveQuestionDown"
                                          OnRemoveQuestion="@RemoveQuestion" />
                            <nav class="step-navigation-dual">
                                <RadzenButton Text="@T("buttons.previous-basic-info")" ButtonStyle="ButtonStyle.Light" Icon="arrow_back" Click="@(() => SetCurrentStep(1))" />
                                <RadzenButton Text="@T("buttons.next-review")" ButtonStyle="ButtonStyle.Primary" Icon="arrow_forward" Click="@(() => SetCurrentStep(3))" />
                            </nav>
                        </section>
                    }
                    else if (State.CurrentStep == 3)
                    {
                        <section class="step-section" data-step="3">
                            <header class="qb-step-header">
                                <h2 class="step-title">@T("steps.review-publish")</h2>
                                <p class="step-description">@T("steps.review-description")</p>
                            </header>
                            <ReviewTab Template="@State.Template" QuestionTypeLabels="@questionTypeLabels" Categories="@categories" />
                            <nav class="step-navigation-dual">
                                <RadzenButton Text="@T("buttons.previous-build-sections")" ButtonStyle="ButtonStyle.Light" Icon="arrow_back" Click="@(() => SetCurrentStep(2))" />
                                <div class="publish-actions">
                                    @{
                                        var stepNavStatus = State.IsEditMode ? State.Template.Status : TemplateStatus.Draft;
                                    }
                                    @switch (stepNavStatus)
                                    {
                                        case TemplateStatus.Draft:
                                            <RadzenButton Text="@(isSaving ? T("messages.saving") : T("buttons.save-draft"))" ButtonStyle="ButtonStyle.Secondary" Icon="save" Click="@SaveQuestionnaire" Disabled="@isSaving" />
                                            <RadzenButton Text="@T("buttons.publish")" ButtonStyle="ButtonStyle.Success" Icon="publish" Click="@PublishQuestionnaire" Disabled="@isSaving" />
                                            break;
                                        case TemplateStatus.Published:
                                            <RadzenButton Text="@T("buttons.unpublish")" ButtonStyle="ButtonStyle.Warning" Icon="unpublished" Click="@UnpublishQuestionnaire" />
                                            break;
                                        case TemplateStatus.Archived:
                                            <RadzenButton Text="@T("buttons.restore")" ButtonStyle="ButtonStyle.Primary" Icon="restore" Click="@RestoreQuestionnaire" />
                                            break;
                                    }
                                </div>
                            </nav>
                        </section>
                    }
            </ChildContent>
        </PageLayout>
    </Authorized>
    <NotAuthorized>
        <AccessDeniedComponent RequiredRole="HR" PageName="@T("pages.questionnaire-builder")" />
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter] public Guid? TemplateId { get; set; }

    private bool IsEditMode => TemplateId.HasValue;
    private bool isSaving = false;
    private DateTime? lastSavedTime = null;

    // Editable question type labels
    private Dictionary<QuestionType, string> questionTypeLabels = new();

    private void InitializeQuestionTypeLabels()
    {
        questionTypeLabels = new Dictionary<QuestionType, string>
        {
            { QuestionType.Assessment, T("question-types.assessment") },
            { QuestionType.Goal, T("question-types.goal-achievement") },
            { QuestionType.TextQuestion, T("question-types.text-question") }
        };
    }

    private List<Category> categories = new();
    private Guid? lastLoadedTemplateId = null;

    protected override Task OnInitializedAsync()
    {
        return base.OnInitializedAsync();
    }

    protected override void OnInitialized()
    {
        State.OnStateChanged += HandleStateChanged;
    }

    protected override async Task OnParametersSetAsync()
    {
        // Handle both initial load (both null) and template ID changes
        // Use Equals to properly handle nullable Guid comparisons
        bool shouldLoad = !Equals(lastLoadedTemplateId, TemplateId) || lastLoadedTemplateId == null;

        if (shouldLoad)
        {
            lastLoadedTemplateId = TemplateId;
            await LoadQuestionnaireData();
        }
    }

    private async Task LoadQuestionnaireData()
    {
        await ExecuteSafelyAsync(async () =>
        {
            // Initialize translations-dependent data
            InitializeQuestionTypeLabels();

            // Reset to step 1 whenever loading a template
            State.CurrentStep = 1;

            if (IsEditMode && TemplateId.HasValue)
            {
                // Load categories and template in parallel for better performance
                var loadCategoriesTask = LoadCategories();
                var loadTemplateTask = LoadTemplate(TemplateId.Value);

                await Task.WhenAll(loadCategoriesTask, loadTemplateTask);
            }
            else
            {
                // Load categories and initialize template
                await LoadCategories();

                // Initialize empty template with default values
                State.Template = new QuestionnaireTemplate
                {
                    Id = Guid.NewGuid(), // Generate ID upfront for efficient refetch after create
                    NameEnglish = "",
                    NameGerman = "",
                    DescriptionEnglish = "",
                    DescriptionGerman = "",
                    CategoryId = Guid.Empty
                };
            }
        }, "InitializeQuestionnaireBuilder");
    }

    private void HandleStateChanged()
    {
        NotifyStateChanged();
    }

    public override void Dispose()
    {
        State.OnStateChanged -= HandleStateChanged;
        base.Dispose();
    }

    protected override bool HasStateChanged()
    {
        return HasParameterChanged(nameof(State.Template), State.Template?.Id) ||
               HasParameterChanged(nameof(State.CurrentStep), State.CurrentStep) ||
               HasParameterChanged(nameof(State.ShowQuestionEditor), State.ShowQuestionEditor) ||
               HasParameterChanged(nameof(State.ShowQuestionTypeSelection), State.ShowQuestionTypeSelection);
    }

    private async Task LoadCategories()
    {
        try
        {
            categories = await CategoryService.GetAllCategoriesAsync();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, T("notifications.error"), $"{T("messages.failed-load-categories")}: {ex.Message}");
            // Fallback to default categories if API fails
            categories = [];
        }
    }

    private async Task LoadTemplate(Guid templateId)
    {
        try
        {
            var loadedTemplate = await ApiService.GetTemplateByIdAsync(templateId);
            if (loadedTemplate != null)
            {
                State.Template = loadedTemplate;
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Warning, T("notifications.not-found"), T("messages.template-not-found"));
                State.Template = new QuestionnaireTemplate();
                // Clear the TemplateId parameter to switch to create mode
                TemplateId = null;
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, T("notifications.error"), $"{T("messages.failed-load-template")}: {ex.Message}");
            State.Template = new QuestionnaireTemplate();
            TemplateId = null;
        }
    }

    private void SetCurrentStep(int step)
    {
        State.CurrentStep = step;
    }


    private void AddSectionWithType(QuestionType questionType)
    {
        var newSection = new QuestionSection
        {
            TitleEnglish = "",
            TitleGerman = "", // Leave German empty for now
            DescriptionEnglish = "",
            DescriptionGerman = "",
            Order = State.Template.Sections.Count,
            IsRequired = true,
            CompletionRole = CompletionRole.Employee,
            Type = questionType
        };

        // Get the appropriate handler for this question type
        var handler = HandlerFactory.GetHandler(questionType);

        // Initialize the section's configuration and add default item
        // (AssessmentHandler adds 1 evaluation, TextQuestionHandler adds 1 text section, etc.)
        handler.InitializeQuestion(newSection);

        State.Template.Sections.Add(newSection);
        State.MarkAsDirty();
    }

    private void AddItemDirectly(int sectionIndex)
    {
        if (sectionIndex >= 0 && sectionIndex < State.Template.Sections.Count)
        {
            var section = State.Template.Sections[sectionIndex];

            // Use QuestionHandlers to add configuration items (evaluations, text sections, etc.)
            var handler = HandlerFactory.GetHandler(section.Type);
            handler.AddItem(section);
            State.MarkAsDirty();
        }
    }

    private void AddItemToExistingQuestion(QuestionSection question)
    {
        // Use Strategy Pattern to delegate to appropriate handler
        var handler = HandlerFactory.GetHandler(question.Type);
        handler.AddItem(question);
        State.MarkAsDirty();
    }


    private async Task RemoveSection(int index)
    {
        if (index >= 0 && index < State.Template.Sections.Count)
        {
            var section = State.Template.Sections[index];
            var sectionName = section.GetLocalizedTitleWithFallback(CurrentLanguage);
            if (string.IsNullOrWhiteSpace(sectionName))
            {
                sectionName = T("labels.section-default").Replace("{0}", (index + 1).ToString());
            }
            var confirmed = await DialogService.Confirm(T("dialogs.delete-section-message").Replace("{0}", sectionName), T("dialogs.delete-section-title"),
                new ConfirmOptions() { OkButtonText = T("buttons.yes"), CancelButtonText = T("buttons.no") });

            if (confirmed.HasValue && confirmed.Value)
            {
                State.Template.Sections.RemoveAt(index);
                // Reorder remaining sections
                for (int i = 0; i < State.Template.Sections.Count; i++)
                {
                    State.Template.Sections[i].Order = i;
                }
                State.MarkAsDirty();
            }
        }
    }

    private void MoveSectionUp(int index)
    {
        if (index > 0)
        {
            (State.Template.Sections[index], State.Template.Sections[index - 1]) = (State.Template.Sections[index - 1], State.Template.Sections[index]);
            State.Template.Sections[index].Order = index;
            State.Template.Sections[index - 1].Order = index - 1;
            State.MarkAsDirty();
        }
    }

    private void MoveSectionDown(int index)
    {
        if (index < State.Template.Sections.Count - 1)
        {
            (State.Template.Sections[index], State.Template.Sections[index + 1]) = (State.Template.Sections[index + 1], State.Template.Sections[index]);
            State.Template.Sections[index].Order = index;
            State.Template.Sections[index + 1].Order = index + 1;
            State.MarkAsDirty();
        }
    }


    private async Task RemoveQuestion(int sectionIndex, int questionIndex)
    {
        var section = State.Template.Sections[sectionIndex];
        // Remove configuration items (evaluations, text sections, etc.) using the appropriate handler
        var handler = HandlerFactory.GetHandler(section.Type);
        var itemCount = handler.GetItemCount(section);

        if (questionIndex >= 0 && questionIndex < itemCount)
        {
            var confirmed = await DialogService.Confirm(
                T("dialogs.delete-question-message").Replace("{0}", $"Item {questionIndex + 1}"),
                T("dialogs.delete-question-title"),
                new ConfirmOptions() { OkButtonText = T("buttons.yes"), CancelButtonText = T("buttons.no") });

            if (confirmed.HasValue && confirmed.Value)
            {
                handler.RemoveItem(section, questionIndex);
                State.MarkAsDirty();
            }
        }
    }

    private void MoveQuestionUp(int sectionIndex, int questionIndex)
    {
        if (sectionIndex >= 0 && sectionIndex < State.Template.Sections.Count)
        {
            var section = State.Template.Sections[sectionIndex];
            var handler = HandlerFactory.GetHandler(section.Type);

            handler.MoveItemUp(section, questionIndex);
            State.MarkAsDirty();
        }
    }

    private void MoveQuestionDown(int sectionIndex, int questionIndex)
    {
        if (sectionIndex >= 0 && sectionIndex < State.Template.Sections.Count)
        {
            var section = State.Template.Sections[sectionIndex];
            var handler = HandlerFactory.GetHandler(section.Type);

            handler.MoveItemDown(section, questionIndex);
            State.MarkAsDirty();
        }
    }

    private string GetQuestionTypeIcon(QuestionType type)
    {
        return type switch
        {
            QuestionType.Assessment => "self_improvement",
            QuestionType.Goal => "track_changes",
            QuestionType.TextQuestion => "psychology",
            _ => "help"
        };
    }



    private async Task SaveQuestionnaire()
    {
        if (!ValidateQuestionnaire())
        {
            return;
        }

        isSaving = true;
        try
        {
            if (IsEditMode)
            {
                var updated = await ApiService.UpdateTemplateAsync(State.Template);
                if (updated != null)
                {
                    State.Template = updated;
                    State.MarkAsClean();
                    lastSavedTime = DateTime.Now;
                    NotificationService.Notify(NotificationSeverity.Success, T("notifications.saved"), T("messages.template-updated-successfully"));
                }
                else
                {
                    NotificationService.Notify(NotificationSeverity.Error, T("notifications.error"), T("messages.failed-update-template-no-response"));
                }
            }
            else
            {
                var created = await ApiService.CreateTemplateAsync(State.Template);
                State.Template.Id = created.Id; // Update with the server-generated ID
                State.MarkAsClean();
                lastSavedTime = DateTime.Now;
                NotificationService.Notify(NotificationSeverity.Success, T("notifications.saved"), T("messages.template-created-successfully"));

                // Navigate to edit mode to prevent duplicate creation on subsequent saves
                NavigationManager.NavigateTo($"/questionnaire-builder/{created.Id}", forceLoad: false);
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, T("notifications.error"), $"{T("messages.failed-save-template")}: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task PublishQuestionnaire()
    {
        if (!ValidateQuestionnaire())
        {
            return;
        }

        isSaving = true;
        try
        {
            // Save the template first (without setting isSaving again)
            if (IsEditMode)
            {
                var updated = await ApiService.UpdateTemplateAsync(State.Template);
                if (updated != null)
                {
                    State.Template = updated;
                    State.MarkAsClean();
                }
                else
                {
                    NotificationService.Notify(NotificationSeverity.Error, T("notifications.error"), T("messages.failed-update-template-no-response"));
                    return;
                }
            }
            else
            {
                var created = await ApiService.CreateTemplateAsync(State.Template);
                State.Template.Id = created.Id;
                State.MarkAsClean();
                // Navigate to edit mode to prevent duplicate creation
                NavigationManager.NavigateTo($"/questionnaire-builder/{created.Id}", forceLoad: false);
            }

            // Set as published
            State.Template.Status = TemplateStatus.Published;
            State.Template.LastPublishedDate = DateTime.Now;

            // Set PublishedDate only on first publish
            if (State.Template.PublishedDate == null)
            {
                State.Template.PublishedDate = DateTime.Now;
            }

            // Update the template with published status
            var publishedTemplate = await ApiService.PublishTemplateAsync(State.Template.Id);
            if (publishedTemplate != null)
            {
                State.Template = publishedTemplate;
                NotificationService.Notify(NotificationSeverity.Success, T("notifications.published"), T("messages.template-published-successfully"));
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, T("notifications.error"), T("messages.failed-publish-template"));
                // Revert on failure
                State.Template.Status = TemplateStatus.Draft;
                State.Template.LastPublishedDate = null;
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, T("notifications.error"), $"{T("messages.failed-publish-template")}: {ex.Message}");
            // Revert on failure
            State.Template.Status = TemplateStatus.Draft;
            State.Template.LastPublishedDate = null;
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task UnpublishQuestionnaire()
    {
        try
        {
            // Set as unpublished (back to draft)
            State.Template.Status = TemplateStatus.Draft;

            // Update the template with unpublished status
            var updated = await ApiService.UpdateTemplateAsync(State.Template);
            if (updated != null)
            {
                State.Template = updated;
                NotificationService.Notify(NotificationSeverity.Info, T("notifications.unpublished"), T("messages.template-unpublished-successfully"));
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, T("notifications.error"), T("messages.failed-unpublish-template"));
                State.Template.Status = TemplateStatus.Published; // Revert on failure
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, T("notifications.error"), $"{T("messages.failed-unpublish-template")}: {ex.Message}");
            State.Template.Status = TemplateStatus.Published; // Revert on failure
        }
    }

    private async Task RestoreQuestionnaire()
    {
        try
        {
            var updated = await ApiService.RestoreTemplateAsync(State.Template.Id);
            if (updated != null)
            {
                State.Template = updated;
                NotificationService.Notify(NotificationSeverity.Success, T("notifications.restored"), T("messages.template-restored-successfully"));
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, T("notifications.error"), T("messages.failed-restore-template"));
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, T("notifications.error"), $"{T("messages.failed-restore-template")}: {ex.Message}");
        }
    }

    private async Task ArchiveQuestionnaire()
    {
        try
        {
            var updated = await ApiService.ArchiveTemplateAsync(State.Template.Id);
            if (updated != null)
            {
                State.Template = updated;
                NotificationService.Notify(NotificationSeverity.Success, T("notifications.archived"), T("messages.template-archived-successfully"));
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, T("notifications.error"), T("messages.failed-archive-template"));
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, T("notifications.error"), $"{T("messages.failed-archive-template")}: {ex.Message}");
        }
    }

    private async Task HandleClone()
    {
        try
        {
            // Show confirmation dialog
            var confirmed = await DialogService.Confirm(
                T("dialogs.clone-template-message"),
                T("dialogs.clone-template-title"),
                new ConfirmOptions
                {
                    OkButtonText = T("buttons.clone"),
                    CancelButtonText = T("buttons.cancel")
                });

            if (confirmed != true)
                return;

            NotificationService.Notify(NotificationSeverity.Info, T("notifications.cloning"), T("messages.cloning-template"));

            // Call service to clone
            var newTemplateId = await ApiService.CloneTemplateAsync(State.Template.Id);

            if (newTemplateId.HasValue)
            {
                NotificationService.Notify(NotificationSeverity.Success, T("notifications.cloned"), T("messages.template-cloned-successfully"));

                // Navigate to the cloned template editor
                NavigationManager.NavigateTo($"/questionnaire-builder/{newTemplateId.Value}");
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, T("notifications.error"), T("messages.failed-clone-template"));
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, T("notifications.error"), $"{T("messages.error-cloning-template")}: {ex.Message}");
        }
    }

    private bool ValidateQuestionnaire()
    {
        var validationErrors = ValidationService.ValidateQuestionnaire(State.Template);

        // Show validation errors if any
        if (validationErrors.Count > 0)
        {
            var errorMessage = validationErrors.Count == 1
                ? validationErrors[0]
                : $"Please fix the following issues:\n• {string.Join("\n• ", validationErrors)}";

            NotificationService.Notify(NotificationSeverity.Warning, T("tooltips.validation-required"), errorMessage);
            return false;
        }

        return true;
    }

    // Helper methods to avoid section/question directive conflicts



    private string GetStatusDescription()
    {
        if (!IsEditMode)
        {
            return T("pages.questionnaire-description");
        }

        return TemplateStatusHelper.GetStatusDescription(State.Template.Status);
    }


    private string GetQuestionTypeLabel(QuestionSection question)
    {
        // Return the standard type label based on question type
        return questionTypeLabels[question.Type];
    }



    // Event handler overloads for the new component structure
    private async Task RemoveQuestion((int sectionIndex, int questionIndex) indices)
    {
        await RemoveQuestion(indices.sectionIndex, indices.questionIndex);
    }

    private void MoveQuestionUp((int sectionIndex, int questionIndex) indices)
    {
        MoveQuestionUp(indices.sectionIndex, indices.questionIndex);
    }

    private void MoveQuestionDown((int sectionIndex, int questionIndex) indices)
    {
        MoveQuestionDown(indices.sectionIndex, indices.questionIndex);
    }

    // Helper method to get default title for question types using translations
    private string GetDefaultTitleForQuestionType(QuestionType questionType)
    {
        return questionType switch
        {
            QuestionType.Assessment => T("questions.default-assessment-title"),
            QuestionType.Goal => T("questions.default-goal-title"),
            QuestionType.TextQuestion => T("questions.default-text-title"),
            _ => T("questions.default-assessment-title") // fallback
        };
    }

    // Helper method to get badge style for template status
    private BadgeStyle GetStatusBadgeStyle(TemplateStatus status) => status switch
    {
        TemplateStatus.Published => BadgeStyle.Success,
        TemplateStatus.Draft => BadgeStyle.Warning,
        TemplateStatus.Archived => BadgeStyle.Danger,
        _ => BadgeStyle.Info
    };
}

<style>
    @@keyframes rotate {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }
</style>
