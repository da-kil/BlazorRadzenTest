@page "/organization/questionnaires"
@using Radzen
@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Services
@using ti8m.BeachBreak.Client.Components.Shared
@using ti8m.BeachBreak.Client.Components.Dialogs
@inherits OptimizedComponentBase
@inject IHRQuestionnaireService HRQuestionnaireService
@inject IOrganizationApiService OrganizationService
@inject IQuestionnaireTemplateService TemplateService
@inject NotificationService NotificationService

<PageTitle>Organization Questionnaires</PageTitle>

@if (configuration != null && dataService != null)
{
    <GenericQuestionnaireListPage Configuration="@configuration" DataService="@dataService" />
}
else if (isLoading)
{
    <div class="text-center p-5">
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
        <RadzenText TextStyle="TextStyle.Body1" Class="text-muted mt-3">Loading organization data...</RadzenText>
    </div>
}

@code {
    private QuestionnairePageConfiguration? configuration;
    private IQuestionnaireDataService? dataService;

    private List<QuestionnaireAssignment> allAssignments = new();
    private List<EmployeeDto> allEmployees = new();
    private List<Organization> allOrganizations = new();
    private List<QuestionnaireTemplate> allTemplates = new();
    private bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadInitialData();
        SetupConfiguration();
    }

    private async Task LoadInitialData()
    {
        SetLoading(true);

        try
        {
            // Create the data service
            dataService = new HRQuestionnaireDataService(HRQuestionnaireService, TemplateService);

            // Load data to setup configuration
            var assignmentsTask = HRQuestionnaireService.GetAllAssignmentsAsync();
            var employeesTask = HRQuestionnaireService.GetAllEmployeesAsync();
            var organizationsTask = OrganizationService.GetAllOrganizationsAsync(includeDeleted: false, includeIgnored: false);
            var templatesTask = TemplateService.GetAllTemplatesAsync();

            await Task.WhenAll(assignmentsTask, employeesTask, organizationsTask, templatesTask);

            allAssignments = assignmentsTask.Result;
            allEmployees = employeesTask.Result;
            allOrganizations = organizationsTask.Result;
            allTemplates = templatesTask.Result;
        }
        catch (Exception ex)
        {
            HandleError(ex, "loading organization data");
        }
        finally
        {
            SetLoading(false);
        }
    }

    private void SetupConfiguration()
    {
        configuration = QuestionnairePageConfigurationFactory.CreateHRConfiguration(
            allAssignments,
            allEmployees,
            allOrganizations,
            allTemplates);

        // Add custom action handlers
        var exportAction = configuration.Actions.FirstOrDefault(a => a.Id == "export");
        if (exportAction != null)
        {
            exportAction.OnClick = ExportOrganizationReport;
        }

        var analyticsAction = configuration.Actions.FirstOrDefault(a => a.Id == "analytics");
        if (analyticsAction != null)
        {
            analyticsAction.OnClick = OpenAnalyticsDashboard;
        }
    }

    private async Task ExportOrganizationReport()
    {
        ShowInfo("Organization report export functionality would be implemented here");
    }

    private async Task OpenAnalyticsDashboard()
    {
        ShowInfo("Analytics dashboard functionality would be implemented here");
    }

    private void SetLoading(bool loading)
    {
        isLoading = loading;
        NotifyStateChanged();
    }

    private void HandleError(Exception ex, string context)
    {
        NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed {context}: {ex.Message}");
    }

    private void ShowInfo(string message)
    {
        NotificationService.Notify(NotificationSeverity.Info, "Information", message);
    }
}