@page "/organization/questionnaires"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@using Radzen
@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Services
@using ti8m.BeachBreak.Client.Components.Shared
@using ti8m.BeachBreak.Client.Components.Dialogs
@inherits BaseQuestionnaireListPage
@inject IHRQuestionnaireService HRQuestionnaireService
@inject IOrganizationApiService OrganizationService
@inject IQuestionnaireTemplateService TemplateService

<PageTitle>Organization Questionnaires</PageTitle>

@if (configuration != null && dataService != null)
{
	<GenericQuestionnaireListPage Configuration="@configuration" DataService="@dataService" />
}
else if (isLoading)
{
	<div class="text-center p-5">
		<RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
		<RadzenText TextStyle="TextStyle.Body1" Class="text-muted mt-3">Loading organization data...</RadzenText>
	</div>
}

@code {
	// HR-specific state
	private List<QuestionnaireAssignment> allAssignments = new();
	private List<EmployeeDto> allEmployees = new();
	private List<Organization> allOrganizations = new();
	private List<QuestionnaireTemplate> allTemplates = new();

	protected override string GetInitializationContext() => "InitializeOrganizationQuestionnaires";

	protected override async Task LoadRoleSpecificDataAsync()
	{
		// Create the data service
		dataService = new HRQuestionnaireDataService(HRQuestionnaireService, TemplateService);

		// Load data in parallel
		var assignmentsTask = HRQuestionnaireService.GetAllAssignmentsAsync();
		var employeesTask = HRQuestionnaireService.GetAllEmployeesAsync();
		var organizationsTask = OrganizationService.GetAllOrganizationsAsync(includeDeleted: false, includeIgnored: false);
		var templatesTask = TemplateService.GetAllTemplatesAsync();

		await Task.WhenAll(assignmentsTask, employeesTask, organizationsTask, templatesTask);

		allAssignments = assignmentsTask.Result;
		allEmployees = employeesTask.Result;
		allOrganizations = organizationsTask.Result;
		allTemplates = templatesTask.Result;
	}

	protected override QuestionnairePageConfiguration CreateConfiguration()
	{
		return QuestionnairePageConfigurationFactory.CreateHRConfiguration(
			allAssignments,
			allEmployees,
			allOrganizations,
			allTemplates,
			categories);
	}

	protected override void ConfigureActions()
	{
		var exportAction = configuration?.Actions.FirstOrDefault(a => a.Id == "export");
		if (exportAction != null)
		{
			exportAction.OnClick = ExportOrganizationReport;
		}

		var analyticsAction = configuration?.Actions.FirstOrDefault(a => a.Id == "analytics");
		if (analyticsAction != null)
		{
			analyticsAction.OnClick = OpenAnalyticsDashboard;
		}
	}

	private async Task ExportOrganizationReport()
	{
		ShowInfo("Organization report export functionality would be implemented here");
	}

	private async Task OpenAnalyticsDashboard()
	{
		ShowInfo("Analytics dashboard functionality would be implemented here");
	}
}
