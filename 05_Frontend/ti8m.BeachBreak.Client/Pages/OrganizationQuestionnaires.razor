@page "/organization/questionnaires"
@using Microsoft.AspNetCore.Components.Authorization
@using Radzen
@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Services
@using ti8m.BeachBreak.Client.Components.Shared
@using ti8m.BeachBreak.Client.Components.Dialogs
@using ti8m.BeachBreak.Client.Layout
@using ti8m.BeachBreak.Client.Models.Reports
@using ti8m.BeachBreak.Client.Services.Exports
@using System.Text
@inherits BaseQuestionnaireListPage
@inject IHRQuestionnaireService HRQuestionnaireService
@inject IOrganizationApiService OrganizationService
@inject IQuestionnaireTemplateService TemplateService
@inject IQuestionnaireReportExporter ReportExporter

<PageTitle>@T("pages.organization-questionnaires")</PageTitle>

<AuthorizeView Policy="HR">
    <Authorized>
        <PageLayout Type="LayoutType.Standard"
                   Title="@T("pages.organization-questionnaires")"
                   Description="@T("pages.organization-questionnaires-description")">
	<HeaderActions>
		@if (configuration?.Actions != null)
		{
			@foreach (var action in configuration.Actions.Where(a => a.IsVisible))
			{
				<RadzenButton Text="@action.Text"
							 Icon="@action.Icon"
							 ButtonStyle="@GetButtonStyle(action.ButtonStyle)"
							 Click="@(() => HandleActionClick(action))"
							 Size="ButtonSize.Medium" />
			}
		}
	</HeaderActions>
	<ChildContent>
		@if (configuration != null && dataService != null)
		{
			<GenericQuestionnaireListPage Configuration="@configuration"
										  DataService="@dataService"
										  HideHeader="true" />
		}
		else if (isLoading)
		{
			<div class="text-center p-5">
				<RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
				<RadzenText TextStyle="TextStyle.Body1" Class="text-muted mt-3">@T("messages.loading-organization-data")</RadzenText>
			</div>
		}
	</ChildContent>
</PageLayout>
    </Authorized>
    <NotAuthorized>
        <AccessDeniedComponent RequiredRole="HR" PageName="@T("pages.organization-questionnaires")" />
    </NotAuthorized>
</AuthorizeView>

@code {
	// HR-specific state
	private List<QuestionnaireAssignment> allAssignments = new();
	private List<EmployeeDto> allEmployees = new();
	private List<Organization> allOrganizations = new();
	private List<QuestionnaireTemplate> allTemplates = new();

	protected override string GetInitializationContext() => "InitializeOrganizationQuestionnaires";

	protected override async Task LoadRoleSpecificDataAsync()
	{
		// Load data in parallel
		var assignmentsTask = HRQuestionnaireService.GetAllAssignmentsAsync();
		var employeesTask = HRQuestionnaireService.GetAllEmployeesAsync();
		var organizationsTask = OrganizationService.GetAllOrganizationsAsync(includeDeleted: false, includeIgnored: false);
		var templatesTask = TemplateService.GetAllTemplatesAsync();

		await Task.WhenAll(assignmentsTask, employeesTask, organizationsTask, templatesTask);

		allAssignments = assignmentsTask.Result;
		allEmployees = employeesTask.Result;
		allOrganizations = organizationsTask.Result;
		allTemplates = templatesTask.Result;

		// Create the data service with organizations
		dataService = new HRQuestionnaireDataService(HRQuestionnaireService, TemplateService, allOrganizations);
	}

	protected override QuestionnairePageConfiguration CreateConfiguration()
	{
		return QuestionnairePageConfigurationFactory.CreateHRConfiguration(
			allAssignments,
			allEmployees,
			allOrganizations,
			allTemplates,
			categories,
			CurrentLanguage);
	}

	protected override void ConfigureActions()
	{
		var exportAction = configuration?.Actions.FirstOrDefault(a => a.Id == "export");
		if (exportAction != null)
		{
			exportAction.OnClick = ExportOrganizationReport;
		}

		var analyticsAction = configuration?.Actions.FirstOrDefault(a => a.Id == "analytics");
		if (analyticsAction != null)
		{
			analyticsAction.OnClick = OpenAnalyticsDashboard;
		}
	}

	private async Task ExportOrganizationReport()
	{
		try
		{
			ShowInfo(T("messages.generating-organization-report"));

			// Generate export data using refactored method
			var exportData = GenerateOrganizationReportData();

			// Use shared CSV generation
			var csvContent = await ReportExporter.GenerateCSVAsync(exportData);

			// Use shared download method
			var fileName = $"Organization_Questionnaires_Report_{DateTime.Now:yyyy-MM-dd_HH-mm-ss}.csv";
			ReportExporter.DownloadFile(csvContent, fileName, "text/csv");

			ShowSuccess($"{T("messages.report-exported-successfully")}: {fileName}");
		}
		catch (Exception ex)
		{
			ShowWarning($"{T("messages.failed-to-export-report")}: {ex.Message}");
		}
	}

	private Task OpenAnalyticsDashboard()
	{
		// Guide user to analytics tab instead of programmatic navigation
		ShowInfo(T("messages.analytics-tab-instruction"));
		return Task.CompletedTask;
	}

	private OrganizationReportData GenerateOrganizationReportData()
	{
		var now = DateTime.Now;

		// Use centralized metrics calculation for overall organization data
		var orgMetrics = QuestionnaireMetricsCalculator.CalculateMetrics(allAssignments, now);

		var reportData = new OrganizationReportData
		{
			GeneratedDate = now,
			TotalEmployees = allEmployees.Count,
			TotalAssignments = orgMetrics.Total,
			CompletedAssignments = orgMetrics.Completed,
			PendingAssignments = orgMetrics.Pending,
			OverdueAssignments = orgMetrics.Overdue,
			EmployeeDetails = allEmployees.Select(emp =>
			{
				var empAssignments = allAssignments.Where(a => a.EmployeeId == emp.Id).ToList();
				var empMetrics = QuestionnaireMetricsCalculator.CalculateMetrics(empAssignments, now);

				return new EmployeeReportData
				{
					EmployeeId = emp.Id,
					EmployeeName = $"{emp.FirstName} {emp.LastName}",
					Email = emp.EMail,
					Department = emp.Organization ?? T("labels.unknown"),
					Role = emp.ApplicationRole.ToString(),
					TotalAssignments = empMetrics.Total,
					CompletedAssignments = empMetrics.Completed,
					PendingAssignments = empMetrics.Pending,
					OverdueAssignments = empMetrics.Overdue,
					CompletionPercentage = empMetrics.CompletionPercentage
				};
			}).OrderBy(e => e.EmployeeName).ToList()
		};

		return reportData;
	}




}
