@page "/manager-dashboard"
@using Microsoft.AspNetCore.Components.Authorization
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Models.Dto
@using ti8m.BeachBreak.Client.Services
@using ti8m.BeachBreak.Client.Components.Shared
@using ti8m.BeachBreak.Client.Layout
@inject IManagerQuestionnaireService ManagerService
@inject NavigationManager NavigationManager
@inherits OptimizedTranslatableComponentBase

<AuthorizeView Policy="TeamLead">
    <Authorized>
        <PageLayout Title="@T("pages.manager-dashboard")"
                   Description="@T("pages.manager-dashboard-description")">
            <HeaderActions>
                <RadzenIcon Icon="supervisor_account" Class="page-icon" />
            </HeaderActions>
            <ChildContent>

    @if (isLoading)
    {
        <RadzenCard>
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Small" />
                <RadzenText>@T("messages.loading-dashboard")</RadzenText>
            </RadzenStack>
        </RadzenCard>
    }
    else if (dashboard == null)
    {
        <RadzenAlert AlertStyle="AlertStyle.Warning" Variant="Variant.Flat" Shade="Shade.Lighter">
            @T("messages.no-dashboard-data")
        </RadzenAlert>
    }
    else
    {
        <!-- Team-wide Metrics -->
        <RadzenText TextStyle="TextStyle.H5" Class="rz-mb-2">@T("sections.team-overview")</RadzenText>
        <RadzenRow Gap="1rem">
            <RadzenColumn Size="12" SizeMD="3">
                <MetricCard Title="@T("metrics.team-pending")"
                           Value="@dashboard.TeamPendingCount.ToString()"
                           Icon="pending_actions"
                           Type="MetricType.Pending"
                           OnClick="@(() => NavigateToTeamQuestionnaires())" />
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="3">
                <MetricCard Title="@T("metrics.team-in-progress")"
                           Value="@dashboard.TeamInProgressCount.ToString()"
                           Icon="hourglass_top"
                           Type="MetricType.Progress"
                           OnClick="@(() => NavigateToTeamQuestionnaires())" />
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="3">
                <MetricCard Title="@T("metrics.team-completed")"
                           Value="@dashboard.TeamCompletedCount.ToString()"
                           Icon="check_circle"
                           Type="MetricType.Completed"
                           OnClick="@(() => NavigateToTeamQuestionnaires())" />
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="3">
                <MetricCard Title="@T("metrics.team-members")"
                           Value="@dashboard.TeamMemberCount.ToString()"
                           Icon="group"
                           Type="MetricType.Info" />
            </RadzenColumn>
        </RadzenRow>

        <!-- Team Members Section -->
        @if (dashboard.TeamMembers.Any())
        {
            <RadzenText TextStyle="TextStyle.H5" Class="rz-mt-4 rz-mb-2">@T("sections.team-members")</RadzenText>
            <RadzenRow Gap="1rem">
                @foreach (var member in dashboard.TeamMembers)
                {
                    <RadzenColumn Size="12" SizeMD="6" SizeLG="4">
                        <RadzenCard Class="team-member-card">
                            <RadzenStack Gap="0.75rem">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <RadzenText TextStyle="TextStyle.Subtitle1" Class="rz-mb-0">@member.EmployeeName</RadzenText>
                                        <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-text-secondary-color);">@member.EmployeeEmail</RadzenText>
                                    </div>
                                    @if (member.HasOverdueItems)
                                    {
                                        <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="@T("status.overdue")" />
                                    }
                                    else if (member.UrgentCount > 0)
                                    {
                                        <RadzenBadge BadgeStyle="BadgeStyle.Warning" Text="@($"{member.UrgentCount} {T("status.urgent")}")" />
                                    }
                                </div>

                                <RadzenRow Gap="0.5rem">
                                    <RadzenColumn Size="4">
                                        <div class="metric-small">
                                            <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-text-secondary-color);">@T("status.pending")</RadzenText>
                                            <RadzenText TextStyle="TextStyle.H6" Class="rz-mb-0">@member.PendingCount</RadzenText>
                                        </div>
                                    </RadzenColumn>
                                    <RadzenColumn Size="4">
                                        <div class="metric-small">
                                            <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-text-secondary-color);">@T("status.active")</RadzenText>
                                            <RadzenText TextStyle="TextStyle.H6" Class="rz-mb-0">@member.InProgressCount</RadzenText>
                                        </div>
                                    </RadzenColumn>
                                    <RadzenColumn Size="4">
                                        <div class="metric-small">
                                            <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-text-secondary-color);">@T("status.done")</RadzenText>
                                            <RadzenText TextStyle="TextStyle.H6" Class="rz-mb-0">@member.CompletedCount</RadzenText>
                                        </div>
                                    </RadzenColumn>
                                </RadzenRow>
                            </RadzenStack>
                        </RadzenCard>
                    </RadzenColumn>
                }
            </RadzenRow>
        }

        <!-- Urgent Assignments Section -->
        @if (dashboard.UrgentAssignments.Any())
        {
            <RadzenText TextStyle="TextStyle.H5" Class="rz-mt-4 rz-mb-2">@T("sections.urgent-assignments")</RadzenText>
            <div class="rz-background-color-base-100 rz-p-4 rz-border-radius-3" style="border: 1px solid var(--rz-base-300);">
                <RadzenDataList Data="@dashboard.UrgentAssignments" TItem="TeamUrgentAssignmentDto" AllowPaging="true" PageSize="5">
                    <Template Context="assignment">
                        <RadzenCard Class="rz-shadow-0 rz-border-base-300" Style="margin-bottom: 0.5rem;">
                            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center" Gap="1rem" Wrap="FlexWrap.Wrap">
                                <RadzenStack Gap="0.25rem" Style="flex: 1;">
                                    <RadzenText TextStyle="TextStyle.Subtitle2" Class="rz-mb-0">@assignment.QuestionnaireTemplateName</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-text-secondary-color);">
                                        @assignment.EmployeeName
                                    </RadzenText>
                                </RadzenStack>

                                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                                    @if (assignment.IsOverdue)
                                    {
                                        <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="@T("status.overdue")" />
                                        <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-danger);">
                                            @T("labels.due") @assignment.DueDate.ToString("MMM dd, yyyy")
                                        </RadzenText>
                                    }
                                    else
                                    {
                                        <RadzenBadge BadgeStyle="BadgeStyle.Warning" Text="@($"{assignment.DaysUntilDue} {T("labels.days-left")}")" />
                                        <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-warning);">
                                            @T("labels.due") @assignment.DueDate.ToString("MMM dd, yyyy")
                                        </RadzenText>
                                    }
                                    <RadzenBadge BadgeStyle="BadgeStyle.Light" Text="@assignment.WorkflowState" />
                                </RadzenStack>
                            </RadzenStack>
                        </RadzenCard>
                    </Template>
                </RadzenDataList>
            </div>
        }
        else if (dashboard.TeamMembers.Any())
        {
            <RadzenText TextStyle="TextStyle.H5" Class="rz-mt-4 rz-mb-2">@T("sections.urgent-assignments")</RadzenText>
            <RadzenAlert AlertStyle="AlertStyle.Success" Variant="Variant.Flat" Shade="Shade.Lighter">
                @T("messages.no-urgent-assignments")
            </RadzenAlert>
        }

        <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-text-secondary-color);" Class="rz-mt-3">
            @T("labels.last-updated"): @dashboard.LastUpdated.ToString("MMM dd, yyyy HH:mm")
        </RadzenText>
    }

            </ChildContent>
        </PageLayout>
    </Authorized>
    <NotAuthorized>
        <AccessDeniedComponent RequiredRole="TeamLead" PageName="@T("pages.manager-dashboard")" />
    </NotAuthorized>
</AuthorizeView>

@code {
    private ManagerDashboardDto? dashboard;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardAsync();
    }

    private async Task LoadDashboardAsync()
    {
        isLoading = true;
        try
        {
            dashboard = await ManagerService.GetMyDashboardAsync();
        }
        catch (Exception ex)
        {
            // Log error - could add notification here
            Console.WriteLine($"Error loading dashboard: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void NavigateToTeamQuestionnaires()
    {
        NavigationManager.NavigateTo("/team-questionnaires");
    }
}

<!-- Dashboard patterns loaded from dashboard-patterns.css -->
