@page "/team/questionnaires"
@using Microsoft.AspNetCore.Components.Authorization
@using Radzen
@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Services
@using ti8m.BeachBreak.Client.Components.Shared
@using ti8m.BeachBreak.Client.Components.Dialogs
@using ti8m.BeachBreak.Client.Layout
@using ti8m.BeachBreak.Client.Models.Reports
@using ti8m.BeachBreak.Client.Services.Exports
@using System.Text
@inherits BaseQuestionnaireListPage
@inject IManagerQuestionnaireService ManagerQuestionnaireService
@inject IQuestionnaireTemplateService TemplateService
@inject IQuestionnaireReportExporter ReportExporter
@inject IJSRuntime JSRuntime

<PageTitle>@T("pages.team-questionnaires")</PageTitle>

<AuthorizeView Policy="TeamLead">
    <Authorized>
        <PageLayout Type="LayoutType.Standard"
                   Title="@T("pages.team-questionnaires")"
                   Description="@T("pages.team-questionnaires-description")">
	<HeaderActions>
		@if (configuration?.Actions != null)
		{
			@foreach (var action in configuration.Actions.Where(a => a.IsVisible))
			{
				<RadzenButton Text="@action.Text"
							 Icon="@action.Icon"
							 ButtonStyle="@GetButtonStyle(action.ButtonStyle)"
							 Click="@(() => HandleActionClick(action))"
							 Size="ButtonSize.Medium" />
			}
		}
	</HeaderActions>
	<ChildContent>
		@if (configuration != null && dataService != null)
		{
			<GenericQuestionnaireListPage Configuration="@configuration"
										  DataService="@dataService"
										  HideHeader="true" />
		}
		else if (isLoading)
		{
			<div class="text-center p-5">
				<RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
				<RadzenText TextStyle="TextStyle.Body1" Class="text-muted mt-3">Loading team data...</RadzenText>
			</div>
		}
	</ChildContent>
</PageLayout>
    </Authorized>
    <NotAuthorized>
        <AccessDeniedComponent RequiredRole="TeamLead" PageName="Team Questionnaires" />
    </NotAuthorized>
</AuthorizeView>

@code {
	// Manager-specific state
	private List<QuestionnaireAssignment> allAssignments = new();
	private List<EmployeeDto> teamMembers = new();

	protected override string GetInitializationContext() => "InitializeTeamQuestionnaires";

	protected override async Task LoadRoleSpecificDataAsync()
	{
		// Create the data service
		dataService = new ManagerQuestionnaireDataService(ManagerQuestionnaireService, TemplateService);

		// Load data in parallel
		var assignmentsTask = ManagerQuestionnaireService.GetTeamAssignmentsAsync();
		var teamMembersTask = ManagerQuestionnaireService.GetTeamMembersAsync();

		await Task.WhenAll(assignmentsTask, teamMembersTask);

		allAssignments = assignmentsTask.Result;
		teamMembers = teamMembersTask.Result;
	}

	protected override async Task<QuestionnairePageConfiguration> CreateConfigurationAsync()
	{
		return await QuestionnairePageConfigurationFactory.CreateManagerConfigurationAsync(
			allAssignments,
			teamMembers,
			categories,
			TranslationService,
			CurrentLanguage);
	}

	protected override void ConfigureActions()
	{
		var exportAction = configuration?.Actions.FirstOrDefault(a => a.Id == "export");
		if (exportAction != null)
		{
			exportAction.OnClick = ExportTeamReport;
		}
	}

	private async Task ExportTeamReport()
	{
		try
		{
			ShowInfo("Generating team report...");

			// Generate export data using refactored method
			var exportData = GenerateTeamReportData();

			// Use shared CSV generation
			var csvContent = await ReportExporter.GenerateCSVAsync(exportData);

			// Use shared download method
			var fileName = $"Team_Questionnaires_Report_{DateTime.Now:yyyy-MM-dd_HH-mm-ss}.csv";
			ReportExporter.DownloadFile(csvContent, fileName, "text/csv");

			ShowSuccess($"Team report exported successfully: {fileName}");
		}
		catch (Exception ex)
		{
			ShowWarning($"Failed to export team report: {ex.Message}");
		}
	}

	private TeamReportData GenerateTeamReportData()
	{
		var now = DateTime.Now;

		// Use centralized metrics calculation for overall team data
		var teamMetrics = QuestionnaireMetricsCalculator.CalculateMetrics(allAssignments, now);

		var reportData = new TeamReportData
		{
			GeneratedDate = now,
			TotalTeamMembers = teamMembers.Count,
			TotalAssignments = teamMetrics.Total,
			CompletedAssignments = teamMetrics.Completed,
			PendingAssignments = teamMetrics.Pending,
			OverdueAssignments = teamMetrics.Overdue,
			TeamMemberDetails = teamMembers.Select(member =>
			{
				var memberAssignments = allAssignments.Where(a => a.EmployeeId == member.Id).ToList();
				var memberMetrics = QuestionnaireMetricsCalculator.CalculateMetrics(memberAssignments, now);

				return new TeamMemberReportData
				{
					MemberId = member.Id,
					MemberName = $"{member.FirstName} {member.LastName}",
					Email = member.EMail,
					Role = member.ApplicationRole.ToString(),
					TotalAssignments = memberMetrics.Total,
					CompletedAssignments = memberMetrics.Completed,
					PendingAssignments = memberMetrics.Pending,
					OverdueAssignments = memberMetrics.Overdue,
					CompletionPercentage = memberMetrics.CompletionPercentage
				};
			}).OrderBy(m => m.MemberName).ToList()
		};

		return reportData;
	}
}
