@using Microsoft.AspNetCore.Components
@using Radzen
@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Models.Dto
@using ti8m.BeachBreak.Client.Services
@using ti8m.BeachBreak.Client.Components.Shared
@using ti8m.BeachBreak.Client.Components.EmployeeFeedback
@inject IEmployeeFeedbackApiService FeedbackService
@inject IEmployeeApiService EmployeeService
@inject DialogService DialogService
@inject NotificationService NotificationService
@inherits OptimizedTranslatableComponentBase

<div class="edit-feedback-dialog">
    @if (isLoading)
    {
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
        <RadzenText TextStyle="TextStyle.Body1">@T("messages.loading-feedback")</RadzenText>
    }
    else if (feedback != null)
    {
        <RadzenStack Gap="1rem">
            <!-- Employee Information (Read-only) -->
            <RadzenCard>
                <RadzenText TextStyle="TextStyle.H6" Class="mb-3">
                    @T("sections.employee-information")
                </RadzenText>

                <RadzenRow Gap="1rem">
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenText TextStyle="TextStyle.Body2" Class="mb-1">
                            @T("labels.employee")
                        </RadzenText>
                        <RadzenText TextStyle="TextStyle.Body1" Class="font-medium">
                            @feedback.EmployeeName
                        </RadzenText>
                    </RadzenColumn>

                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenText TextStyle="TextStyle.Body2" Class="mb-1">
                            @T("labels.feedback-date")
                        </RadzenText>
                        <RadzenText TextStyle="TextStyle.Body1" Class="font-medium">
                            @feedback.FeedbackDate.ToString("yyyy-MM-dd")
                        </RadzenText>
                    </RadzenColumn>
                </RadzenRow>

                <RadzenRow Gap="1rem" Class="mt-2">
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenText TextStyle="TextStyle.Body2" Class="mb-1">
                            @T("labels.source-type")
                        </RadzenText>
                        <RadzenBadge Text="@feedback.SourceTypeDisplayName"
                                   Variant="Variant.Flat"
                                   IsPill="true"
                                   Class="@feedback.SourceTypeBadgeClass" />
                    </RadzenColumn>

                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenText TextStyle="TextStyle.Body2" Class="mb-1">
                            @T("labels.feedback-provider")
                        </RadzenText>
                        <RadzenText TextStyle="TextStyle.Body1" Class="font-medium">
                            @feedback.ProviderName
                        </RadzenText>
                        @if (!string.IsNullOrWhiteSpace(feedback.ProviderRole))
                        {
                            <RadzenText TextStyle="TextStyle.Body2" Class="text-muted">
                                @feedback.ProviderRole
                            </RadzenText>
                        }
                    </RadzenColumn>
                </RadzenRow>
            </RadzenCard>

            <!-- Editable Feedback Content -->
            <ConfigurableFeedbackSection @bind-FeedbackData="@editableFeedbackData"
                                       AvailableCriteria="@availableCriteria"
                                       TextSections="@availableTextSections"
                                       RatingScale="10" />

            <!-- Action Buttons -->
            <RadzenCard>
                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem">
                    <RadzenButton Text="@T("buttons.cancel")"
                                ButtonStyle="ButtonStyle.Light"
                                Click="@CancelEdit"
                                Icon="cancel" />

                    <RadzenButton Text="@T("buttons.save-changes")"
                                ButtonStyle="ButtonStyle.Primary"
                                Click="@SaveChanges"
                                Icon="save"
                                IsBusy="@isSaving" />
                </RadzenStack>
            </RadzenCard>
        </RadzenStack>
    }
    else
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger">
            @T("messages.feedback-not-found")
        </RadzenAlert>
    }
</div>

@code {
    [Parameter] public Guid FeedbackId { get; set; }

    private bool isLoading = true;
    private bool isSaving = false;
    private EmployeeFeedbackSummaryDto? feedback;
    private ti8m.BeachBreak.Client.Models.Dto.ConfigurableFeedbackDataDto editableFeedbackData = new();
    private List<EvaluationItem> availableCriteria = new();
    private List<TextSection> availableTextSections = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadFeedback();
    }

    private async Task LoadFeedback()
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            var result = await FeedbackService.GetFeedbackByIdAsync(FeedbackId);
            if (result.Succeeded)
            {
                feedback = result.Payload;
                editableFeedbackData = feedback.FeedbackData ?? new ti8m.BeachBreak.Client.Models.Dto.ConfigurableFeedbackDataDto();

                // For now, create some default criteria and sections
                // In a full implementation, these would come from templates or API
                availableCriteria = CreateDefaultCriteria();
                availableTextSections = CreateDefaultTextSections();
            }
            else
            {
                feedback = null;
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = T("notifications.error"),
                Detail = $"{T("messages.error-loading-feedback")}: {ex.Message}",
                Duration = 5000
            });
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task SaveChanges()
    {
        if (feedback == null) return;

        try
        {
            isSaving = true;
            StateHasChanged();

            var updateDto = new ti8m.BeachBreak.Client.Models.Dto.UpdateEmployeeFeedbackDto
            {
                FeedbackData = editableFeedbackData,
                FeedbackDate = feedback.FeedbackDate,
                ProviderInfo = new ti8m.BeachBreak.Client.Models.Dto.FeedbackProviderInfoDto
                {
                    ProviderName = feedback.ProviderName,
                    ProviderRole = feedback.ProviderRole,
                    ProjectName = feedback.ProjectName,
                    ProjectContext = null
                }
            };

            var result = await FeedbackService.UpdateFeedbackAsync(FeedbackId, updateDto);
            if (result.Succeeded)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = T("notifications.success"),
                    Detail = T("messages.feedback-updated-successfully"),
                    Duration = 3000
                });

                DialogService.Close(true);
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = T("notifications.error"),
                    Detail = result.ErrorMessage ?? T("messages.error-updating-feedback"),
                    Duration = 5000
                });
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = T("notifications.error"),
                Detail = $"{T("messages.error-updating-feedback")}: {ex.Message}",
                Duration = 5000
            });
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private void CancelEdit()
    {
        DialogService.Close(false);
    }

    private List<EvaluationItem> CreateDefaultCriteria()
    {
        return new List<EvaluationItem>
        {
            new("communication", T("criteria.communication"), "", false, 1),
            new("teamwork", T("criteria.teamwork"), "", false, 2),
            new("problem_solving", T("criteria.problem-solving"), "", false, 3),
            new("quality", T("criteria.quality"), "", false, 4),
            new("reliability", T("criteria.reliability"), "", false, 5),
            new("initiative", T("criteria.initiative"), "", false, 6),
            new("overall", T("criteria.overall"), "", false, 7)
        };
    }

    private List<TextSection> CreateDefaultTextSections()
    {
        return new List<TextSection>
        {
            new() {
                TitleEnglish = T("feedback-sections.positive-feedback.title"),
                TitleGerman = T("feedback-sections.positive-feedback.title"),
                DescriptionEnglish = T("feedback-sections.positive-feedback.placeholder"),
                DescriptionGerman = T("feedback-sections.positive-feedback.placeholder"),
                Order = 1
            },
            new() {
                TitleEnglish = T("feedback-sections.areas-for-improvement.title"),
                TitleGerman = T("feedback-sections.areas-for-improvement.title"),
                DescriptionEnglish = T("feedback-sections.areas-for-improvement.placeholder"),
                DescriptionGerman = T("feedback-sections.areas-for-improvement.placeholder"),
                Order = 2
            },
            new() {
                TitleEnglish = T("feedback-sections.additional-comments.title"),
                TitleGerman = T("feedback-sections.additional-comments.title"),
                DescriptionEnglish = T("feedback-sections.additional-comments.placeholder"),
                DescriptionGerman = T("feedback-sections.additional-comments.placeholder"),
                Order = 3
            }
        };
    }
}