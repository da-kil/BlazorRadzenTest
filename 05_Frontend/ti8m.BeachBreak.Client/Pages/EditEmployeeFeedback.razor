@using Microsoft.AspNetCore.Components
@using Radzen
@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Models.Dto
@using ti8m.BeachBreak.Client.Services
@using ti8m.BeachBreak.Client.Components.Shared
@using ti8m.BeachBreak.Client.Components.EmployeeFeedback
@inject IEmployeeFeedbackApiService FeedbackService
@inject IEmployeeApiService EmployeeService
@inject IFeedbackTemplateService TemplateService
@inject DialogService DialogService
@inherits OptimizedTranslatableComponentBase

<div class="edit-feedback-dialog">
    @if (isLoading)
    {
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
        <RadzenText TextStyle="TextStyle.Body1">@T("messages.loading-feedback")</RadzenText>
    }
    else if (feedback != null)
    {
        <RadzenStack Gap="1rem">
            <!-- Employee Information (Read-only) -->
            <RadzenText TextStyle="TextStyle.H6" Class="mb-3">
                @T("sections.employee-information")
            </RadzenText>

            <RadzenRow Gap="1rem">
                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenText TextStyle="TextStyle.Body2" Class="mb-1">
                        @T("labels.employee")
                    </RadzenText>
                    <RadzenText TextStyle="TextStyle.Body1" Class="font-medium">
                        @feedback.EmployeeName
                    </RadzenText>
                </RadzenColumn>

                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenText TextStyle="TextStyle.Body2" Class="mb-1">
                        @T("labels.feedback-date")
                    </RadzenText>
                    <RadzenText TextStyle="TextStyle.Body1" Class="font-medium">
                        @feedback.FeedbackDate.ToString("yyyy-MM-dd")
                    </RadzenText>
                </RadzenColumn>
            </RadzenRow>

            <RadzenRow Gap="1rem" Class="mt-2">
                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenText TextStyle="TextStyle.Body2" Class="mb-1">
                        @T("labels.source-type")
                    </RadzenText>
                    <RadzenBadge Text="@feedback.SourceTypeDisplayName"
                                 Variant="Variant.Flat"
                                 IsPill="true"
                                 Class="@feedback.SourceTypeBadgeClass" />
                </RadzenColumn>

                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenText TextStyle="TextStyle.Body2" Class="mb-1">
                        @T("labels.feedback-provider")
                    </RadzenText>
                    <RadzenText TextStyle="TextStyle.Body1" Class="font-medium">
                        @feedback.ProviderName
                    </RadzenText>
                    @if (!string.IsNullOrWhiteSpace(feedback.ProviderRole))
                    {
                        <RadzenText TextStyle="TextStyle.Body2" Class="text-muted">
                            @feedback.ProviderRole
                        </RadzenText>
                    }
                </RadzenColumn>
            </RadzenRow>

            <!-- Editable Feedback Content -->
            <ConfigurableFeedbackSection @bind-FeedbackData="@editableFeedbackData"
                                         AvailableCriteria="@availableCriteria"
                                         TextSections="@availableTextSections"
                                         RatingScale="@ratingScale" />

            <!-- Action Buttons -->
            <RadzenCard>
                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem">
                    <RadzenButton Text="@T("buttons.cancel")"
                                  ButtonStyle="ButtonStyle.Light"
                                  Click="@CancelEdit"
                                  Icon="cancel" />

                    <RadzenButton Text="@T("buttons.save-changes")"
                                  ButtonStyle="ButtonStyle.Primary"
                                  Click="@SaveChanges"
                                  Icon="save"
                                  IsBusy="@isSaving" />
                </RadzenStack>
            </RadzenCard>
        </RadzenStack>
    }
    else
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger">
            @T("messages.feedback-not-found")
        </RadzenAlert>
    }
</div>

@code {
    [Parameter] public Guid FeedbackId { get; set; }

    private bool isLoading = true;
    private bool isSaving = false;
    private EmployeeFeedbackSummaryDto? feedback;
    private ti8m.BeachBreak.Client.Models.Dto.ConfigurableFeedbackDataDto editableFeedbackData = new();
    private List<EvaluationItem> availableCriteria = new();
    private List<TextSection> availableTextSections = new();
    private int ratingScale = 10;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await LoadFeedback();
    }

    private async Task LoadFeedback()
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            var result = await FeedbackService.GetFeedbackByIdAsync(FeedbackId);
            if (result.Succeeded)
            {
                feedback = result.Payload;
                editableFeedbackData = feedback.FeedbackData ?? new ti8m.BeachBreak.Client.Models.Dto.ConfigurableFeedbackDataDto();

                // Load template data based on the feedback source type
                await LoadTemplateData((FeedbackSourceType)feedback.SourceType);
            }
            else
            {
                feedback = null;
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = T("notifications.error"),
                Detail = $"{T("messages.error-loading-feedback")}: {ex.Message}",
                Duration = 5000
            });
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task SaveChanges()
    {
        if (feedback == null) return;

        try
        {
            isSaving = true;
            StateHasChanged();

            var updateDto = new ti8m.BeachBreak.Client.Models.Dto.UpdateEmployeeFeedbackDto
            {
                FeedbackData = editableFeedbackData,
                FeedbackDate = feedback.FeedbackDate,
                ProviderInfo = new ti8m.BeachBreak.Client.Models.Dto.FeedbackProviderInfoDto
                {
                    ProviderName = feedback.ProviderName,
                    ProviderRole = feedback.ProviderRole,
                    ProjectName = feedback.ProjectName,
                    ProjectContext = null
                }
            };

            var result = await FeedbackService.UpdateFeedbackAsync(FeedbackId, updateDto);
            if (result.Succeeded)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = T("notifications.success"),
                    Detail = T("messages.feedback-updated-successfully"),
                    Duration = 3000
                });

                DialogService.Close(true);
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = T("notifications.error"),
                    Detail = result.ErrorMessage ?? T("messages.error-updating-feedback"),
                    Duration = 5000
                });
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = T("notifications.error"),
                Detail = $"{T("messages.error-updating-feedback")}: {ex.Message}",
                Duration = 5000
            });
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private void CancelEdit()
    {
        DialogService.Close(false);
    }

    private async Task LoadTemplateData(FeedbackSourceType sourceType)
    {
        try
        {
            // Load templates that support the feedback source type
            var templates = await TemplateService.GetTemplatesBySourceTypeAsync(sourceType);

            // Use the most recently published template as the reference
            // Note: Since feedback doesn't store the original template ID, we use the latest published template
            // This is a reasonable approximation as templates are typically stable within an organization
            var template = templates
                .Where(t => t.CanBeUsedForFeedback) // Published and not deleted
                .OrderByDescending(t => t.PublishedDate)
                .FirstOrDefault();

            if (template != null)
            {
                // Set criteria directly from template
                availableCriteria = template.Criteria;

                // Set rating scale from template
                ratingScale = template.RatingScale;

                // Convert TextSectionDefinition to TextSection
                availableTextSections = template.TextSections.Select(section => new TextSection
                {
                    TitleEnglish = section.TitleEnglish,
                    TitleGerman = section.TitleGerman,
                    DescriptionEnglish = section.DescriptionEnglish,
                    DescriptionGerman = section.DescriptionGerman,
                    IsRequired = section.IsRequired,
                    Order = section.Order,
                    // Note: TextSection doesn't have Key or Placeholder fields like TextSectionDefinition
                    // These are only needed for template editing, not for feedback display
                }).ToList();
            }
            else
            {
                // If no template is found, leave empty (fallback to existing behavior)
                availableCriteria = new List<EvaluationItem>();
                availableTextSections = new List<TextSection>();
            }
        }
        catch (Exception ex)
        {
            // Log the error but don't show it to the user since template loading is auxiliary
            // The feedback can still be edited without the template structure
            availableCriteria = new List<EvaluationItem>();
            availableTextSections = new List<TextSection>();

            // Optionally log the exception (if logging is available)
            Console.WriteLine($"Error loading template data for source type {sourceType}: {ex.Message}");
        }
    }

}