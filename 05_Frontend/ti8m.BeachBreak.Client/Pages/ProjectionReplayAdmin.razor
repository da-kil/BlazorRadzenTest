@page "/admin/projection-replay"
@using Microsoft.AspNetCore.Components.Authorization
@using Radzen
@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Models.Dto
@using ti8m.BeachBreak.Client.Services
@using ti8m.BeachBreak.Client.Components.Shared
@using ti8m.BeachBreak.Client.Components.Dialogs
@using ti8m.BeachBreak.Client.Layout
@inject IProjectionReplayApiService ReplayService
@inject DialogService DialogService
@inherits OptimizedTranslatableComponentBase
@implements IDisposable

<PageTitle>@T("pages.projection-replay-administration")</PageTitle>

<AuthorizeView Policy="Admin">
    <Authorized>
        <PageLayout Type="LayoutType.Standard"
                   Title="@T("pages.projection-replay-administration")"
                Description="@T("pages.projection-replay-administration-description")">
    <HeaderActions>
        <AsyncButton Text="@T("buttons.start-new-replay")"
                     ButtonStyle="ButtonStyle.Primary"
                     Icon="play_arrow"
                     Click="@ShowStartReplayDialog" />
        <RadzenButton Icon="refresh" Click="@LoadData" Disabled="@isLoading" ButtonStyle="ButtonStyle.Secondary" />
    </HeaderActions>
    <ChildContent>

                <RadzenTabs>
                    <Tabs>
                        <RadzenTabsItem Text="@T("tabs.active-replays")">
                            @if (isLoading)
                            {
                                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                            }
                            else if (activeReplays.Any())
                            {
                                <RadzenDataGrid Data="@activeReplays" TItem="ProjectionReplayStatus" class="mt-3">
                                    <Columns>
                                        <RadzenDataGridColumn TItem="ProjectionReplayStatus" Property="ProjectionName" Title="@T("columns.projection")">
                                            <Template Context="replay">
                                                <RadzenText TextStyle="TextStyle.Body1"><strong>@replay.ProjectionName</strong></RadzenText>
                                            </Template>
                                        </RadzenDataGridColumn>

                                        <RadzenDataGridColumn TItem="ProjectionReplayStatus" Property="Status" Title="@T("columns.status")">
                                            <Template Context="replay">
                                                <RadzenBadge BadgeStyle="@GetStatusBadgeStyle(replay.Status)" Text="@replay.Status" />
                                            </Template>
                                        </RadzenDataGridColumn>

                                        <RadzenDataGridColumn TItem="ProjectionReplayStatus" Property="ProgressPercentage" Title="@T("columns.progress")">
                                            <Template Context="replay">
                                                <div style="width: 200px;">
                                                    <RadzenProgressBar Value="@replay.ProgressPercentage" ShowValue="true" Unit="%" Style="width: 100%;" />
                                                    <RadzenText TextStyle="TextStyle.Caption">
                                                        @replay.ProcessedEvents / @replay.TotalEvents @T("labels.events")
                                                    </RadzenText>
                                                </div>
                                            </Template>
                                        </RadzenDataGridColumn>

                                        <RadzenDataGridColumn TItem="ProjectionReplayStatus" Property="StartedAt" Title="@T("columns.started")">
                                            <Template Context="replay">
                                                <RadzenText TextStyle="TextStyle.Body2">@replay.StartedAt.ToLocalTime().ToString("g")</RadzenText>
                                                <RadzenText TextStyle="TextStyle.Caption" Class="text-muted">
                                                    @GetDuration(replay.StartedAt)
                                                </RadzenText>
                                            </Template>
                                        </RadzenDataGridColumn>

                                        <RadzenDataGridColumn TItem="ProjectionReplayStatus" Title="@T("columns.actions")" Width="100px">
                                            <Template Context="replay">
                                                @if (replay.Status == "Pending" || replay.Status == "Validating" ||
                                                                                                replay.Status == "DeletingSnapshots" || replay.Status == "Replaying")
                                                {
                                                    <RadzenButton Icon="cancel" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small"
                                                                  Click="@(() => CancelReplay(replay.Id))" />
                                                }
                                            </Template>
                                        </RadzenDataGridColumn>
                                    </Columns>
                                </RadzenDataGrid>
                            }
                            else
                            {
                                <RadzenAlert AlertStyle="AlertStyle.Info" Class="mt-3">
                                    @T("messages.no-active-replays")
                                </RadzenAlert>
                            }
                        </RadzenTabsItem>

                        <RadzenTabsItem Text="@T("tabs.history")">
                            @if (isLoading)
                            {
                                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                            }
                            else
                            {
                                <RadzenDataGrid Data="@completedReplays" TItem="ProjectionReplayStatus" AllowSorting="true" class="mt-3">
                                    <Columns>
                                        <RadzenDataGridColumn TItem="ProjectionReplayStatus" Property="ProjectionName" Title="@T("columns.projection")" />
                                        <RadzenDataGridColumn TItem="ProjectionReplayStatus" Property="Status" Title="@T("columns.status")">
                                            <Template Context="replay">
                                                <RadzenBadge BadgeStyle="@GetStatusBadgeStyle(replay.Status)" Text="@replay.Status" />
                                            </Template>
                                        </RadzenDataGridColumn>
                                        <RadzenDataGridColumn TItem="ProjectionReplayStatus" Property="StartedAt" Title="@T("columns.started-at")">
                                            <Template Context="replay">
                                                @replay.StartedAt.ToLocalTime().ToString("g")
                                            </Template>
                                        </RadzenDataGridColumn>
                                        <RadzenDataGridColumn TItem="ProjectionReplayStatus" Property="CompletedAt" Title="@T("columns.completed-at")">
                                            <Template Context="replay">
                                                @(replay.CompletedAt?.ToLocalTime().ToString("g") ?? T("labels.not-available"))
                                            </Template>
                                        </RadzenDataGridColumn>
                                        <RadzenDataGridColumn TItem="ProjectionReplayStatus" Property="InitiatedBy" Title="@T("columns.initiated-by")" />
                                        <RadzenDataGridColumn TItem="ProjectionReplayStatus" Property="Reason" Title="@T("columns.reason")">
                                            <Template Context="replay">
                                                <RadzenText TextStyle="TextStyle.Caption">@replay.Reason</RadzenText>
                                            </Template>
                                        </RadzenDataGridColumn>
                                    </Columns>
                                </RadzenDataGrid>
                            }
                        </RadzenTabsItem>
                    </Tabs>
                </RadzenTabs>
    </ChildContent>
</PageLayout>
    </Authorized>
    <NotAuthorized>
        <AccessDeniedComponent RequiredRole="Admin" PageName="@T("pages.projection-replay-administration")" />
    </NotAuthorized>
</AuthorizeView>

@code {
    private List<ProjectionReplayStatus> allReplays = new();
    private List<ProjectionInfo> availableProjections = new();
    private bool isLoading = true;
    private System.Threading.Timer? pollingTimer;

    private List<ProjectionReplayStatus> activeReplays => allReplays
        .Where(r => r.Status != "Completed" && r.Status != "Failed" && r.Status != "Cancelled")
        .ToList();

    private List<ProjectionReplayStatus> completedReplays => allReplays
        .Where(r => r.Status == "Completed" || r.Status == "Failed" || r.Status == "Cancelled")
        .ToList();

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await LoadData();
        StartPolling();
    }

    private async Task LoadData()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            allReplays = await ReplayService.GetReplayHistoryAsync(100);
            availableProjections = await ReplayService.GetAvailableProjectionsAsync();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = T("notifications.error"),
                Detail = $"{T("messages.failed-to-load-data")}: {ex.Message}",
                Duration = 4000
            });
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void StartPolling()
    {
        pollingTimer = new System.Threading.Timer(async _ =>
        {
            if (activeReplays.Any())
            {
                await InvokeAsync(async () =>
                {
                    allReplays = await ReplayService.GetReplayHistoryAsync(100);
                    StateHasChanged();
                });
            }
        }, null, TimeSpan.FromSeconds(2), TimeSpan.FromSeconds(2));
    }

    private async Task ShowStartReplayDialog()
    {
        var result = await DialogService.OpenAsync<StartReplayDialog>(T("dialogs.start-projection-replay"),
            new Dictionary<string, object> { { "Projections", availableProjections } },
            new DialogOptions { Width = "600px", Resizable = true });

        if (result is StartProjectionReplayRequestDto request)
        {
            await StartReplay(request);
        }
    }

    private async Task StartReplay(StartProjectionReplayRequestDto request)
    {
        try
        {
            var replayId = await ReplayService.StartReplayAsync(request);

            if (replayId.HasValue)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = T("notifications.replay-started"),
                    Detail = $"{T("messages.projection-replay-started")} {request.ProjectionName}",
                    Duration = 4000
                });

                await LoadData();
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = T("notifications.error"),
                    Detail = T("messages.failed-to-start-replay"),
                    Duration = 4000
                });
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = T("notifications.error"),
                Detail = $"{T("messages.failed-to-start-replay")}: {ex.Message}",
                Duration = 4000
            });
        }
    }

    private async Task CancelReplay(Guid replayId)
    {
        var confirmed = await DialogService.Confirm(T("dialogs.confirm-cancel-replay"), T("dialogs.cancel-replay"),
            new ConfirmOptions { OkButtonText = T("buttons.yes"), CancelButtonText = T("buttons.no") });

        if (confirmed == true)
        {
            var success = await ReplayService.CancelReplayAsync(replayId);

            if (success)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = T("notifications.cancelled"),
                    Detail = T("messages.projection-replay-cancelled"),
                    Duration = 4000
                });

                await LoadData();
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = T("notifications.error"),
                    Detail = T("messages.failed-to-cancel-replay"),
                    Duration = 4000
                });
            }
        }
    }

    private BadgeStyle GetStatusBadgeStyle(string status) => status switch
    {
        "Pending" => BadgeStyle.Secondary,
        "Validating" => BadgeStyle.Info,
        "DeletingSnapshots" => BadgeStyle.Warning,
        "Replaying" => BadgeStyle.Info,
        "Completed" => BadgeStyle.Success,
        "Failed" => BadgeStyle.Danger,
        "Cancelled" => BadgeStyle.Warning,
        _ => BadgeStyle.Light
    };

    private string GetDuration(DateTime startedAt)
    {
        var duration = DateTime.UtcNow - startedAt;
        if (duration.TotalMinutes < 1) return $"{(int)duration.TotalSeconds}s";
        if (duration.TotalHours < 1) return $"{(int)duration.TotalMinutes}m {duration.Seconds}s";
        return $"{(int)duration.TotalHours}h {duration.Minutes}m";
    }

    public override void Dispose()
    {
        pollingTimer?.Dispose();
        base.Dispose();
    }
}
