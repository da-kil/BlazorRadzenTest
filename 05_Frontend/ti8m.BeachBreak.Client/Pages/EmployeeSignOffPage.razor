@page "/questionnaire/{AssignmentId:guid}/sign-off"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@using Radzen
@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Components
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Models.DTOs
@using ti8m.BeachBreak.Client.Services
@using ti8m.BeachBreak.Client.Layout
@using Microsoft.AspNetCore.Components.Authorization
@using ti8m.BeachBreak.Client.Extensions
@using ti8m.BeachBreak.Client.Components.Shared
@using ti8m.BeachBreak.Client.Components.WorkflowPages
@inject NavigationManager NavigationManager
@inject IQuestionnaireAssignmentService AssignmentService
@inject IQuestionnaireTemplateService TemplateService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IAuthService AuthService
@inherits OptimizedTranslatableComponentBase

<PageTitle>@(template?.GetLocalizedNameWithFallback(CurrentLanguage) ?? T("pages.employee-sign-off-title"))</PageTitle>

@if (isLoading)
{
    <div class="text-center p-5">
        <RadzenProgressBarCircular ProgressBarStyle="ProgressBarStyle.Primary" Value="100" ShowValue="false" Class="mb-3" />
        <RadzenText TextStyle="TextStyle.Body1" Class="text-muted">@T("messages.loading-sign-off-page")</RadzenText>
    </div>
}
else if (assignment == null || template == null)
{
    <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat">
        <RadzenText TextStyle="TextStyle.Body1">@T("messages.unable-to-load-questionnaire-data")</RadzenText>
    </RadzenAlert>
}
else if (!CanSignOffReview())
{
    <RadzenAlert AlertStyle="AlertStyle.Warning" Variant="Variant.Flat">
        <RadzenText TextStyle="TextStyle.Body1">
            @T("messages.sign-off-not-allowed")
        </RadzenText>
    </RadzenAlert>
}
else
{
    <PageLayout Title="@T("pages.employee-sign-off-title")"
                Description="@string.Format(T("pages.confirm-review-discussion"), template.GetLocalizedNameWithFallback(CurrentLanguage))"
                ShowDefaultFooter="false">
        <ChildContent>
            <!-- Back Navigation -->
            <div class="back-navigation mb-4">
                <RadzenLink Path="@GetReturnUrl()" Text="@T("navigation.back-to-questionnaire")" Icon="arrow_back" />
            </div>

            <!-- Critical Notice at Top -->
            <div class="critical-notice mb-4">
                <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter" ShowIcon="true">
                    <RadzenText TextStyle="TextStyle.Body2">
                        <strong>@T("labels.important"):</strong>
                        <span> @T("messages.sign-off-notice")</span>
                    </RadzenText>
                </RadzenAlert>
            </div>

            <!-- Review Outcome Display -->
            <ReviewOutcomeCard Assignment="@assignment" Template="@template" />

            <!-- Employee Sign-Off Form -->
            <div class="sign-off-section mt-4">
                <EmployeeSignOffForm
                    ExistingEmployeeComments="@assignment.EmployeeReviewComments"
                    IsSubmitting="@isSubmitting"
                    OnSubmit="@HandleSignOff"
                    OnCancel="@HandleCancel" />
            </div>

        </ChildContent>
    </PageLayout>
}

@code {
    [Parameter] public Guid AssignmentId { get; set; }

    private QuestionnaireAssignment? assignment;
    private QuestionnaireTemplate? template;
    private bool isLoading = true;
    private bool isSubmitting = false;
    private string currentUserName = string.Empty;
    private ApplicationRole currentUserRole = ApplicationRole.Employee;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await InitializeUserContext();
        await LoadData();
    }

    private async Task InitializeUserContext()
    {
        try
        {
            var roleData = await AuthService.GetMyRoleAsync();
            if (roleData != null)
            {
                currentUserRole = roleData.ApplicationRole;
            }

            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            currentUserName = authState.User.Identity?.Name ?? T("labels.unknown-employee");
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, T("notifications.error"), $"{T("messages.failed-to-get-user-info")}: {ex.Message}");
            currentUserRole = ApplicationRole.Employee;
        }
    }

    private async Task LoadData()
    {
        try
        {
            isLoading = true;

            // Load assignment using employee endpoint to avoid authorization issues
            assignment = await AssignmentService.GetMyAssignmentByIdAsync(AssignmentId);
            if (assignment == null)
            {
                NotificationService.Notify(NotificationSeverity.Error, T("notifications.error"), T("messages.assignment-not-found"));
                NavigateBack();
                return;
            }

            // Load template
            template = await TemplateService.GetTemplateByIdAsync(assignment.TemplateId);
            if (template == null)
            {
                NotificationService.Notify(NotificationSeverity.Error, T("notifications.error"), T("messages.template-not-found"));
                NavigateBack();
                return;
            }

            // Validate user can sign off this review
            if (!CanSignOffReview())
            {
                NotificationService.Notify(NotificationSeverity.Warning, T("notifications.access-denied"),
                    T("messages.sign-off-permission-denied"));
                NavigateBack();
                return;
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, T("notifications.error"), $"{T("messages.failed-to-load-data")}: {ex.Message}");
            NavigateBack();
        }
        finally
        {
            isLoading = false;
        }
    }

    private bool CanSignOffReview()
    {
        // Employee can sign off when review is confirmed by manager
        return assignment != null &&
               assignment.WorkflowState == WorkflowState.ReviewFinished;
    }

    private async Task HandleSignOff(string? comments)
    {
        if (assignment == null || isSubmitting)
            return;

        try
        {
            isSubmitting = true;
            StateHasChanged();

            var success = await AssignmentService.ConfirmEmployeeReviewAsync(
                assignment.Id,
                currentUserName,
                comments);

            if (success)
            {
                NotificationService.Notify(NotificationSeverity.Success, T("notifications.success"),
                    T("messages.review-signed-off-successfully"));

                // Navigate back to the questionnaire
                NavigateToQuestionnaire();
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, T("notifications.error"),
                    T("messages.failed-to-sign-off-review"));
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, T("notifications.error"),
                $"{T("messages.error-signing-off-review")}: {ex.Message}");
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private void HandleCancel()
    {
        NavigateBack();
    }

    private void NavigateBack()
    {
        var returnUrl = GetReturnUrl();
        NavigationManager.NavigateTo(returnUrl);
    }

    private void NavigateToQuestionnaire()
    {
        NavigationManager.NavigateTo($"/questionnaire/{AssignmentId}");
    }

    private string GetReturnUrl()
    {
        // Return to the main questionnaire page
        return $"/questionnaire/{AssignmentId}";
    }
}