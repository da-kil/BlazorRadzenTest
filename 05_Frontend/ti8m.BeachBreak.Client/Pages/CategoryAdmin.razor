@page "/admin/categories"
@using Microsoft.AspNetCore.Components.Authorization
@using Radzen
@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Services
@using ti8m.BeachBreak.Client.Components
@using ti8m.BeachBreak.Client.Components.Shared
@using ti8m.BeachBreak.Client.Layout
@inject ICategoryApiService CategoryService
@inject DialogService DialogService
@inject NotificationService NotificationService
@inherits OptimizedComponentBase

<PageTitle>Questionnaire Type Administration</PageTitle>

<AuthorizeView Policy="HR">
    <Authorized>
        <PageLayout
                   Title="Questionnaire Type Administration"
                   Description="Manage questionnaire types (e.g., Annual Reviews, Quarterly Check-ins)">
    <HeaderActions>
        <AsyncButton Text="Add New Type"
                     ButtonStyle="ButtonStyle.Primary"
                     Icon="add"
                     Click="@ShowAddCategoryDialog" />
    </HeaderActions>
    <ChildContent>

                <div class="mb-3 d-flex justify-content-between">
                    <RadzenTextBox @bind-Value="@searchText"
                                   Placeholder="Search types..."
                                   @oninput="@OnSearchTextChanged" />
                    <RadzenToggleButton @bind-Value="@showInactiveCategories"
                                        Text="Show Inactive"
                                        Change="@LoadCategories" />
                </div>

                <RadzenDataGrid @ref="categoriesGrid" Data="@filteredCategories" TItem="Category"
                                AllowFiltering="true" AllowColumnResize="true" AllowSorting="true"
                                EditMode="DataGridEditMode.Single" AllowAlternatingRows="false">
                    <Columns>
                        <RadzenDataGridColumn TItem="Category" Property="NameEn" Title="Name EN" Width="200px">
                            <Template Context="category">
                                <RadzenText TextStyle="TextStyle.Body1">@category.NameEn</RadzenText>
                            </Template>
                            <EditTemplate Context="category">
                                <RadzenTextBox @bind-Value="category.NameEn" Placeholder="Enter English name" Class="w-100" />
                            </EditTemplate>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="Category" Property="NameDe" Title="Name DE" Width="200px">
                            <Template Context="category">
                                <RadzenText TextStyle="TextStyle.Body1">@category.NameDe</RadzenText>
                            </Template>
                            <EditTemplate Context="category">
                                <RadzenTextBox @bind-Value="category.NameDe" Placeholder="Deutschen Namen eingeben" Class="w-100" />
                            </EditTemplate>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="Category" Property="DescriptionEn" Title="Description EN" Width="250px">
                            <Template Context="category">
                                <RadzenText TextStyle="TextStyle.Body2">@category.DescriptionEn</RadzenText>
                            </Template>
                            <EditTemplate Context="category">
                                <RadzenTextArea @bind-Value="category.DescriptionEn" Placeholder="Enter English description (optional)" Rows="2" Class="w-100" />
                            </EditTemplate>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="Category" Property="DescriptionDe" Title="Description DE" Width="250px">
                            <Template Context="category">
                                <RadzenText TextStyle="TextStyle.Body2">@category.DescriptionDe</RadzenText>
                            </Template>
                            <EditTemplate Context="category">
                                <RadzenTextArea @bind-Value="category.DescriptionDe" Placeholder="Deutsche Beschreibung eingeben (optional)" Rows="2" Class="w-100" />
                            </EditTemplate>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="Category" Property="SortOrder" Title="Sort Order" Width="120px">
                            <Template Context="category">
                                <RadzenBadge Text="@category.SortOrder.ToString()" Variant="Variant.Outlined" />
                            </Template>
                            <EditTemplate Context="category">
                                <RadzenNumeric @bind-Value="category.SortOrder" TValue="int" Class="w-100" Min="0" Max="1000" />
                            </EditTemplate>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="Category" Property="IsActive" Title="Status" Width="120px">
                            <Template Context="category">
                                @if (category.IsActive)
                                {
                                    <RadzenBadge Text="Active" BadgeStyle="BadgeStyle.Success" />
                                }
                                else
                                {
                                    <RadzenBadge Text="Inactive" BadgeStyle="BadgeStyle.Secondary" />
                                }
                            </Template>
                            <EditTemplate Context="category">
                                <RadzenSwitch @bind-Value="category.IsActive" />
                            </EditTemplate>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="Category" Property="CreatedDate" Title="Created" Width="150px">
                            <Template Context="category">
                                <RadzenText TextStyle="TextStyle.Caption">@category.CreatedDate.ToString("MMM dd, yyyy")</RadzenText>
                            </Template>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="Category" Filterable="false" Sortable="false" Width="180px" Title="Actions">
                            <Template Context="category">
                                <div class="d-flex gap-1">
                                    <AsyncButton ButtonStyle="ButtonStyle.Light"
                                                 Icon="edit"
                                                 Size="ButtonSize.ExtraSmall"
                                                 Click="@(() => EditRow(category))"
                                                 Tooltip="Edit Category" />
                                    <AsyncButton ButtonStyle="ButtonStyle.Danger"
                                                 ProcessingText="Deleting"
                                                 Icon="delete"
                                                 Size="ButtonSize.ExtraSmall"
                                                 Click="@(() => DeleteCategory(category))"
                                                 Tooltip="Delete Category" />
                                </div>
                            </Template>
                            <EditTemplate Context="category">
                                <div class="d-flex gap-1">
                                    <AsyncButton ButtonStyle="ButtonStyle.Success"
                                                 ProcessingText="Saving"
                                                 Icon="save"
                                                 Size="ButtonSize.ExtraSmall"
                                                 Click="@(() => SaveRow(category))"
                                                 Tooltip="Save Changes" />
                                    <AsyncButton ButtonStyle="ButtonStyle.Secondary"
                                                 Icon="cancel"
                                                 Size="ButtonSize.ExtraSmall"
                                                 Click="@(() => CancelEdit(category))"
                                                 Tooltip="Cancel Edit" />
                                </div>
                            </EditTemplate>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
    </ChildContent>
</PageLayout>
    </Authorized>
    <NotAuthorized>
        <AccessDeniedComponent RequiredRole="HR" PageName="Questionnaire Type Administration" />
    </NotAuthorized>
</AuthorizeView>

@code {

    private List<Category> categories = new();
    private List<Category> filteredCategories = new();
    private RadzenDataGrid<Category>? categoriesGrid;
    private string searchText = "";
    private bool showInactiveCategories = false;
    private Category? categoryBeingEdited;
    private HashSet<Guid> newCategoryIds = new(); // Track IDs of newly created categories

    protected override async Task OnInitializedAsync()
    {
        await ExecuteSafelyAsync(async () =>
        {
            await LoadCategories();
        }, "InitializeCategoryAdmin");
    }

    protected override bool HasStateChanged()
    {
        return HasParameterChanged(nameof(categories), categories.Count) ||
               HasParameterChanged(nameof(searchText), searchText) ||
               HasParameterChanged(nameof(showInactiveCategories), showInactiveCategories);
    }

    private async Task LoadCategories()
    {
        try
        {
            categories = await CategoryService.GetAllCategoriesAsync(showInactiveCategories);
            FilterCategories();
            NotifyStateChanged();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load categories: {ex.Message}");
        }
    }

    private void OnSearchTextChanged(ChangeEventArgs e)
    {
        searchText = e.Value?.ToString() ?? "";
        FilterCategories();
    }

    private void FilterCategories()
    {
        filteredCategories = categories
            .Where(c => string.IsNullOrEmpty(searchText) ||
                       c.NameEn.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                       c.NameDe.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                       c.DescriptionEn.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                       c.DescriptionDe.Contains(searchText, StringComparison.OrdinalIgnoreCase))
            .OrderBy(c => c.SortOrder)
            .ThenBy(c => c.NameEn)
            .ToList();

        InvokeAsync(StateHasChanged);
    }

    private async Task ShowAddCategoryDialog()
    {
        var newCategory = new Category
        {
            Id = Guid.NewGuid(),
            NameEn = "",
            NameDe = "",
            DescriptionEn = "",
            DescriptionDe = "",
            IsActive = true,
            SortOrder = categories.Count > 0 ? categories.Max(c => c.SortOrder) + 10 : 10,
            CreatedDate = DateTime.Now
        };

        // Track this as a new category
        newCategoryIds.Add(newCategory.Id);

        // Add to local collections without API call
        categories.Add(newCategory);
        FilterCategories();

        // Immediately put the new category in edit mode
        await EditRow(newCategory);
    }

    private async Task EditRow(Category category)
    {
        // Store original values for cancel functionality
        categoryBeingEdited = new Category
        {
            Id = category.Id,
            NameEn = category.NameEn,
            NameDe = category.NameDe,
            DescriptionEn = category.DescriptionEn,
            DescriptionDe = category.DescriptionDe,
            IsActive = category.IsActive,
            SortOrder = category.SortOrder,
            CreatedDate = category.CreatedDate,
            LastModified = category.LastModified
        };

        categoriesGrid!.EditRow(category);
        await Task.CompletedTask;
    }

    private async Task SaveRow(Category category)
    {
        try
        {
            category.LastModified = DateTime.Now;

            // Check if this is a new category using the tracked IDs
            bool isNewCategory = newCategoryIds.Contains(category.Id);

            if (isNewCategory)
            {
                // Create new category
                await CategoryService.CreateCategoryAsync(category);
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Category created successfully");

                // Remove from new category tracking
                newCategoryIds.Remove(category.Id);

                // Reload categories to get the actual data from API
                await LoadCategories();
            }
            else
            {
                // Update existing category
                await CategoryService.UpdateCategoryAsync(category);
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Category updated successfully");
                await categoriesGrid!.UpdateRow(category);
            }

            categoryBeingEdited = null;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to save category: {ex.Message}");
        }
    }

    private async Task CancelEdit(Category category)
    {
        if (categoryBeingEdited != null)
        {
            // Check if this is a new category using tracked IDs
            bool isNewCategory = newCategoryIds.Contains(category.Id);

            if (isNewCategory)
            {
                // Remove from tracking set
                newCategoryIds.Remove(category.Id);

                // Remove the new category from local collections
                categories.Remove(category);
                FilterCategories();
                categoriesGrid!.CancelEditRow(category);
            }
            else
            {
                // Restore original values for existing categories
                category.NameEn = categoryBeingEdited.NameEn;
                category.NameDe = categoryBeingEdited.NameDe;
                category.DescriptionEn = categoryBeingEdited.DescriptionEn;
                category.DescriptionDe = categoryBeingEdited.DescriptionDe;
                category.IsActive = categoryBeingEdited.IsActive;
                category.SortOrder = categoryBeingEdited.SortOrder;
                categoriesGrid!.CancelEditRow(category);
            }
        }

        categoryBeingEdited = null;
        await Task.CompletedTask;
    }

    private async Task DeleteCategory(Category category)
    {
        var result = await DialogService.Confirm($"Are you sure you want to delete the category '{category.NameEn}'?",
            "Delete Category", new ConfirmOptions() { OkButtonText = "Delete", CancelButtonText = "Cancel" });

        if (result == true)
        {
            try
            {
                var success = await CategoryService.DeleteCategoryAsync(category.Id);
                if (success)
                {
                    NotificationService.Notify(NotificationSeverity.Success, "Success", "Category deleted successfully");
                    await LoadCategories();
                }
                else
                {
                    NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to delete category");
                }
            }
            catch (Exception ex)
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to delete category: {ex.Message}");
            }
        }
    }
}