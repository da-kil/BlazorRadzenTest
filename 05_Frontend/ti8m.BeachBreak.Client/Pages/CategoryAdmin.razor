@page "/admin/categories"
@using Microsoft.AspNetCore.Components.Authorization
@using Radzen
@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Services
@using ti8m.BeachBreak.Client.Components
@using ti8m.BeachBreak.Client.Components.Shared
@using ti8m.BeachBreak.Client.Layout
@inject ICategoryApiService CategoryService
@inject DialogService DialogService
@inherits OptimizedTranslatableComponentBase

<PageTitle>@T("pages.questionnaire-type-administration")</PageTitle>

<AuthorizeView Policy="HR">
    <Authorized>
        <PageLayout
                   Title="@T("pages.questionnaire-type-administration")"
                   Description="@T("pages.questionnaire-type-administration-description")">
    <HeaderActions>
        <AsyncButton Text="@T("buttons.add-new-type")"
                     ButtonStyle="ButtonStyle.Primary"
                     Icon="add"
                     Click="@ShowAddCategoryDialog" />
    </HeaderActions>
    <ChildContent>

                <div class="mb-3 d-flex justify-content-between">
                    <RadzenTextBox @bind-Value="@searchText"
                                   Placeholder="@T("filters.search-types")"
                                   @oninput="@OnSearchTextChanged" />
                    <RadzenToggleButton @bind-Value="@showInactiveCategories"
                                        Text="@T("filters.show-inactive")"
                                        Change="@LoadCategories" />
                </div>

                <RadzenDataGrid @ref="categoriesGrid" Data="@filteredCategories" TItem="Category"
                                AllowFiltering="true" AllowColumnResize="true" AllowSorting="true"
                                EditMode="DataGridEditMode.Single" AllowAlternatingRows="false">
                    <Columns>
                        <RadzenDataGridColumn TItem="Category" Property="NameEn" Title="@T("columns.name-en")" Width="200px">
                            <Template Context="category">
                                <RadzenText TextStyle="TextStyle.Body1">@category.NameEn</RadzenText>
                            </Template>
                            <EditTemplate Context="category">
                                <RadzenTextBox @bind-Value="category.NameEn" Placeholder="@T("placeholders.enter-english-name")" Class="w-100" />
                            </EditTemplate>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="Category" Property="NameDe" Title="@T("columns.name-de")" Width="200px">
                            <Template Context="category">
                                <RadzenText TextStyle="TextStyle.Body1">@category.NameDe</RadzenText>
                            </Template>
                            <EditTemplate Context="category">
                                <RadzenTextBox @bind-Value="category.NameDe" Placeholder="@T("placeholders.enter-german-name")" Class="w-100" />
                            </EditTemplate>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="Category" Property="DescriptionEn" Title="@T("columns.description-en")" Width="250px">
                            <Template Context="category">
                                <RadzenText TextStyle="TextStyle.Body2">@category.DescriptionEn</RadzenText>
                            </Template>
                            <EditTemplate Context="category">
                                <RadzenTextArea @bind-Value="category.DescriptionEn" Placeholder="@T("placeholders.enter-english-description")" Rows="2" Class="w-100" />
                            </EditTemplate>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="Category" Property="DescriptionDe" Title="@T("columns.description-de")" Width="250px">
                            <Template Context="category">
                                <RadzenText TextStyle="TextStyle.Body2">@category.DescriptionDe</RadzenText>
                            </Template>
                            <EditTemplate Context="category">
                                <RadzenTextArea @bind-Value="category.DescriptionDe" Placeholder="@T("placeholders.enter-german-description")" Rows="2" Class="w-100" />
                            </EditTemplate>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="Category" Property="SortOrder" Title="@T("columns.sort-order")" Width="120px">
                            <Template Context="category">
                                <RadzenBadge Text="@category.SortOrder.ToString()" Variant="Variant.Outlined" />
                            </Template>
                            <EditTemplate Context="category">
                                <RadzenNumeric @bind-Value="category.SortOrder" TValue="int" Class="w-100" Min="0" Max="1000" />
                            </EditTemplate>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="Category" Property="IsActive" Title="@T("columns.status")" Width="120px">
                            <Template Context="category">
                                @if (category.IsActive)
                                {
                                    <RadzenBadge Text="@T("status.active")" BadgeStyle="BadgeStyle.Success" />
                                }
                                else
                                {
                                    <RadzenBadge Text="@T("status.inactive")" BadgeStyle="BadgeStyle.Secondary" />
                                }
                            </Template>
                            <EditTemplate Context="category">
                                <RadzenSwitch @bind-Value="category.IsActive" />
                            </EditTemplate>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="Category" Property="CreatedDate" Title="@T("columns.created")" Width="150px">
                            <Template Context="category">
                                <RadzenText TextStyle="TextStyle.Caption">@category.CreatedDate.ToString("MMM dd, yyyy")</RadzenText>
                            </Template>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="Category" Filterable="false" Sortable="false" Width="180px" Title="@T("columns.actions")">
                            <Template Context="category">
                                <div class="d-flex gap-1">
                                    <AsyncButton ButtonStyle="ButtonStyle.Light"
                                                 Icon="edit"
                                                 Size="ButtonSize.ExtraSmall"
                                                 Click="@(() => EditRow(category))"
                                                 Tooltip="@T("tooltips.edit-category")" />
                                    <AsyncButton ButtonStyle="ButtonStyle.Danger"
                                                 ProcessingText="@T("buttons.deleting")"
                                                 Icon="delete"
                                                 Size="ButtonSize.ExtraSmall"
                                                 Click="@(() => DeleteCategory(category))"
                                                 Tooltip="@T("tooltips.delete-category")" />
                                </div>
                            </Template>
                            <EditTemplate Context="category">
                                <div class="d-flex gap-1">
                                    <AsyncButton ButtonStyle="ButtonStyle.Success"
                                                 ProcessingText="@T("buttons.saving")"
                                                 Icon="save"
                                                 Size="ButtonSize.ExtraSmall"
                                                 Click="@(() => SaveRow(category))"
                                                 Tooltip="@T("tooltips.save-changes")" />
                                    <AsyncButton ButtonStyle="ButtonStyle.Secondary"
                                                 Icon="cancel"
                                                 Size="ButtonSize.ExtraSmall"
                                                 Click="@(() => CancelEdit(category))"
                                                 Tooltip="@T("tooltips.cancel-edit")" />
                                </div>
                            </EditTemplate>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
    </ChildContent>
</PageLayout>
    </Authorized>
    <NotAuthorized>
        <AccessDeniedComponent RequiredRole="HR" PageName="@T("pages.questionnaire-type-administration")" />
    </NotAuthorized>
</AuthorizeView>

@code {

    private List<Category> categories = new();
    private List<Category> filteredCategories = new();
    private RadzenDataGrid<Category>? categoriesGrid;
    private string searchText = "";
    private bool showInactiveCategories = false;
    private Category? categoryBeingEdited;
    private HashSet<Guid> newCategoryIds = new(); // Track IDs of newly created categories

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await ExecuteSafelyAsync(async () =>
        {
            await LoadCategories();
        }, "InitializeCategoryAdmin");
    }

    protected override bool HasStateChanged()
    {
        return HasParameterChanged(nameof(categories), categories.Count) ||
               HasParameterChanged(nameof(searchText), searchText) ||
               HasParameterChanged(nameof(showInactiveCategories), showInactiveCategories);
    }

    private async Task LoadCategories()
    {
        try
        {
            categories = await CategoryService.GetAllCategoriesAsync(showInactiveCategories);
            FilterCategories();
            NotifyStateChanged();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, T("notifications.error"), $"{T("notifications.failed-to-load-categories")}: {ex.Message}");
        }
    }

    private void OnSearchTextChanged(ChangeEventArgs e)
    {
        searchText = e.Value?.ToString() ?? "";
        FilterCategories();
    }

    private void FilterCategories()
    {
        filteredCategories = categories
            .Where(c => string.IsNullOrEmpty(searchText) ||
                       c.NameEn.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                       c.NameDe.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                       c.DescriptionEn.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                       c.DescriptionDe.Contains(searchText, StringComparison.OrdinalIgnoreCase))
            .OrderBy(c => c.SortOrder)
            .ThenBy(c => c.NameEn)
            .ToList();

        InvokeAsync(StateHasChanged);
    }

    private async Task ShowAddCategoryDialog()
    {
        var newCategory = new Category
        {
            Id = Guid.NewGuid(),
            NameEn = "",
            NameDe = "",
            DescriptionEn = "",
            DescriptionDe = "",
            IsActive = true,
            SortOrder = categories.Count > 0 ? categories.Max(c => c.SortOrder) + 10 : 10,
            CreatedDate = DateTime.Now
        };

        // Track this as a new category
        newCategoryIds.Add(newCategory.Id);

        // Add to local collections without API call
        categories.Add(newCategory);
        FilterCategories();

        // Immediately put the new category in edit mode
        await EditRow(newCategory);
    }

    private async Task EditRow(Category category)
    {
        // Store original values for cancel functionality
        categoryBeingEdited = new Category
        {
            Id = category.Id,
            NameEn = category.NameEn,
            NameDe = category.NameDe,
            DescriptionEn = category.DescriptionEn,
            DescriptionDe = category.DescriptionDe,
            IsActive = category.IsActive,
            SortOrder = category.SortOrder,
            CreatedDate = category.CreatedDate,
            LastModified = category.LastModified
        };

        categoriesGrid!.EditRow(category);
        await Task.CompletedTask;
    }

    private async Task SaveRow(Category category)
    {
        try
        {
            category.LastModified = DateTime.Now;

            // Check if this is a new category using the tracked IDs
            bool isNewCategory = newCategoryIds.Contains(category.Id);

            if (isNewCategory)
            {
                // Create new category
                await CategoryService.CreateCategoryAsync(category);
                NotificationService.Notify(NotificationSeverity.Success, T("notifications.success"), T("notifications.category-created-successfully"));

                // Remove from new category tracking
                newCategoryIds.Remove(category.Id);

                // Reload categories to get the actual data from API
                await LoadCategories();
            }
            else
            {
                // Update existing category
                await CategoryService.UpdateCategoryAsync(category);
                NotificationService.Notify(NotificationSeverity.Success, T("notifications.success"), T("notifications.category-updated-successfully"));
                await categoriesGrid!.UpdateRow(category);
            }

            categoryBeingEdited = null;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, T("notifications.error"), $"{T("notifications.failed-to-save-category")}: {ex.Message}");
        }
    }

    private async Task CancelEdit(Category category)
    {
        if (categoryBeingEdited != null)
        {
            // Check if this is a new category using tracked IDs
            bool isNewCategory = newCategoryIds.Contains(category.Id);

            if (isNewCategory)
            {
                // Remove from tracking set
                newCategoryIds.Remove(category.Id);

                // Remove the new category from local collections
                categories.Remove(category);
                FilterCategories();
                categoriesGrid!.CancelEditRow(category);
            }
            else
            {
                // Restore original values for existing categories
                category.NameEn = categoryBeingEdited.NameEn;
                category.NameDe = categoryBeingEdited.NameDe;
                category.DescriptionEn = categoryBeingEdited.DescriptionEn;
                category.DescriptionDe = categoryBeingEdited.DescriptionDe;
                category.IsActive = categoryBeingEdited.IsActive;
                category.SortOrder = categoryBeingEdited.SortOrder;
                categoriesGrid!.CancelEditRow(category);
            }
        }

        categoryBeingEdited = null;
        await Task.CompletedTask;
    }

    private async Task DeleteCategory(Category category)
    {
        var result = await DialogService.Confirm($"{T("dialogs.confirm-delete-category")} '{category.NameEn}'?",
            T("dialogs.delete-category"), new ConfirmOptions() { OkButtonText = T("buttons.delete"), CancelButtonText = T("buttons.cancel") });

        if (result == true)
        {
            try
            {
                var success = await CategoryService.DeleteCategoryAsync(category.Id);
                if (success)
                {
                    NotificationService.Notify(NotificationSeverity.Success, T("notifications.success"), T("notifications.category-deleted-successfully"));
                    await LoadCategories();
                }
                else
                {
                    NotificationService.Notify(NotificationSeverity.Error, T("notifications.error"), T("notifications.failed-to-delete-category"));
                }
            }
            catch (Exception ex)
            {
                NotificationService.Notify(NotificationSeverity.Error, T("notifications.error"), $"{T("notifications.failed-to-delete-category")}: {ex.Message}");
            }
        }
    }
}