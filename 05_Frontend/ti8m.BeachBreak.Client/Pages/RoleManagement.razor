@page "/admin/roles"
@using Microsoft.AspNetCore.Components.Authorization
@using Radzen
@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Services
@using ti8m.BeachBreak.Client.Components.Shared
@using ti8m.BeachBreak.Client.Layout
@using ti8m.BeachBreak.Client.Models
@inject IEmployeeApiService EmployeeService
@inject DialogService DialogService
@inject NotificationService NotificationService
@inherits OptimizedTranslatableComponentBase

<PageTitle>Role Management</PageTitle>

<AuthorizeView Policy="HR">
    <Authorized>
        <PageLayout Type="LayoutType.Standard"
                   Title="Application Role Management"
                   Description="Manage employee application roles">
            <ChildContent>

                            <div class="mb-3 d-flex justify-content-between align-items-center gap-2">
                                <RadzenTextBox @bind-Value="@searchText"
                                               Placeholder="@T("filters.search-employees")"
                                               @oninput="@OnSearchTextChanged"
                                               Style="width: 300px;" />
                                <RadzenText TextStyle="TextStyle.Body2" Class="text-muted">
                                    Showing @filteredEmployees.Count employees
                                </RadzenText>
                            </div>

                            @if (filteredEmployees.Count == 0)
                            {
                                <RadzenText TextStyle="TextStyle.Body1" Class="text-muted">No employees found.</RadzenText>
                            }
                            else
                            {
                                <RadzenDataGrid @ref="employeesGrid"
                                                Data="@filteredEmployees"
                                                TItem="EmployeeDto"
                                                AllowFiltering="true"
                                                AllowColumnResize="true"
                                                AllowSorting="true"
                                                EditMode="DataGridEditMode.Single"
                                                RowUpdate="@OnUpdateRow"
                                                AllowAlternatingRows="false">
                                    <Columns>
                                        <RadzenDataGridColumn TItem="EmployeeDto" Property="FirstName" Title="@T("columns.first-name")" Width="150px" Sortable="true" Filterable="true">
                                            <Template Context="employee">
                                                <RadzenText TextStyle="TextStyle.Body1">@employee.FirstName</RadzenText>
                                            </Template>
                                        </RadzenDataGridColumn>

                                        <RadzenDataGridColumn TItem="EmployeeDto" Property="LastName" Title="@T("columns.last-name")" Width="150px" Sortable="true" Filterable="true">
                                            <Template Context="employee">
                                                <RadzenText TextStyle="TextStyle.Body1">@employee.LastName</RadzenText>
                                            </Template>
                                        </RadzenDataGridColumn>

                                        <RadzenDataGridColumn TItem="EmployeeDto" Property="Role" Title="@T("columns.job-role")" Width="200px" Sortable="true" Filterable="true">
                                            <Template Context="employee">
                                                <RadzenText TextStyle="TextStyle.Body2" Class="text-muted">@employee.Role</RadzenText>
                                            </Template>
                                        </RadzenDataGridColumn>

                                        <RadzenDataGridColumn TItem="EmployeeDto" Property="Organization" Title="@T("columns.organization")" Width="200px" Sortable="true" Filterable="true">
                                            <Template Context="employee">
                                                <RadzenText TextStyle="TextStyle.Body2">@employee.Organization</RadzenText>
                                            </Template>
                                        </RadzenDataGridColumn>

                                        <RadzenDataGridColumn TItem="EmployeeDto" Property="ApplicationRole" Title="@T("columns.application-role")" Width="180px" Sortable="true" Filterable="true">
                                            <Template Context="employee">
                                                @{
                                                    var badgeStyle = employee.ApplicationRole switch
                                                    {
                                                        ApplicationRole.Admin => BadgeStyle.Danger,
                                                        ApplicationRole.HRLead => BadgeStyle.Warning,
                                                        ApplicationRole.HR => BadgeStyle.Info,
                                                        ApplicationRole.TeamLead => BadgeStyle.Success,
                                                        _ => BadgeStyle.Light
                                                    };
                                                }
                                                <RadzenBadge Text="@employee.ApplicationRole.ToString()" BadgeStyle="@badgeStyle" />
                                            </Template>
                                            <EditTemplate Context="employee">
                                                <RadzenDropDown @bind-Value="employee.ApplicationRole"
                                                                Data="@GetAvailableRoles()"
                                                                TValue="ApplicationRole"
                                                                Class="w-100" />
                                            </EditTemplate>
                                        </RadzenDataGridColumn>

                                        <RadzenDataGridColumn TItem="EmployeeDto" Context="employee" Filterable="false" Sortable="false" Width="160px" TextAlign="TextAlign.Right">
                                            <Template Context="employee">
                                                <RadzenButton Icon="edit"
                                                              ButtonStyle="ButtonStyle.Light"
                                                              Variant="Variant.Flat"
                                                              Size="ButtonSize.Small"
                                                              Click="@(args => EditRow(employee))"
                                                              @onclick:stopPropagation="true">
                                                </RadzenButton>
                                            </Template>
                                            <EditTemplate Context="employee">
                                                <RadzenButton Icon="check"
                                                              ButtonStyle="ButtonStyle.Success"
                                                              Variant="Variant.Flat"
                                                              Size="ButtonSize.Small"
                                                              Click="@((args) => SaveRow(employee))">
                                                </RadzenButton>
                                                <RadzenButton Icon="close"
                                                              ButtonStyle="ButtonStyle.Light"
                                                              Variant="Variant.Flat"
                                                              Size="ButtonSize.Small"
                                                              Click="@((args) => CancelEdit(employee))">
                                                </RadzenButton>
                                            </EditTemplate>
                                        </RadzenDataGridColumn>
                                    </Columns>
                                </RadzenDataGrid>
                            }
            </ChildContent>
        </PageLayout>
    </Authorized>
    <NotAuthorized>
        <PageLayout Type="LayoutType.Standard"
                   Title="Access Denied"
                   Description="You do not have permission to access this page">
            <ChildContent>
                <div class="d-flex flex-column align-items-center justify-content-center" style="min-height: 400px;">
                    <RadzenIcon Icon="block" Style="font-size: 4rem; color: var(--rz-danger);" Class="rz-mb-3" />
                    <RadzenText TextStyle="TextStyle.H4" Class="rz-mb-2">Access Denied</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body1" Class="text-muted text-center">
                        You do not have permission to access the Role Management page.
                        <br />
                        This page is restricted to administrators only.
                    </RadzenText>
                </div>
            </ChildContent>
        </PageLayout>
    </NotAuthorized>
</AuthorizeView>

@code {
    protected override bool EnableParameterOptimization => true;

    [CascadingParameter]
    private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

    RadzenDataGrid<EmployeeDto> employeesGrid = null!;
    List<EmployeeDto> employees = new();
    List<EmployeeDto> filteredEmployees = new();
    string searchText = string.Empty;
    ApplicationRole currentUserRole = ApplicationRole.Employee;

    // State tracking fields for optimization
    private List<EmployeeDto> _lastEmployees = new();
    private string _lastSearchText = string.Empty;
    private ApplicationRole _lastCurrentUserRole = ApplicationRole.Employee;

    protected override async Task OnInitializedAsync()
    {
        await LoadCurrentUserRole();
        await LoadEmployees();

        // Initialize state tracking after loading data
        _lastEmployees = employees;
        _lastSearchText = searchText;
        _lastCurrentUserRole = currentUserRole;
    }

    protected override bool HasStateChanged()
    {
        // Check if employees list reference or content changed
        bool employeesChanged = !ReferenceEquals(_lastEmployees, employees) ||
                               _lastEmployees.Count != employees.Count;

        // Check if search text changed
        bool searchChanged = _lastSearchText != searchText;

        // Check if role changed
        bool roleChanged = _lastCurrentUserRole != currentUserRole;

        // Update tracked values if changed
        if (employeesChanged) _lastEmployees = employees;
        if (searchChanged) _lastSearchText = searchText;
        if (roleChanged) _lastCurrentUserRole = currentUserRole;

        return employeesChanged || searchChanged || roleChanged;
    }

    async Task LoadCurrentUserRole()
    {
        if (AuthenticationStateTask != null)
        {
            var authState = await AuthenticationStateTask;
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                var roleClaim = user.FindFirst("ApplicationRole")?.Value
                    ?? user.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value;

                if (!string.IsNullOrEmpty(roleClaim) && Enum.TryParse<ApplicationRole>(roleClaim, out var role))
                {
                    currentUserRole = role;
                }
            }
        }
    }

    async Task LoadEmployees()
    {
        try
        {
            employees = await EmployeeService.GetAllEmployeesAsync();
            employees = employees.Where(e => !e.IsDeleted).ToList();
            FilterEmployees();
            NotifyStateChanged();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = $"Failed to load employees: {ex.Message}",
                Duration = 4000
            });
        }
    }

    void OnSearchTextChanged(ChangeEventArgs args)
    {
        searchText = args.Value?.ToString() ?? string.Empty;
        FilterEmployees();
        NotifyStateChanged(); // Force re-render after filtering
    }

    void FilterEmployees()
    {
        if (string.IsNullOrWhiteSpace(searchText))
        {
            filteredEmployees = employees;
        }
        else
        {
            var search = searchText.ToLowerInvariant();
            filteredEmployees = employees.Where(e =>
                e.FirstName.ToLowerInvariant().Contains(search) ||
                e.LastName.ToLowerInvariant().Contains(search) ||
                e.Organization.ToLowerInvariant().Contains(search) ||
                e.Role.ToLowerInvariant().Contains(search)
            ).ToList();
        }
    }

    List<ApplicationRole> GetAvailableRoles()
    {
        // Business rule: Users can only assign roles at their level or below
        // Admin can assign all roles
        // HRLead can assign all roles except Admin
        // HR can assign all roles except Admin and HRLead
        return currentUserRole switch
        {
            ApplicationRole.Admin => Enum.GetValues<ApplicationRole>().ToList(),
            ApplicationRole.HRLead => new List<ApplicationRole>
            {
                ApplicationRole.Employee,
                ApplicationRole.TeamLead,
                ApplicationRole.HR,
                ApplicationRole.HRLead
            },
            ApplicationRole.HR => new List<ApplicationRole>
            {
                ApplicationRole.Employee,
                ApplicationRole.TeamLead,
                ApplicationRole.HR
            },
            _ => new List<ApplicationRole>() // Should not happen as page requires HR+ policy
        };
    }

    async Task EditRow(EmployeeDto employee)
    {
        await employeesGrid.EditRow(employee);
    }

    void CancelEdit(EmployeeDto employee)
    {
        employeesGrid.CancelEditRow(employee);
    }

    async Task SaveRow(EmployeeDto employee)
    {
        await employeesGrid.UpdateRow(employee);
    }

    async Task OnUpdateRow(EmployeeDto employee)
    {
        try
        {
            var success = await EmployeeService.ChangeApplicationRoleAsync(employee.Id, employee.ApplicationRole);

            if (success)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Success",
                    Detail = $"Application role for {employee.FullName} updated to {employee.ApplicationRole}",
                    Duration = 4000
                });

                await LoadEmployees();
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Error",
                    Detail = "Failed to update application role",
                    Duration = 4000
                });
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = $"Failed to update role: {ex.Message}",
                Duration = 4000
            });
        }
    }
}
