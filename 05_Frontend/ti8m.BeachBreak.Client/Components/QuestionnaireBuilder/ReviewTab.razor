@using Radzen
@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Services
@inject QuestionConfigurationService ConfigService

<div class="summary-container">
    @if (Template.Sections.Any())
    {
        <!-- Template Information Cards -->
        <div class="info-cards-grid">
            <div class="info-card">
                <h3 class="preview-section-title">Template Name</h3>
                <p class="preview-content-text">@Template.Name</p>
            </div>

            <div class="info-card">
                <h3 class="preview-section-title">Category</h3>
                <p class="preview-content-text">@GetCategoryName()</p>
            </div>

            <div class="info-card">
                <h3 class="preview-section-title">Review Required</h3>
                <div class="review-badge-container">
                    @if (Template.RequiresManagerReview)
                    {
                        <span class="review-badge required">
                            <RadzenIcon Icon="check_circle" Style="font-size: 1rem;" />
                            Yes
                        </span>
                    }
                    else
                    {
                        <span class="review-badge not-required">
                            <RadzenIcon Icon="cancel" Style="font-size: 1rem;" />
                            No
                        </span>
                    }
                </div>
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(Template.Description))
        {
            <div class="info-card description-card">
                <h3 class="preview-section-title">Description</h3>
                <p class="preview-description-text">@Template.Description</p>
            </div>
        }

        <!-- Integrated Summary Header -->
        <div class="questionnaire-summary">
            <h3 class="summary-title">@Template.Name Summary</h3>
            <p class="summary-stats">
                @Template.Sections.Count section@(Template.Sections.Count != 1 ? "s" : "") •
                @GetTotalItems() total item@(GetTotalItems() != 1 ? "s" : "")*@(Template.RequiresManagerReview ? " • Manager review required" : " • No manager review")
            </p>
        </div>

        <!-- Structure Table -->
        <div class="structure-table-wrapper">
            <table class="structure-table">
                <thead>
                    <tr>
                        <th>Section</th>
                        <th class="table-header-center table-col-completed-by">Completed By</th>
                        <th class="table-header-center table-col-items">Items</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var templateSection in Template.Sections.OrderBy(s => s.Order))
                    {
                        <tr class="section-row">
                            <td>
                                <strong>@templateSection.Title</strong>
                            </td>
                            <td class="table-cell-center">
                                @GetCompletionRoleBadge(templateSection)
                            </td>
                            <td class="table-cell-center">
                                @GetSectionItemsText(templateSection)
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <p class="preview-footer-note">
            * Items include competencies (Assessment questions) and text sections (Text questions). Goal questions have items added during response.
        </p>
    }
    else
    {
        <div class="empty-state">
            <RadzenIcon Icon="description" class="empty-state-icon" />
            <p>Add sections and questions to see the summary</p>
        </div>
    }
</div>

@code {
    [Parameter, EditorRequired] public QuestionnaireTemplate Template { get; set; } = null!;
    [Parameter, EditorRequired] public Dictionary<QuestionType, string> QuestionTypeLabels { get; set; } = null!;
    [Parameter] public List<Category> Categories { get; set; } = new();

    private string GetCategoryName()
    {
        if (Template.CategoryId == Guid.Empty)
        {
            return "No category selected";
        }

        var category = Categories.FirstOrDefault(c => c.Id == Template.CategoryId);
        return category?.NameEn ?? "Unknown category";
    }

    private int GetTotalItems()
    {
        int total = 0;
        foreach (var section in Template.Sections)
        {
            foreach (var question in section.Questions)
            {
                total += GetItemCount(question);
            }
        }
        return total;
    }

    private int GetItemCount(QuestionItem question)
    {
        return question.Type switch
        {
            QuestionType.Assessment => ConfigService.GetCompetencies(question).Count,
            QuestionType.TextQuestion => ConfigService.GetTextSections(question).Count,
            QuestionType.Goal => 0, // Goals are added during response
            _ => 0
        };
    }

    private string GetSectionItemsText(QuestionSection section)
    {
        var itemCounts = new List<string>();
        int assessmentCount = 0;
        int textSectionCount = 0;
        bool hasGoals = false;

        foreach (var question in section.Questions)
        {
            switch (question.Type)
            {
                case QuestionType.Assessment:
                    assessmentCount += ConfigService.GetCompetencies(question).Count;
                    break;
                case QuestionType.TextQuestion:
                    textSectionCount += ConfigService.GetTextSections(question).Count;
                    break;
                case QuestionType.Goal:
                    hasGoals = true;
                    break;
            }
        }

        if (assessmentCount > 0)
        {
            itemCounts.Add($"{assessmentCount} competenc{(assessmentCount != 1 ? "ies" : "y")}");
        }

        if (textSectionCount > 0)
        {
            itemCounts.Add($"{textSectionCount} section{(textSectionCount != 1 ? "s" : "")}");
        }

        if (hasGoals)
        {
            itemCounts.Add("Goals added during response");
        }

        return itemCounts.Any() ? string.Join(", ", itemCounts) : "—";
    }

    private RenderFragment GetCompletionRoleBadge(QuestionSection section)
    {
        var roleColor = section.GetRoleColor();
        var roleIcon = section.GetRoleIcon();
        var roleText = GetCompletionRoleText(section.CompletionRole);

        return @<span class="role-badge" style="background-color: @roleColor;">
            <RadzenIcon Icon="@roleIcon" Style="font-size: 1rem;" />
            @roleText
        </span>;
    }

    private string GetCompletionRoleText(CompletionRole role)
    {
        return role switch
        {
            CompletionRole.Employee => "Employee",
            CompletionRole.Manager => "Manager",
            CompletionRole.Both => "Both",
            _ => "Unknown"
        };
    }
}
