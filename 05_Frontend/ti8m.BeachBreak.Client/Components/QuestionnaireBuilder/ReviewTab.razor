@using Radzen
@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Services
@using ti8m.BeachBreak.Client.Components.Shared
@inject QuestionConfigurationService ConfigService
@inherits OptimizedTranslatableComponentBase

<div class="summary-container">
    @if (Template.Sections.Any())
    {
        <!-- Template Information Cards -->
        <div class="info-cards-grid">
            <div class="info-card">
                <h3 class="preview-section-title">@T("labels.template-name")</h3>
                <p class="preview-content-text">@Template.GetLocalizedNameWithFallback(CurrentLanguage)</p>
            </div>

            <div class="info-card">
                <h3 class="preview-section-title">@T("labels.category")</h3>
                <p class="preview-content-text">@GetCategoryName()</p>
            </div>

            <div class="info-card">
                <h3 class="preview-section-title">@T("labels.review-required")</h3>
                <div class="review-badge-container">
                    @if (Template.RequiresManagerReview)
                    {
                        <span class="review-badge required">
                            <RadzenIcon Icon="check_circle" Style="font-size: 1rem;" />
                            @T("labels.yes")
                        </span>
                    }
                    else
                    {
                        <span class="review-badge not-required">
                            <RadzenIcon Icon="cancel" Style="font-size: 1rem;" />
                            @T("labels.no")
                        </span>
                    }
                </div>
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(Template.GetLocalizedDescriptionWithFallback(CurrentLanguage)))
        {
            <div class="info-card description-card">
                <h3 class="preview-section-title">@T("labels.description")</h3>
                <p class="preview-description-text">@Template.GetLocalizedDescriptionWithFallback(CurrentLanguage)</p>
            </div>
        }

        <!-- Integrated Summary Header -->
        <div class="questionnaire-summary">
            <h3 class="summary-title">@Template.GetLocalizedNameWithFallback(CurrentLanguage) @T("labels.summary")</h3>
            <p class="summary-stats">
                @Template.Sections.Count @(Template.Sections.Count != 1 ? T("labels.sections").ToLower() : T("labels.section").ToLower()) •
                @GetTotalItems() @(GetTotalItems() != 1 ? T("labels.total-items").ToLower() : T("labels.total-item").ToLower())@(Template.RequiresManagerReview ? " • " + T("labels.manager-review-required") : " • " + T("labels.no-manager-review"))
            </p>
        </div>

        <!-- Structure Table -->
        <div class="structure-table-wrapper">
            <table class="structure-table">
                <thead>
                    <tr>
                        <th>@T("labels.section")</th>
                        <th class="table-header-center table-col-completed-by">@T("labels.completed-by")</th>
                        <th class="table-header-center table-col-items">@T("labels.items")</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var templateSection in Template.Sections.OrderBy(s => s.Order))
                    {
                        <tr class="section-row">
                            <td>
                                <strong>@templateSection.GetLocalizedTitleWithFallback(CurrentLanguage)</strong>
                            </td>
                            <td class="table-cell-center">
                                @GetCompletionRoleBadge(templateSection)
                            </td>
                            <td class="table-cell-center">
                                @GetSectionItemsText(templateSection)
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <p class="preview-footer-note">
            @T("messages.items-explanation")
        </p>
    }
    else
    {
        <div class="empty-state">
            <RadzenIcon Icon="description" class="empty-state-icon" />
            <p>@T("messages.add-sections-to-see-summary")</p>
        </div>
    }
</div>

@code {
    [Parameter, EditorRequired] public QuestionnaireTemplate Template { get; set; } = null!;
    [Parameter, EditorRequired] public Dictionary<QuestionType, string> QuestionTypeLabels { get; set; } = null!;
    [Parameter] public List<Category> Categories { get; set; } = new();

    private string GetCategoryName()
    {
        if (Template.CategoryId == Guid.Empty)
        {
            return T("messages.no-category-selected");
        }

        var category = Categories.FirstOrDefault(c => c.Id == Template.CategoryId);
        return category?.NameEn ?? T("messages.unknown-category");
    }

    private int GetTotalItems()
    {
        int total = 0;
        foreach (var section in Template.Sections)
        {
            foreach (var question in section.Questions)
            {
                total += GetItemCount(question);
            }
        }
        return total;
    }

    private int GetItemCount(QuestionItem question)
    {
        return question.Type switch
        {
            QuestionType.Assessment => ConfigService.GetCompetencies(question).Count,
            QuestionType.TextQuestion => ConfigService.GetTextSections(question).Count,
            QuestionType.Goal => 0, // Goals are added during response
            _ => 0
        };
    }

    private string GetSectionItemsText(QuestionSection section)
    {
        var itemCounts = new List<string>();
        int assessmentCount = 0;
        int textSectionCount = 0;
        bool hasGoals = false;

        foreach (var question in section.Questions)
        {
            switch (question.Type)
            {
                case QuestionType.Assessment:
                    assessmentCount += ConfigService.GetCompetencies(question).Count;
                    break;
                case QuestionType.TextQuestion:
                    textSectionCount += ConfigService.GetTextSections(question).Count;
                    break;
                case QuestionType.Goal:
                    hasGoals = true;
                    break;
            }
        }

        if (assessmentCount > 0)
        {
            itemCounts.Add($"{assessmentCount} {(assessmentCount != 1 ? T("labels.competencies").ToLower() : T("labels.competency").ToLower())}");
        }

        if (textSectionCount > 0)
        {
            itemCounts.Add($"{textSectionCount} {(textSectionCount != 1 ? T("labels.sections").ToLower() : T("labels.section").ToLower())}");
        }

        if (hasGoals)
        {
            itemCounts.Add(T("messages.goals-added-during-response"));
        }

        return itemCounts.Any() ? string.Join(", ", itemCounts) : "—";
    }

    private RenderFragment GetCompletionRoleBadge(QuestionSection section)
    {
        var roleColor = section.GetRoleColor();
        var roleIcon = section.GetRoleIcon();
        var roleText = GetCompletionRoleText(section.CompletionRole);

        return @<span class="role-badge" style="background-color: @roleColor;">
            <RadzenIcon Icon="@roleIcon" Style="font-size: 1rem;" />
            @roleText
        </span>;
    }

    private string GetCompletionRoleText(CompletionRole role)
    {
        return role switch
        {
            CompletionRole.Employee => T("labels.employee"),
            CompletionRole.Manager => T("labels.manager"),
            CompletionRole.Both => T("labels.both"),
            _ => T("labels.unknown")
        };
    }
}
