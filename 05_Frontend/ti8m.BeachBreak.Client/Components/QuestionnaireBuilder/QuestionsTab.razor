@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Components.QuestionnaireBuilder
@using ti8m.BeachBreak.Client.Components.Shared
@inherits OptimizedTranslatableComponentBase

<div class="questions-tab-content">
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <RadzenText TextStyle="TextStyle.Body1" Class="text-muted">
                    @T("messages.create-sections-instruction")
                </RadzenText>
            </div>
            <div class="d-flex gap-2">
                <AsyncButton Text="@T("buttons.assessment")"
                            ButtonStyle="ButtonStyle.Primary"
                            Icon="self_improvement"
                            Size="ButtonSize.Small"
                            Click="@(() => OnAddSectionWithTypeInternal(QuestionType.Assessment))"
                            Title="@T("tooltips.add-assessment-section")"
                            Disabled="@(!Template.IsAvailableForEditing)" />
                <AsyncButton Text="@T("buttons.goal-achievement")"
                            ButtonStyle="ButtonStyle.Success"
                            Icon="track_changes"
                            Size="ButtonSize.Small"
                            Click="@(() => OnAddSectionWithTypeInternal(QuestionType.Goal))"
                            Title="@T("tooltips.add-goal-section")"
                            Disabled="@(!Template.IsAvailableForEditing)" />
                <AsyncButton Text="@T("buttons.text-question")"
                            ButtonStyle="ButtonStyle.Secondary"
                            Icon="psychology"
                            Size="ButtonSize.Small"
                            Click="@(() => OnAddSectionWithTypeInternal(QuestionType.TextQuestion))"
                            Title="@T("tooltips.add-text-question-section")"
                            Disabled="@(!Template.IsAvailableForEditing)" />
            </div>
        </div>

        @if (Template.Sections.Count > 0)
        {
            <div class="assessment-stats mb-4">
                <div class="d-flex gap-4 align-items-center justify-content-center">
                    <RadzenText TextStyle="TextStyle.Body1" Class="text-muted mb-0">
                        <RadzenIcon Icon="folder" Class="me-1 stats-icon-primary" />
                        <strong class="stats-count-primary">@Template.Sections.Count</strong> @T("labels.sections")
                    </RadzenText>
                    <RadzenText TextStyle="TextStyle.Body1" Class="text-muted mb-0">
                        <RadzenIcon Icon="quiz" Class="me-1 stats-icon-success" />
                        <strong class="stats-count-success">@GetTotalItemsCount()</strong> @T("labels.total-items")
                    </RadzenText>
                </div>
            </div>
        }
    </div>

    @if (Template.Sections.Count == 0)
    {
        <div class="empty-state text-center p-5">
            <RadzenIcon Icon="quiz" Class="empty-state-icon" />
            <RadzenText TextStyle="TextStyle.Body1" Class="text-muted mt-2">
                @T("messages.no-sections-created")
            </RadzenText>
        </div>
    }
    else
    {
        <div class="sections-container">
            @for (int sectionIndex = 0; sectionIndex < Template.Sections.Count; sectionIndex++)
            {
                var templateSection = Template.Sections[sectionIndex];
                var currentSectionIndex = sectionIndex;

                @if (sectionIndex > 0)
                {
                    <div class="section-separator mb-4">
                        <hr class="section-separator-line border-0" />
                    </div>
                }

                <SectionCard Section="@templateSection"
                           Template="@Template"
                           CanMoveUp="@(currentSectionIndex > 0)"
                           CanMoveDown="@(currentSectionIndex < Template.Sections.Count - 1)"
                           ShowQuestionTypeSelection="@(ShowQuestionTypeSelection && SelectedSectionIndex == currentSectionIndex)"
                           QuestionTypeLabels="@QuestionTypeLabels"
                           OnMoveUp="@(() => OnMoveSectionUpInternal(currentSectionIndex))"
                           OnMoveDown="@(() => OnMoveSectionDownInternal(currentSectionIndex))"
                           OnDelete="@(() => OnRemoveSectionInternal(currentSectionIndex))"
                           OnAddQuestion="@(() => OnShowAddQuestionDialogInternal(currentSectionIndex))"
                           OnAddItemDirectly="@(() => OnAddItemDirectlyInternal(currentSectionIndex))"
                           OnCancelQuestionSelection="@OnCancelQuestionTypeSelection"
                           OnAddQuestionType="@((type) => OnAddQuestionOfTypeInternal(type))"
                           OnEditQuestion="@((questionIndex) => OnEditQuestionInternal(currentSectionIndex, questionIndex))"
                           OnMoveQuestionUp="@((questionIndex) => OnMoveQuestionUpInternal(currentSectionIndex, questionIndex))"
                           OnMoveQuestionDown="@((questionIndex) => OnMoveQuestionDownInternal(currentSectionIndex, questionIndex))"
                           OnDeleteQuestion="@((questionIndex) => OnRemoveQuestionInternal(currentSectionIndex, questionIndex))"
                           OnTitleChanged="@((value) => OnSectionTitleChanged(currentSectionIndex, value))"
                           OnDescriptionChanged="@((value) => OnSectionDescriptionChanged(currentSectionIndex, value))" />
            }
        </div>
    }
</div>

@code {
    [Parameter, EditorRequired] public QuestionnaireTemplate Template { get; set; } = null!;
    [Parameter, EditorRequired] public bool ShowQuestionTypeSelection { get; set; }
    [Parameter, EditorRequired] public int SelectedSectionIndex { get; set; }
    [Parameter, EditorRequired] public Dictionary<QuestionType, string> QuestionTypeLabels { get; set; } = null!;

    [Parameter] public EventCallback<QuestionType> OnAddSectionWithType { get; set; }
    [Parameter] public EventCallback<int> OnMoveSectionUp { get; set; }
    [Parameter] public EventCallback<int> OnMoveSectionDown { get; set; }
    [Parameter] public EventCallback<int> OnRemoveSection { get; set; }
    [Parameter] public EventCallback<int> OnShowAddQuestionDialog { get; set; }
    [Parameter] public EventCallback<int> OnAddItemDirectly { get; set; }
    [Parameter] public EventCallback OnCancelQuestionTypeSelection { get; set; }
    [Parameter] public EventCallback<QuestionType> OnAddQuestionOfType { get; set; }
    [Parameter] public EventCallback<(int sectionIndex, int questionIndex)> OnEditQuestion { get; set; }
    [Parameter] public EventCallback<(int sectionIndex, int questionIndex)> OnMoveQuestionUp { get; set; }
    [Parameter] public EventCallback<(int sectionIndex, int questionIndex)> OnMoveQuestionDown { get; set; }
    [Parameter] public EventCallback<(int sectionIndex, int questionIndex)> OnRemoveQuestion { get; set; }

    private async Task OnAddSectionWithTypeInternal(QuestionType type) => await OnAddSectionWithType.InvokeAsync(type);
    private async Task OnMoveSectionUpInternal(int sectionIndex) => await OnMoveSectionUp.InvokeAsync(sectionIndex);
    private async Task OnMoveSectionDownInternal(int sectionIndex) => await OnMoveSectionDown.InvokeAsync(sectionIndex);
    private async Task OnRemoveSectionInternal(int sectionIndex) => await OnRemoveSection.InvokeAsync(sectionIndex);
    private async Task OnShowAddQuestionDialogInternal(int sectionIndex) => await OnShowAddQuestionDialog.InvokeAsync(sectionIndex);
    private async Task OnAddItemDirectlyInternal(int sectionIndex) => await OnAddItemDirectly.InvokeAsync(sectionIndex);
    private async Task OnAddQuestionOfTypeInternal(QuestionType type) => await OnAddQuestionOfType.InvokeAsync(type);

    private async Task OnEditQuestionInternal(int sectionIndex, int questionIndex) =>
        await OnEditQuestion.InvokeAsync((sectionIndex, questionIndex));

    private async Task OnMoveQuestionUpInternal(int sectionIndex, int questionIndex) =>
        await OnMoveQuestionUp.InvokeAsync((sectionIndex, questionIndex));

    private async Task OnMoveQuestionDownInternal(int sectionIndex, int questionIndex) =>
        await OnMoveQuestionDown.InvokeAsync((sectionIndex, questionIndex));

    private async Task OnRemoveQuestionInternal(int sectionIndex, int questionIndex) =>
        await OnRemoveQuestion.InvokeAsync((sectionIndex, questionIndex));

    private async Task OnSectionTitleChanged(int sectionIndex, string value)
    {
        // Section title is already updated in SectionCard component
        StateHasChanged();
    }

    private async Task OnSectionDescriptionChanged(int sectionIndex, string value)
    {
        // Section description is already updated in SectionCard component
        StateHasChanged();
    }

    private int GetTotalItemsCount()
    {
        int totalItems = 0;

        foreach (var section in Template.Sections)
        {
            // Check if this section uses the new simplified structure
            if (section.Configuration.Any())
            {
                totalItems += section.GetItemCount();
            }
            // Fallback to legacy Questions structure
            else
            {
                foreach (var question in section.Questions)
                {
                    switch (question.Type)
                    {
                        case QuestionType.Assessment:
                            if (question.Configuration.TryGetValue("Competencies", out var competenciesObj))
                            {
                                if (competenciesObj is System.Text.Json.JsonElement jsonElement && jsonElement.ValueKind == System.Text.Json.JsonValueKind.Array)
                                {
                                    try { totalItems += jsonElement.GetArrayLength(); } catch { }
                                }
                                else if (competenciesObj is System.Collections.ICollection collection)
                                {
                                    totalItems += collection.Count;
                                }
                            }
                            break;
                        case QuestionType.Goal:
                            if (question.Configuration.TryGetValue("GoalCategories", out var goalCategoriesObj))
                            {
                                if (goalCategoriesObj is System.Text.Json.JsonElement jsonElement && jsonElement.ValueKind == System.Text.Json.JsonValueKind.Array)
                                {
                                    try { totalItems += jsonElement.GetArrayLength(); } catch { }
                                }
                                else if (goalCategoriesObj is System.Collections.ICollection collection)
                                {
                                    totalItems += collection.Count;
                                }
                            }
                            break;
                        case QuestionType.TextQuestion:
                            if (question.Configuration.TryGetValue("TextSections", out var textSectionsObj))
                            {
                                if (textSectionsObj is System.Text.Json.JsonElement jsonElement && jsonElement.ValueKind == System.Text.Json.JsonValueKind.Array)
                                {
                                    try { totalItems += jsonElement.GetArrayLength(); } catch { }
                                }
                                else if (textSectionsObj is System.Collections.ICollection collection)
                                {
                                    totalItems += collection.Count;
                                }
                            }
                            // Check for legacy format
                            else if (question.Configuration.ContainsKey("SectionTitle") || question.Configuration.ContainsKey("SectionDescription"))
                            {
                                totalItems += 1;
                            }
                            break;
                        default:
                            totalItems += 1; // Fallback for unknown question types
                            break;
                    }
                }
            }
        }

        return totalItems;
    }

}