@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Components.QuestionnaireBuilder
@using ti8m.BeachBreak.Client.Components.Shared
@inherits OptimizedTranslatableComponentBase

<div class="questions-tab-content">
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <RadzenText TextStyle="TextStyle.Body1" Class="text-muted">
                    @T("messages.create-sections-instruction")
                </RadzenText>
            </div>
            <div class="d-flex gap-2">
                @if (IsQuestionTypeAllowed(QuestionType.Assessment))
                {
                    <AsyncButton Text="@T("buttons.assessment")"
                                ButtonStyle="ButtonStyle.Primary"
                                Icon="self_improvement"
                                Size="ButtonSize.Small"
                                Click="@(() => OnAddSectionWithTypeInternal(QuestionType.Assessment))"
                                Title="@T("tooltips.add-assessment-section")"
                                Disabled="@(!Template.IsAvailableForEditing)" />
                }
                @if (IsQuestionTypeAllowed(QuestionType.Goal))
                {
                    <AsyncButton Text="@T("buttons.goal-achievement")"
                                ButtonStyle="ButtonStyle.Success"
                                Icon="track_changes"
                                Size="ButtonSize.Small"
                                Click="@(() => OnAddSectionWithTypeInternal(QuestionType.Goal))"
                                Title="@T("tooltips.add-goal-section")"
                                Disabled="@(!Template.IsAvailableForEditing)" />
                }
                @if (IsQuestionTypeAllowed(QuestionType.TextQuestion))
                {
                    <AsyncButton Text="@T("buttons.text-question")"
                                ButtonStyle="ButtonStyle.Secondary"
                                Icon="psychology"
                                Size="ButtonSize.Small"
                                Click="@(() => OnAddSectionWithTypeInternal(QuestionType.TextQuestion))"
                                Title="@T("tooltips.add-text-question-section")"
                                Disabled="@(!Template.IsAvailableForEditing)" />
                }
                @if (IsQuestionTypeAllowed(QuestionType.EmployeeFeedback))
                {
                    <AsyncButton Text="@T("question-types.employee-feedback")"
                                ButtonStyle="ButtonStyle.Info"
                                Icon="feedback"
                                Size="ButtonSize.Small"
                                Click="@(() => OnAddSectionWithTypeInternal(QuestionType.EmployeeFeedback))"
                                Title="@($"{T("buttons.add")} {T("question-types.employee-feedback")}")"
                                Disabled="@(!Template.IsAvailableForEditing)" />
                }
            </div>
        </div>

        @if (Template.Sections.Count > 0)
        {
            <div class="assessment-stats mb-4">
                <div class="d-flex gap-4 align-items-center justify-content-center">
                    <RadzenText TextStyle="TextStyle.Body1" Class="text-muted mb-0">
                        <RadzenIcon Icon="folder" Class="me-1 stats-icon-primary" />
                        <strong class="stats-count-primary">@Template.Sections.Count</strong> @T("labels.sections")
                    </RadzenText>
                    <RadzenText TextStyle="TextStyle.Body1" Class="text-muted mb-0">
                        <RadzenIcon Icon="quiz" Class="me-1 stats-icon-success" />
                        <strong class="stats-count-success">@GetTotalItemsCount()</strong> @T("labels.total-items")
                    </RadzenText>
                </div>
            </div>
        }
    </div>

    @if (Template.Sections.Count == 0)
    {
        <div class="empty-state text-center p-5">
            <RadzenIcon Icon="quiz" Class="empty-state-icon" />
            <RadzenText TextStyle="TextStyle.Body1" Class="text-muted mt-2">
                @T("messages.no-sections-created")
            </RadzenText>
        </div>
    }
    else
    {
        <div class="sections-container">
            @for (int sectionIndex = 0; sectionIndex < Template.Sections.Count; sectionIndex++)
            {
                var templateSection = Template.Sections[sectionIndex];
                var currentSectionIndex = sectionIndex;

                <SectionCard Section="@templateSection"
                           Template="@Template"
                           CanMoveUp="@(currentSectionIndex > 0)"
                           CanMoveDown="@(currentSectionIndex < Template.Sections.Count - 1)"
                           OnMoveUp="@(() => OnMoveSectionUpInternal(currentSectionIndex))"
                           OnMoveDown="@(() => OnMoveSectionDownInternal(currentSectionIndex))"
                           OnDelete="@(() => OnRemoveSectionInternal(currentSectionIndex))"
                           OnAddItemDirectly="@(() => OnAddItemDirectlyInternal(currentSectionIndex))"
                           OnMoveQuestionUp="@((questionIndex) => OnMoveQuestionUpInternal(currentSectionIndex, questionIndex))"
                           OnMoveQuestionDown="@((questionIndex) => OnMoveQuestionDownInternal(currentSectionIndex, questionIndex))"
                           OnDeleteQuestion="@((questionIndex) => OnRemoveQuestionInternal(currentSectionIndex, questionIndex))"
                           OnTitleEnglishChanged="@((value) => OnSectionTitleEnglishChanged(currentSectionIndex, value))"
                           OnTitleGermanChanged="@((value) => OnSectionTitleGermanChanged(currentSectionIndex, value))"
                           OnDescriptionEnglishChanged="@((value) => OnSectionDescriptionEnglishChanged(currentSectionIndex, value))"
                           OnDescriptionGermanChanged="@((value) => OnSectionDescriptionGermanChanged(currentSectionIndex, value))" />
            }
        </div>
    }
</div>

@code {
    [Parameter, EditorRequired] public QuestionnaireTemplate Template { get; set; } = null!;

    [Parameter] public EventCallback<QuestionType> OnAddSectionWithType { get; set; }
    [Parameter] public EventCallback<int> OnMoveSectionUp { get; set; }
    [Parameter] public EventCallback<int> OnMoveSectionDown { get; set; }
    [Parameter] public EventCallback<int> OnRemoveSection { get; set; }
    [Parameter] public EventCallback<int> OnAddItemDirectly { get; set; }
    [Parameter] public EventCallback<(int sectionIndex, int questionIndex)> OnMoveQuestionUp { get; set; }
    [Parameter] public EventCallback<(int sectionIndex, int questionIndex)> OnMoveQuestionDown { get; set; }
    [Parameter] public EventCallback<(int sectionIndex, int questionIndex)> OnRemoveQuestion { get; set; }

    private async Task OnAddSectionWithTypeInternal(QuestionType type) => await OnAddSectionWithType.InvokeAsync(type);
    private async Task OnMoveSectionUpInternal(int sectionIndex) => await OnMoveSectionUp.InvokeAsync(sectionIndex);
    private async Task OnMoveSectionDownInternal(int sectionIndex) => await OnMoveSectionDown.InvokeAsync(sectionIndex);
    private async Task OnRemoveSectionInternal(int sectionIndex) => await OnRemoveSection.InvokeAsync(sectionIndex);
    private async Task OnAddItemDirectlyInternal(int sectionIndex) => await OnAddItemDirectly.InvokeAsync(sectionIndex);

    private async Task OnMoveQuestionUpInternal(int sectionIndex, int questionIndex) =>
        await OnMoveQuestionUp.InvokeAsync((sectionIndex, questionIndex));

    private async Task OnMoveQuestionDownInternal(int sectionIndex, int questionIndex) =>
        await OnMoveQuestionDown.InvokeAsync((sectionIndex, questionIndex));

    private async Task OnRemoveQuestionInternal(int sectionIndex, int questionIndex) =>
        await OnRemoveQuestion.InvokeAsync((sectionIndex, questionIndex));

    private async Task OnSectionTitleEnglishChanged(int sectionIndex, string value)
    {
        // Section title is already updated in SectionCard component
        StateHasChanged();
    }

    private async Task OnSectionTitleGermanChanged(int sectionIndex, string value)
    {
        // Section title is already updated in SectionCard component
        StateHasChanged();
    }

    private async Task OnSectionDescriptionEnglishChanged(int sectionIndex, string value)
    {
        // Section description is already updated in SectionCard component
        StateHasChanged();
    }

    private async Task OnSectionDescriptionGermanChanged(int sectionIndex, string value)
    {
        // Section description is already updated in SectionCard component
        StateHasChanged();
    }

    private int GetTotalItemsCount()
    {
        int totalItems = 0;

        foreach (var section in Template.Sections)
        {
            totalItems += section.GetItemCount();
        }

        return totalItems;
    }

    private bool IsQuestionTypeAllowed(QuestionType questionType)
    {
        return Template.ProcessType.IsQuestionTypeAllowed(questionType);
    }

}