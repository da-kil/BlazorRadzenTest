@using Radzen
@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Components.Shared
@inject DialogService DialogService
@inherits OptimizedTranslatableComponentBase



<div class="competencies-container">
        <!-- Assessment Configuration -->
        @if (Question.Type == QuestionType.Assessment)
        {
            var competencies = GetOrderedEvaluations();
            <div class="competencies-config">

                @if (competencies.Count == 0)
                {
                    <div class="text-center p-3 text-muted">
                        <RadzenIcon Icon="self_improvement" Class="empty-state-competencies-icon" />
                        <div class="mt-2 small">No competencies configured</div>
                    </div>
                }
                else
                {
                    @for (int i = 0; i < competencies.Count; i++)
                    {
                        var competencyIndex = i;
                        var competency = competencies[competencyIndex];

                        <div class="competency-item builder-context">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div class="d-flex align-items-center gap-3">
                                    <RadzenText TextStyle="TextStyle.Body2" Class="fw-bold mb-0">
                                        Competency @(competencyIndex + 1)
                                    </RadzenText>
                                    <div class="required-badge-container">
                                        <RadzenCheckBox Value="@GetCompetencyRequired(competencyIndex)"
                                                       ValueChanged="@((bool value) => UpdateCompetencyRequired(competencyIndex, value))"
                                                       Name="@($"comp_req_{Question.Id}_{competencyIndex}")"
                                                       Disabled="@(!Template.IsAvailableForEditing)" />
                                        <RadzenLabel Text="Required" Component="@($"comp_req_{Question.Id}_{competencyIndex}")" Class="ms-1" />
                                    </div>
                                </div>
                                <div class="d-flex gap-1">
                                    <AsyncButton ButtonStyle="ButtonStyle.Light"
                                                Icon="keyboard_arrow_up"
                                                Size="ButtonSize.ExtraSmall"
                                                Click="@(() => MoveCompetencyUp(competencyIndex))"
                                                Disabled="@(competencyIndex == 0 || !Template.IsAvailableForEditing)"
                                                Title="Move up" />
                                    <AsyncButton ButtonStyle="ButtonStyle.Light"
                                                Icon="keyboard_arrow_down"
                                                Size="ButtonSize.ExtraSmall"
                                                Click="@(() => MoveCompetencyDown(competencyIndex))"
                                                Disabled="@(competencyIndex == competencies.Count - 1 || !Template.IsAvailableForEditing)"
                                                Title="Move down" />
                                    <AsyncButton ButtonStyle="ButtonStyle.Danger"
                                                ProcessingText="Deleting"
                                                Icon="delete_outline"
                                                Size="ButtonSize.ExtraSmall"
                                                Click="@(() => RemoveCompetency(competencyIndex))"
                                                Title="Delete competency"
                                                Disabled="@(!Template.IsAvailableForEditing)" />
                                </div>
                            </div>
                            <!-- Title Row -->
                            <div class="competency-title-section mb-2">
                                <div class="multilang-input-grid">
                                    <div class="input-field-container">
                                        <RadzenText TextStyle="TextStyle.Caption" Class="mb-1">English Title *</RadzenText>
                                        <RadzenTextBox Value="@competency.TitleEnglish"
                                                      ValueChanged="@((string value) => UpdateCompetencyTitleEnglish(competencyIndex, value))"
                                                      Placeholder="Enter English competency title..."
                                                      Disabled="@(!Template.IsAvailableForEditing)"
                                                      Class="@GetCompetencyTitleValidationClass(competencyIndex)"
                                                      @onblur="@(() => ValidateCompetencyTitle(competencyIndex))" />
                                        @if (!GetCompetencyTitleValid(competencyIndex) && GetCompetencyTitleValidated(competencyIndex))
                                        {
                                            <div class="validation-message">
                                                <RadzenIcon Icon="error_outline" Class="validation-icon me-1" />
                                                English competency title is required
                                            </div>
                                        }
                                    </div>
                                    <div class="input-field-container">
                                        <RadzenText TextStyle="TextStyle.Caption" Class="mb-1">German Title (Optional)</RadzenText>
                                        <RadzenTextBox Value="@competency.TitleGerman"
                                                      ValueChanged="@((string value) => UpdateCompetencyTitleGerman(competencyIndex, value))"
                                                      Placeholder="Enter German competency title (optional)..."
                                                      Disabled="@(!Template.IsAvailableForEditing)"
                                                      Class="w-100" />
                                    </div>
                                </div>
                            </div>
                            <!-- Description Row -->
                            <div class="multilang-input-grid mb-2">
                                <div class="input-field">
                                    <RadzenText TextStyle="TextStyle.Caption" Class="mb-1">English Description</RadzenText>
                                    <RadzenTextArea Value="@competency.DescriptionEnglish"
                                                   ValueChanged="@((string value) => UpdateCompetencyDescriptionEnglish(competencyIndex, value))"
                                                   Disabled="@(!Template.IsAvailableForEditing)"
                                                   Placeholder="Describe what this competency evaluates in English..."
                                                   Rows="2"
                                                   Class="w-100" />
                                </div>
                                <div class="input-field">
                                    <RadzenText TextStyle="TextStyle.Caption" Class="mb-1">German Description (Optional)</RadzenText>
                                    <RadzenTextArea Value="@competency.DescriptionGerman"
                                                   ValueChanged="@((string value) => UpdateCompetencyDescriptionGerman(competencyIndex, value))"
                                                   Disabled="@(!Template.IsAvailableForEditing)"
                                                   Placeholder="Describe what this competency evaluates in German (optional)..."
                                                   Rows="2"
                                                   Class="w-100" />
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>
        }

        <!-- Goal Configuration -->
        @if (Question.Type == QuestionType.Goal)
        {
            <div class="goal-config text-center p-4">
                <RadzenIcon Icon="flag" Class="goal-config-icon mb-3" />
                <RadzenText TextStyle="TextStyle.Body1" Class="mb-2 fw-bold">
                    Goal Question Type
                </RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" Class="text-muted mb-3">
                    No template configuration is required for Goal questions.
                </RadzenText>
                <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" Class="mb-0 goal-workflow-alert" ShowIcon="false">
                    <RadzenText TextStyle="TextStyle.Caption" Class="d-block mb-1 goal-workflow-caption">
                        Goals are added dynamically during the questionnaire workflow:
                    </RadzenText>
                    <ul class="small mb-0 goal-workflow-list">
                        <li>Employee and Manager add goals during their completion phases</li>
                        <li>Goals can be linked to predecessor questionnaires for rating</li>
                        <li>Each goal includes objective, timeframe, measurement, and weighting</li>
                    </ul>
                </RadzenAlert>
            </div>
        }

        <!-- Text Question Configuration -->
        @if (Question.Type == QuestionType.TextQuestion)
        {
            var textSections = GetOrderedTextSections();
            <div class="text-sections-config">
                @if (textSections.Count == 0)
                {
                    <div class="text-center p-3 text-muted">
                        <RadzenIcon Icon="psychology" Class="empty-state-text-icon" />
                        <div class="mt-2 small">No text sections configured</div>
                    </div>
                }
                else
                {
                    @for (int i = 0; i < textSections.Count; i++)
                    {
                        var sectionIndex = i;
                        var textSection = textSections[sectionIndex];

                        <div class="text-section-item rz-p-3 rz-mb-2">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="d-flex align-items-center gap-3">
                                    <RadzenText TextStyle="TextStyle.Body2" Class="fw-bold question-text-response">
                                        Text Section @(sectionIndex + 1)
                                    </RadzenText>
                                    <div class="required-badge-container">
                                        <RadzenCheckBox Value="@GetTextSectionRequired(sectionIndex)"
                                                       ValueChanged="@((bool value) => UpdateTextSectionRequired(sectionIndex, value))"
                                                       Name="@($"text_req_{Question.Id}_{sectionIndex}")"
                                                       Disabled="@(!Template.IsAvailableForEditing)" />
                                        <RadzenLabel Text="Required" Component="@($"text_req_{Question.Id}_{sectionIndex}")" Class="ms-1" />
                                    </div>
                                </div>
                                <div class="d-flex gap-1">
                                    <AsyncButton ButtonStyle="ButtonStyle.Light"
                                                Icon="keyboard_arrow_up"
                                                Size="ButtonSize.ExtraSmall"
                                                Click="@(() => MoveTextSectionUp(sectionIndex))"
                                                Disabled="@(sectionIndex == 0 || !Template.IsAvailableForEditing)"
                                                Title="Move up" />
                                    <AsyncButton ButtonStyle="ButtonStyle.Light"
                                                Icon="keyboard_arrow_down"
                                                Size="ButtonSize.ExtraSmall"
                                                Click="@(() => MoveTextSectionDown(sectionIndex))"
                                                Disabled="@(sectionIndex == textSections.Count - 1 || !Template.IsAvailableForEditing)"
                                                Title="Move down" />
                                    <AsyncButton ButtonStyle="ButtonStyle.Danger"
                                                ProcessingText="Deleting"
                                                Icon="delete"
                                                Size="ButtonSize.ExtraSmall"
                                                Click="@(() => RemoveTextSection(sectionIndex))"
                                                Title="Delete"
                                                Disabled="@(!Template.IsAvailableForEditing)" />
                                </div>
                            </div>
                            <!-- Title Row -->
                            <div class="text-section-title-row mb-2">
                                <div class="multilang-input-grid">
                                    <div class="input-field-container">
                                        <RadzenText TextStyle="TextStyle.Caption" Class="mb-1">English Title *</RadzenText>
                                        <RadzenTextBox Value="@textSection.TitleEnglish"
                                                      ValueChanged="@((string value) => UpdateTextSectionTitleEnglish(sectionIndex, value))"
                                                      Placeholder="Enter section title in English..."
                                                      Disabled="@(!Template.IsAvailableForEditing)"
                                                      Class="@GetTextSectionTitleValidationClass(sectionIndex)"
                                                      @onblur="@(() => ValidateTextSectionTitle(sectionIndex))" />
                                        @if (!GetTextSectionTitleValid(sectionIndex) && GetTextSectionTitleValidated(sectionIndex))
                                        {
                                            <div class="validation-message">
                                                <RadzenIcon Icon="error_outline" Class="validation-icon me-1" />
                                                English title is required
                                            </div>
                                        }
                                    </div>
                                    <div class="input-field-container">
                                        <RadzenText TextStyle="TextStyle.Caption" Class="mb-1">German Title (Optional)</RadzenText>
                                        <RadzenTextBox Value="@textSection.TitleGerman"
                                                      ValueChanged="@((string value) => UpdateTextSectionTitleGerman(sectionIndex, value))"
                                                      Placeholder="Enter section title in German (optional)..."
                                                      Disabled="@(!Template.IsAvailableForEditing)"
                                                      Class="w-100" />
                                    </div>
                                </div>
                            </div>
                            <!-- Description Row -->
                            <div class="multilang-input-grid mb-2">
                                <div class="input-field">
                                    <RadzenText TextStyle="TextStyle.Caption" Class="mb-1">English Description *</RadzenText>
                                    <RadzenTextArea Value="@textSection.DescriptionEnglish"
                                                   ValueChanged="@((string value) => UpdateTextSectionDescriptionEnglish(sectionIndex, value))"
                                                   Placeholder="Describe this text section in English..."
                                                   Rows="2"
                                                   Class="w-100" />
                                </div>
                                <div class="input-field">
                                    <RadzenText TextStyle="TextStyle.Caption" Class="mb-1">German Description (Optional)</RadzenText>
                                    <RadzenTextArea Value="@textSection.DescriptionGerman"
                                                   ValueChanged="@((string value) => UpdateTextSectionDescriptionGerman(sectionIndex, value))"
                                                   Placeholder="Describe this text section in German (optional)..."
                                                   Rows="2"
                                                   Class="w-100" />
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>
        }

        <!-- Question-level required flag is removed as individual items now have their own required flags -->
</div>

@code {
    [Parameter, EditorRequired] public QuestionItem Question { get; set; } = null!;
    [Parameter, EditorRequired] public QuestionnaireTemplate Template { get; set; } = null!;
    [Parameter, EditorRequired] public bool CanMoveUp { get; set; }
    [Parameter, EditorRequired] public bool CanMoveDown { get; set; }
    [Parameter, EditorRequired] public Dictionary<QuestionType, string> QuestionTypeLabels { get; set; } = null!;


    [Parameter] public EventCallback OnEdit { get; set; }
    [Parameter] public EventCallback OnMoveUp { get; set; }
    [Parameter] public EventCallback OnMoveDown { get; set; }
    [Parameter] public EventCallback OnDelete { get; set; }
    [Parameter] public EventCallback OnRequiredChanged { get; set; }

    // Validation state
    private bool isTitleValid = true;
    private bool hasBeenValidated = false;

    // Competency validation state
    private Dictionary<int, bool> competencyTitleValid = new();
    private Dictionary<int, bool> competencyTitleValidated = new();

    // Goal category validation state
    private Dictionary<int, bool> goalCategoryTitleValid = new();
    private Dictionary<int, bool> goalCategoryTitleValidated = new();

    // Text section validation state
    private Dictionary<int, bool> textSectionTitleValid = new();
    private Dictionary<int, bool> textSectionTitleValidated = new();

    private async Task OnEditClick() => await OnEdit.InvokeAsync();
    private async Task OnMoveUpClick() => await OnMoveUp.InvokeAsync();
    private async Task OnMoveDownClick() => await OnMoveDown.InvokeAsync();
    private async Task OnDeleteClick() => await OnDelete.InvokeAsync();

    // Validation methods
    private void ValidateTitle()
    {
        hasBeenValidated = true;
        isTitleValid = !string.IsNullOrWhiteSpace(Question.TitleEnglish) || !string.IsNullOrWhiteSpace(Question.TitleGerman);
        StateHasChanged();
    }

    private string GetTitleValidationClass()
    {
        var baseClass = "w-100";
        if (hasBeenValidated && !isTitleValid)
        {
            return $"{baseClass} border-danger";
        }
        return baseClass;
    }

    public bool IsQuestionValid()
    {
        ValidateTitle();

        // Validate question content based on type
        bool contentValid = true;

        if (Question.Type == QuestionType.Assessment)
        {
            var competencies = GetOrderedEvaluations();
            for (int i = 0; i < competencies.Count; i++)
            {
                ValidateCompetencyTitle(i);
                if (!GetCompetencyTitleValid(i))
                    contentValid = false;
            }
        }
        else if (Question.Type == QuestionType.Goal)
        {
            // Goal questions don't use template items - always valid
            contentValid = true;
        }
        else if (Question.Type == QuestionType.TextQuestion)
        {
            var sections = GetOrderedTextSections();
            for (int i = 0; i < sections.Count; i++)
            {
                ValidateTextSectionTitle(i);
                if (!GetTextSectionTitleValid(i))
                    contentValid = false;
            }
        }

        return isTitleValid && contentValid;
    }

    // Competency validation methods
    private void ValidateCompetencyTitle(int index)
    {
        var competencies = GetOrderedEvaluations();
        if (index >= 0 && index < competencies.Count)
        {
            competencyTitleValidated[index] = true;
            competencyTitleValid[index] = !string.IsNullOrWhiteSpace(competencies[index].TitleEnglish);
            StateHasChanged();
        }
    }

    private bool GetCompetencyTitleValid(int index)
    {
        return competencyTitleValid.GetValueOrDefault(index, true);
    }

    private bool GetCompetencyTitleValidated(int index)
    {
        return competencyTitleValidated.GetValueOrDefault(index, false);
    }

    private string GetCompetencyTitleValidationClass(int index)
    {
        var baseClass = "w-100 mb-2";
        if (GetCompetencyTitleValidated(index) && !GetCompetencyTitleValid(index))
        {
            return $"{baseClass} border-danger";
        }
        return baseClass;
    }

    // Goal category validation methods
    private void ValidateGoalCategoryTitle(int index)
    {
        var categories = GetOrderedGoalCategories();
        if (index >= 0 && index < categories.Count)
        {
            goalCategoryTitleValidated[index] = true;
            goalCategoryTitleValid[index] = !string.IsNullOrWhiteSpace(categories[index].TitleEnglish);
            StateHasChanged();
        }
    }

    private bool GetGoalCategoryTitleValid(int index)
    {
        return goalCategoryTitleValid.GetValueOrDefault(index, true);
    }

    private bool GetGoalCategoryTitleValidated(int index)
    {
        return goalCategoryTitleValidated.GetValueOrDefault(index, false);
    }

    private string GetGoalCategoryTitleValidationClass(int index)
    {
        var baseClass = "w-100 mb-2";
        if (GetGoalCategoryTitleValidated(index) && !GetGoalCategoryTitleValid(index))
        {
            return $"{baseClass} border-danger";
        }
        return baseClass;
    }

    // Text section validation methods
    private void ValidateTextSectionTitle(int index)
    {
        var sections = GetOrderedTextSections();
        if (index >= 0 && index < sections.Count)
        {
            textSectionTitleValidated[index] = true;
            textSectionTitleValid[index] = !string.IsNullOrWhiteSpace(sections[index].TitleEnglish);
            StateHasChanged();
        }
    }

    private bool GetTextSectionTitleValid(int index)
    {
        return textSectionTitleValid.GetValueOrDefault(index, true);
    }

    private bool GetTextSectionTitleValidated(int index)
    {
        return textSectionTitleValidated.GetValueOrDefault(index, false);
    }

    private string GetTextSectionTitleValidationClass(int index)
    {
        var baseClass = "w-100 mb-2";
        if (GetTextSectionTitleValidated(index) && !GetTextSectionTitleValid(index))
        {
            return $"{baseClass} border-danger";
        }
        return baseClass;
    }

    private string GetQuestionTypeIcon(QuestionType type) => type switch
    {
        QuestionType.Assessment => "self_improvement",
        QuestionType.Goal => "track_changes",
        QuestionType.TextQuestion => "psychology",
        _ => "help"
    };


    // Assessment methods

    private List<EvaluationItem> GetOrderedEvaluations()
    {
        if (Question.Configuration is AssessmentConfiguration config)
        {
            return config.Evaluations.OrderBy(e => e.Order).ToList();
        }
        return new List<EvaluationItem>();
    }


    private async Task RemoveCompetency(int displayIndex)
    {
        var orderedCompetencies = GetOrderedEvaluations();
        if (displayIndex >= 0 && displayIndex < orderedCompetencies.Count)
        {
            var competencyToRemove = orderedCompetencies[displayIndex];
            var competencyName = string.IsNullOrWhiteSpace(competencyToRemove.TitleEnglish) ? $"Competency {displayIndex + 1}" : competencyToRemove.TitleEnglish;
            var confirmed = await DialogService.Confirm($"Are you sure you want to delete '{competencyName}'?", "Delete Competency",
                new ConfirmOptions() { OkButtonText = "Yes", CancelButtonText = "No" });

            if (confirmed == true)
            {
                var allEvaluations = GetOrderedEvaluations();
                allEvaluations.Remove(competencyToRemove);
                UpdateAssessmentConfiguration(allEvaluations);
                StateHasChanged();
            }
        }
    }

    private void UpdateCompetencyTitleEnglish(int displayIndex, string value)
    {
        var evaluations = GetOrderedEvaluations();
        if (displayIndex >= 0 && displayIndex < evaluations.Count)
        {
            evaluations[displayIndex].TitleEnglish = value ?? "";
            UpdateAssessmentConfiguration(evaluations);
            StateHasChanged();
        }
    }

    private void UpdateCompetencyTitleGerman(int displayIndex, string value)
    {
        var evaluations = GetOrderedEvaluations();
        if (displayIndex >= 0 && displayIndex < evaluations.Count)
        {
            evaluations[displayIndex].TitleGerman = value ?? "";
            UpdateAssessmentConfiguration(evaluations);
            StateHasChanged();
        }
    }

    private void UpdateCompetencyDescriptionEnglish(int displayIndex, string value)
    {
        var evaluations = GetOrderedEvaluations();
        if (displayIndex >= 0 && displayIndex < evaluations.Count)
        {
            evaluations[displayIndex].DescriptionEnglish = value ?? "";
            UpdateAssessmentConfiguration(evaluations);
            StateHasChanged();
        }
    }

    private void UpdateCompetencyDescriptionGerman(int displayIndex, string value)
    {
        var evaluations = GetOrderedEvaluations();
        if (displayIndex >= 0 && displayIndex < evaluations.Count)
        {
            evaluations[displayIndex].DescriptionGerman = value ?? "";
            UpdateAssessmentConfiguration(evaluations);
            StateHasChanged();
        }
    }

    // Goal Achievement methods
    private List<GoalCategory> GetGoalCategoriesFromConfiguration()
    {
        if (Question.Configuration.ContainsKey("GoalCategories"))
        {
            var goalCategoriesObj = Question.Configuration["GoalCategories"];

            // Handle direct cast (when set in editor)
            if (goalCategoriesObj is List<GoalCategory> categories)
            {
                return categories;
            }

            // Handle JSON deserialization (when loaded from API)
            if (goalCategoriesObj is System.Text.Json.JsonElement jsonElement)
            {
                try
                {
                    if (jsonElement.ValueKind == System.Text.Json.JsonValueKind.Array)
                    {
                        return System.Text.Json.JsonSerializer.Deserialize<List<GoalCategory>>(jsonElement.GetRawText()) ?? new List<GoalCategory>();
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error deserializing goal categories: {ex.Message}");
                }
            }

            // Handle string representation (backup case)
            if (goalCategoriesObj is string jsonString)
            {
                try
                {
                    return System.Text.Json.JsonSerializer.Deserialize<List<GoalCategory>>(jsonString) ?? new List<GoalCategory>();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error deserializing goal categories from string: {ex.Message}");
                }
            }

            // Handle List<object> from API deserialization
            // Note: List<object> is necessary here because JSON API data sometimes comes as untyped objects
            // that need to be converted to strongly-typed GoalCategory objects
            if (goalCategoriesObj is List<object> objectList)
            {
                try
                {
                    var json = System.Text.Json.JsonSerializer.Serialize(objectList);
                    return System.Text.Json.JsonSerializer.Deserialize<List<GoalCategory>>(json) ?? new List<GoalCategory>();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error deserializing goal categories from API List<object>: {ex.Message}");
                }
            }
        }
        return new List<GoalCategory>();
    }

    private List<GoalCategory> GetOrderedGoalCategories()
    {
        var categories = GetGoalCategoriesFromConfiguration();
        return categories.OrderBy(c => c.Order).ToList();
    }


    private async Task RemoveGoalCategory(int index)
    {
        var categories = GetGoalCategoriesFromConfiguration();
        if (index >= 0 && index < categories.Count)
        {
            var categoryName = string.IsNullOrWhiteSpace(categories[index].GetLocalizedTitleWithFallback(CurrentLanguage)) ? $"Goal Category {index + 1}" : categories[index].GetLocalizedTitleWithFallback(CurrentLanguage);
            var confirmed = await DialogService.Confirm($"Are you sure you want to delete '{categoryName}'?", "Delete Goal Category",
                new ConfirmOptions() { OkButtonText = "Yes", CancelButtonText = "No" });

            if (confirmed == true)
            {
                categories.RemoveAt(index);
                Question.Configuration["GoalCategories"] = categories;
                StateHasChanged();
            }
        }
    }

    private void UpdateGoalCategoryTitle(int index, string value)
    {
        var categories = GetGoalCategoriesFromConfiguration();
        if (index >= 0 && index < categories.Count)
        {
            if (CurrentLanguage == Language.German)
            {
                categories[index].TitleGerman = value ?? "";
            }
            else
            {
                categories[index].TitleEnglish = value ?? "";
            }
            Question.Configuration["GoalCategories"] = categories;
            StateHasChanged();
        }
    }

    private void UpdateGoalCategoryDescription(int index, string value)
    {
        var categories = GetGoalCategoriesFromConfiguration();
        if (index >= 0 && index < categories.Count)
        {
            if (CurrentLanguage == Language.German)
            {
                categories[index].DescriptionGerman = value ?? "";
            }
            else
            {
                categories[index].DescriptionEnglish = value ?? "";
            }
            Question.Configuration["GoalCategories"] = categories;
            StateHasChanged();
        }
    }

    private void UpdateGoalCategoryTitleEnglish(int index, string value)
    {
        var categories = GetGoalCategoriesFromConfiguration();
        if (index >= 0 && index < categories.Count)
        {
            categories[index].TitleEnglish = value ?? "";
            Question.Configuration["GoalCategories"] = categories;
            StateHasChanged();
        }
    }

    private void UpdateGoalCategoryTitleGerman(int index, string value)
    {
        var categories = GetGoalCategoriesFromConfiguration();
        if (index >= 0 && index < categories.Count)
        {
            categories[index].TitleGerman = value ?? "";
            Question.Configuration["GoalCategories"] = categories;
            StateHasChanged();
        }
    }

    private void UpdateGoalCategoryDescriptionEnglish(int index, string value)
    {
        var categories = GetGoalCategoriesFromConfiguration();
        if (index >= 0 && index < categories.Count)
        {
            categories[index].DescriptionEnglish = value ?? "";
            Question.Configuration["GoalCategories"] = categories;
            StateHasChanged();
        }
    }

    private void UpdateGoalCategoryDescriptionGerman(int index, string value)
    {
        var categories = GetGoalCategoriesFromConfiguration();
        if (index >= 0 && index < categories.Count)
        {
            categories[index].DescriptionGerman = value ?? "";
            Question.Configuration["GoalCategories"] = categories;
            StateHasChanged();
        }
    }

    // Text Question methods
    private List<TextSection> GetOrderedTextSections()
    {
        if (Question.Configuration is TextQuestionConfiguration config)
        {
            return config.TextSections.OrderBy(s => s.Order).ToList();
        }
        return new List<TextSection>();
    }

    private void UpdateTextQuestionConfiguration(List<TextSection> sections)
    {
        if (Question.Configuration is TextQuestionConfiguration config)
        {
            config.TextSections = sections;
        }
        else
        {
            // Create new configuration if it doesn't exist or is wrong type
            Question.Configuration = new TextQuestionConfiguration
            {
                TextSections = sections
            };
        }
    }


    private async Task RemoveTextSection(int index)
    {
        var sections = GetOrderedTextSections();
        if (index >= 0 && index < sections.Count)
        {
            var sectionName = string.IsNullOrWhiteSpace(sections[index].GetLocalizedTitleWithFallback(CurrentLanguage)) ? $"Text Section {index + 1}" : sections[index].GetLocalizedTitleWithFallback(CurrentLanguage);
            var confirmed = await DialogService.Confirm($"Are you sure you want to delete '{sectionName}'?", "Delete Text Section",
                new ConfirmOptions() { OkButtonText = "Yes", CancelButtonText = "No" });

            if (confirmed == true)
            {
                sections.RemoveAt(index);
                UpdateTextQuestionConfiguration(sections);
                StateHasChanged();
            }
        }
    }

    private void UpdateTextSectionTitle(int index, string value)
    {
        var sections = GetOrderedTextSections();
        if (index >= 0 && index < sections.Count)
        {
            if (CurrentLanguage == Language.German)
            {
                sections[index].TitleGerman = value ?? "";
            }
            else
            {
                sections[index].TitleEnglish = value ?? "";
            }
            UpdateTextQuestionConfiguration(sections);
            StateHasChanged();
        }
    }

    private void UpdateTextSectionDescription(int index, string value)
    {
        var sections = GetOrderedTextSections();
        if (index >= 0 && index < sections.Count)
        {
            if (CurrentLanguage == Language.German)
            {
                sections[index].DescriptionGerman = value ?? "";
            }
            else
            {
                sections[index].DescriptionEnglish = value ?? "";
            }
            UpdateTextQuestionConfiguration(sections);
            StateHasChanged();
        }
    }

    private void UpdateTextSectionTitleEnglish(int index, string value)
    {
        var sections = GetOrderedTextSections();
        if (index >= 0 && index < sections.Count)
        {
            sections[index].TitleEnglish = value ?? "";
            UpdateTextQuestionConfiguration(sections);
            StateHasChanged();
        }
    }

    private void UpdateTextSectionTitleGerman(int index, string value)
    {
        var sections = GetOrderedTextSections();
        if (index >= 0 && index < sections.Count)
        {
            sections[index].TitleGerman = value ?? "";
            UpdateTextQuestionConfiguration(sections);
            StateHasChanged();
        }
    }

    private void UpdateTextSectionDescriptionEnglish(int index, string value)
    {
        var sections = GetOrderedTextSections();
        if (index >= 0 && index < sections.Count)
        {
            sections[index].DescriptionEnglish = value ?? "";
            UpdateTextQuestionConfiguration(sections);
            StateHasChanged();
        }
    }

    private void UpdateTextSectionDescriptionGerman(int index, string value)
    {
        var sections = GetOrderedTextSections();
        if (index >= 0 && index < sections.Count)
        {
            sections[index].DescriptionGerman = value ?? "";
            UpdateTextQuestionConfiguration(sections);
            StateHasChanged();
        }
    }

    private void MoveTextSectionUp(int displayIndex)
    {
        var sections = GetOrderedTextSections();
        if (displayIndex > 0 && displayIndex < sections.Count)
        {
            // Simple array swap - exactly like the original working code
            (sections[displayIndex], sections[displayIndex - 1]) = (sections[displayIndex - 1], sections[displayIndex]);

            // Now update Order properties to match new positions
            for (int i = 0; i < sections.Count; i++)
            {
                sections[i].Order = i;
            }

            UpdateTextQuestionConfiguration(sections);
            StateHasChanged();
        }
    }

    private void MoveTextSectionDown(int displayIndex)
    {
        var sections = GetOrderedTextSections();
        if (displayIndex >= 0 && displayIndex < sections.Count - 1)
        {
            // Simple array swap - exactly like the original working code
            (sections[displayIndex], sections[displayIndex + 1]) = (sections[displayIndex + 1], sections[displayIndex]);

            // Now update Order properties to match new positions
            for (int i = 0; i < sections.Count; i++)
            {
                sections[i].Order = i;
            }

            UpdateTextQuestionConfiguration(sections);
            StateHasChanged();
        }
    }

    // Required flag methods for competencies
    private bool GetCompetencyRequired(int displayIndex)
    {
        var orderedCompetencies = GetOrderedEvaluations();
        if (displayIndex >= 0 && displayIndex < orderedCompetencies.Count)
        {
            return orderedCompetencies[displayIndex].IsRequired;
        }
        return false;
    }

    private async Task UpdateCompetencyRequired(int displayIndex, bool value)
    {
        var evaluations = GetOrderedEvaluations();
        if (displayIndex >= 0 && displayIndex < evaluations.Count)
        {
            evaluations[displayIndex].IsRequired = value;
            UpdateAssessmentConfiguration(evaluations);
            StateHasChanged();
            await OnRequiredChanged.InvokeAsync();
        }
    }

    private void MoveCompetencyUp(int displayIndex)
    {
        var evaluations = GetOrderedEvaluations();
        if (displayIndex > 0 && displayIndex < evaluations.Count)
        {
            // Simple array swap
            (evaluations[displayIndex], evaluations[displayIndex - 1]) = (evaluations[displayIndex - 1], evaluations[displayIndex]);

            // Update Order properties to match new positions
            for (int i = 0; i < evaluations.Count; i++)
            {
                evaluations[i].Order = i;
            }

            UpdateAssessmentConfiguration(evaluations);
            StateHasChanged();
        }
    }

    private void MoveCompetencyDown(int displayIndex)
    {
        var evaluations = GetOrderedEvaluations();
        if (displayIndex >= 0 && displayIndex < evaluations.Count - 1)
        {
            // Simple array swap
            (evaluations[displayIndex], evaluations[displayIndex + 1]) = (evaluations[displayIndex + 1], evaluations[displayIndex]);

            // Update Order properties to match new positions
            for (int i = 0; i < evaluations.Count; i++)
            {
                evaluations[i].Order = i;
            }

            UpdateAssessmentConfiguration(evaluations);
            StateHasChanged();
        }
    }

    // Required flag methods for goal categories
    private bool GetGoalCategoryRequired(int index)
    {
        var categories = GetGoalCategoriesFromConfiguration();
        if (index >= 0 && index < categories.Count)
        {
            return categories[index].IsRequired;
        }
        return false;
    }

    private async Task UpdateGoalCategoryRequired(int index, bool value)
    {
        var categories = GetGoalCategoriesFromConfiguration();
        if (index >= 0 && index < categories.Count)
        {
            categories[index].IsRequired = value;
            Question.Configuration["GoalCategories"] = categories;
            StateHasChanged();
            await OnRequiredChanged.InvokeAsync();
        }
    }

    private void MoveGoalCategoryUp(int displayIndex)
    {
        var categories = GetOrderedGoalCategories();
        if (displayIndex > 0 && displayIndex < categories.Count)
        {
            // Simple array swap - exactly like the original working code
            (categories[displayIndex], categories[displayIndex - 1]) = (categories[displayIndex - 1], categories[displayIndex]);

            // Now update Order properties to match new positions
            for (int i = 0; i < categories.Count; i++)
            {
                categories[i].Order = i;
            }

            Question.Configuration["GoalCategories"] = categories;
            StateHasChanged();
        }
    }

    private void MoveGoalCategoryDown(int displayIndex)
    {
        var categories = GetOrderedGoalCategories();
        if (displayIndex >= 0 && displayIndex < categories.Count - 1)
        {
            // Simple array swap - exactly like the original working code
            (categories[displayIndex], categories[displayIndex + 1]) = (categories[displayIndex + 1], categories[displayIndex]);

            // Now update Order properties to match new positions
            for (int i = 0; i < categories.Count; i++)
            {
                categories[i].Order = i;
            }

            Question.Configuration["GoalCategories"] = categories;
            StateHasChanged();
        }
    }

    // Required flag methods for text sections
    private bool GetTextSectionRequired(int index)
    {
        var sections = GetOrderedTextSections();
        if (index >= 0 && index < sections.Count)
        {
            return sections[index].IsRequired;
        }
        return false;
    }

    private async Task UpdateTextSectionRequired(int index, bool value)
    {
        var sections = GetOrderedTextSections();
        if (index >= 0 && index < sections.Count)
        {
            sections[index].IsRequired = value;
            UpdateTextQuestionConfiguration(sections);
            StateHasChanged();
            await OnRequiredChanged.InvokeAsync();
        }
    }

    // Helper method to update Assessment configuration
    private void UpdateAssessmentConfiguration(List<EvaluationItem> evaluations)
    {
        if (Question.Configuration is AssessmentConfiguration config)
        {
            config.Evaluations = evaluations;
        }
        else
        {
            // Create new configuration if it doesn't exist or is wrong type
            Question.Configuration = new AssessmentConfiguration
            {
                Evaluations = evaluations,
                RatingScale = 4,
                ScaleLowLabel = "Poor",
                ScaleHighLabel = "Excellent"
            };
        }
    }


    public class GoalCategory
    {
        // Bilingual content properties
        public string TitleEnglish { get; set; } = "";
        public string TitleGerman { get; set; } = "";
        public string DescriptionEnglish { get; set; } = "";
        public string DescriptionGerman { get; set; } = "";

        public bool IsRequired { get; set; } = false;
        public int Order { get; set; } = 0;

        // Helper methods for language-aware content display
        public string GetLocalizedTitle(Language language)
        {
            return language == Language.German ? TitleGerman : TitleEnglish;
        }

        public string GetLocalizedDescription(Language language)
        {
            return language == Language.German ? DescriptionGerman : DescriptionEnglish;
        }

        // Helper method to fallback to English if German is empty
        public string GetLocalizedTitleWithFallback(Language language)
        {
            var localized = GetLocalizedTitle(language);
            return !string.IsNullOrWhiteSpace(localized) ? localized : TitleEnglish;
        }

        public string GetLocalizedDescriptionWithFallback(Language language)
        {
            var localized = GetLocalizedDescription(language);
            return !string.IsNullOrWhiteSpace(localized) ? localized : DescriptionEnglish;
        }
    }
}