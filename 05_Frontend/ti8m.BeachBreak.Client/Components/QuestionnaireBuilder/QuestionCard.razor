@using Radzen
@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Components.Shared
@inject DialogService DialogService
@inherits OptimizedTranslatableComponentBase



<div class="evaluations-container">
        <!-- Assessment Configuration -->
        @if (Question.Type == QuestionType.Assessment)
        {
            var evaluations = GetOrderedEvaluations();
            <div class="evaluations-config">

                @if (evaluations.Count == 0)
                {
                    <div class="text-center p-3 text-muted">
                        <RadzenIcon Icon="self_improvement" Class="empty-state-evaluations-icon" />
                        <div class="mt-2 small">@T("messages.no-evaluations-configured")</div>
                    </div>
                }
                else
                {
                    @for (int i = 0; i < evaluations.Count; i++)
                    {
                        var evaluationIndex = i;
                        var evaluation = evaluations[evaluationIndex];

                        <div class="evaluation-item builder-context">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div class="d-flex align-items-center gap-3">
                                    <RadzenText TextStyle="TextStyle.Body2" Class="fw-bold mb-0">
                                        @T("labels.item") @(evaluationIndex + 1)
                                    </RadzenText>
                                    <div class="required-badge-container">
                                        <RadzenCheckBox Value="@GetEvaluationRequired(evaluationIndex)"
                                                       ValueChanged="@((bool value) => UpdateEvaluationRequired(evaluationIndex, value))"
                                                       Name="@($"eval_req_{Question.Id}_{evaluationIndex}")"
                                                       Disabled="@(!Template.IsAvailableForEditing)" />
                                        <RadzenLabel Text="@T("labels.required")" Component="@($"eval_req_{Question.Id}_{evaluationIndex}")" Class="ms-1" />
                                    </div>
                                </div>
                                <div class="d-flex gap-1">
                                    <AsyncButton ButtonStyle="ButtonStyle.Light"
                                                Icon="keyboard_arrow_up"
                                                Size="ButtonSize.ExtraSmall"
                                                Click="@(() => MoveEvaluationUp(evaluationIndex))"
                                                Disabled="@(evaluationIndex == 0 || !Template.IsAvailableForEditing)"
                                                Title="@T("tooltips.move-up")" />
                                    <AsyncButton ButtonStyle="ButtonStyle.Light"
                                                Icon="keyboard_arrow_down"
                                                Size="ButtonSize.ExtraSmall"
                                                Click="@(() => MoveEvaluationDown(evaluationIndex))"
                                                Disabled="@(evaluationIndex == evaluations.Count - 1 || !Template.IsAvailableForEditing)"
                                                Title="@T("tooltips.move-down")" />
                                    <AsyncButton ButtonStyle="ButtonStyle.Danger"
                                                ProcessingText="@T("messages.deleting")"
                                                Icon="delete_outline"
                                                Size="ButtonSize.ExtraSmall"
                                                Click="@(() => RemoveEvaluation(evaluationIndex))"
                                                Title="@T("tooltips.delete-item")"
                                                Disabled="@(!Template.IsAvailableForEditing)" />
                                </div>
                            </div>
                            <!-- Title Row -->
                            <div class="evaluation-title-section mb-2">
                                <div class="multilang-input-grid">
                                    <div class="input-field-container">
                                        <RadzenText TextStyle="TextStyle.Caption" Class="mb-1">@T("labels.english-title-required")</RadzenText>
                                        <RadzenTextBox Value="@evaluation.TitleEnglish"
                                                      ValueChanged="@((string value) => UpdateEvaluationTitleEnglish(evaluationIndex, value))"
                                                      Placeholder="@T("placeholders.enter-english-evaluation-title")"
                                                      Disabled="@(!Template.IsAvailableForEditing)"
                                                      Class="@GetEvaluationTitleValidationClass(evaluationIndex)"
                                                      @onblur="@(() => ValidateEvaluationTitle(evaluationIndex))" />
                                        @if (!GetEvaluationTitleValid(evaluationIndex) && GetEvaluationTitleValidated(evaluationIndex))
                                        {
                                            <div class="validation-message">
                                                <RadzenIcon Icon="error_outline" Class="validation-icon me-1" />
                                                @T("messages.english-item-title-required")
                                            </div>
                                        }
                                    </div>
                                    <div class="input-field-container">
                                        <RadzenText TextStyle="TextStyle.Caption" Class="mb-1">@T("labels.german-title-optional")</RadzenText>
                                        <RadzenTextBox Value="@evaluation.TitleGerman"
                                                      ValueChanged="@((string value) => UpdateEvaluationTitleGerman(evaluationIndex, value))"
                                                      Placeholder="@T("placeholders.enter-german-evaluation-title-optional")"
                                                      Disabled="@(!Template.IsAvailableForEditing)"
                                                      Class="w-100" />
                                    </div>
                                </div>
                            </div>
                            <!-- Description Row -->
                            <div class="multilang-input-grid mb-2">
                                <div class="input-field">
                                    <RadzenText TextStyle="TextStyle.Caption" Class="mb-1">@T("labels.english-description")</RadzenText>
                                    <RadzenTextArea Value="@evaluation.DescriptionEnglish"
                                                   ValueChanged="@((string value) => UpdateEvaluationDescriptionEnglish(evaluationIndex, value))"
                                                   Disabled="@(!Template.IsAvailableForEditing)"
                                                   Placeholder="@T("placeholders.describe-evaluation-english")"
                                                   Rows="2"
                                                   Class="w-100" />
                                </div>
                                <div class="input-field">
                                    <RadzenText TextStyle="TextStyle.Caption" Class="mb-1">@T("labels.german-description-optional")</RadzenText>
                                    <RadzenTextArea Value="@evaluation.DescriptionGerman"
                                                   ValueChanged="@((string value) => UpdateEvaluationDescriptionGerman(evaluationIndex, value))"
                                                   Disabled="@(!Template.IsAvailableForEditing)"
                                                   Placeholder="@T("placeholders.describe-evaluation-german-optional")"
                                                   Rows="2"
                                                   Class="w-100" />
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>
        }

        <!-- Goal Configuration -->
        @if (Question.Type == QuestionType.Goal)
        {
            <div class="goal-config p-4">
                <div class="text-center mb-3">
                    <RadzenIcon Icon="flag" Class="goal-config-icon mb-3" />
                    <RadzenText TextStyle="TextStyle.Body1" Class="mb-2 fw-bold">
                        @T("labels.goal-question-type")
                    </RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2" Class="text-muted mb-3">
                        @T("messages.no-goal-template-configuration-required")
                    </RadzenText>
                </div>

                <!-- Goal Section Visibility Toggle -->
                <div class="mb-3 p-3 border rounded bg-light">
                    <RadzenText TextStyle="TextStyle.Subtitle2" Class="mb-2 d-flex align-items-center">
                        <RadzenIcon Icon="visibility" Class="me-2" />
                        @T("labels.goal-section-visibility")
                    </RadzenText>
                    <div class="d-flex align-items-center">
                        <RadzenSwitch Value="@GetShowGoalSection()"
                                      ValueChanged="@((bool value) => SetShowGoalSection(value))"
                                      Class="me-2" />
                        <RadzenText TextStyle="TextStyle.Body2">
                            @(GetShowGoalSection() ? @T("messages.goal-section-visible") : @T("messages.goal-section-hidden"))
                        </RadzenText>
                    </div>
                    <RadzenText TextStyle="TextStyle.Caption" Class="text-muted mt-2 d-block">
                        @T("messages.goal-section-visibility-description")
                    </RadzenText>
                </div>

                <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" Class="mb-0 goal-workflow-alert" ShowIcon="false">
                    <RadzenText TextStyle="TextStyle.Caption" Class="d-block mb-1 goal-workflow-caption">
                        @T("messages.goals-added-dynamically-workflow")
                    </RadzenText>
                    <ul class="small mb-0 goal-workflow-list">
                        <li>@T("messages.goal-workflow-employee-manager")</li>
                        <li>@T("messages.goal-workflow-predecessor-linking")</li>
                        <li>@T("messages.goal-workflow-objective-timeframe")</li>
                    </ul>
                </RadzenAlert>
            </div>
        }

        <!-- Text Question Configuration -->
        @if (Question.Type == QuestionType.TextQuestion)
        {
            var textSections = GetOrderedTextSections();
            <div class="text-sections-config">
                @if (textSections.Count == 0)
                {
                    <div class="text-center p-3 text-muted">
                        <RadzenIcon Icon="psychology" Class="empty-state-text-icon" />
                        <div class="mt-2 small">@T("messages.no-text-sections-configured")</div>
                    </div>
                }
                else
                {
                    @for (int i = 0; i < textSections.Count; i++)
                    {
                        var sectionIndex = i;
                        var textSection = textSections[sectionIndex];

                        <div class="text-section-item rz-p-3 rz-mb-2">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="d-flex align-items-center gap-3">
                                    <RadzenText TextStyle="TextStyle.Body2" Class="fw-bold question-text-response">
                                        @T("labels.text-section") @(sectionIndex + 1)
                                    </RadzenText>
                                    <div class="required-badge-container">
                                        <RadzenCheckBox Value="@GetTextSectionRequired(sectionIndex)"
                                                       ValueChanged="@((bool value) => UpdateTextSectionRequired(sectionIndex, value))"
                                                       Name="@($"text_req_{Question.Id}_{sectionIndex}")"
                                                       Disabled="@(!Template.IsAvailableForEditing)" />
                                        <RadzenLabel Text="@T("labels.required")" Component="@($"text_req_{Question.Id}_{sectionIndex}")" Class="ms-1" />
                                    </div>
                                </div>
                                <div class="d-flex gap-1">
                                    <AsyncButton ButtonStyle="ButtonStyle.Light"
                                                Icon="keyboard_arrow_up"
                                                Size="ButtonSize.ExtraSmall"
                                                Click="@(() => MoveTextSectionUp(sectionIndex))"
                                                Disabled="@(sectionIndex == 0 || !Template.IsAvailableForEditing)"
                                                Title="@T("tooltips.move-up")" />
                                    <AsyncButton ButtonStyle="ButtonStyle.Light"
                                                Icon="keyboard_arrow_down"
                                                Size="ButtonSize.ExtraSmall"
                                                Click="@(() => MoveTextSectionDown(sectionIndex))"
                                                Disabled="@(sectionIndex == textSections.Count - 1 || !Template.IsAvailableForEditing)"
                                                Title="@T("tooltips.move-down")" />
                                    <AsyncButton ButtonStyle="ButtonStyle.Danger"
                                                ProcessingText="@T("messages.deleting")"
                                                Icon="delete"
                                                Size="ButtonSize.ExtraSmall"
                                                Click="@(() => RemoveTextSection(sectionIndex))"
                                                Title="@T("tooltips.delete")"
                                                Disabled="@(!Template.IsAvailableForEditing)" />
                                </div>
                            </div>
                            <!-- Title Row -->
                            <div class="text-section-title-row mb-2">
                                <div class="multilang-input-grid">
                                    <div class="input-field-container">
                                        <RadzenText TextStyle="TextStyle.Caption" Class="mb-1">@T("labels.english-title-required")</RadzenText>
                                        <RadzenTextBox Value="@textSection.TitleEnglish"
                                                      ValueChanged="@((string value) => UpdateTextSectionTitleEnglish(sectionIndex, value))"
                                                      Placeholder="@T("placeholders.enter-text-section-title-english")"
                                                      Disabled="@(!Template.IsAvailableForEditing)"
                                                      Class="@GetTextSectionTitleValidationClass(sectionIndex)"
                                                      @onblur="@(() => ValidateTextSectionTitle(sectionIndex))" />
                                        @if (!GetTextSectionTitleValid(sectionIndex) && GetTextSectionTitleValidated(sectionIndex))
                                        {
                                            <div class="validation-message">
                                                <RadzenIcon Icon="error_outline" Class="validation-icon me-1" />
                                                @T("messages.english-title-required")
                                            </div>
                                        }
                                    </div>
                                    <div class="input-field-container">
                                        <RadzenText TextStyle="TextStyle.Caption" Class="mb-1">@T("labels.german-title-optional")</RadzenText>
                                        <RadzenTextBox Value="@textSection.TitleGerman"
                                                      ValueChanged="@((string value) => UpdateTextSectionTitleGerman(sectionIndex, value))"
                                                      Placeholder="@T("placeholders.enter-text-section-title-german-optional")"
                                                      Disabled="@(!Template.IsAvailableForEditing)"
                                                      Class="w-100" />
                                    </div>
                                </div>
                            </div>
                            <!-- Description Row -->
                            <div class="multilang-input-grid mb-2">
                                <div class="input-field">
                                    <RadzenText TextStyle="TextStyle.Caption" Class="mb-1">@T("labels.english-description-required")</RadzenText>
                                    <RadzenTextArea Value="@textSection.DescriptionEnglish"
                                                   ValueChanged="@((string value) => UpdateTextSectionDescriptionEnglish(sectionIndex, value))"
                                                   Placeholder="@T("placeholders.describe-text-section-english")"
                                                   Rows="2"
                                                   Class="w-100" />
                                </div>
                                <div class="input-field">
                                    <RadzenText TextStyle="TextStyle.Caption" Class="mb-1">@T("labels.german-description-optional")</RadzenText>
                                    <RadzenTextArea Value="@textSection.DescriptionGerman"
                                                   ValueChanged="@((string value) => UpdateTextSectionDescriptionGerman(sectionIndex, value))"
                                                   Placeholder="@T("placeholders.describe-text-section-german-optional")"
                                                   Rows="2"
                                                   Class="w-100" />
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>
        }

        <!-- Question-level required flag is removed as individual items now have their own required flags -->
</div>

@code {
    [Parameter, EditorRequired] public QuestionItem Question { get; set; } = null!;
    [Parameter, EditorRequired] public QuestionnaireTemplate Template { get; set; } = null!;
    [Parameter, EditorRequired] public bool CanMoveUp { get; set; }
    [Parameter, EditorRequired] public bool CanMoveDown { get; set; }
    [Parameter, EditorRequired] public Dictionary<QuestionType, string> QuestionTypeLabels { get; set; } = null!;


    [Parameter] public EventCallback OnEdit { get; set; }
    [Parameter] public EventCallback OnMoveUp { get; set; }
    [Parameter] public EventCallback OnMoveDown { get; set; }
    [Parameter] public EventCallback OnDelete { get; set; }
    [Parameter] public EventCallback OnRequiredChanged { get; set; }

    // Validation state
    private bool isTitleValid = true;
    private bool hasBeenValidated = false;

    // Evaluation validation state
    private Dictionary<int, bool> evaluationTitleValid = new();
    private Dictionary<int, bool> evaluationTitleValidated = new();

    // Goal category validation state
    private Dictionary<int, bool> goalCategoryTitleValid = new();
    private Dictionary<int, bool> goalCategoryTitleValidated = new();

    // Text section validation state
    private Dictionary<int, bool> textSectionTitleValid = new();
    private Dictionary<int, bool> textSectionTitleValidated = new();

    private async Task OnEditClick() => await OnEdit.InvokeAsync();
    private async Task OnMoveUpClick() => await OnMoveUp.InvokeAsync();
    private async Task OnMoveDownClick() => await OnMoveDown.InvokeAsync();
    private async Task OnDeleteClick() => await OnDelete.InvokeAsync();

    // Validation methods
    private void ValidateTitle()
    {
        hasBeenValidated = true;
        isTitleValid = !string.IsNullOrWhiteSpace(Question.TitleEnglish) || !string.IsNullOrWhiteSpace(Question.TitleGerman);
        StateHasChanged();
    }

    private string GetTitleValidationClass()
    {
        var baseClass = "w-100";
        if (hasBeenValidated && !isTitleValid)
        {
            return $"{baseClass} border-danger";
        }
        return baseClass;
    }

    public bool IsQuestionValid()
    {
        ValidateTitle();

        // Validate question content based on type
        bool contentValid = true;

        if (Question.Type == QuestionType.Assessment)
        {
            var evaluations = GetOrderedEvaluations();
            for (int i = 0; i < evaluations.Count; i++)
            {
                ValidateEvaluationTitle(i);
                if (!GetEvaluationTitleValid(i))
                    contentValid = false;
            }
        }
        else if (Question.Type == QuestionType.Goal)
        {
            // Goal questions don't use template items - always valid
            contentValid = true;
        }
        else if (Question.Type == QuestionType.TextQuestion)
        {
            var sections = GetOrderedTextSections();
            for (int i = 0; i < sections.Count; i++)
            {
                ValidateTextSectionTitle(i);
                if (!GetTextSectionTitleValid(i))
                    contentValid = false;
            }
        }

        return isTitleValid && contentValid;
    }

    // Evaluation validation methods
    private void ValidateEvaluationTitle(int index)
    {
        var evaluations = GetOrderedEvaluations();
        if (index >= 0 && index < evaluations.Count)
        {
            evaluationTitleValidated[index] = true;
            evaluationTitleValid[index] = !string.IsNullOrWhiteSpace(evaluations[index].TitleEnglish);
            StateHasChanged();
        }
    }

    private bool GetEvaluationTitleValid(int index)
    {
        return evaluationTitleValid.GetValueOrDefault(index, true);
    }

    private bool GetEvaluationTitleValidated(int index)
    {
        return evaluationTitleValidated.GetValueOrDefault(index, false);
    }

    private string GetEvaluationTitleValidationClass(int index)
    {
        var baseClass = "w-100 mb-2";
        if (GetEvaluationTitleValidated(index) && !GetEvaluationTitleValid(index))
        {
            return $"{baseClass} border-danger";
        }
        return baseClass;
    }

    // Goal category validation methods
    private void ValidateGoalCategoryTitle(int index)
    {
        var categories = GetOrderedGoalCategories();
        if (index >= 0 && index < categories.Count)
        {
            goalCategoryTitleValidated[index] = true;
            goalCategoryTitleValid[index] = !string.IsNullOrWhiteSpace(categories[index].TitleEnglish);
            StateHasChanged();
        }
    }

    private bool GetGoalCategoryTitleValid(int index)
    {
        return goalCategoryTitleValid.GetValueOrDefault(index, true);
    }

    private bool GetGoalCategoryTitleValidated(int index)
    {
        return goalCategoryTitleValidated.GetValueOrDefault(index, false);
    }

    private string GetGoalCategoryTitleValidationClass(int index)
    {
        var baseClass = "w-100 mb-2";
        if (GetGoalCategoryTitleValidated(index) && !GetGoalCategoryTitleValid(index))
        {
            return $"{baseClass} border-danger";
        }
        return baseClass;
    }

    // Text section validation methods
    private void ValidateTextSectionTitle(int index)
    {
        var sections = GetOrderedTextSections();
        if (index >= 0 && index < sections.Count)
        {
            textSectionTitleValidated[index] = true;
            textSectionTitleValid[index] = !string.IsNullOrWhiteSpace(sections[index].TitleEnglish);
            StateHasChanged();
        }
    }

    private bool GetTextSectionTitleValid(int index)
    {
        return textSectionTitleValid.GetValueOrDefault(index, true);
    }

    private bool GetTextSectionTitleValidated(int index)
    {
        return textSectionTitleValidated.GetValueOrDefault(index, false);
    }

    private string GetTextSectionTitleValidationClass(int index)
    {
        var baseClass = "w-100 mb-2";
        if (GetTextSectionTitleValidated(index) && !GetTextSectionTitleValid(index))
        {
            return $"{baseClass} border-danger";
        }
        return baseClass;
    }

    private string GetQuestionTypeIcon(QuestionType type) => type switch
    {
        QuestionType.Assessment => "self_improvement",
        QuestionType.Goal => "track_changes",
        QuestionType.TextQuestion => "psychology",
        _ => "help"
    };


    // Assessment methods

    private List<EvaluationItem> GetOrderedEvaluations()
    {
        if (Question.Configuration is AssessmentConfiguration config)
        {
            return config.Evaluations.OrderBy(e => e.Order).ToList();
        }
        return new List<EvaluationItem>();
    }


    private async Task RemoveEvaluation(int displayIndex)
    {
        var orderedEvaluations = GetOrderedEvaluations();
        if (displayIndex >= 0 && displayIndex < orderedEvaluations.Count)
        {
            var evaluationToRemove = orderedEvaluations[displayIndex];
            var evaluationName = string.IsNullOrWhiteSpace(evaluationToRemove.TitleEnglish) ? $"Item {displayIndex + 1}" : evaluationToRemove.TitleEnglish;
            var confirmed = await DialogService.Confirm($"{T("dialogs.confirm-delete-evaluation").Replace("{0}", evaluationName)}", T("dialogs.delete-item-title"),
                new ConfirmOptions() { OkButtonText = T("buttons.yes"), CancelButtonText = T("buttons.no") });

            if (confirmed == true)
            {
                var allEvaluations = GetOrderedEvaluations();
                allEvaluations.Remove(evaluationToRemove);
                UpdateAssessmentConfiguration(allEvaluations);
                StateHasChanged();
            }
        }
    }

    private void UpdateEvaluationTitleEnglish(int displayIndex, string value)
    {
        var evaluations = GetOrderedEvaluations();
        if (displayIndex >= 0 && displayIndex < evaluations.Count)
        {
            evaluations[displayIndex].TitleEnglish = value ?? "";
            UpdateAssessmentConfiguration(evaluations);
            StateHasChanged();
        }
    }

    private void UpdateEvaluationTitleGerman(int displayIndex, string value)
    {
        var evaluations = GetOrderedEvaluations();
        if (displayIndex >= 0 && displayIndex < evaluations.Count)
        {
            evaluations[displayIndex].TitleGerman = value ?? "";
            UpdateAssessmentConfiguration(evaluations);
            StateHasChanged();
        }
    }

    private void UpdateEvaluationDescriptionEnglish(int displayIndex, string value)
    {
        var evaluations = GetOrderedEvaluations();
        if (displayIndex >= 0 && displayIndex < evaluations.Count)
        {
            evaluations[displayIndex].DescriptionEnglish = value ?? "";
            UpdateAssessmentConfiguration(evaluations);
            StateHasChanged();
        }
    }

    private void UpdateEvaluationDescriptionGerman(int displayIndex, string value)
    {
        var evaluations = GetOrderedEvaluations();
        if (displayIndex >= 0 && displayIndex < evaluations.Count)
        {
            evaluations[displayIndex].DescriptionGerman = value ?? "";
            UpdateAssessmentConfiguration(evaluations);
            StateHasChanged();
        }
    }

    // Goal Achievement methods
    // NOTE: Goal questions don't use template configuration - goals are added dynamically during workflow execution
    // These methods are legacy code and always return empty lists
    private List<GoalCategory> GetGoalCategoriesFromConfiguration()
    {
        // Goal questions use GoalConfiguration with ShowGoalSection flag only
        // No template-level goal categories
        return new List<GoalCategory>();
    }

    private List<GoalCategory> GetOrderedGoalCategories()
    {
        var categories = GetGoalCategoriesFromConfiguration();
        return categories.OrderBy(c => c.Order).ToList();
    }

    // Goal Configuration - ShowGoalSection visibility toggle
    private bool GetShowGoalSection()
    {
        if (Question.Configuration is GoalConfiguration config)
        {
            return config.ShowGoalSection;
        }
        return true; // Default to visible
    }

    private void SetShowGoalSection(bool value)
    {
        if (Question.Configuration is GoalConfiguration config)
        {
            config.ShowGoalSection = value;
        }
        else
        {
            // Initialize configuration if it doesn't exist
            Question.Configuration = new GoalConfiguration
            {
                ShowGoalSection = value
            };
        }
        StateHasChanged();
    }


    private async Task RemoveGoalCategory(int index)
    {
        var categories = GetGoalCategoriesFromConfiguration();
        if (index >= 0 && index < categories.Count)
        {
            var categoryName = string.IsNullOrWhiteSpace(categories[index].GetLocalizedTitleWithFallback(CurrentLanguage)) ? $"Goal Category {index + 1}" : categories[index].GetLocalizedTitleWithFallback(CurrentLanguage);
            var confirmed = await DialogService.Confirm($"{T("dialogs.confirm-delete-goal-category").Replace("{0}", categoryName)}", T("dialogs.delete-goal-category-title"),
                new ConfirmOptions() { OkButtonText = T("buttons.yes"), CancelButtonText = T("buttons.no") });

            if (confirmed == true)
            {
                categories.RemoveAt(index);
                // No-op: Goal questions don't use template configuration
                StateHasChanged();
            }
        }
    }

    private void UpdateGoalCategoryTitle(int index, string value)
    {
        var categories = GetGoalCategoriesFromConfiguration();
        if (index >= 0 && index < categories.Count)
        {
            if (CurrentLanguage == Language.German)
            {
                categories[index].TitleGerman = value ?? "";
            }
            else
            {
                categories[index].TitleEnglish = value ?? "";
            }
            // No-op: Goal questions don't use template configuration
            StateHasChanged();
        }
    }

    private void UpdateGoalCategoryDescription(int index, string value)
    {
        var categories = GetGoalCategoriesFromConfiguration();
        if (index >= 0 && index < categories.Count)
        {
            if (CurrentLanguage == Language.German)
            {
                categories[index].DescriptionGerman = value ?? "";
            }
            else
            {
                categories[index].DescriptionEnglish = value ?? "";
            }
            // No-op: Goal questions don't use template configuration
            StateHasChanged();
        }
    }

    private void UpdateGoalCategoryTitleEnglish(int index, string value)
    {
        var categories = GetGoalCategoriesFromConfiguration();
        if (index >= 0 && index < categories.Count)
        {
            categories[index].TitleEnglish = value ?? "";
            // No-op: Goal questions don't use template configuration
            StateHasChanged();
        }
    }

    private void UpdateGoalCategoryTitleGerman(int index, string value)
    {
        var categories = GetGoalCategoriesFromConfiguration();
        if (index >= 0 && index < categories.Count)
        {
            categories[index].TitleGerman = value ?? "";
            // No-op: Goal questions don't use template configuration
            StateHasChanged();
        }
    }

    private void UpdateGoalCategoryDescriptionEnglish(int index, string value)
    {
        var categories = GetGoalCategoriesFromConfiguration();
        if (index >= 0 && index < categories.Count)
        {
            categories[index].DescriptionEnglish = value ?? "";
            // No-op: Goal questions don't use template configuration
            StateHasChanged();
        }
    }

    private void UpdateGoalCategoryDescriptionGerman(int index, string value)
    {
        var categories = GetGoalCategoriesFromConfiguration();
        if (index >= 0 && index < categories.Count)
        {
            categories[index].DescriptionGerman = value ?? "";
            // No-op: Goal questions don't use template configuration
            StateHasChanged();
        }
    }

    // Text Question methods
    private List<TextSection> GetOrderedTextSections()
    {
        if (Question.Configuration is TextQuestionConfiguration config)
        {
            return config.TextSections.OrderBy(s => s.Order).ToList();
        }
        return new List<TextSection>();
    }

    private void UpdateTextQuestionConfiguration(List<TextSection> sections)
    {
        if (Question.Configuration is TextQuestionConfiguration config)
        {
            config.TextSections = sections;
        }
        else
        {
            // Create new configuration if it doesn't exist or is wrong type
            Question.Configuration = new TextQuestionConfiguration
            {
                TextSections = sections
            };
        }
    }


    private async Task RemoveTextSection(int index)
    {
        var sections = GetOrderedTextSections();
        if (index >= 0 && index < sections.Count)
        {
            var sectionName = string.IsNullOrWhiteSpace(sections[index].GetLocalizedTitleWithFallback(CurrentLanguage)) ? $"Text Section {index + 1}" : sections[index].GetLocalizedTitleWithFallback(CurrentLanguage);
            var confirmed = await DialogService.Confirm($"{T("dialogs.confirm-delete-text-section").Replace("{0}", sectionName)}", T("dialogs.delete-text-section-title"),
                new ConfirmOptions() { OkButtonText = T("buttons.yes"), CancelButtonText = T("buttons.no") });

            if (confirmed == true)
            {
                sections.RemoveAt(index);
                UpdateTextQuestionConfiguration(sections);
                StateHasChanged();
            }
        }
    }

    private void UpdateTextSectionTitle(int index, string value)
    {
        var sections = GetOrderedTextSections();
        if (index >= 0 && index < sections.Count)
        {
            if (CurrentLanguage == Language.German)
            {
                sections[index].TitleGerman = value ?? "";
            }
            else
            {
                sections[index].TitleEnglish = value ?? "";
            }
            UpdateTextQuestionConfiguration(sections);
            StateHasChanged();
        }
    }

    private void UpdateTextSectionDescription(int index, string value)
    {
        var sections = GetOrderedTextSections();
        if (index >= 0 && index < sections.Count)
        {
            if (CurrentLanguage == Language.German)
            {
                sections[index].DescriptionGerman = value ?? "";
            }
            else
            {
                sections[index].DescriptionEnglish = value ?? "";
            }
            UpdateTextQuestionConfiguration(sections);
            StateHasChanged();
        }
    }

    private void UpdateTextSectionTitleEnglish(int index, string value)
    {
        var sections = GetOrderedTextSections();
        if (index >= 0 && index < sections.Count)
        {
            sections[index].TitleEnglish = value ?? "";
            UpdateTextQuestionConfiguration(sections);
            StateHasChanged();
        }
    }

    private void UpdateTextSectionTitleGerman(int index, string value)
    {
        var sections = GetOrderedTextSections();
        if (index >= 0 && index < sections.Count)
        {
            sections[index].TitleGerman = value ?? "";
            UpdateTextQuestionConfiguration(sections);
            StateHasChanged();
        }
    }

    private void UpdateTextSectionDescriptionEnglish(int index, string value)
    {
        var sections = GetOrderedTextSections();
        if (index >= 0 && index < sections.Count)
        {
            sections[index].DescriptionEnglish = value ?? "";
            UpdateTextQuestionConfiguration(sections);
            StateHasChanged();
        }
    }

    private void UpdateTextSectionDescriptionGerman(int index, string value)
    {
        var sections = GetOrderedTextSections();
        if (index >= 0 && index < sections.Count)
        {
            sections[index].DescriptionGerman = value ?? "";
            UpdateTextQuestionConfiguration(sections);
            StateHasChanged();
        }
    }

    private void MoveTextSectionUp(int displayIndex)
    {
        var sections = GetOrderedTextSections();
        if (displayIndex > 0 && displayIndex < sections.Count)
        {
            // Simple array swap - exactly like the original working code
            (sections[displayIndex], sections[displayIndex - 1]) = (sections[displayIndex - 1], sections[displayIndex]);

            // Now update Order properties to match new positions
            for (int i = 0; i < sections.Count; i++)
            {
                sections[i].Order = i;
            }

            UpdateTextQuestionConfiguration(sections);
            StateHasChanged();
        }
    }

    private void MoveTextSectionDown(int displayIndex)
    {
        var sections = GetOrderedTextSections();
        if (displayIndex >= 0 && displayIndex < sections.Count - 1)
        {
            // Simple array swap - exactly like the original working code
            (sections[displayIndex], sections[displayIndex + 1]) = (sections[displayIndex + 1], sections[displayIndex]);

            // Now update Order properties to match new positions
            for (int i = 0; i < sections.Count; i++)
            {
                sections[i].Order = i;
            }

            UpdateTextQuestionConfiguration(sections);
            StateHasChanged();
        }
    }

    // Required flag methods for evaluations
    private bool GetEvaluationRequired(int displayIndex)
    {
        var orderedEvaluations = GetOrderedEvaluations();
        if (displayIndex >= 0 && displayIndex < orderedEvaluations.Count)
        {
            return orderedEvaluations[displayIndex].IsRequired;
        }
        return false;
    }

    private async Task UpdateEvaluationRequired(int displayIndex, bool value)
    {
        var evaluations = GetOrderedEvaluations();
        if (displayIndex >= 0 && displayIndex < evaluations.Count)
        {
            evaluations[displayIndex].IsRequired = value;
            UpdateAssessmentConfiguration(evaluations);
            StateHasChanged();
            await OnRequiredChanged.InvokeAsync();
        }
    }

    private void MoveEvaluationUp(int displayIndex)
    {
        var evaluations = GetOrderedEvaluations();
        if (displayIndex > 0 && displayIndex < evaluations.Count)
        {
            // Simple array swap
            (evaluations[displayIndex], evaluations[displayIndex - 1]) = (evaluations[displayIndex - 1], evaluations[displayIndex]);

            // Update Order properties to match new positions
            for (int i = 0; i < evaluations.Count; i++)
            {
                evaluations[i].Order = i;
            }

            UpdateAssessmentConfiguration(evaluations);
            StateHasChanged();
        }
    }

    private void MoveEvaluationDown(int displayIndex)
    {
        var evaluations = GetOrderedEvaluations();
        if (displayIndex >= 0 && displayIndex < evaluations.Count - 1)
        {
            // Simple array swap
            (evaluations[displayIndex], evaluations[displayIndex + 1]) = (evaluations[displayIndex + 1], evaluations[displayIndex]);

            // Update Order properties to match new positions
            for (int i = 0; i < evaluations.Count; i++)
            {
                evaluations[i].Order = i;
            }

            UpdateAssessmentConfiguration(evaluations);
            StateHasChanged();
        }
    }

    // Required flag methods for goal categories
    private bool GetGoalCategoryRequired(int index)
    {
        var categories = GetGoalCategoriesFromConfiguration();
        if (index >= 0 && index < categories.Count)
        {
            return categories[index].IsRequired;
        }
        return false;
    }

    private async Task UpdateGoalCategoryRequired(int index, bool value)
    {
        var categories = GetGoalCategoriesFromConfiguration();
        if (index >= 0 && index < categories.Count)
        {
            categories[index].IsRequired = value;
            // No-op: Goal questions don't use template configuration
            StateHasChanged();
            await OnRequiredChanged.InvokeAsync();
        }
    }

    private void MoveGoalCategoryUp(int displayIndex)
    {
        var categories = GetOrderedGoalCategories();
        if (displayIndex > 0 && displayIndex < categories.Count)
        {
            // Simple array swap - exactly like the original working code
            (categories[displayIndex], categories[displayIndex - 1]) = (categories[displayIndex - 1], categories[displayIndex]);

            // Now update Order properties to match new positions
            for (int i = 0; i < categories.Count; i++)
            {
                categories[i].Order = i;
            }

            // No-op: Goal questions don't use template configuration
            StateHasChanged();
        }
    }

    private void MoveGoalCategoryDown(int displayIndex)
    {
        var categories = GetOrderedGoalCategories();
        if (displayIndex >= 0 && displayIndex < categories.Count - 1)
        {
            // Simple array swap - exactly like the original working code
            (categories[displayIndex], categories[displayIndex + 1]) = (categories[displayIndex + 1], categories[displayIndex]);

            // Now update Order properties to match new positions
            for (int i = 0; i < categories.Count; i++)
            {
                categories[i].Order = i;
            }

            // No-op: Goal questions don't use template configuration
            StateHasChanged();
        }
    }

    // Required flag methods for text sections
    private bool GetTextSectionRequired(int index)
    {
        var sections = GetOrderedTextSections();
        if (index >= 0 && index < sections.Count)
        {
            return sections[index].IsRequired;
        }
        return false;
    }

    private async Task UpdateTextSectionRequired(int index, bool value)
    {
        var sections = GetOrderedTextSections();
        if (index >= 0 && index < sections.Count)
        {
            sections[index].IsRequired = value;
            UpdateTextQuestionConfiguration(sections);
            StateHasChanged();
            await OnRequiredChanged.InvokeAsync();
        }
    }

    // Helper method to update Assessment configuration
    private void UpdateAssessmentConfiguration(List<EvaluationItem> evaluations)
    {
        if (Question.Configuration is AssessmentConfiguration config)
        {
            config.Evaluations = evaluations;
        }
        else
        {
            // Create new configuration if it doesn't exist or is wrong type
            Question.Configuration = new AssessmentConfiguration
            {
                Evaluations = evaluations,
                RatingScale = 4,
                ScaleLowLabel = "Poor",
                ScaleHighLabel = "Excellent"
            };
        }
    }


    public class GoalCategory
    {
        // Bilingual content properties
        public string TitleEnglish { get; set; } = "";
        public string TitleGerman { get; set; } = "";
        public string DescriptionEnglish { get; set; } = "";
        public string DescriptionGerman { get; set; } = "";

        public bool IsRequired { get; set; } = false;
        public int Order { get; set; } = 0;

        // Helper methods for language-aware content display
        public string GetLocalizedTitle(Language language)
        {
            return language == Language.German ? TitleGerman : TitleEnglish;
        }

        public string GetLocalizedDescription(Language language)
        {
            return language == Language.German ? DescriptionGerman : DescriptionEnglish;
        }

        // Helper method to fallback to English if German is empty
        public string GetLocalizedTitleWithFallback(Language language)
        {
            var localized = GetLocalizedTitle(language);
            return !string.IsNullOrWhiteSpace(localized) ? localized : TitleEnglish;
        }

        public string GetLocalizedDescriptionWithFallback(Language language)
        {
            var localized = GetLocalizedDescription(language);
            return !string.IsNullOrWhiteSpace(localized) ? localized : DescriptionEnglish;
        }
    }
}