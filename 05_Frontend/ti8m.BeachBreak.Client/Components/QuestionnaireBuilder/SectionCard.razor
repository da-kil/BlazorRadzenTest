@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Components.QuestionnaireBuilder
@using System.Collections

<div class="section-card mb-4">
    <!-- Section Header -->
    <div class="section-header">
        <div class="section-content p-3 position-relative">
            <!-- Action Buttons -->
            <div class="position-absolute" style="top: 0.75rem; right: 0.75rem;">
                <div class="d-flex gap-1">
                    <RadzenButton ButtonStyle="ButtonStyle.Light"
                                 Icon="keyboard_arrow_up"
                                 Size="ButtonSize.ExtraSmall"
                                 Click="@(() => OnMoveUpClick())"
                                 Disabled="@(!CanMoveUp)"
                                 Title="Move section up" />
                    <RadzenButton ButtonStyle="ButtonStyle.Light"
                                 Icon="keyboard_arrow_down"
                                 Size="ButtonSize.ExtraSmall"
                                 Click="@(() => OnMoveDownClick())"
                                 Disabled="@(!CanMoveDown)"
                                 Title="Move section down" />
                    <RadzenButton ButtonStyle="ButtonStyle.Danger"
                                 Icon="delete_outline"
                                 Size="ButtonSize.ExtraSmall"
                                 Click="@(() => OnDeleteClick())"
                                 Title="Delete section" />
                </div>
            </div>

            <!-- Section Type Indicator -->
            <div class="mb-3" style="padding-right: 6.5rem;">
                <div class="d-flex align-items-center gap-3 mb-2">
                    <div class="section-type-badge d-flex align-items-center gap-2 px-2 py-1 rounded-pill"
                         style="@($"background-color: {GetSectionTypeColor()}15; border: 1px solid {GetSectionTypeColor()}30;")">
                        <RadzenIcon Icon="@GetSectionTypeIcon()" Style="@($"color: {GetSectionTypeColor()};")" Class="fs-6" />
                        <span class="small fw-medium" style="@($"color: {GetSectionTypeColor()};")">@GetSectionTypeName()</span>
                    </div>
                    <div class="completion-role-badge d-flex align-items-center gap-1 px-2 py-1 rounded-pill"
                         style="@($"background-color: {Section.GetRoleColor()}15; border: 1px solid {Section.GetRoleColor()}30;")">
                        <RadzenIcon Icon="@Section.GetRoleIcon()" Style="@($"color: {Section.GetRoleColor()};")" Class="fs-6" />
                        <span class="small fw-medium" style="@($"color: {Section.GetRoleColor()};")">@GetCompletionRoleText()</span>
                    </div>
                </div>

                <!-- Role Assignment Selector -->
                <div class="role-selector mb-2">
                    <RadzenText TextStyle="TextStyle.Caption" Class="mb-1 text-muted">Who completes this section?</RadzenText>
                    <RadzenRadioButtonList @bind-Value="@Section.AssignedTo"
                                           Data="@roleOptions"
                                           TextProperty="Text"
                                           ValueProperty="Value"
                                           Orientation="Radzen.Orientation.Horizontal"
                                           Class="role-select-list" />
                </div>
            </div>

            <!-- Title Input -->
            <div class="mb-3" style="padding-right: 6.5rem;">
                <RadzenTextBox Value="@Section.Title"
                             ValueChanged="@(value => OnSectionTitleChanged(value))"
                             Placeholder="e.g., Performance Review 2023, Goal Setting Workshop..."
                             Class="section-title-input"
                             Style="font-size: 1.1rem; font-weight: 600;" />
            </div>

            <!-- Description Input -->
            <div class="mb-3" style="padding-right: 6.5rem;">
                <RadzenTextArea Value="@Section.Description"
                              ValueChanged="@(value => OnSectionDescriptionChanged(value))"
                              Placeholder="Provide context about this section's purpose. What will participants accomplish here?"
                              Class="section-description-input"
                              Rows="2" />
            </div>

            <!-- Rating Scale Configuration - only for Self-Assessment sections -->
            @if (Section.Questions.Any() && Section.Questions.First().Type == QuestionType.SelfAssessment)
            {
                var firstQuestion = Section.Questions.First();
                <div class="rating-scale-config mb-3 p-3 bg-light rounded">
                    <div class="d-flex align-items-center mb-3">
                        <RadzenIcon Icon="tune" Style="color: var(--primary-color);" Class="me-2" />
                        <RadzenText TextStyle="TextStyle.Body1" Class="fw-bold mb-0">Rating Scale</RadzenText>
                    </div>
                    <div class="row g-2">
                        <div class="col-md-3">
                            <RadzenText TextStyle="TextStyle.Caption" Class="mb-1 text-muted">Scale</RadzenText>
                            <RadzenDropDown Value="@GetRatingScale(firstQuestion)"
                                           ValueChanged="@((int value) => SetRatingScale(firstQuestion, value))"
                                           Data="@(new List<int> { 3, 4, 5, 7, 10 })"
                                           Class="w-100" />
                        </div>
                        <div class="col-md-4">
                            <RadzenText TextStyle="TextStyle.Caption" Class="mb-1 text-muted">Low Label</RadzenText>
                            <RadzenTextBox Value="@GetScaleLowLabel(firstQuestion)"
                                          ValueChanged="@((string value) => SetScaleLowLabel(firstQuestion, value))"
                                          Placeholder="e.g., Poor, Beginner"
                                          Class="w-100" />
                        </div>
                        <div class="col-md-4">
                            <RadzenText TextStyle="TextStyle.Caption" Class="mb-1 text-muted">High Label</RadzenText>
                            <RadzenTextBox Value="@GetScaleHighLabel(firstQuestion)"
                                          ValueChanged="@((string value) => SetScaleHighLabel(firstQuestion, value))"
                                          Placeholder="e.g., Excellent, Expert"
                                          Class="w-100" />
                        </div>
                    </div>
                </div>
            }

            <!-- Simplified Section Stats -->
            @if (GetItemCount() > 0)
            {
                <div class="section-stats mb-2">
                    <div class="d-flex align-items-center gap-3 text-muted small">
                        <span class="d-flex align-items-center gap-1">
                            <RadzenIcon Icon="quiz" Class="fs-6" />
                            <strong>@GetItemCount()</strong> items
                        </span>
                        <span class="d-flex align-items-center gap-1">
                            <RadzenIcon Icon="star" Class="fs-6" />
                            <strong>@GetRequiredItemCount()</strong> required
                        </span>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Items Area -->
    <div class="items-area p-3 pt-0">
        <div class="items-header mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <RadzenText TextStyle="TextStyle.Subtitle2" Class="fw-bold mb-0 d-flex align-items-center">
                    <RadzenIcon Icon="@GetSectionTypeIcon()" Style="@($"color: {GetSectionTypeColor()};")" Class="me-2" />
                    @GetSectionTypeName() Items
                </RadzenText>
                <RadzenButton Text="Add Item"
                             ButtonStyle="ButtonStyle.Primary"
                             Icon="add_circle_outline"
                             Size="ButtonSize.Small"
                             Click="@(() => OnAddItemClick())" />
            </div>
        </div>


        @* Question Type Selection - Only show if section has no questions yet *@
        @if (ShowQuestionTypeSelection && !Section.Questions.Any())
        {
            <div class="question-type-selection mb-4">
                <div class="border-2 rounded p-0" style="border-color: var(--primary-color);">
                    <div class="p-3 rounded-top" style="background: var(--light-gray);">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <RadzenText TextStyle="TextStyle.Body1" Class="fw-bold mb-1" style="color: var(--primary-color);">
                                    <RadzenIcon Icon="add_circle" Class="me-2" />
                                    Choose Question Type
                                </RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption" Class="text-muted">
                                    Select the type of question you want to add to this section
                                </RadzenText>
                            </div>
                            <RadzenButton Icon="close"
                                         ButtonStyle="ButtonStyle.Light"
                                         Size="ButtonSize.Small"
                                         Click="@(() => OnCancelQuestionTypeSelection())"
                                         Title="Cancel" />
                        </div>
                    </div>
                    <div class="p-4">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="question-type-card self-assessment h-100 p-4 rounded-3 border-2 text-center position-relative cursor-pointer shadow-sm user-select-none"
                                     style="transition: all 0.15s ease-in-out; transform: scale(1);"
                                     @onclick="async () => await OnAddQuestionOfType(QuestionType.SelfAssessment)"
                                     onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 8px 25px rgba(15, 105, 255, 0.15)'; this.style.borderColor='var(--primary-color)'"
                                     onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 0.125rem 0.25rem rgba(0, 0, 0, 0.075)'; this.style.borderColor='var(--primary-color)'"
                                     onmousedown="this.style.transform='scale(0.98)'"
                                     onmouseup="this.style.transform='scale(1.02)'"
                                     tabindex="0"
                                     role="button"
                                     aria-label="Add Self-Assessment Question">
                                    <div class="position-absolute top-0 start-50 translate-middle">
                                        <div class="bg-self-assessment text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 24px; height: 24px; font-size: 0.75rem;">
                                            <RadzenIcon Icon="add" />
                                        </div>
                                    </div>
                                    <RadzenIcon Icon="self_improvement" Class="question-self-assessment fs-1 mb-3 mt-2" />
                                    <RadzenText TextStyle="TextStyle.Subtitle2" Class="fw-bold question-self-assessment mb-2">
                                        Self-Assessment
                                    </RadzenText>
                                    <RadzenText TextStyle="TextStyle.Caption" Class="text-muted mb-2">
                                        Rate competencies and skills on a scale
                                    </RadzenText>
                                    <div class="mt-3">
                                        <span class="badge badge-self-assessment px-2 py-1" style="font-size: 0.7rem;">Click to Add</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="question-type-card goal-achievement h-100 p-4 rounded-3 border-2 text-center position-relative cursor-pointer shadow-sm user-select-none"
                                     style="transition: all 0.15s ease-in-out; transform: scale(1);"
                                     @onclick="async () => await OnAddQuestionOfType(QuestionType.GoalAchievement)"
                                     onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 8px 25px rgba(230, 191, 127, 0.15)'; this.style.borderColor='var(--golden-milk)'"
                                     onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 0.125rem 0.25rem rgba(0, 0, 0, 0.075)'; this.style.borderColor='var(--warning-color)'"
                                     onmousedown="this.style.transform='scale(0.98)'"
                                     onmouseup="this.style.transform='scale(1.02)'"
                                     tabindex="0"
                                     role="button"
                                     aria-label="Add Goal Review Question">
                                    <div class="position-absolute top-0 start-50 translate-middle">
                                        <div class="bg-goal-achievement text-dark rounded-circle d-flex align-items-center justify-content-center" style="width: 24px; height: 24px; font-size: 0.75rem;">
                                            <RadzenIcon Icon="add" />
                                        </div>
                                    </div>
                                    <RadzenIcon Icon="track_changes" Class="question-goal-achievement fs-1 mb-3 mt-2" />
                                    <RadzenText TextStyle="TextStyle.Subtitle2" Class="fw-bold question-goal-achievement mb-2">
                                        Goal Review
                                    </RadzenText>
                                    <RadzenText TextStyle="TextStyle.Caption" Class="text-muted mb-2">
                                        Track progress and achievement status
                                    </RadzenText>
                                    <div class="mt-3">
                                        <span class="badge badge-goal-achievement px-2 py-1" style="font-size: 0.7rem;">Click to Add</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="question-type-card text-response h-100 p-4 rounded-3 border-2 text-center position-relative cursor-pointer shadow-sm user-select-none"
                                     style="transition: all 0.15s ease-in-out; transform: scale(1);"
                                     @onclick="async () => await OnAddQuestionOfType(QuestionType.TextQuestion)"
                                     onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 8px 25px rgba(147, 91, 169, 0.15)'; this.style.borderColor='var(--purple-rain)'"
                                     onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 0.125rem 0.25rem rgba(0, 0, 0, 0.075)'; this.style.borderColor='var(--info-color)'"
                                     onmousedown="this.style.transform='scale(0.98)'"
                                     onmouseup="this.style.transform='scale(1.02)'"
                                     tabindex="0"
                                     role="button"
                                     aria-label="Add Text Response Question">
                                    <div class="position-absolute top-0 start-50 translate-middle">
                                        <div class="bg-text-response text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 24px; height: 24px; font-size: 0.75rem;">
                                            <RadzenIcon Icon="add" />
                                        </div>
                                    </div>
                                    <RadzenIcon Icon="psychology" Class="question-text-response fs-1 mb-3 mt-2" />
                                    <RadzenText TextStyle="TextStyle.Subtitle2" Class="fw-bold question-text-response mb-2">
                                        Text Response
                                    </RadzenText>
                                    <RadzenText TextStyle="TextStyle.Caption" Class="text-muted mb-2">
                                        Collect written feedback and insights
                                    </RadzenText>
                                    <div class="mt-3">
                                        <span class="badge badge-text-response px-2 py-1" style="font-size: 0.7rem;">Click to Add</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

        @if (Section.Questions.Count == 0)
        {
            <div class="empty-questions text-center py-4">
                <RadzenIcon Icon="@GetSectionTypeIcon()" Style="@($"font-size: 1.5rem; color: {GetSectionTypeColor()}; opacity: 0.5;")" />
                <RadzenText TextStyle="TextStyle.Body2" Class="text-muted mt-2">
                    No @GetSectionTypeName().ToLower() items yet
                </RadzenText>
                <RadzenText TextStyle="TextStyle.Caption" Class="text-muted">
                    Click "Add Item" to get started
                </RadzenText>
            </div>
        }
        else
        {
            @for (int questionIndex = 0; questionIndex < Section.Questions.Count; questionIndex++)
            {
                var question = Section.Questions[questionIndex];
                var currentQuestionIndex = questionIndex;

                <QuestionCard Question="@question"
                            CanMoveUp="@(currentQuestionIndex > 0)"
                            CanMoveDown="@(currentQuestionIndex < Section.Questions.Count - 1)"
                            QuestionTypeLabels="@QuestionTypeLabels"
                            OnEdit="@(() => OnEditQuestionInternal(currentQuestionIndex))"
                            OnMoveUp="@(() => OnMoveQuestionUpInternal(currentQuestionIndex))"
                            OnMoveDown="@(() => OnMoveQuestionDownInternal(currentQuestionIndex))"
                            OnDelete="@(() => OnDeleteQuestionInternal(currentQuestionIndex))"
                            OnRequiredChanged="@OnRequiredItemsChanged" />
            }
        }
    </div>
</div>

<style>
.section-card {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    overflow: hidden;
}

.section-header {
    background: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
}

.section-title-input {
    width: 100%;
    border: 1px solid #ced4da;
    border-radius: 4px;
    padding: 0.5rem 0.75rem;
    background: white;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.section-title-input:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(15, 96, 255, 0.25);
}

.section-description-input {
    width: 100%;
    border: 1px solid #ced4da;
    border-radius: 4px;
    padding: 0.5rem 0.75rem;
    background: white;
    resize: vertical;
    min-height: 60px;
    line-height: 1.4;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.section-description-input:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(15, 96, 255, 0.25);
}

.empty-questions {
    background: #f8f9fa;
    border: 2px dashed #dee2e6;
    border-radius: 6px;
}

.completion-role-badge {
    font-size: 0.8rem;
    white-space: nowrap;
}

.role-select-list {
    font-size: 0.85rem;
}

.role-select-list .rz-radiobutton-item {
    margin-right: 1rem;
}

.role-selector {
    max-width: 350px;
}
</style>

@code {
    [Parameter, EditorRequired] public QuestionSection Section { get; set; } = null!;
    [Parameter, EditorRequired] public bool CanMoveUp { get; set; }
    [Parameter, EditorRequired] public bool CanMoveDown { get; set; }
    [Parameter, EditorRequired] public bool ShowQuestionTypeSelection { get; set; }
    [Parameter, EditorRequired] public Dictionary<QuestionType, string> QuestionTypeLabels { get; set; } = null!;

    [Parameter] public EventCallback OnMoveUp { get; set; }
    [Parameter] public EventCallback OnMoveDown { get; set; }
    [Parameter] public EventCallback OnDelete { get; set; }
    [Parameter] public EventCallback OnAddQuestion { get; set; }
    [Parameter] public EventCallback OnAddItemDirectly { get; set; }
    [Parameter] public EventCallback OnCancelQuestionSelection { get; set; }
    [Parameter] public EventCallback<QuestionType> OnAddQuestionType { get; set; }
    [Parameter] public EventCallback<int> OnEditQuestion { get; set; }
    [Parameter] public EventCallback<int> OnMoveQuestionUp { get; set; }
    [Parameter] public EventCallback<int> OnMoveQuestionDown { get; set; }
    [Parameter] public EventCallback<int> OnDeleteQuestion { get; set; }
    [Parameter] public EventCallback<string> OnTitleChanged { get; set; }
    [Parameter] public EventCallback<string> OnDescriptionChanged { get; set; }

    private async Task OnMoveUpClick() => await OnMoveUp.InvokeAsync();
    private async Task OnMoveDownClick() => await OnMoveDown.InvokeAsync();
    private async Task OnDeleteClick() => await OnDelete.InvokeAsync();
    private async Task OnAddQuestionClick() => await OnAddQuestion.InvokeAsync();
    private async Task OnAddItemClick()
    {
        // If section already has questions, add another of the same type
        if (Section.Questions.Any())
        {
            await OnAddItemDirectly.InvokeAsync();
        }
        else
        {
            // No questions yet, show question type selection
            await OnAddQuestion.InvokeAsync();
        }
    }
    private async Task OnCancelQuestionTypeSelection() => await OnCancelQuestionSelection.InvokeAsync();
    private async Task OnAddQuestionOfType(QuestionType type) => await OnAddQuestionType.InvokeAsync(type);

    private async Task OnSectionTitleChanged(string value)
    {
        Section.Title = value ?? "";
        await OnTitleChanged.InvokeAsync(value);
    }

    private async Task OnSectionDescriptionChanged(string value)
    {
        Section.Description = value ?? "";
        await OnDescriptionChanged.InvokeAsync(value);
    }

    private async Task OnEditQuestionInternal(int questionIndex) => await OnEditQuestion.InvokeAsync(questionIndex);
    private async Task OnMoveQuestionUpInternal(int questionIndex) => await OnMoveQuestionUp.InvokeAsync(questionIndex);
    private async Task OnMoveQuestionDownInternal(int questionIndex) => await OnMoveQuestionDown.InvokeAsync(questionIndex);
    private async Task OnDeleteQuestionInternal(int questionIndex) => await OnDeleteQuestion.InvokeAsync(questionIndex);

    private async Task OnRequiredItemsChanged()
    {
        // Force a refresh of the component to update the required count display
        StateHasChanged();
    }


    private string GetSectionNumber()
    {
        // This could be enhanced to get the actual section number from parent
        return (Section.Order + 1).ToString();
    }

    private int GetQuestionTypesCount()
    {
        // Count unique question types in this section
        return Section.Questions.Select(q => q.Type).Distinct().Count();
    }

    private int GetTotalItemsCount()
    {
        int totalItems = 0;

        foreach (var question in Section.Questions)
        {
            switch (question.Type)
            {
                case QuestionType.SelfAssessment:
                    if (question.Configuration.TryGetValue("Competencies", out var competenciesObj))
                    {
                        if (competenciesObj is System.Text.Json.JsonElement jsonElement && jsonElement.ValueKind == System.Text.Json.JsonValueKind.Array)
                        {
                            try { totalItems += jsonElement.GetArrayLength(); } catch { }
                        }
                        else if (competenciesObj is System.Collections.ICollection collection)
                        {
                            totalItems += collection.Count;
                        }
                    }
                    break;
                case QuestionType.GoalAchievement:
                    if (question.Configuration.TryGetValue("GoalCategories", out var goalCategoriesObj))
                    {
                        if (goalCategoriesObj is System.Text.Json.JsonElement jsonElement && jsonElement.ValueKind == System.Text.Json.JsonValueKind.Array)
                        {
                            try { totalItems += jsonElement.GetArrayLength(); } catch { }
                        }
                        else if (goalCategoriesObj is System.Collections.ICollection collection)
                        {
                            totalItems += collection.Count;
                        }
                    }
                    break;
                case QuestionType.TextQuestion:
                    if (question.Configuration.TryGetValue("TextSections", out var textSectionsObj))
                    {
                        if (textSectionsObj is System.Text.Json.JsonElement jsonElement && jsonElement.ValueKind == System.Text.Json.JsonValueKind.Array)
                        {
                            try { totalItems += jsonElement.GetArrayLength(); } catch { }
                        }
                        else if (textSectionsObj is System.Collections.ICollection collection)
                        {
                            totalItems += collection.Count;
                        }
                    }
                    // Check for legacy format
                    else if (question.Configuration.ContainsKey("SectionTitle") || question.Configuration.ContainsKey("SectionDescription"))
                    {
                        totalItems += 1;
                    }
                    break;
                default:
                    totalItems += 1; // Fallback for unknown question types
                    break;
            }
        }

        return totalItems;
    }

    // New methods for simplified structure
    private string GetSectionTypeIcon()
    {
        return Section.Questions.FirstOrDefault()?.Type switch
        {
            QuestionType.SelfAssessment => "self_improvement",
            QuestionType.GoalAchievement => "track_changes",
            QuestionType.TextQuestion => "psychology",
            _ => "help"
        };
    }

    private string GetSectionTypeName()
    {
        return Section.Questions.FirstOrDefault()?.Type switch
        {
            QuestionType.SelfAssessment => "Self-Assessment",
            QuestionType.GoalAchievement => "Goal Achievement",
            QuestionType.TextQuestion => "Text Question",
            _ => "Unknown"
        };
    }

    private string GetSectionTypeColor()
    {
        return Section.Questions.FirstOrDefault()?.Type switch
        {
            QuestionType.SelfAssessment => "#0F60FF",
            QuestionType.GoalAchievement => "#00E6C8",
            QuestionType.TextQuestion => "#935BA9",
            _ => "#6c757d"
        };
    }

    private int GetItemCount()
    {
        return GetTotalItemsCount();
    }

    private int GetRequiredItemCount()
    {
        int requiredItems = 0;

        foreach (var question in Section.Questions)
        {
            switch (question.Type)
            {
                case QuestionType.SelfAssessment:
                    if (question.Configuration.TryGetValue("Competencies", out var competenciesObj))
                    {
                        if (competenciesObj is System.Text.Json.JsonElement jsonElement && jsonElement.ValueKind == System.Text.Json.JsonValueKind.Array)
                        {
                            try
                            {
                                var competencies = System.Text.Json.JsonSerializer.Deserialize<List<CompetencyDefinition>>(jsonElement.GetRawText(), new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true }) ?? new List<CompetencyDefinition>();
                                requiredItems += competencies.Count(c => c.IsRequired);
                            }
                            catch { }
                        }
                        else if (competenciesObj is List<CompetencyDefinition> competenciesList)
                        {
                            requiredItems += competenciesList.Count(c => c.IsRequired);
                        }
                    }
                    break;
                case QuestionType.GoalAchievement:
                    if (question.Configuration.TryGetValue("GoalCategories", out var goalCategoriesObj))
                    {
                        if (goalCategoriesObj is System.Text.Json.JsonElement jsonElement && jsonElement.ValueKind == System.Text.Json.JsonValueKind.Array)
                        {
                            try
                            {
                                var categories = System.Text.Json.JsonSerializer.Deserialize<List<QuestionCard.GoalCategory>>(jsonElement.GetRawText(), new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true }) ?? new List<QuestionCard.GoalCategory>();
                                requiredItems += categories.Count(c => c.IsRequired);
                            }
                            catch { }
                        }
                        else if (goalCategoriesObj is List<QuestionCard.GoalCategory> categoriesList)
                        {
                            requiredItems += categoriesList.Count(c => c.IsRequired);
                        }
                        else if (goalCategoriesObj is List<object> objectList)
                        {
                            try
                            {
                                var json = System.Text.Json.JsonSerializer.Serialize(objectList);
                                var categories = System.Text.Json.JsonSerializer.Deserialize<List<QuestionCard.GoalCategory>>(json, new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true }) ?? new List<QuestionCard.GoalCategory>();
                                requiredItems += categories.Count(c => c.IsRequired);
                            }
                            catch { }
                        }
                    }
                    break;
                case QuestionType.TextQuestion:
                    if (question.Configuration.TryGetValue("TextSections", out var textSectionsObj))
                    {
                        if (textSectionsObj is System.Text.Json.JsonElement jsonElement && jsonElement.ValueKind == System.Text.Json.JsonValueKind.Array)
                        {
                            try
                            {
                                var sections = System.Text.Json.JsonSerializer.Deserialize<List<QuestionCard.TextSection>>(jsonElement.GetRawText(), new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true }) ?? new List<QuestionCard.TextSection>();
                                requiredItems += sections.Count(s => s.IsRequired);
                            }
                            catch { }
                        }
                        else if (textSectionsObj is List<QuestionCard.TextSection> sectionsList)
                        {
                            requiredItems += sectionsList.Count(s => s.IsRequired);
                        }
                        else if (textSectionsObj is List<object> objectList)
                        {
                            try
                            {
                                var json = System.Text.Json.JsonSerializer.Serialize(objectList);
                                var sections = System.Text.Json.JsonSerializer.Deserialize<List<QuestionCard.TextSection>>(json, new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true }) ?? new List<QuestionCard.TextSection>();
                                requiredItems += sections.Count(s => s.IsRequired);
                            }
                            catch { }
                        }
                    }
                    // Check for legacy format
                    else if (question.Configuration.ContainsKey("SectionTitle") || question.Configuration.ContainsKey("SectionDescription"))
                    {
                        // Legacy text questions don't have individual required flags, so count as 0
                    }
                    break;
                default:
                    // For unknown question types, fall back to the question-level required flag
                    if (question.IsRequired) requiredItems += 1;
                    break;
            }
        }

        return requiredItems;
    }

    // Rating scale configuration methods for Self-Assessment sections
    private int GetRatingScale(QuestionItem question)
    {
        if (question.Configuration.TryGetValue("RatingScale", out var scale))
        {
            // Handle JsonElement properly
            if (scale is System.Text.Json.JsonElement jsonElement)
            {
                return jsonElement.GetInt32();
            }
        }
        return 4; // Default
    }

    private void SetRatingScale(QuestionItem question, int value)
    {
        question.Configuration["RatingScale"] = value;
        // Apply to all questions in the section
        foreach (var q in Section.Questions.Where(q => q.Type == QuestionType.SelfAssessment))
        {
            q.Configuration["RatingScale"] = value;
        }
        StateHasChanged();
    }

    private string GetScaleLowLabel(QuestionItem question)
    {
        if (question.Configuration.TryGetValue("ScaleLowLabel", out var label))
        {
            return label.ToString() ?? "Poor";
        }
        return "Poor";
    }

    private void SetScaleLowLabel(QuestionItem question, string value)
    {
        // Apply to all questions in the section
        foreach (var q in Section.Questions.Where(q => q.Type == QuestionType.SelfAssessment))
        {
            q.Configuration["ScaleLowLabel"] = value ?? "Poor";
        }
        StateHasChanged();
    }

    private string GetScaleHighLabel(QuestionItem question)
    {
        if (question.Configuration.TryGetValue("ScaleHighLabel", out var label))
        {
            return label.ToString() ?? "Excellent";
        }
        return "Excellent";
    }

    private void SetScaleHighLabel(QuestionItem question, string value)
    {
        // Apply to all questions in the section
        foreach (var q in Section.Questions.Where(q => q.Type == QuestionType.SelfAssessment))
        {
            q.Configuration["ScaleHighLabel"] = value ?? "Excellent";
        }
        StateHasChanged();
    }

    // Role selection support
    private List<RoleOption> roleOptions = new()
    {
        new() { Value = CompletionRole.Employee, Text = "Employee", Icon = "person" },
        new() { Value = CompletionRole.Manager, Text = "Manager", Icon = "supervisor_account" },
        new() { Value = CompletionRole.Both, Text = "Both", Icon = "groups" }
    };

    private string GetCompletionRoleText()
    {
        return Section.AssignedTo switch
        {
            CompletionRole.Employee => "Employee",
            CompletionRole.Manager => "Manager",
            CompletionRole.Both => "Both",
            _ => "Unknown"
        };
    }

    public class RoleOption
    {
        public CompletionRole Value { get; set; }
        public string Text { get; set; } = string.Empty;
        public string Icon { get; set; } = string.Empty;
    }
}