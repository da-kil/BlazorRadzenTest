@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Components.QuestionnaireBuilder
@using ti8m.BeachBreak.Client.Components.Shared
@using System.Collections
@inherits OptimizedTranslatableComponentBase

<div class="modern-section-card mb-4">
    <!-- Enhanced Section Header with proper action button placement -->
    <div class="section-header-modern">
        <!-- Header Top Row: Type indicators and Action Buttons -->
        <div class="header-top-row">
            <div class="section-badges">
                <div class="section-type-badge">
                    <RadzenIcon Icon="@GetSectionTypeIcon()" Class="badge-icon" />
                    <span class="badge-text">@GetSectionTypeName()</span>
                </div>
                <div class="completion-role-badge">
                    <RadzenIcon Icon="@Section.GetRoleIcon()" Class="badge-icon" />
                    <span class="badge-text">@GetCompletionRoleText()</span>
                </div>
            </div>

            <!-- Action Buttons - moved to dedicated area -->
            <div class="section-actions">
                <AsyncButton ButtonStyle="ButtonStyle.Light"
                            Icon="keyboard_arrow_up"
                            Size="ButtonSize.Small"
                            Click="@(() => OnMoveUpClick())"
                            Disabled="@(!CanMoveUp || !Template.IsAvailableForEditing)"
                            Title="Move section up"
                            Class="action-btn" />
                <AsyncButton ButtonStyle="ButtonStyle.Light"
                            Icon="keyboard_arrow_down"
                            Size="ButtonSize.Small"
                            Click="@(() => OnMoveDownClick())"
                            Disabled="@(!CanMoveDown || !Template.IsAvailableForEditing)"
                            Title="Move section down"
                            Class="action-btn" />
                <AsyncButton ButtonStyle="ButtonStyle.Danger"
                            ProcessingText="Deleting"
                            Icon="delete_outline"
                            Size="ButtonSize.Small"
                            Click="@(() => OnDeleteClick())"
                            Title="Delete section"
                            Class="action-btn action-btn-danger"
                            Disabled="@(!Template.IsAvailableForEditing)" />
            </div>
        </div>

        <!-- Header Content Row: Role selector -->
        <div class="header-content-row">
            <div class="role-assignment-section">
                <RadzenText TextStyle="TextStyle.Caption" Class="role-label">Who completes this section?</RadzenText>
                @if (!Template.RequiresManagerReview)
                {
                    <RadzenText TextStyle="TextStyle.Caption" Class="text-warning d-block mb-2">
                        <RadzenIcon Icon="info" Style="font-size: 0.875rem;" />
                        Manager review disabled - sections must be completed by employees only
                    </RadzenText>
                }
                <RadzenRadioButtonList @bind-Value="@Section.CompletionRole"
                                       Data="@GetFilteredRoleOptions()"
                                       TextProperty="Text"
                                       ValueProperty="Value"
                                       Orientation="Radzen.Orientation.Horizontal"
                                       Class="role-select-modern"
                                       Disabled="@(!Template.IsAvailableForEditing)" />
            </div>
        </div>
    </div>

    <!-- Section Content Area -->
    <div class="section-content-modern">

        <!-- Title Inputs -->
        <div class="multilang-input-grid mb-3">
            <div class="input-field">
                <RadzenText TextStyle="TextStyle.Caption" Class="fw-bold mb-1">English Title *</RadzenText>
                <RadzenTextBox Value="@Section.TitleEnglish"
                             ValueChanged="@(value => OnSectionTitleEnglishChanged(value))"
                             Placeholder="@T("placeholders.section-title-english-example")"
                             Class="title-input-modern"
                             Disabled="@(!Template.IsAvailableForEditing)" />
            </div>
            <div class="input-field">
                <RadzenText TextStyle="TextStyle.Caption" Class="fw-bold mb-1">German Title (Optional)</RadzenText>
                <RadzenTextBox Value="@Section.TitleGerman"
                             ValueChanged="@(value => OnSectionTitleGermanChanged(value))"
                             Placeholder="@T("placeholders.section-title-german-example")"
                             Class="title-input-modern"
                             Disabled="@(!Template.IsAvailableForEditing)" />
            </div>
        </div>

        <!-- Description Inputs -->
        <div class="multilang-input-grid mb-3">
            <div class="input-field">
                <RadzenText TextStyle="TextStyle.Caption" Class="fw-bold mb-1">English Description *</RadzenText>
                <RadzenTextArea Value="@Section.DescriptionEnglish"
                              ValueChanged="@(value => OnSectionDescriptionEnglishChanged(value))"
                              Placeholder="@T("placeholders.section-description-english")"
                              Class="description-input-modern"
                              Disabled="@(!Template.IsAvailableForEditing)"
                              Rows="3" />
            </div>
            <div class="input-field">
                <RadzenText TextStyle="TextStyle.Caption" Class="fw-bold mb-1">German Description (Optional)</RadzenText>
                <RadzenTextArea Value="@Section.DescriptionGerman"
                              ValueChanged="@(value => OnSectionDescriptionGermanChanged(value))"
                              Placeholder="@T("placeholders.section-description-german")"
                              Class="description-input-modern"
                              Disabled="@(!Template.IsAvailableForEditing)"
                              Rows="3" />
            </div>
        </div>

        <!-- Rating Scale Configuration - only for Assessment sections -->
        @if (Section.Type == QuestionType.Assessment)
        {
            <div class="rating-scale-config-modern">
                <div class="config-header">
                    <RadzenIcon Icon="tune" Class="config-icon" />
                    <RadzenText TextStyle="TextStyle.Body1" Class="config-title">Rating Scale Configuration</RadzenText>
                </div>
                <div class="rating-scale-grid">
                    <div class="scale-input">
                        <RadzenText TextStyle="TextStyle.Caption" Class="input-label">Scale</RadzenText>
                        <RadzenDropDown Value="@GetRatingScale()"
                                       ValueChanged="@((int value) => SetRatingScale(value))"
                                       Data="@(new List<int> { 3, 4, 5, 7, 10 })"
                                       Class="modern-dropdown"
                                       Disabled="@(!Template.IsAvailableForEditing)" />
                    </div>
                    <div class="scale-input">
                        <RadzenText TextStyle="TextStyle.Caption" Class="input-label">Low Label</RadzenText>
                        <RadzenTextBox Value="@GetScaleLowLabel()"
                                      ValueChanged="@((string value) => SetScaleLowLabel(value))"
                                      Placeholder="@T("placeholders.scale-low-label-example")"
                                      Class="modern-textbox"
                                      Disabled="@(!Template.IsAvailableForEditing)" />
                    </div>
                    <div class="scale-input">
                        <RadzenText TextStyle="TextStyle.Caption" Class="input-label">High Label</RadzenText>
                        <RadzenTextBox Value="@GetScaleHighLabel()"
                                      ValueChanged="@((string value) => SetScaleHighLabel(value))"
                                      Placeholder="@T("placeholders.scale-high-label-example")"
                                      Class="modern-textbox"
                                      Disabled="@(!Template.IsAvailableForEditing)" />
                    </div>
                </div>
            </div>
        }

        <!-- Enhanced Section Stats -->
        @if (GetItemCount() > 0)
        {
            <div class="section-stats-modern">
                <div class="stat-item">
                    <RadzenIcon Icon="quiz" Class="stat-icon" />
                    <span class="stat-number">@GetItemCount()</span>
                    <span class="stat-label">items</span>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-item">
                    <RadzenIcon Icon="star" Class="stat-icon" />
                    <span class="stat-number">@GetRequiredItemCount()</span>
                    <span class="stat-label">required</span>
                </div>
            </div>
        }
    </div>

    <!-- Items Area - Reduced padding for flatter design -->
    <div class="items-area py-2">
        <div class="items-header mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <RadzenText TextStyle="TextStyle.Subtitle2" Class="fw-bold mb-0 d-flex align-items-center">
                    <RadzenIcon Icon="@GetSectionTypeIcon()" Style="@($"color: {GetSectionTypeColor()};")" Class="me-2" />
                    @GetSectionTypeName() Items
                </RadzenText>
                <AsyncButton Text="Add Item"
                            ButtonStyle="ButtonStyle.Primary"
                            Icon="add_circle_outline"
                            Size="ButtonSize.Small"
                            Click="@(() => OnAddItemClick())"
                            Disabled="@(!Template.IsAvailableForEditing)" />
            </div>
        </div>

        @* Render items based on section type *@
        @if (IsSectionInitialized())
        {
            <div class="items-list mt-3">
                @if (Section.Type == QuestionType.Assessment)
                {
                    var evaluations = GetOrderedEvaluations();
                    @if (evaluations.Count == 0)
                    {
                        <div class="text-center p-3 text-muted">
                            <RadzenIcon Icon="self_improvement" Class="empty-state-icon" />
                            <div class="mt-2 small">No evaluations configured</div>
                        </div>
                    }
                    else
                    {
                        @for (int i = 0; i < evaluations.Count; i++)
                        {
                            var evalIndex = i;
                            var evaluation = evaluations[evalIndex];

                            <div class="item-card mb-3 p-3 border rounded">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div class="d-flex align-items-center gap-3">
                                        <RadzenText TextStyle="TextStyle.Body2" Class="fw-bold mb-0">
                                            Evaluation @(evalIndex + 1)
                                        </RadzenText>
                                        <div class="d-flex align-items-center">
                                            <RadzenCheckBox Value="@evaluation.IsRequired"
                                                          ValueChanged="@((bool value) => UpdateEvaluationRequired(evalIndex, value))"
                                                          Name="@($"eval_req_{Section.Id}_{evalIndex}")"
                                                          Disabled="@(!Template.IsAvailableForEditing)" />
                                            <RadzenLabel Text="Required" Component="@($"eval_req_{Section.Id}_{evalIndex}")" Class="ms-1" />
                                        </div>
                                    </div>
                                    <div class="d-flex gap-1">
                                        <AsyncButton ButtonStyle="ButtonStyle.Light"
                                                    Icon="keyboard_arrow_up"
                                                    Size="ButtonSize.ExtraSmall"
                                                    Click="@(() => MoveEvaluationUp(evalIndex))"
                                                    Disabled="@(evalIndex == 0 || !Template.IsAvailableForEditing)"
                                                    Title="Move up" />
                                        <AsyncButton ButtonStyle="ButtonStyle.Light"
                                                    Icon="keyboard_arrow_down"
                                                    Size="ButtonSize.ExtraSmall"
                                                    Click="@(() => MoveEvaluationDown(evalIndex))"
                                                    Disabled="@(evalIndex == evaluations.Count - 1 || !Template.IsAvailableForEditing)"
                                                    Title="Move down" />
                                        <AsyncButton ButtonStyle="ButtonStyle.Danger"
                                                    Icon="delete_outline"
                                                    Size="ButtonSize.ExtraSmall"
                                                    Click="@(() => RemoveEvaluation(evalIndex))"
                                                    Title="Delete"
                                                    Disabled="@(!Template.IsAvailableForEditing)" />
                                    </div>
                                </div>
                                <div class="multilang-input-grid mb-2">
                                    <div class="input-field">
                                        <RadzenText TextStyle="TextStyle.Caption" Class="mb-1">English Title *</RadzenText>
                                        <RadzenTextBox Value="@evaluation.TitleEnglish"
                                                      ValueChanged="@((string value) => UpdateEvaluationTitleEnglish(evalIndex, value))"
                                                      Placeholder="Enter evaluation title..."
                                                      Disabled="@(!Template.IsAvailableForEditing)" />
                                    </div>
                                    <div class="input-field">
                                        <RadzenText TextStyle="TextStyle.Caption" Class="mb-1">German Title (Optional)</RadzenText>
                                        <RadzenTextBox Value="@evaluation.TitleGerman"
                                                      ValueChanged="@((string value) => UpdateEvaluationTitleGerman(evalIndex, value))"
                                                      Placeholder="Enter German title..."
                                                      Disabled="@(!Template.IsAvailableForEditing)" />
                                    </div>
                                </div>
                                <div class="multilang-input-grid">
                                    <div class="input-field">
                                        <RadzenText TextStyle="TextStyle.Caption" Class="mb-1">English Description</RadzenText>
                                        <RadzenTextArea Value="@evaluation.DescriptionEnglish"
                                                       ValueChanged="@((string value) => UpdateEvaluationDescriptionEnglish(evalIndex, value))"
                                                       Placeholder="Describe this evaluation..."
                                                       Rows="2"
                                                       Disabled="@(!Template.IsAvailableForEditing)" />
                                    </div>
                                    <div class="input-field">
                                        <RadzenText TextStyle="TextStyle.Caption" Class="mb-1">German Description (Optional)</RadzenText>
                                        <RadzenTextArea Value="@evaluation.DescriptionGerman"
                                                       ValueChanged="@((string value) => UpdateEvaluationDescriptionGerman(evalIndex, value))"
                                                       Placeholder="Describe this evaluation in German..."
                                                       Rows="2"
                                                       Disabled="@(!Template.IsAvailableForEditing)" />
                                    </div>
                                </div>
                            </div>
                        }
                    }
                }
                else if (Section.Type == QuestionType.Goal)
                {
                    <div class="goal-info text-center p-4">
                        <RadzenIcon Icon="flag" Style="font-size: 2rem;" Class="mb-3 text-success" />
                        <RadzenText TextStyle="TextStyle.Body1" Class="mb-2 fw-bold">
                            Goal Question Type
                        </RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2" Class="text-muted mb-3">
                            No template configuration is required for Goal questions.
                        </RadzenText>
                        <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" Class="mb-0" ShowIcon="false">
                            <RadzenText TextStyle="TextStyle.Caption" Class="d-block mb-1">
                                Goals are added dynamically during the questionnaire workflow:
                            </RadzenText>
                            <ul class="small mb-0 text-start">
                                <li>Employee and Manager add goals during their completion phases</li>
                                <li>Goals can be linked to predecessor questionnaires for rating</li>
                                <li>Each goal includes objective, timeframe, measurement, and weighting</li>
                            </ul>
                        </RadzenAlert>
                    </div>
                }
                else if (Section.Type == QuestionType.TextQuestion)
                {
                    var textSections = GetOrderedTextSections();
                    @if (textSections.Count == 0)
                    {
                        <div class="text-center p-3 text-muted">
                            <RadzenIcon Icon="psychology" Class="empty-state-icon" />
                            <div class="mt-2 small">No text sections configured</div>
                        </div>
                    }
                    else
                    {
                        @for (int i = 0; i < textSections.Count; i++)
                        {
                            var sectionIndex = i;
                            var textSection = textSections[sectionIndex];

                            <div class="item-card mb-3 p-3 border rounded">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div class="d-flex align-items-center gap-3">
                                        <RadzenText TextStyle="TextStyle.Body2" Class="fw-bold mb-0">
                                            Text Section @(sectionIndex + 1)
                                        </RadzenText>
                                        <div class="d-flex align-items-center">
                                            <RadzenCheckBox Value="@textSection.IsRequired"
                                                          ValueChanged="@((bool value) => UpdateTextSectionRequired(sectionIndex, value))"
                                                          Name="@($"text_req_{Section.Id}_{sectionIndex}")"
                                                          Disabled="@(!Template.IsAvailableForEditing)" />
                                            <RadzenLabel Text="Required" Component="@($"text_req_{Section.Id}_{sectionIndex}")" Class="ms-1" />
                                        </div>
                                    </div>
                                    <div class="d-flex gap-1">
                                        <AsyncButton ButtonStyle="ButtonStyle.Light"
                                                    Icon="keyboard_arrow_up"
                                                    Size="ButtonSize.ExtraSmall"
                                                    Click="@(() => MoveTextSectionUp(sectionIndex))"
                                                    Disabled="@(sectionIndex == 0 || !Template.IsAvailableForEditing)"
                                                    Title="Move up" />
                                        <AsyncButton ButtonStyle="ButtonStyle.Light"
                                                    Icon="keyboard_arrow_down"
                                                    Size="ButtonSize.ExtraSmall"
                                                    Click="@(() => MoveTextSectionDown(sectionIndex))"
                                                    Disabled="@(sectionIndex == textSections.Count - 1 || !Template.IsAvailableForEditing)"
                                                    Title="Move down" />
                                        <AsyncButton ButtonStyle="ButtonStyle.Danger"
                                                    Icon="delete_outline"
                                                    Size="ButtonSize.ExtraSmall"
                                                    Click="@(() => RemoveTextSection(sectionIndex))"
                                                    Title="Delete"
                                                    Disabled="@(!Template.IsAvailableForEditing)" />
                                    </div>
                                </div>
                                <div class="multilang-input-grid mb-2">
                                    <div class="input-field">
                                        <RadzenText TextStyle="TextStyle.Caption" Class="mb-1">English Title *</RadzenText>
                                        <RadzenTextBox Value="@textSection.TitleEnglish"
                                                      ValueChanged="@((string value) => UpdateTextSectionTitleEnglish(sectionIndex, value))"
                                                      Placeholder="Enter section title..."
                                                      Disabled="@(!Template.IsAvailableForEditing)" />
                                    </div>
                                    <div class="input-field">
                                        <RadzenText TextStyle="TextStyle.Caption" Class="mb-1">German Title (Optional)</RadzenText>
                                        <RadzenTextBox Value="@textSection.TitleGerman"
                                                      ValueChanged="@((string value) => UpdateTextSectionTitleGerman(sectionIndex, value))"
                                                      Placeholder="Enter German title..."
                                                      Disabled="@(!Template.IsAvailableForEditing)" />
                                    </div>
                                </div>
                                <div class="multilang-input-grid">
                                    <div class="input-field">
                                        <RadzenText TextStyle="TextStyle.Caption" Class="mb-1">English Description</RadzenText>
                                        <RadzenTextArea Value="@textSection.DescriptionEnglish"
                                                       ValueChanged="@((string value) => UpdateTextSectionDescriptionEnglish(sectionIndex, value))"
                                                       Placeholder="Describe this text section..."
                                                       Rows="2"
                                                       Disabled="@(!Template.IsAvailableForEditing)" />
                                    </div>
                                    <div class="input-field">
                                        <RadzenText TextStyle="TextStyle.Caption" Class="mb-1">German Description (Optional)</RadzenText>
                                        <RadzenTextArea Value="@textSection.DescriptionGerman"
                                                       ValueChanged="@((string value) => UpdateTextSectionDescriptionGerman(sectionIndex, value))"
                                                       Placeholder="Describe this text section in German..."
                                                       Rows="2"
                                                       Disabled="@(!Template.IsAvailableForEditing)" />
                                    </div>
                                </div>
                            </div>
                        }
                    }
                }
            </div>
        }
        else
        {
            <div class="section-info text-center py-3">
                <RadzenIcon Icon="add_circle" Style="font-size: 2rem;" Class="mb-2 text-muted" />
                <RadzenText TextStyle="TextStyle.Body2" Class="text-muted">
                    Click "Add Item" to choose a question type for this section
                </RadzenText>
            </div>
        }
    </div>
</div>


@code {
    [Parameter, EditorRequired] public QuestionSection Section { get; set; } = null!;
    [Parameter, EditorRequired] public QuestionnaireTemplate Template { get; set; } = null!;
    [Parameter, EditorRequired] public bool CanMoveUp { get; set; }
    [Parameter, EditorRequired] public bool CanMoveDown { get; set; }

    [Parameter] public EventCallback OnMoveUp { get; set; }
    [Parameter] public EventCallback OnMoveDown { get; set; }
    [Parameter] public EventCallback OnDelete { get; set; }
    [Parameter] public EventCallback OnAddItemDirectly { get; set; }
    [Parameter] public EventCallback<int> OnMoveQuestionUp { get; set; }
    [Parameter] public EventCallback<int> OnMoveQuestionDown { get; set; }
    [Parameter] public EventCallback<int> OnDeleteQuestion { get; set; }
    [Parameter] public EventCallback<string> OnTitleEnglishChanged { get; set; }
    [Parameter] public EventCallback<string> OnTitleGermanChanged { get; set; }
    [Parameter] public EventCallback<string> OnDescriptionEnglishChanged { get; set; }
    [Parameter] public EventCallback<string> OnDescriptionGermanChanged { get; set; }

    private async Task OnMoveUpClick() => await OnMoveUp.InvokeAsync();
    private async Task OnMoveDownClick() => await OnMoveDown.InvokeAsync();
    private async Task OnDeleteClick() => await OnDelete.InvokeAsync();
    private async Task OnAddItemClick() => await OnAddItemDirectly.InvokeAsync();


    private async Task OnSectionTitleEnglishChanged(string value)
    {
        Section.TitleEnglish = value ?? "";
        await OnTitleEnglishChanged.InvokeAsync(value);
    }

    private async Task OnSectionTitleGermanChanged(string value)
    {
        Section.TitleGerman = value ?? "";
        await OnTitleGermanChanged.InvokeAsync(value);
    }

    private async Task OnSectionDescriptionEnglishChanged(string value)
    {
        Section.DescriptionEnglish = value ?? "";
        await OnDescriptionEnglishChanged.InvokeAsync(value);
    }

    private async Task OnSectionDescriptionGermanChanged(string value)
    {
        Section.DescriptionGerman = value ?? "";
        await OnDescriptionGermanChanged.InvokeAsync(value);
    }

    // Assessment item methods
    private List<EvaluationItem> GetOrderedEvaluations()
    {
        if (Section.Configuration is AssessmentConfiguration config)
        {
            return config.Evaluations.OrderBy(e => e.Order).ToList();
        }
        return new List<EvaluationItem>();
    }

    private void UpdateAssessmentConfiguration(List<EvaluationItem> evaluations)
    {
        if (Section.Configuration is AssessmentConfiguration config)
        {
            config.Evaluations = evaluations;
        }
        StateHasChanged();
    }

    private void UpdateEvaluationRequired(int index, bool value)
    {
        var evaluations = GetOrderedEvaluations();
        if (index >= 0 && index < evaluations.Count)
        {
            evaluations[index].IsRequired = value;
            UpdateAssessmentConfiguration(evaluations);
        }
    }

    private void MoveEvaluationUp(int index)
    {
        var evaluations = GetOrderedEvaluations();
        if (index > 0 && index < evaluations.Count)
        {
            (evaluations[index], evaluations[index - 1]) = (evaluations[index - 1], evaluations[index]);
            for (int i = 0; i < evaluations.Count; i++)
            {
                evaluations[i].Order = i;
            }
            UpdateAssessmentConfiguration(evaluations);
        }
    }

    private void MoveEvaluationDown(int index)
    {
        var evaluations = GetOrderedEvaluations();
        if (index >= 0 && index < evaluations.Count - 1)
        {
            (evaluations[index], evaluations[index + 1]) = (evaluations[index + 1], evaluations[index]);
            for (int i = 0; i < evaluations.Count; i++)
            {
                evaluations[i].Order = i;
            }
            UpdateAssessmentConfiguration(evaluations);
        }
    }

    private void RemoveEvaluation(int index)
    {
        var evaluations = GetOrderedEvaluations();
        if (index >= 0 && index < evaluations.Count)
        {
            evaluations.RemoveAt(index);
            for (int i = 0; i < evaluations.Count; i++)
            {
                evaluations[i].Order = i;
            }
            UpdateAssessmentConfiguration(evaluations);
        }
    }

    private void UpdateEvaluationTitleEnglish(int index, string value)
    {
        var evaluations = GetOrderedEvaluations();
        if (index >= 0 && index < evaluations.Count)
        {
            evaluations[index].TitleEnglish = value ?? "";
            UpdateAssessmentConfiguration(evaluations);
        }
    }

    private void UpdateEvaluationTitleGerman(int index, string value)
    {
        var evaluations = GetOrderedEvaluations();
        if (index >= 0 && index < evaluations.Count)
        {
            evaluations[index].TitleGerman = value ?? "";
            UpdateAssessmentConfiguration(evaluations);
        }
    }

    private void UpdateEvaluationDescriptionEnglish(int index, string value)
    {
        var evaluations = GetOrderedEvaluations();
        if (index >= 0 && index < evaluations.Count)
        {
            evaluations[index].DescriptionEnglish = value ?? "";
            UpdateAssessmentConfiguration(evaluations);
        }
    }

    private void UpdateEvaluationDescriptionGerman(int index, string value)
    {
        var evaluations = GetOrderedEvaluations();
        if (index >= 0 && index < evaluations.Count)
        {
            evaluations[index].DescriptionGerman = value ?? "";
            UpdateAssessmentConfiguration(evaluations);
        }
    }

    // Text question item methods
    private List<TextSection> GetOrderedTextSections()
    {
        if (Section.Configuration is TextQuestionConfiguration config)
        {
            return config.TextSections.OrderBy(s => s.Order).ToList();
        }
        return new List<TextSection>();
    }

    private void UpdateTextQuestionConfiguration(List<TextSection> sections)
    {
        if (Section.Configuration is TextQuestionConfiguration config)
        {
            config.TextSections = sections;
        }
        StateHasChanged();
    }

    private void UpdateTextSectionRequired(int index, bool value)
    {
        var sections = GetOrderedTextSections();
        if (index >= 0 && index < sections.Count)
        {
            sections[index].IsRequired = value;
            UpdateTextQuestionConfiguration(sections);
        }
    }

    private void MoveTextSectionUp(int index)
    {
        var sections = GetOrderedTextSections();
        if (index > 0 && index < sections.Count)
        {
            (sections[index], sections[index - 1]) = (sections[index - 1], sections[index]);
            for (int i = 0; i < sections.Count; i++)
            {
                sections[i].Order = i;
            }
            UpdateTextQuestionConfiguration(sections);
        }
    }

    private void MoveTextSectionDown(int index)
    {
        var sections = GetOrderedTextSections();
        if (index >= 0 && index < sections.Count - 1)
        {
            (sections[index], sections[index + 1]) = (sections[index + 1], sections[index]);
            for (int i = 0; i < sections.Count; i++)
            {
                sections[i].Order = i;
            }
            UpdateTextQuestionConfiguration(sections);
        }
    }

    private void RemoveTextSection(int index)
    {
        var sections = GetOrderedTextSections();
        if (index >= 0 && index < sections.Count)
        {
            sections.RemoveAt(index);
            for (int i = 0; i < sections.Count; i++)
            {
                sections[i].Order = i;
            }
            UpdateTextQuestionConfiguration(sections);
        }
    }

    private void UpdateTextSectionTitleEnglish(int index, string value)
    {
        var sections = GetOrderedTextSections();
        if (index >= 0 && index < sections.Count)
        {
            sections[index].TitleEnglish = value ?? "";
            UpdateTextQuestionConfiguration(sections);
        }
    }

    private void UpdateTextSectionTitleGerman(int index, string value)
    {
        var sections = GetOrderedTextSections();
        if (index >= 0 && index < sections.Count)
        {
            sections[index].TitleGerman = value ?? "";
            UpdateTextQuestionConfiguration(sections);
        }
    }

    private void UpdateTextSectionDescriptionEnglish(int index, string value)
    {
        var sections = GetOrderedTextSections();
        if (index >= 0 && index < sections.Count)
        {
            sections[index].DescriptionEnglish = value ?? "";
            UpdateTextQuestionConfiguration(sections);
        }
    }

    private void UpdateTextSectionDescriptionGerman(int index, string value)
    {
        var sections = GetOrderedTextSections();
        if (index >= 0 && index < sections.Count)
        {
            sections[index].DescriptionGerman = value ?? "";
            UpdateTextQuestionConfiguration(sections);
        }
    }


    private string GetSectionNumber()
    {
        // This could be enhanced to get the actual section number from parent
        return (Section.Order + 1).ToString();
    }

    private string GetSectionTypeIcon()
    {
        return Section.GetTypeIcon();
    }

    private string GetSectionTypeName()
    {
        return Section.GetTypeName();
    }

    private string GetSectionTypeColor()
    {
        return Section.GetTypeColor();
    }

    private int GetItemCount()
    {
        return Section.GetItemCount();
    }

    private int GetRequiredItemCount()
    {
        return Section.GetRequiredItemCount();
    }

    private bool IsSectionInitialized()
    {
        // Check if the section has been properly initialized with a configuration
        return Section.Type switch
        {
            QuestionType.Assessment => Section.Configuration is AssessmentConfiguration config && config.Evaluations.Count > 0,
            QuestionType.TextQuestion => Section.Configuration is TextQuestionConfiguration config && config.TextSections.Count > 0,
            QuestionType.Goal => Section.Configuration is GoalConfiguration,
            _ => false
        };
    }

    // Rating scale configuration methods for Assessment sections
    private int GetRatingScale()
    {
        if (Section.Configuration is AssessmentConfiguration config)
        {
            return config.RatingScale;
        }
        return 4; // Default
    }

    private void SetRatingScale(int value)
    {
        // Apply to Section's configuration
        if (Section.Configuration is AssessmentConfiguration config)
        {
            config.RatingScale = value;
        }
        StateHasChanged();
    }

    private string GetScaleLowLabel()
    {
        if (Section.Configuration is AssessmentConfiguration config)
        {
            return config.ScaleLowLabel ?? "Poor";
        }
        return "Poor";
    }

    private void SetScaleLowLabel(string value)
    {
        // Apply to Section's configuration
        if (Section.Configuration is AssessmentConfiguration config)
        {
            config.ScaleLowLabel = value ?? "Poor";
        }
        StateHasChanged();
    }

    private string GetScaleHighLabel()
    {
        if (Section.Configuration is AssessmentConfiguration config)
        {
            return config.ScaleHighLabel ?? "Excellent";
        }
        return "Excellent";
    }

    private void SetScaleHighLabel(string value)
    {
        // Apply to Section's configuration
        if (Section.Configuration is AssessmentConfiguration config)
        {
            config.ScaleHighLabel = value ?? "Excellent";
        }
        StateHasChanged();
    }

    // Role selection support
    private List<RoleOption> roleOptions = new()
    {
        new() { Value = CompletionRole.Employee, Text = "Employee", Icon = "person" },
        new() { Value = CompletionRole.Manager, Text = "Manager", Icon = "supervisor_account" },
        new() { Value = CompletionRole.Both, Text = "Both", Icon = "groups" }
    };

    private List<RoleOption> GetFilteredRoleOptions()
    {
        // If manager review is not required, only allow Employee role
        if (!Template.RequiresManagerReview)
        {
            // Ensure section is set to Employee
            if (Section.CompletionRole != CompletionRole.Employee)
            {
                Section.CompletionRole = CompletionRole.Employee;
            }
            return roleOptions.Where(r => r.Value == CompletionRole.Employee).ToList();
        }
        return roleOptions;
    }

    private string GetCompletionRoleText()
    {
        return Section.CompletionRole switch
        {
            CompletionRole.Employee => "Employee",
            CompletionRole.Manager => "Manager",
            CompletionRole.Both => "Both",
            _ => "Unknown"
        };
    }

    public class RoleOption
    {
        public CompletionRole Value { get; set; }
        public string Text { get; set; } = string.Empty;
        public string Icon { get; set; } = string.Empty;
    }
}