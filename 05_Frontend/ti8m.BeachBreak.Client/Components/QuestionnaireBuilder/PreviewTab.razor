@using Radzen
@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Services
@inject QuestionConfigurationService ConfigService

<style>
    .summary-container {
        padding: 2rem;
        max-width: 1200px;
        margin: 0 auto;
    }

    .info-cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-cards-row {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-bottom: 2rem;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
    }

    .stat-card {
        text-align: center;
        padding: 1.5rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .stat-card.sections {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .stat-card.items {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 0.5rem;
    }

    .stat-label {
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        opacity: 0.9;
    }

    .structure-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: hidden;
    }

    .structure-table th {
        background: #f9fafb;
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: #374151;
        border-bottom: 2px solid #e5e7eb;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .structure-table td {
        padding: 0.875rem 1rem;
        border-bottom: 1px solid #f3f4f6;
        color: #374151;
    }

    .structure-table tr:last-child td {
        border-bottom: none;
    }

    .section-row {
        background: #fefefe;
    }

    .role-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.375rem 0.875rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 500;
        color: white;
    }

    .review-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.375rem 0.875rem;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .review-badge.required {
        background: #d1fae5;
        color: #065f46;
    }

    .review-badge.not-required {
        background: #f3f4f6;
        color: #6b7280;
    }

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #6b7280;
    }

    .empty-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }

    @@media (max-width: 768px) {
        .summary-container {
            padding: 1rem;
        }

        .stat-cards-row {
            grid-template-columns: 1fr;
            max-width: 100%;
        }

        .structure-table {
            font-size: 0.875rem;
        }
    }
</style>

<div class="summary-container">
    @if (Template.Sections.Any())
    {
        <!-- Template Information Cards -->
        <div class="info-cards-grid">
            <div class="info-card rz-background-color-base-100 rz-p-3 rz-border-radius-3" style="border: 1px solid var(--rz-base-300);">
                <h3 style="margin: 0 0 0.5rem 0; font-size: 0.875rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em;">Template Name</h3>
                <p style="margin: 0; font-size: 1.25rem; font-weight: 600; color: #111827;">@Template.Name</p>
            </div>

            <div class="info-card rz-background-color-base-100 rz-p-3 rz-border-radius-3" style="border: 1px solid var(--rz-base-300);">
                <h3 style="margin: 0 0 0.5rem 0; font-size: 0.875rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em;">Category</h3>
                <p style="margin: 0; font-size: 1.25rem; font-weight: 600; color: #111827;">@GetCategoryName()</p>
            </div>

            <div class="info-card rz-background-color-base-100 rz-p-3 rz-border-radius-3" style="border: 1px solid var(--rz-base-300);">
                <h3 style="margin: 0 0 0.5rem 0; font-size: 0.875rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em;">Review Required</h3>
                <div style="margin-top: 0.25rem;">
                    @if (Template.RequiresManagerReview)
                    {
                        <span class="review-badge required">
                            <RadzenIcon Icon="check_circle" Style="font-size: 1rem;" />
                            Yes
                        </span>
                    }
                    else
                    {
                        <span class="review-badge not-required">
                            <RadzenIcon Icon="cancel" Style="font-size: 1rem;" />
                            No
                        </span>
                    }
                </div>
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(Template.Description))
        {
            <div class="info-card rz-background-color-base-100 rz-p-3 rz-border-radius-3" style="border: 1px solid var(--rz-base-300); margin-bottom: 2rem;">
                <h3 style="margin: 0 0 0.5rem 0; font-size: 0.875rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em;">Description</h3>
                <p style="margin: 0; font-size: 1rem; color: #374151; line-height: 1.6;">@Template.Description</p>
            </div>
        }

        <!-- Aggregate Statistics -->
        <div class="stat-cards-row">
            <div class="stat-card sections">
                <div class="stat-number">@Template.Sections.Count</div>
                <div class="stat-label">Total Sections</div>
            </div>
            <div class="stat-card items">
                <div class="stat-number">@GetTotalItems()</div>
                <div class="stat-label">Total Items*</div>
            </div>
        </div>

        <!-- Structure Table -->
        <RadzenCard style="padding: 0;">
            <table class="structure-table">
                <thead>
                    <tr>
                        <th>Section</th>
                        <th style="text-align: center; width: 200px;">Completed By</th>
                        <th style="text-align: center; width: 250px;">Items</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var templateSection in Template.Sections.OrderBy(s => s.Order))
                    {
                        <tr class="section-row">
                            <td>
                                <strong>@templateSection.Title</strong>
                            </td>
                            <td style="text-align: center;">
                                @GetCompletionRoleBadge(templateSection)
                            </td>
                            <td style="text-align: center;">
                                @GetSectionItemsText(templateSection)
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </RadzenCard>

        <p style="margin-top: 1rem; font-size: 0.875rem; color: #6b7280; font-style: italic;">
            * Items include competencies (Assessment questions) and text sections (Text questions). Goal questions have items added during response.
        </p>
    }
    else
    {
        <div class="empty-state">
            <div class="empty-icon">ðŸ“‹</div>
            <p>Add sections and questions to see the summary</p>
        </div>
    }
</div>

@code {
    [Parameter, EditorRequired] public QuestionnaireTemplate Template { get; set; } = null!;
    [Parameter, EditorRequired] public Dictionary<QuestionType, string> QuestionTypeLabels { get; set; } = null!;
    [Parameter] public List<Category> Categories { get; set; } = new();

    private string GetCategoryName()
    {
        if (Template.CategoryId == Guid.Empty)
        {
            return "No category selected";
        }

        var category = Categories.FirstOrDefault(c => c.Id == Template.CategoryId);
        return category?.NameEn ?? "Unknown category";
    }

    private int GetTotalItems()
    {
        int total = 0;
        foreach (var section in Template.Sections)
        {
            foreach (var question in section.Questions)
            {
                total += GetItemCount(question);
            }
        }
        return total;
    }

    private int GetItemCount(QuestionItem question)
    {
        return question.Type switch
        {
            QuestionType.Assessment => ConfigService.GetCompetencies(question).Count,
            QuestionType.TextQuestion => ConfigService.GetTextSections(question).Count,
            QuestionType.Goal => 0, // Goals are added during response
            _ => 0
        };
    }

    private string GetSectionItemsText(QuestionSection section)
    {
        var itemCounts = new List<string>();
        int assessmentCount = 0;
        int textSectionCount = 0;
        bool hasGoals = false;

        foreach (var question in section.Questions)
        {
            switch (question.Type)
            {
                case QuestionType.Assessment:
                    assessmentCount += ConfigService.GetCompetencies(question).Count;
                    break;
                case QuestionType.TextQuestion:
                    textSectionCount += ConfigService.GetTextSections(question).Count;
                    break;
                case QuestionType.Goal:
                    hasGoals = true;
                    break;
            }
        }

        if (assessmentCount > 0)
        {
            itemCounts.Add($"{assessmentCount} competenc{(assessmentCount != 1 ? "ies" : "y")}");
        }

        if (textSectionCount > 0)
        {
            itemCounts.Add($"{textSectionCount} section{(textSectionCount != 1 ? "s" : "")}");
        }

        if (hasGoals)
        {
            itemCounts.Add("Goals added during response");
        }

        return itemCounts.Any() ? string.Join(", ", itemCounts) : "â€”";
    }

    private RenderFragment GetCompletionRoleBadge(QuestionSection section)
    {
        var roleColor = section.GetRoleColor();
        var roleIcon = section.GetRoleIcon();
        var roleText = GetCompletionRoleText(section.CompletionRole);

        return @<span class="role-badge" style="background-color: @roleColor;">
            <RadzenIcon Icon="@roleIcon" Style="font-size: 1rem;" />
            @roleText
        </span>;
    }

    private string GetCompletionRoleText(CompletionRole role)
    {
        return role switch
        {
            CompletionRole.Employee => "Employee",
            CompletionRole.Manager => "Manager",
            CompletionRole.Both => "Both",
            _ => "Unknown"
        };
    }
}
