@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Models.DTOs
@using ti8m.BeachBreak.Client.Components.Shared
@using ti8m.BeachBreak.Client.Components.Dialogs
@using ti8m.BeachBreak.Client.Services
@using ti8m.BeachBreak.Client.Extensions
@inject GoalService GoalService
@inject IGoalApiService GoalApiService
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject IAuthService AuthService
@inherits OptimizedComponentBase

@if (!HideHeader)
{
    <RadzenCard Class="goal-question">
        <RadzenText TextStyle="TextStyle.H5" Class="text-primary mb-3">
            <RadzenIcon Icon="flag" Class="me-2" />
            @Question.Title
            @if (Question.IsRequired) { <span class="text-danger">*</span> }
            <EditedDuringReviewBadge Response="@Response" />
        </RadzenText>

        @if (!string.IsNullOrWhiteSpace(Question.Description))
        {
            <RadzenText TextStyle="TextStyle.Body1" Class="mb-4">@Question.Description</RadzenText>
        }

        @RenderTwoSectionGoalContent()
    </RadzenCard>
}
else
{
    @RenderTwoSectionGoalContent()
}

@code {
    private RenderFragment RenderTwoSectionGoalContent() => __builder =>
    {
        <div class="two-section-goal-content">
            @* SECTION 1: Predecessor Goals Assessment (Always First if Available) *@
            @if (hasPredecessor)
            {
                <PredecessorGoalsComparisonSection
                    Question="@Question"
                    Response="@Response"
                    OnResponseChanged="@NotifyResponseChanged"
                    IsReadOnly="@IsReadOnly"
                    CurrentUserRole="@CurrentUserRole"
                    @ref="predecessorSection" />
            }
            else if (!IsReadOnly && !IsInReviewPhase())
            {
                @* Link Predecessor Section - Only show if no predecessor linked, not read-only, and not in review phase *@
                <RadzenAlert AlertStyle="AlertStyle.Info" Class="mb-4" ShowIcon="true">
                    <RadzenText TextStyle="TextStyle.Body2" Class="mb-2">
                        <strong>Link Previous Questionnaire:</strong> Link a predecessor questionnaire to rate goals from a previous period.
                    </RadzenText>
                    <RadzenButton Text="Link Predecessor Questionnaire"
                                Icon="link"
                                ButtonStyle="ButtonStyle.Primary"
                                Size="ButtonSize.Small"
                                Click="@ShowLinkPredecessorDialog" />
                </RadzenAlert>
            }

            @* SECTION 2: New Goals (Always Second, Collaborative Editing) *@
            <NewGoalsCollaborativeSection
                Question="@Question"
                Response="@Response"
                OnResponseChanged="@NotifyResponseChanged"
                IsReadOnly="@IsReadOnly"
                CurrentUserRole="@CurrentUserRole"
                AssignmentWorkflowState="@AssignmentWorkflowState"
                AssignmentId="@AssignmentId"
                @ref="newGoalsSection" />
        </div>
    };

    // === Old render fragment methods removed - now handled by child components ===

    [Parameter, EditorRequired] public QuestionItem Question { get; set; } = default!;
    [Parameter, EditorRequired] public QuestionResponse Response { get; set; } = default!;
    [Parameter] public EventCallback<QuestionResponse> OnResponseChanged { get; set; }
    [Parameter] public bool IsReadOnly { get; set; } = false;
    [Parameter] public bool HideHeader { get; set; } = false;
    [Parameter] public Guid AssignmentId { get; set; }
    [Parameter] public string CurrentUserRole { get; set; } = "Employee";
    [Parameter] public WorkflowState AssignmentWorkflowState { get; set; } = WorkflowState.EmployeeInProgress;
    [Parameter] public int GoalRefreshToken { get; set; } = 0;

    // Component references for the two sections
    private NewGoalsCollaborativeSection? newGoalsSection;
    private PredecessorGoalsComparisonSection? predecessorSection;

    // Current state (simplified for two-section approach)
    private bool hasPredecessor = false;

    // Helper properties that delegate to child components
    public bool HasPendingChanges => newGoalsSection?.HasPendingChanges ?? false;
    public bool HasValidationErrors => predecessorSection?.ValidationErrors?.Any() ?? false;

    // Tracking for refresh token to detect when parent requests data reload
    private int lastGoalRefreshToken = 0;

    protected override void OnInitialized()
    {
        LoadBasicGoalData();
        base.OnInitialized();
    }

    protected override void OnParametersSet()
    {
        if (HasParameterChanged(nameof(Question), Question) ||
            HasParameterChanged(nameof(Response), Response) ||
            GoalRefreshToken != lastGoalRefreshToken)
        {
            lastGoalRefreshToken = GoalRefreshToken;
            LoadBasicGoalData();
        }

        base.OnParametersSet();
    }

    private void LoadBasicGoalData()
    {
        // Only load basic state needed by parent component
        hasPredecessor = GoalService.GetPredecessorAssignmentId(Response).HasValue;
    }

    protected override bool HasStateChanged()
    {
        var responseDataHash = Response.ResponseData?.GetHashCode() ?? 0;
        return HasParameterChanged(nameof(Response.ResponseData), responseDataHash) ||
               HasParameterChanged(nameof(hasPredecessor), hasPredecessor);
    }


    private async Task ShowLinkPredecessorDialog()
    {
        var result = await DialogService.OpenAsync<LinkPredecessorDialog>("Link Predecessor Questionnaire",
            new Dictionary<string, object>
            {
                { "AssignmentId", AssignmentId },
                { "QuestionId", Question.Id }
            },
            new DialogOptions
            {
                Width = "800px",
                Resizable = true,
                Draggable = true,
                CloseDialogOnOverlayClick = false
            });

        if (result is bool success && success)
        {
            // Update local state and trigger re-render
            LoadBasicGoalData();
            await NotifyResponseChanged();
            await InvokeAsync(StateHasChanged);
        }
    }


    /// <summary>
    /// Executes all pending goal operations by delegating to the child component.
    /// Returns true if all operations succeed, false if any fail.
    /// </summary>
    public async Task<bool> SavePendingGoalChanges()
    {
        // Delegate to the child component which handles all goal operations
        if (newGoalsSection != null)
        {
            return await newGoalsSection.SavePendingGoalChanges();
        }

        return true; // No pending changes if component not initialized
    }

    private async Task NotifyResponseChanged()
    {
        if (OnResponseChanged.HasDelegate)
        {
            await OnResponseChanged.InvokeAsync(Response);
        }
    }

    /// <summary>
    /// Checks if the assignment is in a review phase where structural changes (like linking predecessors) should not be allowed.
    /// </summary>
    private bool IsInReviewPhase()
    {
        return AssignmentWorkflowState is WorkflowState.InReview or
                                         WorkflowState.ManagerReviewConfirmed or
                                         WorkflowState.EmployeeReviewConfirmed or
                                         WorkflowState.Finalized;
    }

}

<style>
.two-section-goal-content {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

/* Ensure proper section ordering */
.two-section-goal-content > .predecessor-goals-section {
    order: 1; /* Always first */
}

.two-section-goal-content > .new-goals-section {
    order: 2; /* Always second */
}

/* Performance optimization */
.two-section-goal-content[data-updating="true"] {
    opacity: 0.8;
}
</style>
