@using ti8m.BeachBreak.Client.Services
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Models.DTOs
@inject ITypedQuestionnaireResponseService TypedResponseService

<div class="assessment-question-container">
    @if (assessmentResponse != null && competencies.Any())
    {
        <div class="competencies-grid">
            @foreach (var competency in competencies)
            {
                <div class="competency-card">
                    <div class="competency-header">
                        <h4>@competency.Name</h4>
                        @if (!string.IsNullOrEmpty(competency.Description))
                        {
                            <p class="competency-description">@competency.Description</p>
                        }
                    </div>

                    <!-- Rating buttons - Type-safe, no magic strings! -->
                    <div class="rating-buttons">
                        @for (int rating = ratingScale.MinValue; rating <= ratingScale.MaxValue; rating++)
                        {
                            var currentRating = rating;
                            var isSelected = GetCompetencyRating(competency.Key) == currentRating;

                            <button type="button"
                                    class="btn rating-btn @(isSelected ? "selected" : "")"
                                    @onclick="() => SetCompetencyRatingTypeSafe(competency.Key, currentRating)"
                                    disabled="@IsReadOnly">
                                <span class="rating-value">@currentRating</span>
                                <span class="rating-description">@GetRatingDescription(currentRating)</span>
                            </button>
                        }
                    </div>

                    <!-- Comment section -->
                    <div class="comment-section">
                        <RadzenTextArea
                            Value="@GetCompetencyComment(competency.Key)"
                            ValueChanged="@(value => SetCompetencyCommentTypeSafe(competency.Key, value))"
                            Placeholder="Optional comment..."
                            Rows="2"
                            Disabled="@IsReadOnly" />
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="no-competencies">
            <p>No competencies configured for this assessment.</p>
        </div>
    }
</div>

@code {
    [Parameter] public QuestionItem Question { get; set; } = null!;
    [Parameter] public QuestionResponseDto Response { get; set; } = null!;
    [Parameter] public bool IsReadOnly { get; set; }
    [Parameter] public EventCallback<QuestionResponseDto> OnResponseChanged { get; set; }

    // Type-safe properties - NO MORE Dictionary<string, object>!
    private AssessmentResponseDto assessmentResponse = new();
    private List<CompetencyItem> competencies = new();
    private RatingScale ratingScale = RatingScale.Default;

    protected override void OnInitialized()
    {
        base.OnInitialized();
        InitializeTypeSafeData();
    }

    protected override void OnParametersSet()
    {
        if (HasParameterChanged(nameof(Question), Question) || HasParameterChanged(nameof(Response), Response))
        {
            InitializeTypeSafeData();
        }
    }

    /// <summary>
    /// Initialize type-safe data structures - NO MORE MAGIC STRINGS!
    /// </summary>
    private void InitializeTypeSafeData()
    {
        // Load configuration using type-safe service
        var configJson = Question?.Configuration != null ? System.Text.Json.JsonSerializer.Serialize(Question.Configuration) : null;
        competencies = TypedAssessmentQuestionService.GetCompetenciesFromConfiguration(configJson);
        ratingScale = TypedAssessmentQuestionService.GetRatingScale(configJson);

        // Initialize or load response data from new ResponseData structure
        if (Response?.ResponseData is AssessmentResponseDataDto assessmentData)
        {
            assessmentResponse = new AssessmentResponseDto();
            foreach (var competency in assessmentData.Competencies)
            {
                assessmentResponse.SetCompetency(competency.Key, competency.Value.Rating, competency.Value.Comment);
            }
        }
        else
        {
            assessmentResponse = TypedAssessmentQuestionService.CreateAssessmentResponse();
        }
    }

    /// <summary>
    /// Type-safe competency rating getter - NO MAGIC STRINGS!
    /// </summary>
    private int GetCompetencyRating(string competencyKey)
    {
        var rating = TypedAssessmentQuestionService.GetCompetencyRating(assessmentResponse, competencyKey);
        return rating?.Rating ?? 0;
    }

    /// <summary>
    /// Type-safe competency rating setter - FIXES THE FORMAT BUG!
    /// Uses consistent format, eliminates "Rating_" vs "competency_" mismatch.
    /// </summary>
    private async Task SetCompetencyRatingTypeSafe(string competencyKey, int rating)
    {
        if (IsReadOnly) return;

        // Type-safe update - no dictionary manipulation!
        TypedAssessmentQuestionService.SetCompetencyRating(assessmentResponse, competencyKey, rating, GetCompetencyComment(competencyKey));

        Response.LastModified = DateTime.Now;
        await NotifyResponseChanged();
    }

    /// <summary>
    /// Type-safe competency comment getter.
    /// </summary>
    private string GetCompetencyComment(string competencyKey)
    {
        var rating = TypedAssessmentQuestionService.GetCompetencyRating(assessmentResponse, competencyKey);
        return rating?.Comment ?? string.Empty;
    }

    /// <summary>
    /// Type-safe competency comment setter.
    /// </summary>
    private async Task SetCompetencyCommentTypeSafe(string competencyKey, string comment)
    {
        if (IsReadOnly) return;

        var currentRating = GetCompetencyRating(competencyKey);
        TypedAssessmentQuestionService.SetCompetencyRating(assessmentResponse, competencyKey, currentRating, comment);

        Response.LastModified = DateTime.Now;
        await NotifyResponseChanged();
    }


    /// <summary>
    /// Gets rating description from scale.
    /// </summary>
    private string GetRatingDescription(int rating)
    {
        return ratingScale.Descriptions.TryGetValue(rating, out var description) ? description : rating.ToString();
    }

    /// <summary>
    /// Validates the response using type-safe validation.
    /// </summary>
    public bool IsResponseValid()
    {
        return TypedAssessmentQuestionService.IsAssessmentComplete(assessmentResponse, Question);
    }

    /// <summary>
    /// Notifies parent of response changes.
    /// </summary>
    private async Task NotifyResponseChanged()
    {
        await OnResponseChanged.InvokeAsync(Response);
    }

    /// <summary>
    /// Helper to detect parameter changes.
    /// </summary>
    private bool HasParameterChanged<T>(string parameterName, T value)
    {
        // Simple change detection - can be improved with proper change tracking
        return true;
    }
}

<style>
    .assessment-question-container {
        padding: 1rem;
    }

    .competencies-grid {
        display: grid;
        gap: 1.5rem;
    }

    .competency-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 1.5rem;
        background: #fafafa;
    }

    .competency-header h4 {
        margin: 0 0 0.5rem 0;
        color: #333;
    }

    .competency-description {
        margin: 0 0 1rem 0;
        color: #666;
        font-size: 0.9rem;
    }

    .rating-buttons {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .rating-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 0.5rem;
        border: 2px solid #ddd;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
        min-width: 80px;
    }

    .rating-btn:hover {
        border-color: #007bff;
        background: #f8f9fa;
    }

    .rating-btn.selected {
        border-color: #007bff;
        background: #007bff;
        color: white;
    }

    .rating-value {
        font-weight: bold;
        font-size: 1.2rem;
    }

    .rating-description {
        font-size: 0.8rem;
        text-align: center;
    }

    .comment-section {
        margin-top: 1rem;
    }

    .no-competencies {
        text-align: center;
        padding: 2rem;
        color: #666;
    }
</style>