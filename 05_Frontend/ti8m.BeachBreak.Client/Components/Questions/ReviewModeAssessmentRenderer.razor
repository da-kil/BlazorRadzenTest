@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Models.DTOs
@using ti8m.BeachBreak.Client.Components.Shared
@using ti8m.BeachBreak.Client.Components.Questions
@using ti8m.BeachBreak.Client.Helpers

<div class="rating-scale-info mb-3">
    <RadzenIcon Icon="info" Class="me-2" />
    <strong>Rating Scale:</strong> @AssessmentConfigurationHelper.GetRatingScaleDescription(ratingScale, scaleLowLabel, scaleHighLabel)
</div>

@if (!evaluations.Any())
{
    <RadzenAlert AlertStyle="AlertStyle.Warning" Variant="Variant.Flat" Class="mb-3">
        <RadzenText TextStyle="TextStyle.Body2">
            <strong>Configuration Error:</strong> No evaluations are defined for this question.
        </RadzenText>
    </RadzenAlert>
}
else
{
    @foreach (var evaluation in evaluations)
    {
        var employeeRating = AssessmentConfigurationHelper.GetEvaluationRatingDto(EmployeeResponse, evaluation.Key);
        var managerRating = AssessmentConfigurationHelper.GetEvaluationRatingDto(ManagerResponse, evaluation.Key);
        var hasDifference = employeeRating.Rating != managerRating.Rating;

        <!-- Each evaluation gets its own comparison card -->
        <div class="evaluation-comparison-card @(hasDifference ? "has-rating-difference" : "")">
            @if (hasDifference)
            {
                <div class="difference-indicator">
                    <RadzenIcon Icon="compare_arrows" Class="me-1" />
                    <span class="difference-text">Rating Difference: @employeeRating.Rating vs @managerRating.Rating stars</span>
                </div>
            }
            <div class="side-by-side-view">
                <!-- Employee Rating -->
                <div class="answer-column employee @(hasDifference ? "has-difference" : "")">
                    <div class="answer-header">
                        <span class="answer-label">
                            <RadzenIcon Icon="person" Style="font-size: 1rem;" />
                            Employee's Answer
                            @if (hasDifference)
                            {
                                <RadzenBadge Text="@($"{employeeRating.Rating} ★")"
                                           Class="rating-badge employee-rating"
                                           BadgeStyle="BadgeStyle.Light" />
                            }
                        </span>
                    </div>
                    <div class="answer-content">
                        <EvaluationRatingItem
                            Evaluation="@evaluation"
                            Rating="@employeeRating"
                            OnRatingChanged="@((rating) => Task.CompletedTask)"
                            IsReadOnly="true"
                            RatingScale="@ratingScale"
                            ScaleLowLabel="@scaleLowLabel"
                            ScaleHighLabel="@scaleHighLabel" />
                    </div>
                    <div class="answer-actions">
                        <RadzenButton Text="Copy to Manager →"
                                     ButtonStyle="ButtonStyle.Light"
                                     Icon="content_copy"
                                     Size="ButtonSize.Small"
                                     Click="@(() => OnCopyAnswer.InvokeAsync((Question, CompletionRole.Employee, CompletionRole.Manager)))"
                                     Class="copy-button" />
                        <RadzenButton Text="Edit"
                                     ButtonStyle="ButtonStyle.Primary"
                                     Icon="edit"
                                     Size="ButtonSize.Small"
                                     Click="@(() => OnEditAnswer.InvokeAsync((Question, CompletionRole.Employee, evaluation.Key)))" />
                    </div>
                </div>

                <!-- Manager Rating -->
                <div class="answer-column manager @(hasDifference ? "has-difference" : "")">
                    <div class="answer-header">
                        <span class="answer-label">
                            <RadzenIcon Icon="supervisor_account" Style="font-size: 1rem;" />
                            Manager's Answer
                            @if (hasDifference)
                            {
                                <RadzenBadge Text="@($"{managerRating.Rating} ★")"
                                           Class="rating-badge manager-rating"
                                           BadgeStyle="BadgeStyle.Light" />
                            }
                        </span>
                    </div>
                    <div class="answer-content">
                        <EvaluationRatingItem
                            Evaluation="@evaluation"
                            Rating="@managerRating"
                            OnRatingChanged="@((rating) => Task.CompletedTask)"
                            IsReadOnly="true"
                            RatingScale="@ratingScale"
                            ScaleLowLabel="@scaleLowLabel"
                            ScaleHighLabel="@scaleHighLabel" />
                    </div>
                    <div class="answer-actions">
                        <RadzenButton Text="← Copy to Employee"
                                     ButtonStyle="ButtonStyle.Light"
                                     Icon="content_copy"
                                     Size="ButtonSize.Small"
                                     Click="@(() => OnCopyAnswer.InvokeAsync((Question, CompletionRole.Manager, CompletionRole.Employee)))"
                                     Class="copy-button" />
                        <RadzenButton Text="Edit"
                                     ButtonStyle="ButtonStyle.Primary"
                                     Icon="edit"
                                     Size="ButtonSize.Small"
                                     Click="@(() => OnEditAnswer.InvokeAsync((Question, CompletionRole.Manager, evaluation.Key)))" />
                    </div>
                </div>
            </div>
        </div>
    }
}

@code {
    [Parameter, EditorRequired] public QuestionSection Question { get; set; } = default!;
    [Parameter, EditorRequired] public QuestionResponse EmployeeResponse { get; set; } = default!;
    [Parameter, EditorRequired] public QuestionResponse ManagerResponse { get; set; } = default!;
    [Parameter] public EventCallback<(QuestionSection, CompletionRole, string?)> OnEditAnswer { get; set; } // Added evaluation key
    [Parameter] public EventCallback<(QuestionSection, CompletionRole, CompletionRole)> OnCopyAnswer { get; set; }

    private List<EvaluationItem> evaluations = new();
    private int ratingScale = 4;
    private string scaleLowLabel = "Poor";
    private string scaleHighLabel = "Excellent";

    protected override void OnInitialized()
    {
        LoadConfiguration();
    }

    protected override void OnParametersSet()
    {
        LoadConfiguration();
    }

    private void LoadConfiguration()
    {
        evaluations = AssessmentConfigurationHelper.GetEvaluationsFromConfiguration(Question);
        ratingScale = AssessmentConfigurationHelper.GetRatingScaleFromConfiguration(Question);
        scaleLowLabel = AssessmentConfigurationHelper.GetScaleLowLabelFromConfiguration(Question);
        scaleHighLabel = AssessmentConfigurationHelper.GetScaleHighLabelFromConfiguration(Question);
    }
}
