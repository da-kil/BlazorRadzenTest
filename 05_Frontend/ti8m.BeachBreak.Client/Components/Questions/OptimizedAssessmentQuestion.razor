@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Models.DTOs
@using ti8m.BeachBreak.Client.Components.Shared
@using ti8m.BeachBreak.Client.Components.Questions
@inherits OptimizedTranslatableComponentBase

@if (!HideHeader)
{
    <div class="assessment-question">
        <header class="question-header">
            <h3 class="question-title">
                @Question.GetLocalizedTitleWithFallback(CurrentLanguage)
                @if (Question.IsRequired) { <span class="text-danger">*</span> }
                <EditedDuringReviewBadge Response="@Response" />
            </h3>

            @{
                var questionDescription = Question.GetLocalizedDescriptionWithFallback(CurrentLanguage);
            }
            @if (!string.IsNullOrWhiteSpace(questionDescription))
            {
                <p class="question-description">@questionDescription</p>
            }

            <div class="rating-scale-info">
                <RadzenIcon Icon="info" Class="me-2" />
                <strong>Rating Scale:</strong> @GetRatingScaleDescription()
            </div>
        </header>

        <div class="evaluations-container">
        @if (!evaluations.Any())
        {
            <RadzenAlert AlertStyle="AlertStyle.Warning" Variant="Variant.Flat" Class="mb-3">
                <RadzenText TextStyle="TextStyle.Body2">
                    <strong>Configuration Error:</strong> No evaluations are defined for this question. Please edit the template to add evaluations.
                </RadzenText>
            </RadzenAlert>
        }
        else
        {
            @if (evaluations.Any(c => string.IsNullOrWhiteSpace(c.GetLocalizedTitleWithFallback(CurrentLanguage))))
            {
                <RadzenAlert AlertStyle="AlertStyle.Warning" Variant="Variant.Flat" Class="mb-3">
                    <RadzenText TextStyle="TextStyle.Body2">
                        <strong>Incomplete Configuration:</strong> One or more evaluations are missing titles. Please edit the template to complete the evaluation configuration.
                    </RadzenText>
                </RadzenAlert>
            }
            @foreach (var evaluation in evaluations)
            {
                var evaluationRating = GetEvaluationRatingDto(evaluation.Key);
                <EvaluationRatingItem @key="@evaluation.Key"
                                     Evaluation="@evaluation"
                                     Rating="@evaluationRating"
                                     OnRatingChanged="@((rating) => OnEvaluationRatingChanged(evaluation.Key, rating))"
                                     IsReadOnly="@IsReadOnly"
                                     RatingScale="@ratingScale"
                                     ScaleLowLabel="@scaleLowLabel"
                                     ScaleHighLabel="@scaleHighLabel" />
            }
        }
        </div>
    </div>
}
else
{
    <div class="rating-scale-info">
        <RadzenIcon Icon="info" Class="me-2" />
        <strong>Rating Scale:</strong> @GetRatingScaleDescription()
    </div>

    <div class="evaluations-container">
        @if (!evaluations.Any())
        {
            <RadzenAlert AlertStyle="AlertStyle.Warning" Variant="Variant.Flat" Class="mb-3">
                <RadzenText TextStyle="TextStyle.Body2">
                    <strong>Configuration Error:</strong> No evaluations are defined for this question. Please edit the template to add evaluations.
                </RadzenText>
            </RadzenAlert>
        }
        else
        {
            @if (evaluations.Any(c => string.IsNullOrWhiteSpace(c.GetLocalizedTitleWithFallback(CurrentLanguage))))
            {
                <RadzenAlert AlertStyle="AlertStyle.Warning" Variant="Variant.Flat" Class="mb-3">
                    <RadzenText TextStyle="TextStyle.Body2">
                        <strong>Incomplete Configuration:</strong> One or more evaluations are missing titles. Please edit the template to complete the evaluation configuration.
                    </RadzenText>
                </RadzenAlert>
            }
            @foreach (var evaluation in evaluations)
            {
                var evaluationRating = GetEvaluationRatingDto(evaluation.Key);
                <EvaluationRatingItem @key="@evaluation.Key"
                                     Evaluation="@evaluation"
                                     Rating="@evaluationRating"
                                     OnRatingChanged="@((rating) => OnEvaluationRatingChanged(evaluation.Key, rating))"
                                     IsReadOnly="@IsReadOnly"
                                     RatingScale="@ratingScale"
                                     ScaleLowLabel="@scaleLowLabel"
                                     ScaleHighLabel="@scaleHighLabel" />
            }
        }
    </div>
}

@code {
    [Parameter, EditorRequired] public QuestionItem Question { get; set; } = default!;
    [Parameter, EditorRequired] public QuestionResponse Response { get; set; } = default!;
    [Parameter] public EventCallback<QuestionResponse> OnResponseChanged { get; set; }
    [Parameter] public bool IsReadOnly { get; set; } = false;
    [Parameter] public bool HideHeader { get; set; } = false;

    private List<EvaluationItem> evaluations = new();
    private int ratingScale = 4;
    private string scaleLowLabel = "Poor";
    private string scaleHighLabel = "Excellent";

    protected override async Task OnInitializedAsync()
    {
        // Always load configuration on initialization
        // This ensures the component works correctly when used in dialogs or other contexts
        // where parameter change detection might not work as expected
        LoadConfigurationAsync();

        await base.OnInitializedAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (HasParameterChanged(nameof(Question), Question))
        {
            LoadConfigurationAsync();
        }
        await base.OnParametersSetAsync();
    }

    private void LoadConfigurationAsync()
    {
        if (Question.Configuration is AssessmentConfiguration config)
        {
            evaluations = config.Evaluations.OrderBy(e => e.Order).ToList();
            ratingScale = config.RatingScale;
            scaleLowLabel = config.ScaleLowLabel;
            scaleHighLabel = config.ScaleHighLabel;
        }
        else
        {
            // Fallback for invalid configuration
            evaluations = new List<EvaluationItem>();
            ratingScale = 4;
            scaleLowLabel = "Poor";
            scaleHighLabel = "Excellent";
        }
    }

    private string GetRatingScaleDescription()
    {
        return $"1 ({scaleLowLabel}) - {ratingScale} ({scaleHighLabel})";
    }

    protected override bool HasStateChanged()
    {
        // Check if response data has changed - compare by reference since ResponseData is strongly typed
        var responseDataHash = Response.ResponseData?.GetHashCode() ?? 0;
        return HasParameterChanged(nameof(Response.ResponseData), responseDataHash) ||
               HasParameterChanged(nameof(evaluations), evaluations.Count);
    }

    private int GetEvaluationRating(string evaluationKey)
    {
        if (Response.ResponseData is AssessmentResponseDataDto assessmentData &&
            assessmentData.Evaluations.TryGetValue(evaluationKey, out var evaluationRating))
        {
            return evaluationRating.Rating;
        }

        return 0;
    }

    private async Task NotifyResponseChanged()
    {
        if (OnResponseChanged.HasDelegate)
        {
            await OnResponseChanged.InvokeAsync(Response);
        }
    }

    private EvaluationRatingDto GetEvaluationRatingDto(string evaluationKey)
    {
        // Ensure we have an AssessmentResponseDataDto
        if (Response.ResponseData is not AssessmentResponseDataDto assessmentData)
        {
            assessmentData = new AssessmentResponseDataDto();
            Response.ResponseData = assessmentData;
        }

        // Get existing evaluation or create new one
        if (!assessmentData.Evaluations.TryGetValue(evaluationKey, out var existingRating))
        {
            existingRating = new EvaluationRatingDto();
            assessmentData.Evaluations[evaluationKey] = existingRating;
        }

        return existingRating;
    }

    private async Task OnEvaluationRatingChanged(string evaluationKey, EvaluationRatingDto rating)
    {
        if (IsReadOnly) return;

        // Ensure we have an AssessmentResponseDataDto
        if (Response.ResponseData is not AssessmentResponseDataDto assessmentData)
        {
            assessmentData = new AssessmentResponseDataDto();
            Response.ResponseData = assessmentData;
        }

        // Update the evaluation rating in the response data
        assessmentData.Evaluations[evaluationKey] = rating;
        Response.LastModified = DateTime.Now;

        await NotifyResponseChanged();
    }
}