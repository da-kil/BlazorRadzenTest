@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Models.DTOs
@using ti8m.BeachBreak.Client.Components.Shared
@inherits OptimizedTranslatableComponentBase

@if (!HideHeader)
{
    <div class="text-question">
        <header class="question-header">
            <h3 class="question-title">
                @Section.GetLocalizedTitleWithFallback(CurrentLanguage)
                <EditedDuringReviewBadge Response="@Response" />
            </h3>

            @{
                var questionDescription = Section.GetLocalizedDescriptionWithFallback(CurrentLanguage);
            }
            @if (!string.IsNullOrWhiteSpace(questionDescription))
            {
                <p class="question-description">@questionDescription</p>
            }
        </header>

        <div class="text-sections">
        @{
            var sectionsToRender = textSections.Any() ? textSections : GetTextSectionsFromConfiguration();
        }
        @foreach (var section in sectionsToRender)
        {
            var sectionKey = $"section_{sectionsToRender.IndexOf(section)}";
            <div class="text-section-card" @key="@sectionKey">
                <header class="question-section-header">
                    @{
                        var sectionTitle = section.GetLocalizedTitle(CurrentLanguage);
                    }
                    <h4 class="question-title @(string.IsNullOrWhiteSpace(sectionTitle) ? "text-danger" : "")">
                        @sectionTitle
                        @if (section.IsRequired) { <span class="text-danger">*</span> }
                    </h4>
                </header>

                @if (!IsReadOnly)
                {
                    <RadzenTextArea Value="@GetSectionValue(sectionKey)"
                                  ValueChanged="@((string value) => SetSectionValue(sectionKey, value))"
                                  Placeholder="@GetSectionPlaceholder(section)"
                                  Rows="@GetSectionRows(section)"
                                  Class="w-100"
                                  Disabled="@IsReadOnly" />
                }
                else if (!string.IsNullOrEmpty(GetSectionValue(sectionKey)))
                {
                    <div class="readonly-text p-3 rounded theme-aware-bg">
                        @GetSectionValue(sectionKey)
                    </div>
                }
                else
                {
                    <div class="no-response p-3 rounded text-muted theme-aware-bg">
                        <em>@T("messages.no-response-provided")</em>
                    </div>
                }
            </div>
        }
    </div>
</div>
}
else
{
    <div class="text-sections">
        @{
            var sectionsToRenderNoHeader = textSections.Any() ? textSections : GetTextSectionsFromConfiguration();
        }
        @foreach (var textSection in sectionsToRenderNoHeader)
        {
            var sectionKey = $"section_{sectionsToRenderNoHeader.IndexOf(textSection)}";
            <div class="text-section-card" @key="@sectionKey">
                <header class="question-section-header">
                    @{
                        var textSectionTitle = textSection.GetLocalizedTitle(CurrentLanguage);
                    }
                    <h4 class="question-title @(string.IsNullOrWhiteSpace(textSectionTitle) ? "text-danger" : "")">
                        @textSectionTitle
                        @if (textSection.IsRequired) { <span class="text-danger">*</span> }
                    </h4>
                </header>
                @if (!IsReadOnly)
                {
                    <RadzenTextArea Value="@GetSectionValue(sectionKey)"
                                  ValueChanged="@((string value) => SetSectionValue(sectionKey, value))"
                                  Placeholder="@GetSectionPlaceholder(textSection)"
                                  Rows="@GetSectionRows(textSection)"
                                  Class="w-100" />
                }
                else if (!string.IsNullOrEmpty(GetSectionValue(sectionKey)))
                {
                    <div class="readonly-text p-3 rounded theme-aware-bg">
                        @GetSectionValue(sectionKey)
                    </div>
                }
                else
                {
                    <div class="no-response p-3 rounded text-muted theme-aware-bg">
                        <em>@T("messages.no-response-provided")</em>
                    </div>
                }
            </div>
        }
    </div>
}

@code {
    [Parameter, EditorRequired] public QuestionSection Section { get; set; } = default!;
    [Parameter, EditorRequired] public QuestionResponse Response { get; set; } = default!;
    [Parameter] public EventCallback<QuestionResponse> OnResponseChanged { get; set; }
    [Parameter] public bool IsReadOnly { get; set; } = false;
    [Parameter] public bool HideHeader { get; set; } = false;

    private List<TextSection> textSections = new();

    protected override void OnInitialized()
    {
        base.OnInitialized();
        // Always populate textSections on first render
        textSections = GetTextSectionsFromConfiguration();
    }

    protected override void OnParametersSet()
    {
        if (HasParameterChanged(nameof(Section), Section))
        {
            textSections = GetTextSectionsFromConfiguration();
        }

        // Safety check: Ensure textSections is never empty after parameter updates
        // This prevents textboxes from disappearing after save operations
        if (!textSections.Any())
        {
            textSections = GetTextSectionsFromConfiguration();
        }
    }

    protected override bool HasStateChanged()
    {
        // Ensure textSections is always populated before checking state changes
        if (!textSections.Any())
        {
            textSections = GetTextSectionsFromConfiguration();
        }

        // Get current simple value from ResponseData
        var currentValue = "";
        if (Response.ResponseData is TextResponseDataDto textData && textData.TextSections.Any())
        {
            currentValue = textData.TextSections[0];
        }

        var responseDataHash = Response.ResponseData?.GetHashCode() ?? 0;
        return HasParameterChanged("CurrentValue", currentValue) ||
               HasParameterChanged(nameof(Response.ResponseData), responseDataHash);
    }

    private List<TextSection> GetTextSectionsFromConfiguration()
    {
        if (Section.Configuration is TextQuestionConfiguration config && config.TextSections.Any())
        {
            return config.TextSections.OrderBy(s => s.Order).ToList();
        }

        // Default fallback - always return at least one section
        return new List<TextSection>
        {
            new TextSection
            {
                TitleGerman = T("sections.response"),
                TitleEnglish = T("sections.response"),
                IsRequired = true, // Default fallback text section is required
                Order = 0
            }
        };
    }


    private string GetSectionValue(string sectionKey)
    {
        // Ensure textSections is populated before using it
        if (!textSections.Any())
        {
            textSections = GetTextSectionsFromConfiguration();
        }

        if (Response.ResponseData is not TextResponseDataDto textData)
        {
            return "";
        }

        if (textSections.Count == 1)
        {
            // Single section - return first text section
            return textData.TextSections.FirstOrDefault() ?? "";
        }

        // Multiple sections - extract section index from key like "section_0", "section_1"
        if (sectionKey.StartsWith("section_") && int.TryParse(sectionKey.Substring(8), out var index))
        {
            return index < textData.TextSections.Count ? textData.TextSections[index] : "";
        }

        return "";
    }

    private async Task SetSectionValue(string sectionKey, string value)
    {
        if (IsReadOnly) return;

        // Ensure textSections is populated before using it
        if (!textSections.Any())
        {
            textSections = GetTextSectionsFromConfiguration();
        }

        // Ensure we have a TextResponseDataDto
        if (Response.ResponseData is not TextResponseDataDto textData)
        {
            textData = new TextResponseDataDto();
            Response.ResponseData = textData;
        }

        if (textSections.Count == 1)
        {
            // Single section - set or update the first text section
            if (textData.TextSections.Count == 0)
            {
                textData.TextSections.Add(value ?? "");
            }
            else
            {
                textData.TextSections[0] = value ?? "";
            }
        }
        else
        {
            // Multiple sections - extract section index from key like "section_0", "section_1"
            if (sectionKey.StartsWith("section_") && int.TryParse(sectionKey.Substring(8), out var index))
            {
                // Ensure the list is large enough
                while (textData.TextSections.Count <= index)
                {
                    textData.TextSections.Add("");
                }

                textData.TextSections[index] = value ?? "";
            }
        }

        Response.LastModified = DateTime.Now;

        // Debounce text input changes to avoid excessive API calls
        await NotifyStateChangedDebounced(500);
        await NotifyResponseChanged();
    }

    private async Task NotifyResponseChanged()
    {
        if (OnResponseChanged.HasDelegate)
        {
            await OnResponseChanged.InvokeAsync(Response);
        }
    }

    private string GetSectionPlaceholder(TextSection section)
    {
        // TextSection in frontend doesn't have placeholder properties - return empty
        return T("placeholders.enter-thoughts-plans-goals");
    }

    private int GetSectionRows(TextSection section)
    {
        // TextSection in frontend doesn't have Rows property - return default
        return 4;
    }

    private string GetTextSectionsDescription()
    {
        var sectionCount = textSections.Count;
        if (sectionCount == 1)
        {
            return T("sections.single-text-section");
        }
        else
        {
            return T("sections.multiple-text-sections-to-complete").Replace("{count}", sectionCount.ToString());
        }
    }
}