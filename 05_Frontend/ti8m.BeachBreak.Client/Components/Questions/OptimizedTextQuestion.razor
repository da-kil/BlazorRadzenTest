@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Models.DTOs
@using ti8m.BeachBreak.Client.Components.Shared
@inherits OptimizedComponentBase

@if (!HideHeader)
{
    <div class="text-question">
        <header class="question-header">
            <h3 class="question-title">
                <RadzenIcon Icon="psychology" Class="me-2" />
                @Question.Title
                @if (Question.IsRequired) { <span class="text-danger">*</span> }
                <EditedDuringReviewBadge Response="@Response" />
            </h3>

            @if (!string.IsNullOrWhiteSpace(Question.Description))
            {
                <p class="question-description">@Question.Description</p>
            }
        </header>

        <div class="text-sections">
        @{
            var sectionsToRender = textSections.Any() ? textSections : GetTextSectionsFromConfiguration();
        }
        @foreach (var section in sectionsToRender)
        {
            var sectionKey = $"section_{sectionsToRender.IndexOf(section)}";
            <div class="text-section-card" @key="@sectionKey">
                @if (!string.IsNullOrWhiteSpace(section.Title))
                {
                    <h4 class="text-section-title">
                        @(section.Title)
                        @if (section.IsRequired) { <span class="text-danger">*</span> }
                    </h4>
                }

                @if (!string.IsNullOrWhiteSpace(section.Description))
                {
                    <RadzenText TextStyle="TextStyle.Body2" Class="text-muted mb-2">
                        @(section.Description)
                    </RadzenText>
                }

                @if (!IsReadOnly)
                {
                    <RadzenTextArea Value="@GetSectionValue(sectionKey)"
                                  ValueChanged="@((string value) => SetSectionValue(sectionKey, value))"
                                  Placeholder="@GetSectionPlaceholder(section)"
                                  Rows="@GetSectionRows(section)"
                                  Class="w-100"
                                  Disabled="@IsReadOnly" />
                }
                else if (!string.IsNullOrEmpty(GetSectionValue(sectionKey)))
                {
                    <div class="readonly-text p-3 bg-light rounded">
                        @GetSectionValue(sectionKey)
                    </div>
                }
                else
                {
                    <div class="no-response p-3 bg-light rounded text-muted">
                        <em>No response provided</em>
                    </div>
                }
            </div>
        }
    </div>
</div>
}
else
{
    <div class="text-sections">
        @{
            var sectionsToRenderNoHeader = textSections.Any() ? textSections : GetTextSectionsFromConfiguration();
        }
        @foreach (var textSection in sectionsToRenderNoHeader)
        {
            var sectionKey = $"section_{sectionsToRenderNoHeader.IndexOf(textSection)}";
            <div class="text-section-card" @key="@sectionKey">
                <h4 class="text-section-title">
                    @textSection.Title
                    @if (textSection.IsRequired) { <span class="text-danger">*</span> }
                </h4>
                @if (!string.IsNullOrWhiteSpace(textSection.Description))
                {
                    <RadzenText TextStyle="TextStyle.Body2" Class="text-muted mb-2">@textSection.Description</RadzenText>
                }
                @if (!IsReadOnly)
                {
                    <RadzenTextArea Value="@GetSectionValue(sectionKey)"
                                  ValueChanged="@((string value) => SetSectionValue(sectionKey, value))"
                                  Placeholder="Enter your response..."
                                  Rows="5"
                                  Class="w-100" />
                }
                else if (!string.IsNullOrEmpty(GetSectionValue(sectionKey)))
                {
                    <div class="readonly-text p-3 bg-light rounded">
                        @GetSectionValue(sectionKey)
                    </div>
                }
                else
                {
                    <div class="no-response p-3 bg-light rounded text-muted">
                        <em>No response provided</em>
                    </div>
                }
            </div>
        }
    </div>
}

@code {
    [Parameter, EditorRequired] public QuestionItem Question { get; set; } = default!;
    [Parameter, EditorRequired] public QuestionResponse Response { get; set; } = default!;
    [Parameter] public EventCallback<QuestionResponse> OnResponseChanged { get; set; }
    [Parameter] public bool IsReadOnly { get; set; } = false;
    [Parameter] public bool HideHeader { get; set; } = false;

    private List<TextSectionDefinition> textSections = new();

    protected override void OnInitialized()
    {
        base.OnInitialized();
        // Always populate textSections on first render
        textSections = GetTextSectionsFromConfiguration();
    }

    protected override void OnParametersSet()
    {
        if (HasParameterChanged(nameof(Question), Question))
        {
            textSections = GetTextSectionsFromConfiguration();
        }

        // Safety check: Ensure textSections is never empty after parameter updates
        // This prevents textboxes from disappearing after save operations
        if (!textSections.Any())
        {
            textSections = GetTextSectionsFromConfiguration();
        }
    }

    protected override bool HasStateChanged()
    {
        // Ensure textSections is always populated before checking state changes
        if (!textSections.Any())
        {
            textSections = GetTextSectionsFromConfiguration();
        }

        // Get current simple value from ResponseData
        var currentValue = "";
        if (Response.ResponseData is TextResponseDataDto textData && textData.TextSections.Any())
        {
            currentValue = textData.TextSections[0];
        }

        var responseDataHash = Response.ResponseData?.GetHashCode() ?? 0;
        return HasParameterChanged("CurrentValue", currentValue) ||
               HasParameterChanged(nameof(Response.ResponseData), responseDataHash);
    }

    private List<TextSectionDefinition> GetTextSectionsFromConfiguration()
    {
        if (Question.Configuration?.ContainsKey("TextSections") == true)
        {
            var sectionsObj = Question.Configuration["TextSections"];

            if (sectionsObj is List<TextSectionDefinition> sections && sections.Any())
            {
                return sections;
            }

            // Handle JSON deserialization
            if (sectionsObj is System.Text.Json.JsonElement jsonElement &&
                jsonElement.ValueKind == System.Text.Json.JsonValueKind.Array)
            {
                try
                {
                    var deserializedSections = System.Text.Json.JsonSerializer.Deserialize<List<TextSectionDefinition>>(
                        jsonElement.GetRawText()
                    );

                    if (deserializedSections != null && deserializedSections.Any())
                    {
                        return deserializedSections;
                    }
                }
                catch (Exception)
                {
                    // Fallback to legacy format
                }
            }
        }

        // Legacy format or default - always return at least one section
        return new List<TextSectionDefinition>
        {
            new TextSectionDefinition
            {
                Title = GetLegacySectionTitle(),
                Description = GetLegacySectionDescription(),
                IsRequired = Question.IsRequired,
                Placeholder = "Enter your response here...",
                Rows = 4
            }
        };
    }

    private string GetLegacySectionTitle()
    {
        return Question.Configuration?.TryGetValue("SectionTitle", out var value) == true
            ? value.ToString() ?? "Response"
            : "Response";
    }

    private string GetLegacySectionDescription()
    {
        return Question.Configuration?.TryGetValue("SectionDescription", out var value) == true
            ? value.ToString() ?? ""
            : "";
    }

    private string GetSectionValue(string sectionKey)
    {
        // Ensure textSections is populated before using it
        if (!textSections.Any())
        {
            textSections = GetTextSectionsFromConfiguration();
        }

        if (Response.ResponseData is not TextResponseDataDto textData)
        {
            return "";
        }

        if (textSections.Count == 1)
        {
            // Single section - return first text section
            return textData.TextSections.FirstOrDefault() ?? "";
        }

        // Multiple sections - extract section index from key like "section_0", "section_1"
        if (sectionKey.StartsWith("section_") && int.TryParse(sectionKey.Substring(8), out var index))
        {
            return index < textData.TextSections.Count ? textData.TextSections[index] : "";
        }

        return "";
    }

    private async Task SetSectionValue(string sectionKey, string value)
    {
        if (IsReadOnly) return;

        // Ensure textSections is populated before using it
        if (!textSections.Any())
        {
            textSections = GetTextSectionsFromConfiguration();
        }

        // Ensure we have a TextResponseDataDto
        if (Response.ResponseData is not TextResponseDataDto textData)
        {
            textData = new TextResponseDataDto();
            Response.ResponseData = textData;
        }

        if (textSections.Count == 1)
        {
            // Single section - set or update the first text section
            if (textData.TextSections.Count == 0)
            {
                textData.TextSections.Add(value ?? "");
            }
            else
            {
                textData.TextSections[0] = value ?? "";
            }
        }
        else
        {
            // Multiple sections - extract section index from key like "section_0", "section_1"
            if (sectionKey.StartsWith("section_") && int.TryParse(sectionKey.Substring(8), out var index))
            {
                // Ensure the list is large enough
                while (textData.TextSections.Count <= index)
                {
                    textData.TextSections.Add("");
                }

                textData.TextSections[index] = value ?? "";
            }
        }

        Response.LastModified = DateTime.Now;

        // Debounce text input changes to avoid excessive API calls
        await NotifyStateChangedDebounced(500);
        await NotifyResponseChanged();
    }

    private async Task NotifyResponseChanged()
    {
        if (OnResponseChanged.HasDelegate)
        {
            await OnResponseChanged.InvokeAsync(Response);
        }
    }

    private string GetSectionPlaceholder(TextSectionDefinition section)
    {
        return !string.IsNullOrWhiteSpace(section.Placeholder)
            ? section.Placeholder
            : "Enter your thoughts, plans, and goals...";
    }

    private int GetSectionRows(TextSectionDefinition section)
    {
        return section.Rows > 0 ? section.Rows : 4;
    }

    private string GetTextSectionsDescription()
    {
        var sectionCount = textSections.Count;
        return sectionCount == 1
            ? "Single text section"
            : $"{sectionCount} text sections to complete";
    }

    public class TextSectionDefinition
    {
        public string Title { get; set; } = "";
        public string Description { get; set; } = "";
        public bool IsRequired { get; set; } = false;
        public string Placeholder { get; set; } = "";
        public int Rows { get; set; } = 4;
    }
}

<style>
.text-question {
}

.text-section-card {
    margin-bottom: 1.5rem;
    transition: all 0.2s ease;
    position: relative;
}

.text-section-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0 0 12px 0;
    color: var(--title-color) !important;
    display: flex;
    align-items: center;
}

.text-section-card:focus-within {
    box-shadow: 0 0 0 2px var(--focus-ring, rgba(37, 99, 235, 0.1));
}

.readonly-text {
    white-space: pre-wrap;
    word-wrap: break-word;
    line-height: 1.6;
    min-height: 60px;
}

.no-response {
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Performance optimization: reduce layout thrashing */
.text-section-card textarea {
    resize: vertical;
    transition: none; /* Disable transitions on input for better performance */
}

/* Visual indicator during updates */
.text-section-card[data-updating="true"] {
    opacity: 0.8;
}
</style>