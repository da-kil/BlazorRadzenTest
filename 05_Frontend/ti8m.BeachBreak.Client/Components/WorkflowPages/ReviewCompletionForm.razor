@using Radzen
@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Components.Shared
@inherits OptimizedTranslatableComponentBase

<div class="review-completion-form">
    <RadzenStack Gap="1rem">
        <!-- Header -->
        <div class="form-header">
            <RadzenText TextStyle="TextStyle.H6" Class="mb-0">
                @T("dialogs.finish-review-meeting")
            </RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" Class="text-muted mt-2">
                @T("dialogs.complete-review-meeting-description")
            </RadzenText>
        </div>

            <!-- Important Note -->
            <div class="important-note-prominent">
                <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter" ShowIcon="true">
                    <RadzenText TextStyle="TextStyle.Body2">
                        <strong>@T("labels.important"):</strong>
                        <span> @T("messages.review-completion-note")</span>
                    </RadzenText>
                </RadzenAlert>
            </div>

            <!-- Review Summary Section -->
            <div class="review-summary-section">
                <RadzenText TextStyle="TextStyle.Subtitle2" Class="fw-bold mb-2">
                    @T("dialogs.review-summary-optional")
                </RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" Class="text-muted mb-3">
                    @T("dialogs.summarize-key-points-discussed")
                </RadzenText>

                @if (!string.IsNullOrWhiteSpace(ExistingReviewSummary))
                {
                    <div class="existing-summary-warning mb-3">
                        <RadzenAlert AlertStyle="AlertStyle.Warning" Variant="Variant.Flat" Shade="Shade.Lighter" ShowIcon="true">
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Start" Gap="0.5rem">
                                <div>
                                    <RadzenText TextStyle="TextStyle.Body2" Class="fw-bold mb-1">
                                        @T("dialogs.existing-summary-loaded")
                                    </RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body2">
                                        @T("dialogs.can-edit-replace-summary")
                                    </RadzenText>
                                </div>
                            </RadzenStack>
                        </RadzenAlert>
                    </div>
                }

                <div class="review-summary-input">
                    <RadzenTextArea @bind-Value="@reviewSummary"
                                   Placeholder="@T("placeholders.enter-review-summary-optional")"
                                   Rows="8"
                                   Style="width: 100%;"
                                   MaxLength="5000"
                                   Class="mb-2" />
                    <div class="character-count">
                        <RadzenText TextStyle="TextStyle.Caption" Class="text-muted">
                            @(reviewSummary?.Length ?? 0) / 5000 @T("forms.characters")
                        </RadzenText>
                    </div>
                </div>
            </div>


            <!-- Action Buttons -->
            <div class="form-actions">
                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.75rem">
                    <RadzenButton Text="@T("buttons.cancel")"
                                  ButtonStyle="ButtonStyle.Light"
                                  Icon="cancel"
                                  Size="ButtonSize.Medium"
                                  Click="@HandleCancel"
                                  Disabled="@IsSubmitting" />

                    <AsyncButton Text="@T("dialogs.finish-review-meeting")"
                                ProcessingText="@T("dialogs.finishing")"
                                ButtonStyle="ButtonStyle.Success"
                                Icon="event_available"
                                Size="ButtonSize.Medium"
                                Click="@HandleSubmit"
                                IsProcessing="@IsSubmitting" />
                </RadzenStack>
            </div>

    </RadzenStack>
</div>

<style>
.review-completion-form {
    margin-bottom: 1rem;
}

.character-count {
    text-align: right;
}

.existing-summary-warning {
    border-left: 4px solid #ffc107;
    background-color: #fff3cd;
    padding: 0;
}

.form-actions {
    border-top: 1px solid var(--border-color);
    padding-top: 1rem;
    margin-top: 0.5rem;
}

.important-note-prominent {
    margin-top: 0.5rem;
    margin-bottom: 0.5rem;
}
</style>

@code {
    [Parameter] public string? ExistingReviewSummary { get; set; }
    [Parameter] public bool IsSubmitting { get; set; }
    [Parameter] public EventCallback<string> OnSubmit { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    private string? reviewSummary;

    protected override void OnInitialized()
    {
        // Initialize with existing summary if reopening review
        reviewSummary = ExistingReviewSummary;
        base.OnInitialized();
    }

    protected override void OnParametersSet()
    {
        // Update reviewSummary when parameters are set
        reviewSummary = ExistingReviewSummary;
        base.OnParametersSet();
    }

    private async Task HandleSubmit()
    {
        if (OnSubmit.HasDelegate)
        {
            // Combine review summary and notes
            var combinedReview = BuildCombinedReview();
            await OnSubmit.InvokeAsync(combinedReview);
        }
    }

    private string BuildCombinedReview()
    {
        var parts = new System.Collections.Generic.List<string>();

        if (!string.IsNullOrWhiteSpace(reviewSummary))
        {
            parts.Add(reviewSummary);
        }


        return string.Join("\n\n", parts);
    }

    private async Task HandleCancel()
    {
        if (OnCancel.HasDelegate)
        {
            await OnCancel.InvokeAsync();
        }
    }
}