@using ti8m.BeachBreak.Client.Models.Dto
@using ti8m.BeachBreak.Client.Services
@using ti8m.BeachBreak.Client.Components.Shared
@using Radzen.Blazor
@inject IQuestionnaireAssignmentService AssignmentService
@inject NotificationService NotificationService
@inherits OptimizedTranslatableComponentBase

<RadzenStack Gap="1rem">
    @if (isLoading)
    {
        <div class="text-center py-5">
            <RadzenProgressBarCircular Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
            <RadzenText TextStyle="TextStyle.Body2" Class="mt-3 text-muted">
                @T("messages.loading-change-history")
            </RadzenText>
        </div>
    }
    else if (changeLog == null || !changeLog.Any())
    {
        <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter">
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                <RadzenIcon Icon="info" />
                <RadzenText TextStyle="TextStyle.Body1">
                    @T("messages.no-changes-during-review")
                </RadzenText>
            </RadzenStack>
        </RadzenAlert>
    }
    else
    {
        <RadzenText TextStyle="TextStyle.Body2" Class="text-muted mb-3">
            <strong>@changeLog.Count</strong> change@(changeLog.Count == 1 ? "" : "s") recorded during the review meeting
        </RadzenText>

        <div class="change-timeline">
            @foreach (var change in changeLog)
            {
                <div class="change-item mb-4" @key="@change.Id">
                    <RadzenCard Class="change-card">
                        <RadzenStack Gap="0.75rem">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" Class="mb-2">
                                        <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text="@change.SectionTitle" />
                                        <RadzenBadge BadgeStyle="BadgeStyle.Light" Text="@change.OriginalCompletionRole" Shade="Shade.Lighter" />
                                    </RadzenStack>
                                    <RadzenText TextStyle="TextStyle.Subtitle2" Class="fw-bold">
                                        @change.QuestionTitle
                                    </RadzenText>
                                </div>
                                <RadzenIcon Icon="edit" Class="text-warning" />
                            </div>

                            <RadzenText TextStyle="TextStyle.Caption" Class="text-muted">
                                <RadzenIcon Icon="schedule" Style="font-size: 14px; vertical-align: middle;" Class="me-1" />
                                Edited by <strong>@change.ChangedBy</strong> on @change.ChangedAt.ToLocalTime().ToString("MMM dd, yyyy 'at' HH:mm")
                            </RadzenText>

                            <div class="change-comparison">
                                <div class="change-before">
                                    <RadzenText TextStyle="TextStyle.Overline" Class="text-muted mb-2">
                                        <RadzenIcon Icon="remove_circle_outline" Style="font-size: 14px; vertical-align: middle;" Class="me-1" />
                                        BEFORE
                                    </RadzenText>
                                    <div class="change-value p-3 theme-aware-summary-bg rounded">
                                        <RadzenText TextStyle="TextStyle.Body2" Style="white-space: pre-wrap;">
                                            @(string.IsNullOrWhiteSpace(change.OldValue) ? "(empty)" : FormatValue(change.OldValue))
                                        </RadzenText>
                                    </div>
                                </div>

                                <div class="arrow-container">
                                    <RadzenIcon Icon="arrow_forward" Class="text-primary" Style="font-size: 24px;" />
                                </div>

                                <div class="change-after">
                                    <RadzenText TextStyle="TextStyle.Overline" Class="text-muted mb-2">
                                        <RadzenIcon Icon="add_circle_outline" Style="font-size: 14px; vertical-align: middle;" Class="me-1" />
                                        AFTER
                                    </RadzenText>
                                    <div class="change-value p-3 theme-aware-summary-bg rounded">
                                        <RadzenText TextStyle="TextStyle.Body2" Style="white-space: pre-wrap;">
                                            @(string.IsNullOrWhiteSpace(change.NewValue) ? "(empty)" : FormatValue(change.NewValue))
                                        </RadzenText>
                                    </div>
                                </div>
                            </div>
                        </RadzenStack>
                    </RadzenCard>
                </div>
            }
        </div>
    }
</RadzenStack>

<style>
    .change-timeline {
        position: relative;
    }

    .change-item::before {
        content: '';
        position: absolute;
        left: -20px;
        top: 0;
        bottom: -16px;
        width: 2px;
        background: #dee2e6;
    }

    .change-item:last-child::before {
        display: none;
    }

    .change-item {
        position: relative;
    }

    .change-card {
        border-left: 3px solid #ffc107;
        transition: all 0.2s ease;
    }

    .change-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }

    .change-comparison {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        gap: 1.5rem;
        align-items: center;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .arrow-container {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .change-before, .change-after {
        min-width: 0;
    }

    .change-value {
        min-height: 60px;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    .change-before .change-value {
        border-left: 3px solid #dc3545;
    }

    .change-after .change-value {
        border-left: 3px solid #28a745;
    }

    @@media (max-width: 768px) {
        .change-comparison {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .arrow-container {
            transform: rotate(90deg);
        }
    }
</style>

@code {
    [Parameter]
    public Guid AssignmentId { get; set; }

    private List<ReviewChangeDto>? changeLog;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadChangeLog();
    }

    private async Task LoadChangeLog()
    {
        try
        {
            isLoading = true;
            changeLog = await AssignmentService.GetReviewChangesAsync(AssignmentId);
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load change history: {ex.Message}");
            changeLog = new List<ReviewChangeDto>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private string FormatValue(string value)
    {
        if (string.IsNullOrWhiteSpace(value))
            return "(empty)";

        // Try to parse as JSON and format nicely
        try
        {
            var jsonDoc = System.Text.Json.JsonDocument.Parse(value);
            var root = jsonDoc.RootElement;

            // Check for new strongly-typed ResponseData format
            if (root.TryGetProperty("ResponseData", out var responseData))
            {
                return FormatResponseData(responseData);
            }

            // Otherwise return as-is
            return value;
        }
        catch
        {
            // Not JSON or parsing failed, return as-is
            return value;
        }
    }

    /// <summary>
    /// Formats new strongly-typed ResponseData (TextResponseDataDto, AssessmentResponseDataDto, GoalResponseDataDto).
    /// </summary>
    private string FormatResponseData(System.Text.Json.JsonElement responseData)
    {
        var formatted = new System.Text.StringBuilder();

        // Detect response data type by checking properties
        if (responseData.TryGetProperty("TextSections", out var textSections))
        {
            // TextResponseDataDto
            var sectionIndex = 0;
            foreach (var section in textSections.EnumerateArray())
            {
                var sectionText = section.GetString() ?? "";
                if (!string.IsNullOrWhiteSpace(sectionText))
                {
                    formatted.AppendLine(textSections.GetArrayLength() > 1
                        ? $"Section {sectionIndex + 1}: {sectionText}"
                        : $"Answer: {sectionText}");
                }
                sectionIndex++;
            }
        }
        else if (responseData.TryGetProperty("Competencies", out var competencies))
        {
            // AssessmentResponseDataDto
            foreach (var evaluation in competencies.EnumerateObject())
            {
                var evaluationKey = evaluation.Name;
                var evaluationValue = evaluation.Value;

                if (evaluationValue.TryGetProperty("Rating", out var rating))
                {
                    formatted.AppendLine($"Rating ({evaluationKey}): {rating.GetInt32()}");
                }

                if (evaluationValue.TryGetProperty("Comment", out var comment))
                {
                    var commentText = comment.GetString();
                    if (!string.IsNullOrWhiteSpace(commentText))
                    {
                        formatted.AppendLine($"Comment ({evaluationKey}): {commentText}");
                    }
                }
            }
        }
        else if (responseData.TryGetProperty("Goals", out var goals) ||
                 responseData.TryGetProperty("PredecessorRatings", out _))
        {
            // GoalResponseDataDto
            if (goals.ValueKind == System.Text.Json.JsonValueKind.Array)
            {
                var goalIndex = 1;
                foreach (var goal in goals.EnumerateArray())
                {
                    formatted.AppendLine($"Goal {goalIndex}:");

                    if (goal.TryGetProperty("ObjectiveDescription", out var objective))
                    {
                        formatted.AppendLine($"  Objective: {objective.GetString()}");
                    }

                    if (goal.TryGetProperty("MeasurementMetric", out var metric))
                    {
                        formatted.AppendLine($"  Measurement: {metric.GetString()}");
                    }

                    if (goal.TryGetProperty("WeightingPercentage", out var weighting))
                    {
                        formatted.AppendLine($"  Weighting: {weighting.GetDecimal()}%");
                    }

                    goalIndex++;
                    formatted.AppendLine();
                }
            }
        }

        return formatted.Length > 0 ? formatted.ToString().TrimEnd() : "(empty)";
    }
}
