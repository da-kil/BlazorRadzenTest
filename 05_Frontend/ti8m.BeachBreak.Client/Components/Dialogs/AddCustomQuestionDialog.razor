@using Radzen
@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Services
@using ti8m.BeachBreak.Client.Services.QuestionHandlers
@using ti8m.BeachBreak.Client.Components.Shared
@inject DialogService DialogService
@inject QuestionHandlerFactory HandlerFactory
@inherits OptimizedTranslatableComponentBase

<div class="add-custom-question-dialog">
    <RadzenStack Gap="1rem">
        @if (validationErrors.Any())
        {
            <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat" Shade="Shade.Lighter" ShowIcon="true">
                <RadzenText TextStyle="TextStyle.Body2" Class="fw-bold mb-2">@T("messages.please-fix-errors")</RadzenText>
                <ul class="mb-0">
                    @foreach (var error in validationErrors)
                    {
                        <li>@error</li>
                    }
                </ul>
            </RadzenAlert>
        }

        <RadzenText TextStyle="TextStyle.Body1" Class="mb-2">
            @T("messages.add-custom-question-instruction")
        </RadzenText>

        <!-- Question Type Selection -->
        <RadzenFieldset>
            <HeaderTemplate>
                <RadzenIcon Icon="category" Class="me-2" />
                <span class="fw-bold">@T("labels.question-type")</span>
            </HeaderTemplate>
            <ChildContent>
                <RadzenRadioButtonList @bind-Value="@currentSection.Type" TValue="QuestionType" Orientation="Orientation.Vertical" Change="@OnQuestionTypeChanged">
                    <Items>
                        <RadzenRadioButtonListItem Text="@T("question-types.assessment")" Value="QuestionType.Assessment" />
                        <RadzenRadioButtonListItem Text="@T("question-types.textquestion")" Value="QuestionType.TextQuestion" />
                    </Items>
                </RadzenRadioButtonList>
                <RadzenText TextStyle="TextStyle.Caption" Class="text-muted mt-2">
                    @T("messages.goal-questions-not-allowed-custom")
                </RadzenText>
            </ChildContent>
        </RadzenFieldset>

        <!-- Basic Information -->
        <RadzenFieldset>
            <HeaderTemplate>
                <RadzenIcon Icon="info" Class="me-2" />
                <span class="fw-bold">@T("labels.basic-information")</span>
            </HeaderTemplate>
            <ChildContent>
                <RadzenStack Gap="0.5rem">
                    <RadzenLabel Text="@T("labels.title-english")" />
                    <RadzenTextBox @bind-Value="@currentSection.TitleEnglish" Placeholder="@T("placeholders.question-title-english")" Class="w-100" />

                    <RadzenLabel Text="@T("labels.title-german")" Class="mt-3" />
                    <RadzenTextBox @bind-Value="@currentSection.TitleGerman" Placeholder="@T("placeholders.question-title-german")" Class="w-100" />

                    <RadzenLabel Text="@T("labels.description-english")" Class="mt-3" />
                    <RadzenTextArea @bind-Value="@currentSection.DescriptionEnglish" Rows="3" Placeholder="@T("placeholders.question-description-english")" Class="w-100" />

                    <RadzenLabel Text="@T("labels.description-german")" Class="mt-3" />
                    <RadzenTextArea @bind-Value="@currentSection.DescriptionGerman" Rows="3" Placeholder="@T("placeholders.question-description-german")" Class="w-100" />
                </RadzenStack>
            </ChildContent>
        </RadzenFieldset>

        <!-- Question Settings -->
        <RadzenFieldset>
            <HeaderTemplate>
                <RadzenIcon Icon="settings" Class="me-2" />
                <span class="fw-bold">@T("labels.question-settings")</span>
            </HeaderTemplate>
            <ChildContent>
                <RadzenStack Gap="0.5rem">
                    <RadzenCheckBox @bind-Value="@currentSection.IsRequired" Name="isRequired" />
                    <RadzenLabel Text="@T("labels.required-question")" Component="isRequired" Style="margin-left: 0.5rem;" />

                    <RadzenLabel Text="@T("labels.completion-role")" Class="mt-3" />
                    <RadzenDropDown @bind-Value="@currentSection.CompletionRole" Data="@completionRoles" TextProperty="Text" ValueProperty="Value" Class="w-100" />
                </RadzenStack>
            </ChildContent>
        </RadzenFieldset>

        <!-- Configuration (Type-specific) - Uses Handler Pattern -->
        @if (currentSection.Type == QuestionType.Assessment && currentSection.Configuration is AssessmentConfiguration assessmentConfig)
        {
            <RadzenFieldset>
                <HeaderTemplate>
                    <RadzenIcon Icon="assessment" Class="me-2" />
                    <span class="fw-bold">@T("labels.assessment-configuration")</span>
                </HeaderTemplate>
                <ChildContent>
                    <RadzenStack Gap="0.5rem">
                        <RadzenLabel Text="@T("labels.rating-scale")" />
                        <RadzenNumeric @bind-Value="@assessmentConfig.RatingScale" Min="1" Max="10" Class="w-100" />

                        <RadzenLabel Text="@T("labels.scale-low-label")" Class="mt-2" />
                        <RadzenTextBox @bind-Value="@assessmentConfig.ScaleLowLabel" Placeholder="@T("placeholders.scale-low")" Class="w-100" />

                        <RadzenLabel Text="@T("labels.scale-high-label")" Class="mt-2" />
                        <RadzenTextBox @bind-Value="@assessmentConfig.ScaleHighLabel" Placeholder="@T("placeholders.scale-high")" Class="w-100" />

                        <div class="mt-3">
                            <RadzenText TextStyle="TextStyle.Subtitle2" Class="mb-2">@T("labels.evaluation-items")</RadzenText>
                            @if (assessmentConfig.Evaluations.Any())
                            {
                                @for (int i = 0; i < assessmentConfig.Evaluations.Count; i++)
                                {
                                    var index = i; // Capture for lambda
                                    var item = assessmentConfig.Evaluations[i];
                                    <div class="d-flex align-items-center mb-2">
                                        <RadzenTextBox @bind-Value="@item.TitleEnglish" Placeholder="@T("placeholders.evaluation-item")" Class="flex-grow-1 me-2" />
                                        <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Variant="Variant.Text" Click="@(() => RemoveItem(index))" />
                                    </div>
                                }
                            }
                            <RadzenButton Text="@T("buttons.add-evaluation-item")" Icon="add" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" Click="@AddItem" />
                        </div>
                    </RadzenStack>
                </ChildContent>
            </RadzenFieldset>
        }
        else if (currentSection.Type == QuestionType.TextQuestion && currentSection.Configuration is TextQuestionConfiguration textConfig)
        {
            <RadzenFieldset>
                <HeaderTemplate>
                    <RadzenIcon Icon="text_fields" Class="me-2" />
                    <span class="fw-bold">@T("labels.text-question-configuration")</span>
                </HeaderTemplate>
                <ChildContent>
                    <RadzenStack Gap="0.5rem">
                        <RadzenText TextStyle="TextStyle.Subtitle2" Class="mb-2">@T("labels.text-sections")</RadzenText>
                        @if (textConfig.TextSections.Any())
                        {
                            @for (int i = 0; i < textConfig.TextSections.Count; i++)
                            {
                                var index = i; // Capture for lambda
                                var textSection = textConfig.TextSections[i];
                                <div class="text-section-card p-3 border rounded mb-2">
                                    <RadzenStack Gap="0.5rem">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <RadzenText TextStyle="TextStyle.Subtitle2">@T("labels.section") @(i + 1)</RadzenText>
                                            <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Variant="Variant.Text" Size="ButtonSize.Small" Click="@(() => RemoveItem(index))" />
                                        </div>
                                        <RadzenTextBox @bind-Value="@textSection.TitleEnglish" Placeholder="@T("placeholders.section-title-english")" Class="w-100" />
                                        <RadzenTextBox @bind-Value="@textSection.TitleGerman" Placeholder="@T("placeholders.section-title-german")" Class="w-100" />
                                        <RadzenCheckBox @bind-Value="@textSection.IsRequired" Name="@($"section_{i}_required")" />
                                        <RadzenLabel Text="@T("labels.required-section")" Component="@($"section_{i}_required")" Style="margin-left: 0.5rem;" />
                                    </RadzenStack>
                                </div>
                            }
                        }
                        <RadzenButton Text="@T("buttons.add-text-section")" Icon="add" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" Click="@AddItem" />
                    </RadzenStack>
                </ChildContent>
            </RadzenFieldset>
        }

        <!-- Dialog Actions -->
        <div class="d-flex justify-content-end gap-2 mt-3">
            <RadzenButton Text="@T("buttons.cancel")"
                        ButtonStyle="ButtonStyle.Light"
                        Click="@Cancel"
                        Disabled="@isSubmitting" />
            <RadzenButton Text="@(isSubmitting ? T("buttons.adding") : T("buttons.add-question"))"
                        Icon="@(isSubmitting ? "" : "add")"
                        ButtonStyle="ButtonStyle.Primary"
                        Click="@Submit"
                        Disabled="@isSubmitting" />
        </div>

        @if (isSubmitting)
        {
            <div class="text-center">
                <RadzenProgressBarCircular ProgressBarStyle="ProgressBarStyle.Primary" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Small" />
            </div>
        }
    </RadzenStack>
</div>

@code {
    private QuestionSection currentSection = new();
    private IQuestionTypeHandler currentHandler = null!;
    private bool isSubmitting = false;
    private List<string> validationErrors = new();

    private List<CompletionRoleOption> completionRoles = new()
    {
        new CompletionRoleOption { Value = CompletionRole.Employee, Text = "Employee" },
        new CompletionRoleOption { Value = CompletionRole.Manager, Text = "Manager" },
        new CompletionRoleOption { Value = CompletionRole.Both, Text = "Both" }
    };

    protected override void OnInitialized()
    {
        base.OnInitialized();

        // Initialize section with default values
        currentSection = new QuestionSection
        {
            Id = Guid.NewGuid(),
            Type = QuestionType.Assessment,
            IsRequired = true,
            CompletionRole = CompletionRole.Both,
            IsInstanceSpecific = true,
            Order = 0,
            TitleEnglish = string.Empty,
            TitleGerman = string.Empty,
            DescriptionEnglish = string.Empty,
            DescriptionGerman = string.Empty
        };

        // Initialize configuration using handler
        currentHandler = HandlerFactory.GetHandler(currentSection.Type);
        currentHandler.InitializeQuestion(currentSection);
    }

    private void OnQuestionTypeChanged()
    {
        // Get new handler for the selected type
        currentHandler = HandlerFactory.GetHandler(currentSection.Type);

        // Initialize configuration for the new type
        currentHandler.InitializeQuestion(currentSection);

        // Force UI refresh
        StateHasChanged();
    }

    /// <summary>
    /// Adds a new item (evaluation or text section) using the handler
    /// </summary>
    private void AddItem()
    {
        currentHandler.AddItem(currentSection);
        StateHasChanged();
    }

    /// <summary>
    /// Removes an item using the handler
    /// </summary>
    private void RemoveItem(int index)
    {
        currentHandler.RemoveItem(currentSection, index);
        StateHasChanged();
    }

    private bool ValidateInput()
    {
        validationErrors.Clear();

        // Validate basic information
        if (string.IsNullOrWhiteSpace(currentSection.TitleEnglish))
            validationErrors.Add(T("validation.title-english-required"));

        if (string.IsNullOrWhiteSpace(currentSection.TitleGerman))
            validationErrors.Add(T("validation.title-german-required"));

        if (string.IsNullOrWhiteSpace(currentSection.DescriptionEnglish))
            validationErrors.Add(T("validation.description-english-required"));

        if (string.IsNullOrWhiteSpace(currentSection.DescriptionGerman))
            validationErrors.Add(T("validation.description-german-required"));

        // Use handler's validation for type-specific validation
        var handlerErrors = currentHandler.Validate(currentSection, T("labels.custom-question"));
        validationErrors.AddRange(handlerErrors);

        return !validationErrors.Any();
    }

    private void Submit()
    {
        if (!ValidateInput())
        {
            NotificationService.Notify(NotificationSeverity.Warning, T("notifications.validation-failed"), T("messages.please-fix-errors"));
            return;
        }

        try
        {
            isSubmitting = true;

            // Trim all text fields
            currentSection.TitleEnglish = currentSection.TitleEnglish.Trim();
            currentSection.TitleGerman = currentSection.TitleGerman.Trim();
            currentSection.DescriptionEnglish = currentSection.DescriptionEnglish.Trim();
            currentSection.DescriptionGerman = currentSection.DescriptionGerman.Trim();

            // Trim evaluation items or text sections
            if (currentSection.Configuration is AssessmentConfiguration assessmentConfig)
            {
                foreach (var item in assessmentConfig.Evaluations)
                {
                    item.TitleEnglish = item.TitleEnglish.Trim();
                    if (!string.IsNullOrWhiteSpace(item.TitleGerman))
                        item.TitleGerman = item.TitleGerman.Trim();
                }
            }
            else if (currentSection.Configuration is TextQuestionConfiguration textConfig)
            {
                foreach (var section in textConfig.TextSections)
                {
                    section.TitleEnglish = section.TitleEnglish.Trim();
                    if (!string.IsNullOrWhiteSpace(section.TitleGerman))
                        section.TitleGerman = section.TitleGerman.Trim();
                }
            }

            DialogService.Close(currentSection);
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, T("notifications.error"), $"{T("messages.failed-to-create-question")}: {ex.Message}");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void Cancel()
    {
        DialogService.Close(null);
    }

    private class CompletionRoleOption
    {
        public CompletionRole Value { get; set; }
        public string Text { get; set; } = string.Empty;
    }
}
