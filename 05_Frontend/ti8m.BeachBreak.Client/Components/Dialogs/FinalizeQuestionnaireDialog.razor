@using Radzen
@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Components.Shared
@inject DialogService DialogService
@inherits OptimizedTranslatableComponentBase

<div class="dialog-container">
    <div class="dialog-review-info warning">
        <div class="text-center">
            <RadzenIcon Icon="lock" Class="dialog-header-icon" />
            <RadzenText TextStyle="TextStyle.H5" Class="mb-2">
                @T("dialogs.finalize-questionnaire")
            </RadzenText>
            <RadzenText TextStyle="TextStyle.Body2">
                @T("messages.finalize-questionnaire-description")
            </RadzenText>
        </div>
    </div>

    <div class="warning-section">
        <div class="icon-box">
            <RadzenIcon Icon="warning" Style="color: #856404;" />
            <RadzenText TextStyle="TextStyle.Subtitle2" Class="fw-bold mb-0" Style="color: #856404;">
                @T("warnings.action-is-final")
            </RadzenText>
        </div>
        <RadzenText TextStyle="TextStyle.Body2" Style="color: #856404;">
            @T("messages.finalize-readonly-warning")
        </RadzenText>
    </div>

    <div class="info-section">
        <div class="icon-box">
            <RadzenIcon Icon="check_circle" Style="color: #FF9800;" />
            <RadzenText TextStyle="TextStyle.Subtitle2" Class="fw-bold mb-0">
                @T("labels.finalization-confirms")
            </RadzenText>
        </div>
        <ul style="margin-top: 0.5rem; margin-bottom: 0;">
            <li><RadzenText TextStyle="TextStyle.Body2" Class="text-muted">@T("messages.all-review-discussions-complete")</RadzenText></li>
            <li><RadzenText TextStyle="TextStyle.Body2" Class="text-muted">@T("messages.employee-confirmed-review-outcome")</RadzenText></li>
            <li><RadzenText TextStyle="TextStyle.Body2" Class="text-muted">@T("messages.all-feedback-documented")</RadzenText></li>
            <li><RadzenText TextStyle="TextStyle.Body2" Class="text-muted">@T("messages.questionnaire-ready-for-archival")</RadzenText></li>
        </ul>
    </div>

    <div class="dialog-content-section">
        <RadzenText TextStyle="TextStyle.Subtitle2" Class="fw-bold mb-2">
            @T("labels.final-notes-optional")
        </RadzenText>
        <RadzenText TextStyle="TextStyle.Body2" Class="text-muted mb-2">
            @T("messages.add-final-notes-instruction")
        </RadzenText>
        @if (!string.IsNullOrWhiteSpace(ExistingFinalNotes))
        {
            <div class="info-section mb-2" style="background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 0.75rem;">
                <div class="icon-box">
                    <RadzenIcon Icon="edit" Style="color: #ff9800;" />
                    <RadzenText TextStyle="TextStyle.Caption" Class="fw-bold mb-0" Style="color: #856404;">
                        @T("messages.existing-notes-loaded")
                    </RadzenText>
                </div>
                <RadzenText TextStyle="TextStyle.Caption" Style="color: #856404;">
                    @T("messages.can-edit-previous-final-notes")
                </RadzenText>
            </div>
        }
        <RadzenTextArea @bind-Value="@finalNotes"
                       Placeholder="@T("placeholders.enter-final-notes-optional")"
                       Rows="8"
                       Style="width: 100%;"
                       MaxLength="5000" />
        <RadzenText TextStyle="TextStyle.Caption" Class="text-muted mt-1">
            @(finalNotes?.Length ?? 0) / 5000 @T("labels.characters")
        </RadzenText>
    </div>

    <div class="dialog-actions">
        <AsyncButton Text="@T("buttons.cancel")"
                    ButtonStyle="ButtonStyle.Light"
                    Click="@Cancel"
                    Size="ButtonSize.Medium" />
        <AsyncButton Text="@T("buttons.finalize-questionnaire")"
                    ProcessingText="@T("buttons.finalizing")"
                    ButtonStyle="ButtonStyle.Warning"
                    Icon="lock"
                    Click="@FinalizeQuestionnaire"
                    Size="ButtonSize.Medium" />
    </div>
</div>

@code {
    [Parameter]
    public string? ExistingFinalNotes { get; set; }

    private string? finalNotes;

    protected override void OnInitialized()
    {
        // Initialize with existing notes if reopening
        finalNotes = ExistingFinalNotes;
        base.OnInitialized();
    }

    protected override void OnParametersSet()
    {
        // Update notes when parameters are set (important for dialog parameters)
        finalNotes = ExistingFinalNotes;
        base.OnParametersSet();
    }

    private void Cancel()
    {
        DialogService.Close(null);
    }

    private void FinalizeQuestionnaire()
    {
        // Return the final notes (return empty string if null to distinguish from cancellation)
        DialogService.Close(finalNotes ?? string.Empty);
    }
}
