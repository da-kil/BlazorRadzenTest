@using Radzen
@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Models.Dto
@using ti8m.BeachBreak.Client.Models.Dto.Shared
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Components.Shared
@using ti8m.BeachBreak.Client.Services
@using ti8m.BeachBreak.Client.Extensions
@inherits OptimizedTranslatableComponentBase
@inject DialogService DialogService

<div class="add-goal-dialog">
    <RadzenStack Gap="1rem">
        <ValidationErrorAlert Errors="@validationErrors" />

        <GoalDetailsFieldset @bind-ObjectiveDescription="@objectiveDescription"
                            @bind-MeasurementMetric="@measurementMetric" />

        <GoalTimeframeFieldset @bind-TimeframeFrom="@timeframeFrom"
                              @bind-TimeframeTo="@timeframeTo" />

        @* Weighting is hidden during in-progress states and will be set during InReview by manager *@

        <div class="dialog-actions-inline">
            <RadzenButton Text="@T("buttons.cancel")"
                        ButtonStyle="ButtonStyle.Light"
                        Click="@Cancel"
                        Disabled="@isSubmitting" />
            <RadzenButton Text="@GetSubmitButtonText()"
                        Icon="@(isSubmitting ? "" : (IsEditMode ? "save" : "add"))"
                        ButtonStyle="ButtonStyle.Primary"
                        Click="@Submit"
                        Disabled="@isSubmitting" />
        </div>
    </RadzenStack>
</div>

@code {
    [Parameter] public Guid AssignmentId { get; set; }
    [Parameter] public Guid QuestionId { get; set; }
    [Parameter] public ApplicationRole AddedByRole { get; set; } = ApplicationRole.Employee;
    [Parameter] public bool IsEditMode { get; set; } = false;

    // Pre-populated values for editing pending goals
    [Parameter] public string InitialObjective { get; set; } = "";
    [Parameter] public string InitialMeasurement { get; set; } = "";
    [Parameter] public DateTime InitialTimeframeFrom { get; set; } = DateTime.Today;
    [Parameter] public DateTime InitialTimeframeTo { get; set; } = DateTime.Today.AddMonths(6);
    [Parameter] public decimal InitialWeighting { get; set; } = 0;

    private string objectiveDescription = "";
    private string measurementMetric = "";
    private DateTime? timeframeFrom = DateTime.Today;
    private DateTime? timeframeTo = DateTime.Today.AddMonths(6);

    private List<string> validationErrors = new();
    private bool isSubmitting = false;

    protected override void OnParametersSet()
    {
        // Pre-populate form with existing values
        objectiveDescription = InitialObjective;
        measurementMetric = InitialMeasurement;
        timeframeFrom = InitialTimeframeFrom;
        timeframeTo = InitialTimeframeTo;
    }

    private bool ValidateForm()
    {
        validationErrors = GoalFormValidator.ValidateGoalDetails(
            objectiveDescription,
            measurementMetric,
            timeframeFrom,
            timeframeTo);

        return !validationErrors.Any();
    }

    private void Submit()
    {
        if (!ValidateForm())
        {
            StateHasChanged();
            return;
        }

        // Return DTO to parent component (OptimizedGoalQuestion)
        // Parent will queue this operation and execute it when "Save Progress" or "Submit" is clicked
        var dto = new AddGoalDto
        {
            QuestionId = QuestionId,
            ObjectiveDescription = objectiveDescription.Trim(),
            MeasurementMetric = measurementMetric.Trim(),
            TimeframeFrom = timeframeFrom!.Value,
            TimeframeTo = timeframeTo!.Value,
            WeightingPercentage = null // Will be set during InReview by manager
        };

        DialogService.Close(dto);
    }

    private void Cancel()
    {
        DialogService.Close(false);
    }

    private string GetSubmitButtonText()
    {
        if (isSubmitting)
        {
            return IsEditMode ? T("dialogs.updating-goal") : T("dialogs.adding-goal");
        }
        return IsEditMode ? T("dialogs.update-goal") : T("dialogs.add-goal");
    }

}

