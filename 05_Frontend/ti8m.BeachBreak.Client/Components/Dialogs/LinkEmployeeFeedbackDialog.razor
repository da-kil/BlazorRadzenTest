@using Radzen
@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Models.Dto
@using ti8m.BeachBreak.Client.Services
@using ti8m.BeachBreak.Client.Components.Shared
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject EmployeeFeedbackApiService FeedbackApiService
@inherits OptimizedTranslatableComponentBase

<div class="link-feedback-dialog">
    <RadzenStack Gap="1rem">
        @if (isLoading)
        {
            <div class="text-center p-4">
                <RadzenProgressBarCircular ProgressBarStyle="ProgressBarStyle.Primary" Mode="ProgressBarMode.Indeterminate" />
                <RadzenText TextStyle="TextStyle.Body2" Class="mt-2">@T("messages.loading-available-feedback")</RadzenText>
            </div>
        }
        else if (availableFeedback == null || availableFeedback.Count == 0)
        {
            <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" ShowIcon="true">
                <RadzenText TextStyle="TextStyle.Body2">
                    @T("messages.no-feedback-available")
                </RadzenText>
            </RadzenAlert>
        }
        else
        {
            <RadzenText TextStyle="TextStyle.Body1" Class="mb-2">
                @T("sections.select-feedback-to-link")
            </RadzenText>

            <RadzenDataGrid @ref="feedbackGrid"
                           Data="@availableFeedback"
                           TItem="LinkedEmployeeFeedbackDto"
                           AllowFiltering="true"
                           FilterMode="FilterMode.Simple"
                           SelectionMode="DataGridSelectionMode.Multiple"
                           @bind-Value="@selectedFeedback"
                           AllowSorting="true"
                           PageSize="10"
                           AllowPaging="true"
                           PagerHorizontalAlign="HorizontalAlign.Center">
                <Columns>
                    <RadzenDataGridColumn TItem="LinkedEmployeeFeedbackDto" Width="60px" Sortable="false" Filterable="false" TextAlign="TextAlign.Center">
                        <HeaderTemplate>
                            <RadzenCheckBox TriState="false"
                                          TValue="bool"
                                          Value="@(selectedFeedback?.Count == availableFeedback?.Count)"
                                          Change="@((args) => ToggleSelectAll(args))" />
                        </HeaderTemplate>
                        <Template Context="feedback">
                            <RadzenCheckBox TriState="false"
                                          Value="@(selectedFeedback?.Contains(feedback) == true)"
                                          TValue="bool" />
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="LinkedEmployeeFeedbackDto" Property="FeedbackDate" Title="@T("columns.feedback-date")" Width="140px" Sortable="true">
                        <Template Context="feedback">
                            @feedback.FeedbackDate.ToShortDateString()
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="LinkedEmployeeFeedbackDto" Property="SourceType" Title="@T("columns.source-type")" Width="140px" Sortable="true">
                        <Template Context="feedback">
                            <RadzenBadge BadgeStyle="@GetSourceTypeBadgeStyle(feedback.SourceType)"
                                       Text="@GetSourceTypeDisplayName(feedback.SourceType)" />
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="LinkedEmployeeFeedbackDto" Property="ProviderName" Title="@T("columns.provider")" Sortable="true" />

                    <RadzenDataGridColumn TItem="LinkedEmployeeFeedbackDto" Property="ProjectName" Title="@T("columns.project")" Sortable="true">
                        <Template Context="feedback">
                            @(feedback.ProjectName ?? "-")
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="LinkedEmployeeFeedbackDto" Property="AverageRating" Title="@T("columns.avg-rating")" Width="140px" Sortable="true">
                        <Template Context="feedback">
                            @if (feedback.AverageRating.HasValue)
                            {
                                <RadzenRating ReadOnly="true" Value="@((int)Math.Round(feedback.AverageRating.Value))" Stars="5" />
                            }
                            else
                            {
                                <RadzenText TextStyle="TextStyle.Body2" Class="text-muted">@T("labels.no-ratings")</RadzenText>
                            }
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        }

        <div class="d-flex justify-content-end gap-2 mt-3">
            <RadzenButton Text="@T("buttons.cancel")"
                        ButtonStyle="ButtonStyle.Light"
                        Click="@Cancel"
                        Disabled="@isSubmitting" />
            <RadzenButton Text="@(isSubmitting ? T("buttons.linking") : T("buttons.link-selected"))"
                        Icon="@(isSubmitting ? "" : "link")"
                        ButtonStyle="ButtonStyle.Primary"
                        Click="@LinkSelected"
                        Disabled="@(isSubmitting || selectedFeedback == null || selectedFeedback.Count == 0)" />
        </div>
    </RadzenStack>
</div>

@code {
    [Parameter] public Guid AssignmentId { get; set; }
    [Parameter] public Guid QuestionId { get; set; }

    private RadzenDataGrid<LinkedEmployeeFeedbackDto>? feedbackGrid;
    private bool isLoading = true;
    private bool isSubmitting = false;
    private List<LinkedEmployeeFeedbackDto>? availableFeedback;
    private IList<LinkedEmployeeFeedbackDto>? selectedFeedback;

    protected override async Task OnInitializedAsync()
    {
        await LoadAvailableFeedback();
    }

    private async Task LoadAvailableFeedback()
    {
        isLoading = true;
        try
        {
            availableFeedback = await FeedbackApiService.GetAvailableFeedbackForAssignmentAsync(AssignmentId);
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = T("notifications.error"),
                Detail = $"Error loading feedback: {ex.Message}",
                Duration = 4000
            });
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ToggleSelectAll(bool? selectAll)
    {
        selectedFeedback = selectAll == true ? availableFeedback?.ToList() : new List<LinkedEmployeeFeedbackDto>();
    }

    private async Task LinkSelected()
    {
        if (selectedFeedback == null || selectedFeedback.Count == 0)
            return;

        isSubmitting = true;

        var successCount = 0;
        var failureCount = 0;

        foreach (var feedback in selectedFeedback)
        {
            var dto = new LinkEmployeeFeedbackDto
            {
                QuestionId = QuestionId,
                FeedbackId = feedback.FeedbackId
            };

            var success = await FeedbackApiService.LinkFeedbackToAssignmentAsync(AssignmentId, dto);
            if (success)
                successCount++;
            else
                failureCount++;
        }

        isSubmitting = false;

        if (successCount > 0)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = T("notifications.feedback-linked-title"),
                Detail = string.Format(T("notifications.feedback-linked-detail"), successCount),
                Duration = 4000
            });

            DialogService.Close(true);
        }

        if (failureCount > 0)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = T("notifications.feedback-link-failed-title"),
                Detail = string.Format(T("notifications.feedback-link-failed-detail"), failureCount),
                Duration = 4000
            });
        }
    }

    private void Cancel()
    {
        DialogService.Close(false);
    }

    private BadgeStyle GetSourceTypeBadgeStyle(FeedbackSourceType sourceType) => sourceType switch
    {
        FeedbackSourceType.Customer => BadgeStyle.Success,
        FeedbackSourceType.Peer => BadgeStyle.Info,
        FeedbackSourceType.ProjectColleague => BadgeStyle.Warning,
        _ => BadgeStyle.Light
    };

    private string GetSourceTypeDisplayName(FeedbackSourceType sourceType) => sourceType switch
    {
        FeedbackSourceType.Customer => T("feedback-source.customer"),
        FeedbackSourceType.Peer => T("feedback-source.peer"),
        FeedbackSourceType.ProjectColleague => T("feedback-source.project-colleague"),
        _ => T("feedback-source.unknown")
    };
}
