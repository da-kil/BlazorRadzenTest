@using Radzen
@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Models.DTOs
@using ti8m.BeachBreak.Client.Services
@using ti8m.BeachBreak.Client.Models.Dto
@using ti8m.BeachBreak.Client.Components.Dialogs
@using ti8m.BeachBreak.Client.Components.Questions
@using Microsoft.AspNetCore.Components.Authorization
@using ti8m.BeachBreak.Client.Extensions
@inject IQuestionnaireTemplateService TemplateService
@inject IQuestionnaireResponseService ResponseService
@inject IQuestionnaireAssignmentService AssignmentService
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IAuthService AuthService

<link href="css/questionnaire-unified.css" rel="stylesheet" />

<div class="container-fluid questionnaire-unified-container">
    @if (isLoading)
    {
        <div class="text-center p-5">
            <RadzenProgressBarCircular ProgressBarStyle="ProgressBarStyle.Primary" Value="100" ShowValue="false" Class="mb-3" />
            <RadzenText TextStyle="TextStyle.Body1" Class="text-muted">Loading review data...</RadzenText>
        </div>
    }
    else if (template == null || response == null)
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat">
            <RadzenText TextStyle="TextStyle.Body1">Unable to load questionnaire data for review.</RadzenText>
        </RadzenAlert>
    }
    else
    {
        <RadzenCard Class="questionnaire-main-card p-4">
            <!-- Header Section - Matches DynamicQuestionnaire -->
            <div class="questionnaire-header text-center mb-4">
                <RadzenText TextStyle="TextStyle.H3" Class="questionnaire-title text-primary">
                    <RadzenIcon Icon="rate_review" Class="me-2" />
                    Review Meeting: @template.Name
                </RadzenText>
                @if (!string.IsNullOrWhiteSpace(template.Description))
                {
                    <RadzenText TextStyle="TextStyle.Subtitle1" Class="questionnaire-subtitle text-muted">
                        @template.Description
                    </RadzenText>
                }
                <div class="questionnaire-info-banner">
                    <RadzenIcon Icon="info" />
                    <div>
                        <strong>Reviewing Employee:</strong> @Assignment.EmployeeName &nbsp;|&nbsp;
                        As the manager, you can view and edit all answers during this review meeting. All changes are tracked.
                    </div>
                </div>
            </div>

            <!-- Section Counter - Matches DynamicQuestionnaire -->
            <div class="section-counter mb-4">
                <RadzenText TextStyle="TextStyle.Body2" Class="text-muted text-end">
                    Section @(currentSectionIndex + 1) of @template.Sections.Count
                </RadzenText>
            </div>

            <!-- Steps Navigation - Matches DynamicQuestionnaire -->
            <RadzenSteps Value="@currentSectionIndex" Change="@OnSectionChanged" Class="mb-4" ShowStepsButtons="false">
                @for (int i = 0; i < template.Sections.Count; i++)
                {
                    var sectionItem = template.Sections.OrderBy(s => s.Order).Skip(i).FirstOrDefault();
                    if (sectionItem != null)
                    {
                        <RadzenStepsItem Text="@sectionItem.Title" />
                    }
                }
            </RadzenSteps>

            <!-- Current Section Content - Matches DynamicQuestionnaire structure -->
            <div class="questionnaire-content">
                @if (currentSection != null)
                {
                    <RadzenCard Class="section-card p-4">
                        <div class="section-card-header">
                            <div class="section-title-container flex-grow-1">
                                <RadzenText TextStyle="TextStyle.H4" Class="section-title text-primary mb-2">
                                    @currentSection.Title
                                </RadzenText>
                                @if (!string.IsNullOrWhiteSpace(currentSection.Description))
                                {
                                    <RadzenText TextStyle="TextStyle.Body1" Class="section-description text-muted">
                                        @currentSection.Description
                                    </RadzenText>
                                }
                            </div>
                            <div class="completion-role-badge @GetRoleClass(currentSection.CompletionRole)">
                                <RadzenIcon Icon="@GetRoleIcon(currentSection.CompletionRole)" />
                                @currentSection.CompletionRole.ToString()
                            </div>
                        </div>

                        <!-- Questions Container - Matches DynamicQuestionnaire -->
                        <div class="questions-container">
                            @foreach (var question in currentSection.Questions.OrderBy(q => q.Order))
                            {
                                <div class="question-wrapper mb-4">
                                    <div class="question-title">
                                        @question.Title
                                        @if (question.IsRequired)
                                        {
                                            <span class="text-danger">*</span>
                                        }
                                    </div>

                                    @if (!string.IsNullOrWhiteSpace(question.Description))
                                    {
                                        <div class="question-description">@question.Description</div>
                                    }

                                    <div class="review-question-container">
                                        @if (currentSection.CompletionRole == CompletionRole.Both && question.Type != QuestionType.Goal)
                                        {
                                            <!-- Side-by-side view for Both sections (excluding goals) -->
                                            <div class="side-by-side-view">
                                                <!-- Employee Answer -->
                                                <div class="answer-column employee">
                                                    <div class="answer-header">
                                                        <span class="answer-label">
                                                            <RadzenIcon Icon="person" Style="font-size: 1rem;" />
                                                            Employee's Answer
                                                        </span>
                                                    </div>
                                                    <div class="answer-content">
                                                        <div class="answer-value">
                                                            @{
                                                                var employeeResponse = GetQuestionResponse(currentSection.Id, question.Id, CompletionRole.Employee);
                                                            }
                                                            <OptimizedQuestionRenderer
                                                                Question="@question"
                                                                Response="@employeeResponse"
                                                                IsReadOnly="true"
                                                                HideHeader="true"
                                                                AssignmentId="@Assignment.Id"
                                                                CurrentUserRole="Employee"
                                                                AssignmentWorkflowState="@Assignment.WorkflowState"
                                                                GoalRefreshToken="@goalRefreshToken" />
                                                        </div>
                                                    </div>
                                                    <div class="answer-actions">
                                                        <RadzenButton Text="Copy to Manager →"
                                                                     ButtonStyle="ButtonStyle.Light"
                                                                     Icon="content_copy"
                                                                     Size="ButtonSize.Small"
                                                                     Click="@(() => CopyAnswer(question, CompletionRole.Employee, CompletionRole.Manager))"
                                                                     Class="copy-button" />
                                                        <RadzenButton Text="Edit"
                                                                     ButtonStyle="ButtonStyle.Primary"
                                                                     Icon="edit"
                                                                     Size="ButtonSize.Small"
                                                                     Click="@(() => EditAnswer(question, CompletionRole.Employee))" />
                                                    </div>
                                                </div>

                                                <!-- Manager Answer -->
                                                <div class="answer-column manager">
                                                    <div class="answer-header">
                                                        <span class="answer-label">
                                                            <RadzenIcon Icon="supervisor_account" Style="font-size: 1rem;" />
                                                            Manager's Answer
                                                        </span>
                                                    </div>
                                                    <div class="answer-content">
                                                        <div class="answer-value">
                                                            @{
                                                                var managerResponse = GetQuestionResponse(currentSection.Id, question.Id, CompletionRole.Manager);
                                                            }
                                                            <OptimizedQuestionRenderer
                                                                Question="@question"
                                                                Response="@managerResponse"
                                                                IsReadOnly="true"
                                                                HideHeader="true"
                                                                AssignmentId="@Assignment.Id"
                                                                CurrentUserRole="@GetManagerContextRole()"
                                                                AssignmentWorkflowState="@Assignment.WorkflowState"
                                                                GoalRefreshToken="@goalRefreshToken" />
                                                        </div>
                                                    </div>
                                                    <div class="answer-actions">
                                                        <RadzenButton Text="← Copy to Employee"
                                                                     ButtonStyle="ButtonStyle.Light"
                                                                     Icon="content_copy"
                                                                     Size="ButtonSize.Small"
                                                                     Click="@(() => CopyAnswer(question, CompletionRole.Manager, CompletionRole.Employee))"
                                                                     Class="copy-button" />
                                                        <RadzenButton Text="Edit"
                                                                     ButtonStyle="ButtonStyle.Primary"
                                                                     Icon="edit"
                                                                     Size="ButtonSize.Small"
                                                                     Click="@(() => EditAnswer(question, CompletionRole.Manager))" />
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                        else if (currentSection.CompletionRole == CompletionRole.Both && question.Type == QuestionType.Goal)
                                        {
                                            <!-- Collaborative grouped view for goal questions in Both sections -->
                                            <div class="goal-collaborative-view">
                                                @{
                                                    // Use the same approach as DynamicQuestionnaire.razor - let OptimizedQuestionRenderer handle role logic
                                                    var goalResponse = GetGenericQuestionResponse(question.Id);
                                                }


                                                <OptimizedQuestionRenderer
                                                    Question="@question"
                                                    Response="@goalResponse"
                                                    IsReadOnly="false"
                                                    HideHeader="true"
                                                    AssignmentId="@Assignment.Id"
                                                    CurrentUserRole="@GetCurrentUserRole()"
                                                    AssignmentWorkflowState="@Assignment.WorkflowState"
                                                    GoalRefreshToken="@goalRefreshToken" />

                                                <!-- Inline goal management now available directly -->
                                                <!-- EDIT, DELETE, and ADD NEW GOAL buttons are shown inline in the component above -->
                                            </div>
                                        }
                                        else
                                        {
                                            <!-- Single column view for Employee or Manager only sections -->
                                            <div class="single-answer-view">
                                                <div class="answer-header">
                                                    <span class="answer-label">
                                                        <RadzenIcon Icon="@GetRoleIcon(currentSection.CompletionRole)" Style="font-size: 1rem;" />
                                                        @currentSection.CompletionRole's Answer
                                                    </span>
                                                </div>
                                                <div class="answer-content">
                                                    <div class="answer-value">
                                                        @{
                                                            var singleResponse = GetQuestionResponse(currentSection.Id, question.Id, currentSection.CompletionRole);
                                                        }
                                                        <OptimizedQuestionRenderer
                                                            Question="@question"
                                                            Response="@singleResponse"
                                                            IsReadOnly="true"
                                                            HideHeader="true"
                                                            AssignmentId="@Assignment.Id"
                                                            CurrentUserRole="@currentSection.CompletionRole.ToString()"
                                                            AssignmentWorkflowState="@Assignment.WorkflowState"
                                                            GoalRefreshToken="@goalRefreshToken" />
                                                    </div>
                                                </div>
                                                <div class="answer-actions">
                                                    <RadzenButton Text="Edit Answer"
                                                                 ButtonStyle="ButtonStyle.Primary"
                                                                 Icon="edit"
                                                                 Size="ButtonSize.Medium"
                                                                 Click="@(() => EditAnswer(question, currentSection.CompletionRole))" />
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </RadzenCard>
                }
            </div>

            <!-- Navigation Footer - Matches DynamicQuestionnaire -->
            <div class="navigation-footer d-flex justify-content-between mt-4">
                <RadzenButton Text="Previous"
                             ButtonStyle="ButtonStyle.Light"
                             Icon="arrow_back"
                             Click="@PreviousSection"
                             Disabled="@(currentSectionIndex == 0)" />

                <div class="navigation-actions d-flex gap-2">
                    @if (currentSectionIndex < template.Sections.Count - 1)
                    {
                        <RadzenButton Text="Next"
                                     ButtonStyle="ButtonStyle.Primary"
                                     Icon="arrow_forward"
                                     Click="@NextSection" />
                    }
                    else
                    {
                        <RadzenButton Text="Finish Review Meeting"
                                     ButtonStyle="ButtonStyle.Success"
                                     Icon="check_circle"
                                     Click="@FinishReview" />
                    }
                </div>
            </div>
        </RadzenCard>
    }
</div>

@code {
    [Parameter, EditorRequired] public QuestionnaireAssignment Assignment { get; set; } = null!;
    [Parameter] public EventCallback OnReviewFinished { get; set; }

    private QuestionnaireTemplate? template;
    private QuestionnaireResponse? response;
    private int currentSectionIndex = 0;
    private bool isLoading = true;
    private string currentManagerName = string.Empty;

    // Token to trigger goal component refresh after assignment response reload
    private int goalRefreshToken = 0;

    private QuestionSection? currentSection => template?.Sections.OrderBy(s => s.Order).Skip(currentSectionIndex).FirstOrDefault();

    protected override async Task OnInitializedAsync()
    {
        // Initialize the current user role cache before loading review data
        await InitializeCurrentUserRoleAsync();
        await LoadReviewData();
    }

    private async Task LoadReviewData()
    {
        try
        {
            isLoading = true;

            // Get current manager name
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            currentManagerName = authState.User.Identity?.Name ?? "Unknown Manager";

            // Load template
            template = await TemplateService.GetTemplateByIdAsync(Assignment.TemplateId);

            // Load response (contains both employee and manager answers)
            response = await ResponseService.GetResponseByAssignmentIdAsync(Assignment.Id);

            if (template == null || response == null)
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load review data");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load review data: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void OnSectionChanged(int newIndex)
    {
        if (newIndex >= 0 && newIndex < (template?.Sections.Count ?? 0))
        {
            currentSectionIndex = newIndex;
            StateHasChanged();
        }
    }

    private QuestionResponse GetQuestionResponse(Guid sectionId, Guid questionId, CompletionRole role)
    {
        if (response?.SectionResponses == null)
            return new QuestionResponse { QuestionId = questionId, QuestionType = QuestionType.TextQuestion };

        if (!response.SectionResponses.TryGetValue(sectionId, out var sectionResponse))
            return new QuestionResponse { QuestionId = questionId, QuestionType = QuestionType.TextQuestion };

        // Convert CompletionRole to ResponseRole for type-safe dictionary access
        var responseRole = role.ToResponseRole();

        if (sectionResponse.RoleResponses != null &&
            sectionResponse.RoleResponses.TryGetValue(responseRole, out var roleQuestions))
        {
            if (roleQuestions.TryGetValue(questionId, out var questionResponse))
            {
                return questionResponse;
            }
        }

        return new QuestionResponse { QuestionId = questionId, QuestionType = QuestionType.TextQuestion };
    }

    private QuestionResponse GetGenericQuestionResponse(Guid questionId)
    {
        if (currentSection == null || response?.SectionResponses == null)
            return new QuestionResponse { QuestionId = questionId, QuestionType = QuestionType.TextQuestion };

        if (!response.SectionResponses.TryGetValue(currentSection.Id, out var sectionResponse))
            return new QuestionResponse { QuestionId = questionId, QuestionType = QuestionType.TextQuestion };

        // Determine which role's responses to fetch based on section's CompletionRole
        // Copy exact logic from DynamicQuestionnaire.razor lines 1092-1112
        var isPostReviewState = Assignment != null &&
            (Assignment.WorkflowState is WorkflowState.ManagerReviewConfirmed or
                                        WorkflowState.EmployeeReviewConfirmed or
                                        WorkflowState.Finalized);

        // Review mode is always post-review state, but let's be explicit
        var isManagerViewingEmployeeOnlyQuestionnaire = IsManagerRole(currentUserRole) && template != null && !template.RequiresManagerReview;

        ResponseRole roleToFetch = CurrentResponseRole;

        if (isPostReviewState || isManagerViewingEmployeeOnlyQuestionnaire)
        {
            // In post-review states or when manager views employee-only questionnaire,
            // fetch responses based on section's CompletionRole
            roleToFetch = currentSection.CompletionRole switch
            {
                CompletionRole.Employee => ResponseRole.Employee,
                CompletionRole.Manager => ResponseRole.Manager,
                CompletionRole.Both => CurrentResponseRole,
                _ => CurrentResponseRole
            };
        }

        // Access responses for the determined role
        if (sectionResponse.RoleResponses?.TryGetValue(roleToFetch, out var roleQuestions) == true &&
            roleQuestions.TryGetValue(questionId, out var questionResponse))
        {
            return questionResponse;
        }

        return new QuestionResponse { QuestionId = questionId, QuestionType = QuestionType.TextQuestion };
    }

    private object? GetAnswer(Guid sectionId, Guid questionId, CompletionRole role)
    {
        var questionResponse = GetQuestionResponse(sectionId, questionId, role);
        return questionResponse.ResponseData;
    }

    private async Task EditAnswer(QuestionItem question, CompletionRole originalRole)
    {
        var currentAnswer = GetAnswer(currentSection!.Id, question.Id, originalRole);

        var result = await DialogService.OpenAsync<EditAnswerDialog>(
            $"Edit Answer: {currentSection!.Title}",
            new Dictionary<string, object>
            {
                { "Question", question },
                { "CurrentAnswer", currentAnswer },
                { "CompletionRole", originalRole },
                { "SectionTitle", currentSection.Title },
                { "AssignmentId", Assignment.Id },
                { "CurrentUserRole", GetRoleForDialog(originalRole) },
                { "AssignmentWorkflowState", Assignment.WorkflowState }
            },
            new DialogOptions { Width = "900px", Height = "600px", Resizable = true, Draggable = true }
        );

        if (result is QuestionResponse questionResponse)
        {
            await SaveEditedAnswer(currentSection.Id, originalRole, questionResponse);
        }
    }

    private async Task SaveEditedAnswer(Guid sectionId, CompletionRole originalRole, QuestionResponse questionResponse)
    {
        try
        {
            // Serialize the complete QuestionResponse to JSON
            string answerJson = System.Text.Json.JsonSerializer.Serialize(questionResponse);

            var success = await AssignmentService.EditAnswerDuringReviewAsync(
                Assignment.Id,
                sectionId,
                questionResponse.QuestionId,
                originalRole,
                answerJson,
                currentManagerName
            );

            if (success)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Saved", "Answer updated successfully");

                // Reload response to show updated answer
                await LoadReviewData();

                // After assignment response reload, refresh any goal components to prevent stale data
                await RefreshGoalComponents();

                StateHasChanged();
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to save answer");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to save answer: {ex.Message}");
        }
    }

    private async Task CopyAnswer(QuestionItem question, CompletionRole fromRole, CompletionRole toRole)
    {
        var sourceAnswer = GetAnswer(currentSection!.Id, question.Id, fromRole);
        if (sourceAnswer == null)
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Nothing to Copy", "Source answer is empty");
            return;
        }

        var confirmed = await DialogService.Confirm(
            $"Copy answer from {fromRole} to {toRole}?",
            "Confirm Copy",
            new ConfirmOptions { OkButtonText = "Yes, Copy", CancelButtonText = "Cancel" }
        );

        if (confirmed == true)
        {
            // Build QuestionResponse from source answer
            var questionResponse = new QuestionResponse
            {
                QuestionId = question.Id,
                QuestionType = question.Type,
                LastModified = DateTime.Now,
                ResponseData = sourceAnswer as QuestionResponseDataDto
            };

            await SaveEditedAnswer(currentSection.Id, toRole, questionResponse);
        }
    }

    private void PreviousSection()
    {
        if (currentSectionIndex > 0)
        {
            currentSectionIndex--;
            StateHasChanged();
        }
    }

    private void NextSection()
    {
        if (template != null && currentSectionIndex < template.Sections.Count - 1)
        {
            currentSectionIndex++;
            StateHasChanged();
        }
    }

    private async Task FinishReview()
    {
        try
        {
            // Open dialog to collect optional review summary
            // Pass existing ManagerReviewSummary if reopening review (will be shown in dialog)
            var result = await DialogService.OpenAsync<FinishReviewMeetingDialog>(
                "Finish Review Meeting",
                new Dictionary<string, object>
                {
                    { "ExistingReviewSummary", Assignment.ManagerReviewSummary }
                },
                new DialogOptions
                {
                    Width = "650px",
                    Height = "600px",
                    Resizable = false,
                    Draggable = true,
                    ShowClose = true
                });

            // If dialog was cancelled, return
            if (result == null)
            {
                return;
            }

            // Result is the review summary (can be null or empty string)
            var reviewSummary = result as string;

            // Call API to finish review meeting with summary
            var success = await AssignmentService.FinishReviewMeetingAsync(
                Assignment.Id,
                currentManagerName,
                string.IsNullOrWhiteSpace(reviewSummary) ? null : reviewSummary);

            if (success)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Review meeting finished successfully");

                // Trigger the callback to reload assignment
                if (OnReviewFinished.HasDelegate)
                {
                    await OnReviewFinished.InvokeAsync();
                }
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to finish review meeting");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Error finishing review meeting: {ex.Message}");
        }
    }

    private string GetRoleClass(CompletionRole role)
    {
        return role switch
        {
            CompletionRole.Employee => "role-employee",
            CompletionRole.Manager => "role-manager",
            CompletionRole.Both => "role-both",
            _ => ""
        };
    }

    private string GetRoleIcon(CompletionRole role)
    {
        return role switch
        {
            CompletionRole.Employee => "person",
            CompletionRole.Manager => "supervisor_account",
            CompletionRole.Both => "groups",
            _ => "help"
        };
    }

    // Cache the current user's role to avoid async calls during render
    private string currentUserRole = "Employee";

    /// <summary>
    /// The response role for accessing RoleResponses dictionary.
    /// Converts current user's role to ResponseRole for data access.
    /// </summary>
    private ResponseRole CurrentResponseRole
    {
        get
        {
            if (Enum.TryParse<ApplicationRole>(currentUserRole, out var appRole))
            {
                return appRole.ToResponseRole();
            }
            return ResponseRole.Employee; // Fallback
        }
    }

    private async Task InitializeCurrentUserRoleAsync()
    {
        try
        {
            // Properly await the authentication state
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState?.User;

            if (user?.Identity?.IsAuthenticated == true)
            {
                // Try to get ApplicationRole from claims
                var roleClaim = user.FindFirst("ApplicationRole");
                if (roleClaim != null)
                {
                    currentUserRole = roleClaim.Value;
                    return;
                }
            }

            currentUserRole = "Employee";
        }
        catch (Exception)
        {
            currentUserRole = "Employee";
        }
    }

    private string GetCurrentUserRole()
    {
        // Return the cached role (no async operations during render)
        return currentUserRole;
    }

    private string GetRoleForDialog(CompletionRole originalRole)
    {
        // When editing Employee's Answer, always pass "Employee"
        // When editing Manager's Answer, pass the current user's actual role
        return originalRole == CompletionRole.Employee ? "Employee" : GetCurrentUserRole();
    }

    private bool IsManagerRole(string role)
    {
        return role == "TeamLead" || role == "HR" || role == "HRLead" || role == "Admin";
    }

    /// <summary>
    /// Gets the appropriate role context for the Manager's Answer section filtering.
    /// The Manager's Answer section should always show goals from ANY manager role,
    /// regardless of who is currently viewing the page.
    ///
    /// - If current user is a manager: Use their actual role (maintains audit trail)
    /// - If current user is employee: Use representative manager role to trigger manager filtering
    ///
    /// The specific manager role used doesn't affect filtering - the OptimizedGoalQuestion
    /// component shows goals from ALL manager roles when any manager role is provided.
    /// </summary>
    private string GetManagerContextRole()
    {
        var userRole = GetCurrentUserRole();
        return IsManagerRole(userRole) ? userRole : "TeamLead";
    }

    /// <summary>
    /// Triggers refresh of all goal components after assignment response data is reloaded.
    /// This prevents stale goal data from overwriting fresh API updates.
    /// </summary>
    private async Task RefreshGoalComponents()
    {
        // Increment the refresh token to trigger goal component reloads
        goalRefreshToken++;

        // Small delay to ensure token change propagates before any additional operations
        await Task.Delay(50);
    }

    /// <summary>
    /// Debug helper to show which role was fetched for a goal question
    /// </summary>
    private string GetRoleFetchedForGoal(Guid questionId)
    {
        if (currentSection == null || response?.SectionResponses == null)
            return "NO_SECTION_OR_RESPONSE";

        if (!response.SectionResponses.TryGetValue(currentSection.Id, out var sectionResponse))
            return "NO_SECTION_RESPONSE";

        // Copy the same logic from GetGenericQuestionResponse to show what role it would fetch
        var isPostReviewState = Assignment != null &&
            (Assignment.WorkflowState is WorkflowState.ManagerReviewConfirmed or
                                        WorkflowState.EmployeeReviewConfirmed or
                                        WorkflowState.Finalized);

        var isManagerViewingEmployeeOnlyQuestionnaire = IsManagerRole(currentUserRole) && template != null && !template.RequiresManagerReview;

        ResponseRole roleToFetch = CurrentResponseRole;

        if (isPostReviewState || isManagerViewingEmployeeOnlyQuestionnaire)
        {
            roleToFetch = currentSection.CompletionRole switch
            {
                CompletionRole.Employee => ResponseRole.Employee,
                CompletionRole.Manager => ResponseRole.Manager,
                CompletionRole.Both => CurrentResponseRole,
                _ => CurrentResponseRole
            };
        }

        var hasData = sectionResponse.RoleResponses?.TryGetValue(roleToFetch, out var roleQuestions) == true &&
                     roleQuestions.ContainsKey(questionId);

        return $"{roleToFetch} (has_data: {hasData})";
    }
}
