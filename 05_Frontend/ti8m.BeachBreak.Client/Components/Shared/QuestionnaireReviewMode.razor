@using Radzen
@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Models.DTOs
@using ti8m.BeachBreak.Client.Services
@using ti8m.BeachBreak.Client.Models.Dto
@using ti8m.BeachBreak.Client.Components.Questions
@using ti8m.BeachBreak.Client.Components.Dialogs
@using ti8m.BeachBreak.Client.Layout
@using Microsoft.AspNetCore.Components.Authorization
@using ti8m.BeachBreak.Client.Extensions
@using ti8m.BeachBreak.Client.Components.Shared
@inherits OptimizedTranslatableComponentBase
@inject IQuestionnaireTemplateService TemplateService
@inject IQuestionnaireResponseService ResponseService
@inject IQuestionnaireAssignmentService AssignmentService
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IAuthService AuthService
@inject NavigationManager NavigationManager


@if (isLoading)
{
    <div class="text-center p-5">
        <RadzenProgressBarCircular ProgressBarStyle="ProgressBarStyle.Primary" Value="100" ShowValue="false" Class="mb-3" />
        <RadzenText TextStyle="TextStyle.Body1" Class="text-muted">Loading review data...</RadzenText>
    </div>
}
else if (template == null || response == null)
{
    <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat">
        <RadzenText TextStyle="TextStyle.Body1">Unable to load questionnaire data for review.</RadzenText>
    </RadzenAlert>
}
else
{
    <PageLayout Type="LayoutType.Immersive"
                          Title="@($"Review Meeting: {template.GetLocalizedNameWithFallback(CurrentLanguage)}")"
                        Description="@template.GetLocalizedDescriptionWithFallback(CurrentLanguage)"
                        ShowDefaultFooter="true">
        <HeaderContent>
            <div class="questionnaire-info-banner">
                <RadzenIcon Icon="info" />
                <div>
                    <strong>Reviewing Employee:</strong> @Assignment.EmployeeName &nbsp;|&nbsp;
                    As the manager, you can view and edit all answers during this review meeting. All changes are tracked.
                </div>
            </div>
        </HeaderContent>
        <DefaultFooterContent>
            <RadzenButton Text="Previous"
                          ButtonStyle="ButtonStyle.Light"
                          Icon="arrow_back"
                          Click="@PreviousSection"
                          Disabled="@(currentSectionIndex == 0)" />

            <div class="navigation-actions d-flex gap-2">
                @if (currentSectionIndex < template.Sections.Count - 1)
                {
                    <RadzenButton Text="Next"
                                  ButtonStyle="ButtonStyle.Primary"
                                  Icon="arrow_forward"
                                  Click="@NextSection" />
                }
                else
                {
                    <RadzenButton Text="Complete Review"
                                  ButtonStyle="ButtonStyle.Success"
                                  Icon="arrow_forward"
                                  Click="@NavigateToReviewCompletion" />
                }
            </div>
        </DefaultFooterContent>
        <ChildContent>

            <!-- Section Counter - Matches DynamicQuestionnaire -->
            <div class="section-counter mb-4">
                <RadzenText TextStyle="TextStyle.Body2" Class="text-muted text-end">
                    Section @(currentSectionIndex + 1) of @template.Sections.Count
                </RadzenText>
            </div>

            <!-- Steps Navigation - Matches DynamicQuestionnaire -->
            <RadzenSteps Value="@currentSectionIndex" Change="@OnSectionChanged" Class="mb-4" ShowStepsButtons="false">
                @for (int i = 0; i < template.Sections.Count; i++)
                {
                    var sectionItem = template.Sections.OrderBy(s => s.Order).Skip(i).FirstOrDefault();
                    if (sectionItem != null)
                    {
                        <RadzenStepsItem Text="@sectionItem.GetLocalizedTitleWithFallback(CurrentLanguage)" />
                    }
                }
            </RadzenSteps>

            <!-- Current Section Content - Matches DynamicQuestionnaire structure -->
            <div class="questionnaire-content">
                @if (currentSection != null)
                {
                    <header class="section-header-questionnaire">
                        <div class="section-title-container">
                            <h2 class="section-title">@currentSection.GetLocalizedTitleWithFallback(CurrentLanguage)</h2>
                            @if (!string.IsNullOrWhiteSpace(currentSection.GetLocalizedDescriptionWithFallback(CurrentLanguage)))
                            {
                                <p class="section-description">@currentSection.GetLocalizedDescriptionWithFallback(CurrentLanguage)</p>
                            }
                        </div>
                    </header>

                    <!-- Questions Container -->
                    <div class="questions-container">
                        <div class="question-wrapper mb-4">
                            <div class="question-title">
                                @currentSection.GetLocalizedTitleWithFallback(CurrentLanguage)
                            </div>

                            @if (!string.IsNullOrWhiteSpace(currentSection.GetLocalizedDescriptionWithFallback(CurrentLanguage)))
                            {
                                <div class="question-description">@currentSection.GetLocalizedDescriptionWithFallback(CurrentLanguage)</div>
                            }

                            <div class="review-question-container">
                                @if (currentSection.CompletionRole == CompletionRole.Both && currentSection.Type == QuestionType.Assessment)
                                {
                                    <!-- Special renderer for assessment questions showing competencies side-by-side -->
                                    var employeeResponse = GetSectionResponse(currentSection.Id, CompletionRole.Employee);
                                    var managerResponse = GetSectionResponse(currentSection.Id, CompletionRole.Manager);

                                    <ReviewModeAssessmentRenderer Question="@currentSection"
                                                                  EmployeeResponse="@employeeResponse"
                                                                  ManagerResponse="@managerResponse"
                                                                  OnEditAnswer="@((args) => EditAnswer(args.Item1, args.Item2, args.Item3))"
                                                                  OnCopyAnswer="@((args) => CopyAnswer(args.Item1, args.Item2, args.Item3))" />
                                }
                                else if (currentSection.CompletionRole == CompletionRole.Both && currentSection.Type != QuestionType.Goal)
                                {
                                    <!-- Section-by-section comparison card for Both sections (excluding goals and assessments) -->
                                    <div class="question-comparison-card">
                                        <!-- Side-by-side view within the section card -->
                                        <div class="side-by-side-view">
                                            <!-- Employee Answer -->
                                            <div class="answer-column employee">
                                                <div class="answer-header">
                                                    <span class="answer-label">
                                                        <RadzenIcon Icon="person" Style="font-size: 1rem;" />
                                                        Employee's Answer
                                                    </span>
                                                </div>
                                                <div class="answer-content">
                                                    <div class="answer-value">
                                                        @{
                                                            var employeeResponse = GetSectionResponse(currentSection.Id, CompletionRole.Employee);
                                                        }
                                                        <OptimizedQuestionRenderer Section="@currentSection"
                                                                                   Response="@employeeResponse"
                                                                                   IsReadOnly="true"
                                                                                   HideHeader="true"
                                                                                   AssignmentId="@Assignment.Id"
                                                                                   CurrentUserRole="ApplicationRole.Employee"
                                                                                   AssignmentWorkflowState="@Assignment.WorkflowState"
                                                                                   GoalRefreshToken="@goalRefreshToken" />
                                                    </div>
                                                </div>
                                                <div class="answer-actions">
                                                    <RadzenButton Text="Copy to Manager →"
                                                                  ButtonStyle="ButtonStyle.Light"
                                                                  Icon="content_copy"
                                                                  Size="ButtonSize.Small"
                                                                  Click="@(() => CopyAnswer(currentSection, CompletionRole.Employee, CompletionRole.Manager))"
                                                                  Class="copy-button" />
                                                    <RadzenButton Text="Edit"
                                                                  ButtonStyle="ButtonStyle.Primary"
                                                                  Icon="edit"
                                                                  Size="ButtonSize.Small"
                                                                  Click="@(() => EditAnswer(currentSection, CompletionRole.Employee))" />
                                                </div>
                                            </div>

                                            <!-- Manager Answer -->
                                            <div class="answer-column manager">
                                                <div class="answer-header">
                                                    <span class="answer-label">
                                                        <RadzenIcon Icon="supervisor_account" Style="font-size: 1rem;" />
                                                        Manager's Answer
                                                    </span>
                                                </div>
                                                <div class="answer-content">
                                                    <div class="answer-value">
                                                        @{
                                                            var managerResponse = GetSectionResponse(currentSection.Id, CompletionRole.Manager);
                                                        }
                                                        <OptimizedQuestionRenderer Section="@currentSection"
                                                                                   Response="@managerResponse"
                                                                                   IsReadOnly="true"
                                                                                   HideHeader="true"
                                                                                   AssignmentId="@Assignment.Id"
                                                                                   CurrentUserRole="@currentUserRole"
                                                                                   AssignmentWorkflowState="@Assignment.WorkflowState"
                                                                                   GoalRefreshToken="@goalRefreshToken" />
                                                    </div>
                                                </div>
                                                <div class="answer-actions">
                                                    <RadzenButton Text="← Copy to Employee"
                                                                  ButtonStyle="ButtonStyle.Light"
                                                                  Icon="content_copy"
                                                                  Size="ButtonSize.Small"
                                                                  Click="@(() => CopyAnswer(currentSection, CompletionRole.Manager, CompletionRole.Employee))"
                                                                  Class="copy-button" />
                                                    <RadzenButton Text="Edit"
                                                                  ButtonStyle="ButtonStyle.Primary"
                                                                  Icon="edit"
                                                                  Size="ButtonSize.Small"
                                                                  Click="@(() => EditAnswer(currentSection, CompletionRole.Manager))" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                                else if (currentSection.CompletionRole == CompletionRole.Both && currentSection.Type == QuestionType.Goal)
                                {
                                    <!-- Collaborative grouped view for goal sections in Both sections -->
                                    <div class="goal-collaborative-view">
                                        @{
                                            // Use the same approach as DynamicQuestionnaire.razor - let OptimizedQuestionRenderer handle role logic
                                            var goalResponse = GetGenericSectionResponse(currentSection.Id);
                                        }


                                        @{
                                            // Get the section response containing all role responses for review mode
                                            SectionResponse? sectionData = null;
                                            if (currentSection != null && response?.SectionResponses != null &&
                                            response.SectionResponses.TryGetValue(currentSection.Id, out var sectionResponse))
                                            {
                                                sectionData = sectionResponse;
                                            }
                                        }

                                        <OptimizedQuestionRenderer Section="@currentSection"
                                                                   Response="@goalResponse"
                                                                   IsReadOnly="false"
                                                                   HideHeader="true"
                                                                   AssignmentId="@Assignment.Id"
                                                                   CurrentUserRole="@currentUserRole"
                                                                   AssignmentWorkflowState="@Assignment.WorkflowState"
                                                                   GoalRefreshToken="@goalRefreshToken"
                                                                   SectionData="@sectionData" />

                                        <!-- Inline goal management now available directly -->
                                        <!-- EDIT, DELETE, and ADD NEW GOAL buttons are shown inline in the component above -->
                                    </div>
                                }
                                else
                                {
                                    <!-- Single column view for Employee or Manager only sections -->
                                    <div class="single-answer-view">
                                        <div class="answer-header">
                                            <span class="answer-label">
                                                <RadzenIcon Icon="@GetRoleIcon(currentSection.CompletionRole)" Style="font-size: 1rem;" />
                                                @currentSection.CompletionRole's Answer
                                            </span>
                                        </div>
                                        <div class="answer-content">
                                            <div class="answer-value">
                                                @{
                                                    var singleResponse = GetSectionResponse(currentSection.Id, currentSection.CompletionRole);
                                                }
                                                <OptimizedQuestionRenderer Section="@currentSection"
                                                                           Response="@singleResponse"
                                                                           IsReadOnly="true"
                                                                           HideHeader="true"
                                                                           AssignmentId="@Assignment.Id"
                                                                           CurrentUserRole="@ConvertCompletionRoleToApplicationRole(currentSection.CompletionRole)"
                                                                           AssignmentWorkflowState="@Assignment.WorkflowState"
                                                                           GoalRefreshToken="@goalRefreshToken" />
                                            </div>
                                        </div>
                                        <div class="answer-actions">
                                            <RadzenButton Text="Edit Answer"
                                                          ButtonStyle="ButtonStyle.Primary"
                                                          Icon="edit"
                                                          Size="ButtonSize.Medium"
                                                          Click="@(() => EditAnswer(currentSection, currentSection.CompletionRole))" />
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- InReview Notes Panel -->
            @if (Assignment.WorkflowState == WorkflowState.InReview && HasManagerPrivileges)
            {
                <InReviewNotesPanel Assignment="@Assignment"
                                   CurrentSection="@currentSection"
                                   OnNotesChanged="@OnNotesUpdated" />
            }
        </ChildContent>
    </PageLayout>
}

@code {
    [Parameter, EditorRequired] public QuestionnaireAssignment Assignment { get; set; } = null!;
    [Parameter] public EventCallback OnReviewFinished { get; set; }

    // Accept pre-loaded data as parameters to avoid duplicate API calls
    [Parameter, EditorRequired] public QuestionnaireTemplate Template { get; set; } = null!;
    [Parameter, EditorRequired] public QuestionnaireResponse Response { get; set; } = null!;
    [Parameter, EditorRequired] public ApplicationRole UserRole { get; set; }

    private QuestionnaireTemplate? template;
    private QuestionnaireResponse? response;
    private int currentSectionIndex = 0;
    private bool isLoading = false; // No loading needed since data is passed as parameters
    private string currentManagerName = string.Empty;

    // Token to trigger goal component refresh after assignment response reload
    private int goalRefreshToken = 0;

    private QuestionSection? currentSection => template?.Sections.OrderBy(s => s.Order).Skip(currentSectionIndex).FirstOrDefault();

    protected override async Task OnInitializedAsync()
    {
        // Initialize the current user role cache before loading review data
        await InitializeCurrentUserRoleAsync();
        await LoadReviewData();
    }

    private async Task LoadReviewData()
    {
        try
        {
            isLoading = true;

            // Get current manager name
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            currentManagerName = authState.User.Identity?.Name ?? "Unknown Manager";

            // Load template
            template = await TemplateService.GetTemplateByIdAsync(Assignment.TemplateId);

            // Load response (contains both employee and manager answers)
            response = await ResponseService.GetResponseByAssignmentIdAsync(Assignment.Id);

            if (template == null || response == null)
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load review data");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load review data: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void OnSectionChanged(int newIndex)
    {
        if (newIndex >= 0 && newIndex < (template?.Sections.Count ?? 0))
        {
            currentSectionIndex = newIndex;
            StateHasChanged();
        }
    }

    private QuestionResponse GetSectionResponse(Guid sectionId, CompletionRole role)
    {
        if (response?.SectionResponses == null)
            return new QuestionResponse { QuestionId = sectionId, QuestionType = QuestionType.TextQuestion };

        if (!response.SectionResponses.TryGetValue(sectionId, out var sectionResponse))
            return new QuestionResponse { QuestionId = sectionId, QuestionType = QuestionType.TextQuestion };

        // Convert CompletionRole to ResponseRole for type-safe dictionary access
        var responseRole = role.ToResponseRole();

        // Direct 2-level access (Section IS the question)
        if (sectionResponse.RoleResponses?.TryGetValue(responseRole, out var sectionQuestionResponse) == true)
        {
            return sectionQuestionResponse;
        }

        return new QuestionResponse { QuestionId = sectionId, QuestionType = QuestionType.TextQuestion };
    }

    private QuestionResponse GetGenericSectionResponse(Guid sectionId)
    {
        if (currentSection == null || response?.SectionResponses == null)
            return new QuestionResponse { QuestionId = sectionId, QuestionType = QuestionType.TextQuestion };

        if (!response.SectionResponses.TryGetValue(sectionId, out var sectionResponse))
            return new QuestionResponse { QuestionId = sectionId, QuestionType = QuestionType.TextQuestion };

        // Determine which role's responses to fetch based on section's CompletionRole
        var isPostReviewState = Assignment != null &&
            (Assignment.WorkflowState is WorkflowState.ReviewFinished or
                                        WorkflowState.EmployeeReviewConfirmed or
                                        WorkflowState.Finalized);

        // Review mode is always post-review state, but let's be explicit
        var isManagerViewingEmployeeOnlyQuestionnaire = HasManagerPrivileges && template != null && !template.ProcessType.RequiresManagerReview();

        ResponseRole roleToFetch = CurrentResponseRole;

        if (isPostReviewState || isManagerViewingEmployeeOnlyQuestionnaire)
        {
            // In post-review states or when manager views employee-only questionnaire,
            // fetch responses based on section's CompletionRole
            roleToFetch = currentSection.CompletionRole switch
            {
                CompletionRole.Employee => ResponseRole.Employee,
                CompletionRole.Manager => ResponseRole.Manager,
                CompletionRole.Both => CurrentResponseRole,
                _ => CurrentResponseRole
            };
        }

        // Direct 2-level access (Section IS the question)
        if (sectionResponse.RoleResponses?.TryGetValue(roleToFetch, out var sectionQuestionResponse) == true)
        {
            return sectionQuestionResponse;
        }

        return new QuestionResponse { QuestionId = sectionId, QuestionType = QuestionType.TextQuestion };
    }

    private object? GetAnswer(Guid sectionId, CompletionRole role)
    {
        var sectionResponse = GetSectionResponse(sectionId, role);
        return sectionResponse.ResponseData;
    }

    private async Task EditAnswer(QuestionSection section, CompletionRole originalRole, string? evaluationKey = null)
    {
        var currentAnswer = GetAnswer(section.Id, originalRole);

        var parameters = new Dictionary<string, object>
        {
            { "Section", section },
            { "CurrentAnswer", currentAnswer },
            { "CompletionRole", originalRole },
            { "SectionTitle", section.GetLocalizedTitleWithFallback(CurrentLanguage) },
            { "AssignmentId", Assignment.Id },
            { "CurrentUserRole", GetRoleForDialog(originalRole) },
            { "AssignmentWorkflowState", Assignment.WorkflowState }
        };

        // Add EvaluationKey if editing a specific evaluation
        if (!string.IsNullOrEmpty(evaluationKey))
        {
            parameters.Add("EvaluationKey", evaluationKey);
        }

        var result = await DialogService.OpenAsync<EditAnswerDialog>(
            $"Edit Answer: {section.GetLocalizedTitleWithFallback(CurrentLanguage)}",
            parameters,
            new DialogOptions { Width = "900px", Height = "600px", Resizable = true, Draggable = true }
        );

        if (result is QuestionResponse questionResponse)
        {
            await SaveEditedAnswer(section.Id, originalRole, questionResponse);
        }
    }

    private async Task SaveEditedAnswer(Guid sectionId, CompletionRole originalRole, QuestionResponse questionResponse)
    {
        try
        {
            // NOTE: questionResponse.QuestionId IS the sectionId (Section IS the question)
            // Serialize the complete QuestionResponse to JSON
            string answerJson = System.Text.Json.JsonSerializer.Serialize(questionResponse);

            var success = await AssignmentService.EditAnswerDuringReviewAsync(
                Assignment.Id,
                sectionId,
                questionResponse.QuestionId,  // This is the section ID
                originalRole,
                answerJson,
                currentManagerName
            );

            if (success)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Saved", "Answer updated successfully");

                // Reload response to show updated answer
                await LoadReviewData();

                // After assignment response reload, refresh any goal components to prevent stale data
                await RefreshGoalComponents();

                StateHasChanged();
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to save answer");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to save answer: {ex.Message}");
        }
    }

    private async Task CopyAnswer(QuestionSection section, CompletionRole fromRole, CompletionRole toRole)
    {
        var sourceAnswer = GetAnswer(section.Id, fromRole);
        if (sourceAnswer == null)
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Nothing to Copy", "Source answer is empty");
            return;
        }

        var confirmed = await DialogService.Confirm(
            $"Copy answer from {fromRole} to {toRole}?",
            "Confirm Copy",
            new ConfirmOptions { OkButtonText = "Yes, Copy", CancelButtonText = "Cancel" }
        );

        if (confirmed == true)
        {
            // Build QuestionResponse from source answer
            var questionResponse = new QuestionResponse
            {
                QuestionId = section.Id,  // Section ID is the question ID
                QuestionType = section.Type,
                LastModified = DateTime.Now,
                ResponseData = sourceAnswer as QuestionResponseDataDto
            };

            await SaveEditedAnswer(section.Id, toRole, questionResponse);
        }
    }

    private void PreviousSection()
    {
        if (currentSectionIndex > 0)
        {
            currentSectionIndex--;
            StateHasChanged();
        }
    }

    private void NextSection()
    {
        if (template != null && currentSectionIndex < template.Sections.Count - 1)
        {
            currentSectionIndex++;
            StateHasChanged();
        }
    }

    private void NavigateToReviewCompletion()
    {
        var url = $"/questionnaire/{Assignment.Id}/finish-review";
        NavigationManager.NavigateTo(url);
    }

    private string GetRoleClass(CompletionRole role)
    {
        return role switch
        {
            CompletionRole.Employee => "role-employee",
            CompletionRole.Manager => "role-manager",
            CompletionRole.Both => "role-both",
            _ => ""
        };
    }

    private string GetRoleIcon(CompletionRole role)
    {
        return role switch
        {
            CompletionRole.Employee => "person",
            CompletionRole.Manager => "supervisor_account",
            CompletionRole.Both => "groups",
            _ => "help"
        };
    }

    /// <summary>
    /// The user's organizational role determining data access permissions.
    /// Maps to ApplicationRole enum: Employee, TeamLead, HR, HRLead, Admin.
    /// Defaults to Employee (principle of least privilege), then upgraded via API call.
    /// </summary>
    private ApplicationRole currentUserRole = ApplicationRole.Employee;

    /// <summary>
    /// Whether user has manager-level privileges (TeamLead or higher).
    /// Determines endpoint access and UI features.
    /// </summary>
    private bool HasManagerPrivileges => currentUserRole is ApplicationRole.TeamLead
        or ApplicationRole.HR
        or ApplicationRole.HRLead
        or ApplicationRole.Admin;

    /// <summary>
    /// The response role for accessing RoleResponses dictionary.
    /// Converts current user's role to ResponseRole for data access.
    /// </summary>
    private ResponseRole CurrentResponseRole => currentUserRole.ToResponseRole();

    private async Task InitializeCurrentUserRoleAsync()
    {
        try
        {
            // WebAssembly client doesn't have ApplicationRole claims (those are added server-side only)
            // So we need to call the API to get the user's role from the database
            var roleData = await AuthService.GetMyRoleAsync();

            if (roleData == null)
            {
                throw new UnauthorizedAccessException("Unable to retrieve user role for review mode");
            }

            // Store the actual ApplicationRole
            currentUserRole = roleData.ApplicationRole;

            // SECURITY: Validate manager privileges for review mode
            if (!HasManagerPrivileges)
            {
                throw new UnauthorizedAccessException($"Review mode requires manager privileges. Current role: {currentUserRole}");
            }
        }
        catch (Exception ex)
        {
            // Follow principle of least privilege - default to Employee even in error cases
            NotificationService.Notify(NotificationSeverity.Error, "Access Error",
                $"Unable to validate manager access for review mode: {ex.Message}");

            // Default to Employee for consistency and security (least privilege principle)
            // The HasManagerPrivileges validation will catch unauthorized access
            currentUserRole = ApplicationRole.Employee;
        }
    }


    private ApplicationRole GetRoleForDialog(CompletionRole originalRole)
    {
        // When editing Employee's Answer, always pass ApplicationRole.Employee
        // When editing Manager's Answer, pass the current user's actual role
        return originalRole == CompletionRole.Employee ? ApplicationRole.Employee : currentUserRole;
    }

    private bool IsManagerRole(ApplicationRole role)
    {
        return role is ApplicationRole.TeamLead or ApplicationRole.HR or ApplicationRole.HRLead or ApplicationRole.Admin;
    }

    private ApplicationRole ConvertCompletionRoleToApplicationRole(CompletionRole completionRole)
    {
        // CompletionRole.Employee should map to ApplicationRole.Employee
        // CompletionRole.Manager could be the current user's actual role (if they are a manager)
        return completionRole == CompletionRole.Employee ? ApplicationRole.Employee : currentUserRole;
    }


    /// <summary>
    /// Triggers refresh of all goal components after assignment response data is reloaded.
    /// This prevents stale goal data from overwriting fresh API updates.
    /// </summary>
    private async Task RefreshGoalComponents()
    {
        // Increment the refresh token to trigger goal component reloads
        goalRefreshToken++;

        // Small delay to ensure token change propagates before any additional operations
        await Task.Delay(50);
    }

    /// <summary>
    /// Debug helper to show which role was fetched for a goal question
    /// </summary>
    private string GetRoleFetchedForGoal(Guid questionId)
    {
        if (currentSection == null || response?.SectionResponses == null)
            return "NO_SECTION_OR_RESPONSE";

        if (!response.SectionResponses.TryGetValue(currentSection.Id, out var sectionResponse))
            return "NO_SECTION_RESPONSE";

        // Copy the same logic from GetGenericQuestionResponse to show what role it would fetch
        var isPostReviewState = Assignment != null &&
            (Assignment.WorkflowState is WorkflowState.ReviewFinished or
                                        WorkflowState.EmployeeReviewConfirmed or
                                        WorkflowState.Finalized);

        var isManagerViewingEmployeeOnlyQuestionnaire = HasManagerPrivileges && template != null && !template.ProcessType.RequiresManagerReview();

        ResponseRole roleToFetch = CurrentResponseRole;

        if (isPostReviewState || isManagerViewingEmployeeOnlyQuestionnaire)
        {
            roleToFetch = currentSection.CompletionRole switch
            {
                CompletionRole.Employee => ResponseRole.Employee,
                CompletionRole.Manager => ResponseRole.Manager,
                CompletionRole.Both => CurrentResponseRole,
                _ => CurrentResponseRole
            };
        }

        var hasData = sectionResponse.RoleResponses?.TryGetValue(roleToFetch, out var roleQuestion) == true &&
                     roleQuestion != null;

        return $"{roleToFetch} (has_data: {hasData})";
    }

    private async Task OnNotesUpdated()
    {
        // Optionally reload assignment to get latest notes
        // For now, optimistic updates handle this
        StateHasChanged();
    }
}
