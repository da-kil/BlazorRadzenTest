@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Services
@using ti8m.BeachBreak.Client.Components.Dialogs
@using ti8m.BeachBreak.Client.Components.Shared
@inherits OptimizedTranslatableComponentBase
@inject IQuestionnaireAssignmentService AssignmentService
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject NavigationManager NavigationManager

<div class="workflow-action-buttons">
    @if (Assignment != null)
    {
        <div class="workflow-banner-content">
            <div class="workflow-info">
                <div class="workflow-icon">
                    <RadzenIcon Icon="@GetWorkflowIcon()" />
                </div>
                <div class="workflow-text">
                    <div class="workflow-title">@T("labels.workflow-status")</div>
                    <div class="workflow-status">@GetWorkflowStatusText()</div>
                </div>
            </div>

            <div class="button-group">
                @if (IsManager && WorkflowStateHelper.CanManagerInitialize(Assignment))
                {
                    <RadzenButton Text="@T("buttons.initialize-assignment")"
                                  Icon="settings"
                                  ButtonStyle="ButtonStyle.Primary"
                                  Click="@NavigateToInitialization"
                                  Size="ButtonSize.Medium" />
                }

                @if (IsManager && WorkflowStateHelper.CanInitiateReview(Assignment))
                {
                    <AsyncButton Text="@T("buttons.initiate-review-meeting")"
                                 ProcessingText="@T("buttons.initiating")"
                                 Icon="rate_review"
                                 ButtonStyle="ButtonStyle.Primary"
                                 Click="@InitiateReview"
                                 Disabled="@isProcessing"
                                 Size="ButtonSize.Medium" />
                }

                @if (IsEmployee && WorkflowStateHelper.CanEmployeeConfirmReview(Assignment))
                {
                    <AsyncButton Text="@T("buttons.sign-off-on-review")"
                                 ProcessingText="@T("buttons.signing-off")"
                                 Icon="verified"
                                 ButtonStyle="ButtonStyle.Success"
                                 Click="@ConfirmEmployeeReview"
                                 Disabled="@isProcessing"
                                 Size="ButtonSize.Medium" />
                }

                @if (IsManager && WorkflowStateHelper.CanManagerFinalize(Assignment))
                {
                    <AsyncButton Text="@T("buttons.finalize-questionnaire")"
                                 ProcessingText="@T("buttons.finalizing")"
                                 Icon="lock"
                                 ButtonStyle="ButtonStyle.Warning"
                                 Click="@FinalizeQuestionnaire"
                                 Disabled="@isProcessing"
                                 Size="ButtonSize.Medium" />
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public QuestionnaireAssignment? Assignment { get; set; }

    [Parameter]
    public bool IsEmployee { get; set; }

    [Parameter]
    public bool IsManager { get; set; }

    [Parameter]
    public string UserName { get; set; } = string.Empty;

    [Parameter]
    public EventCallback OnActionCompleted { get; set; }

    private bool isProcessing = false;

    private async Task InitiateReview()
    {
        if (Assignment == null) return;

        isProcessing = true;
        try
        {
            var success = await AssignmentService.InitiateReviewAsync(Assignment.Id, UserName);
            if (success)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = T("notifications.success"),
                    Detail = T("notifications.review-initiated"),
                    Duration = 4000
                });
                await OnActionCompleted.InvokeAsync();
                StateHasChanged(); // Force re-render after assignment is reloaded
            }
        }
        catch (HttpRequestException ex)
        {
            // Show the specific error message from the server
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = T("notifications.cannot-initiate-review"),
                Detail = ex.Message,
                Duration = 6000
            });
        }
        catch (Exception ex)
        {
            // Generic error handler
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = T("notifications.error"),
                Detail = string.Format(T("notifications.unexpected-error"), ex.Message),
                Duration = 6000
            });
        }
        finally
        {
            isProcessing = false;
        }
    }

    private void NavigateToInitialization()
    {
        if (Assignment == null) return;

        // Navigate to initialization page for Assigned state
        var initUrl = $"/assignments/{Assignment.Id}/initialize";
        NavigationManager.NavigateTo(initUrl);
    }

    private void ConfirmEmployeeReview()
    {
        if (Assignment == null) return;

        // Navigate to dedicated employee sign-off page following Phase 1 patterns
        var signOffUrl = $"/questionnaire/{Assignment.Id}/sign-off";
        NavigationManager.NavigateTo(signOffUrl);
    }

    private async Task FinalizeQuestionnaire()
    {
        if (Assignment == null) return;

        // Open dialog to collect optional final notes
        // Pass existing ManagerFinalNotes if reopening (will be shown in dialog)
        var result = await DialogService.OpenAsync<FinalizeQuestionnaireDialog>(
            "Finalize Questionnaire",
            new Dictionary<string, object>
            {
                { "ExistingFinalNotes", Assignment.ManagerFinalNotes }
            },
            new DialogOptions
            {
                Width = "650px",
                Resizable = false,
                Draggable = true
            });

        // If dialog was cancelled, return
        if (result == null)
        {
            return;
        }

        isProcessing = true;
        try
        {
            // Result is the final notes (can be null or empty string)
            var finalNotes = result as string;

            var success = await AssignmentService.FinalizeQuestionnaireAsync(
                Assignment.Id,
                UserName,
                string.IsNullOrWhiteSpace(finalNotes) ? null : finalNotes);

            if (success)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = T("notifications.success"),
                    Detail = T("notifications.questionnaire-finalized"),
                    Duration = 4000
                });
                await OnActionCompleted.InvokeAsync();
                StateHasChanged(); // Force re-render after assignment is reloaded
            }
        }
        catch (HttpRequestException ex)
        {
            // Show the specific error message from the server
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = T("notifications.cannot-finalize-questionnaire"),
                Detail = ex.Message,
                Duration = 6000
            });
        }
        catch (Exception ex)
        {
            // Generic error handler
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = T("notifications.error"),
                Detail = string.Format(T("notifications.unexpected-error"), ex.Message),
                Duration = 6000
            });
        }
        finally
        {
            isProcessing = false;
        }
    }

    private string GetWorkflowIcon()
    {
        if (Assignment == null) return "assignment";

        return Assignment.WorkflowState switch
        {
            WorkflowState.Assigned => "assignment_turned_in",
            WorkflowState.Initialized => "settings",
            WorkflowState.EmployeeInProgress => "edit",
            WorkflowState.ManagerInProgress => "rate_review",
            WorkflowState.BothInProgress => "people",
            WorkflowState.EmployeeSubmitted => "check_circle",
            WorkflowState.ManagerSubmitted => "verified",
            WorkflowState.BothSubmitted => "done_all",
            WorkflowState.InReview => "rate_review",
            WorkflowState.ReviewFinished => "event_available",
            WorkflowState.EmployeeReviewConfirmed => "verified",
            WorkflowState.Finalized => "lock",
            _ => "assignment"
        };
    }

    private string GetWorkflowStatusText()
    {
        if (Assignment == null) return T("workflow-states.unknown");

        return Assignment.WorkflowState switch
        {
            WorkflowState.Assigned => T("workflow-states.assigned-description"),
            WorkflowState.Initialized => T("workflow-states.initialized-description"),
            WorkflowState.EmployeeInProgress => T("workflow-states.employee-in-progress-description"),
            WorkflowState.ManagerInProgress => T("workflow-states.manager-in-progress-description"),
            WorkflowState.BothInProgress => T("workflow-states.both-in-progress-description"),
            WorkflowState.EmployeeSubmitted => T("workflow-states.employee-submitted-description"),
            WorkflowState.ManagerSubmitted => T("workflow-states.manager-submitted-description"),
            WorkflowState.BothSubmitted => T("workflow-states.both-submitted-description"),
            WorkflowState.InReview => T("workflow-states.in-review-description"),
            WorkflowState.ReviewFinished => T("workflow-states.review-finished-description"),
            WorkflowState.EmployeeReviewConfirmed => T("workflow-states.employee-review-confirmed-description"),
            WorkflowState.Finalized => T("workflow-states.finalized-description"),
            _ => T("workflow-states.unknown")
        };
    }
}
