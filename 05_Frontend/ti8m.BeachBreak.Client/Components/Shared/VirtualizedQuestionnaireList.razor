@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Services.Enhanced
@inherits OptimizedComponentBase

<div class="virtualized-list-optimized" style="height: @ContainerHeight; overflow-y: auto;" @onscroll="HandleScroll">
    @if (isLoading)
    {
        <div class="d-flex justify-content-center align-items-center" style="height: 200px;">
            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
            <span class="ms-2">Loading questionnaires...</span>
        </div>
    }
    else
    {
        <div>
            @foreach (var assignment in AllAssignments)
            {
                <div class="mb-3">
                    @RenderQuestionnaireCard(assignment)
                </div>
            }
        </div>

        @if (hasMoreData && !isLoadingMore)
        {
            <!-- Load more trigger (invisible, triggers on scroll) -->
            <div id="load-more-trigger" style="height: 1px;"></div>
        }
    }
</div>

@code {
    [Parameter] public List<QuestionnaireAssignment> AllAssignments { get; set; } = new();
    [Parameter] public string ContainerHeight { get; set; } = "600px";
    [Parameter] public RenderFragment<QuestionnaireAssignment> ItemTemplate { get; set; } = default!;
    [Parameter] public EventCallback<QuestionnaireAssignment> OnItemClick { get; set; }
    [Parameter] public Func<int, int, Task<List<QuestionnaireAssignment>>>? DataLoader { get; set; }

    // Lazy loading state
    private int currentPage = 1;
    private const int pageSize = 50;
    private bool hasMoreData = true;
    private bool isLoadingMore = false;
    private bool isLoading = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            NotifyStateChanged();
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    protected override bool HasStateChanged()
    {
        return HasParameterChanged(nameof(AllAssignments), AllAssignments.Count) ||
               HasParameterChanged(nameof(isLoading), isLoading) ||
               HasParameterChanged(nameof(isLoadingMore), isLoadingMore);
    }


    private async Task HandleScroll(EventArgs e)
    {
        await ExecuteSafelyAsync(async () =>
        {
            // Throttle scroll events to avoid excessive re-renders
            if (await TryNotifyStateChangedThrottled(16)) // ~60fps
            {
                // Check if we need to load more data (simplified check)
                // Load more when we're near the end of the current list
                if (AllAssignments.Count > 0 && hasMoreData && !isLoadingMore && DataLoader != null)
                {
                    await LoadMoreData();
                }
            }
        }, "HandleScroll");
    }

    private async Task LoadMoreData()
    {
        if (isLoadingMore || !hasMoreData || DataLoader == null) return;

        isLoadingMore = true;
        NotifyStateChanged();

        try
        {
            await ExecuteSafelyAsync(async () =>
            {
                var result = await PerformanceOptimizer.LazyLoader.LoadVirtualScrollDataAsync(
                    DataLoader,
                    AllAssignments.Count,
                    pageSize
                );

                if (result.IsSuccess && result.Data.Any())
                {
                    AllAssignments.AddRange(result.Data);
                    hasMoreData = result.Data.Count == pageSize;
                }
                else
                {
                    hasMoreData = false;
                }
            }, "LoadMoreData");
        }
        finally
        {
            isLoadingMore = false;
            NotifyStateChanged();
        }
    }

    private RenderFragment RenderQuestionnaireCard(QuestionnaireAssignment assignment)
    {
        if (ItemTemplate != null)
        {
            return ItemTemplate(assignment);
        }

        return @<div class="card questionnaire-card h-100" @onclick="@(() => OnItemClick.InvokeAsync(assignment))" style="cursor: pointer;">
            <div class="card-body">
                <h6 class="card-title">@(assignment.TemplateId.ToString())</h6>
                <p class="card-text text-muted">Assigned by: @assignment.AssignedBy</p>
                @if (assignment.DueDate.HasValue)
                {
                    <small class="text-muted">Due: @assignment.DueDate.Value.ToString("MMM dd, yyyy")</small>
                }
                <div class="mt-2">
                    <span class="badge @GetStatusBadgeClass(assignment.WorkflowState)">@assignment.WorkflowState</span>
                </div>
            </div>
        </div>;
    }

    private string GetStatusBadgeClass(WorkflowState state)
    {
        return state switch
        {
            WorkflowState.Assigned => "bg-secondary",
            WorkflowState.EmployeeInProgress or WorkflowState.ManagerInProgress or WorkflowState.BothInProgress => "bg-info",
            WorkflowState.Finalized => "bg-success",
            _ => "bg-light text-dark"
        };
    }
}

<style>
.virtualized-list {
    position: relative;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: #cbd5e0 transparent;
}

.virtualized-list::-webkit-scrollbar {
    width: 6px;
}

.virtualized-list::-webkit-scrollbar-track {
    background: transparent;
}

.virtualized-list::-webkit-scrollbar-thumb {
    background: #cbd5e0;
    border-radius: 3px;
}

.virtualized-list::-webkit-scrollbar-thumb:hover {
    background: #a0aec0;
}

.questionnaire-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border: 1px solid #e2e8f0;
}

.questionnaire-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}
</style>