@using Radzen
@using Radzen.Blazor
@using ti8m.BeachBreak.Client.Models
@using ti8m.BeachBreak.Client.Services
@using ti8m.BeachBreak.Client.Services.Enhanced
@using Microsoft.AspNetCore.Components
@using ti8m.BeachBreak.Client.Components.Dialogs
@inject NavigationManager NavigationManager
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject IQuestionnaireAssignmentService AssignmentService
@inject IJSRuntime JSRuntime
@inherits OptimizedComponentBase

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-container mb-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <RadzenText TextStyle="TextStyle.H3" Class="text-primary mb-1">
                            <RadzenIcon Icon="@Configuration.PageIcon" Class="me-2" />
                            @Configuration.PageTitle
                        </RadzenText>
                        <RadzenText TextStyle="TextStyle.Subtitle1" Class="text-muted">
                            @Configuration.PageDescription
                        </RadzenText>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <RadzenBadge BadgeStyle="@GetOverallStatusBadge()" Text="@GetOverallStatusText()" Class="px-3 py-2" />
                        @foreach (var action in Configuration.Actions)
                        {
                            @if (action.IsVisible)
                            {
                                <RadzenButton Text="@action.Text"
                                             Icon="@action.Icon"
                                             ButtonStyle="@GetButtonStyle(action.ButtonStyle)"
                                             Click="@(() => HandleActionClick(action))"
                                             Size="ButtonSize.Medium" />
                            }
                        }
                    </div>
                </div>

                <!-- Stats Cards -->
                <StatsCardGrid Stats="@GetStatsCards()" Columns="@Configuration.StatsConfig.Columns" UseCards="false" />

                <!-- Filter Bar Component -->
                <QuestionnaireFilterBar Configuration="Configuration"
                                       CurrentFilters="filterState"
                                       OnFiltersChanged="ApplyFilters"
                                       OnClearFilters="ClearAllFilters"
                                       OnSearchChanged="OnSearchChanged" />

                <!-- Tab Content -->
                <RadzenTabs @bind-SelectedIndex="SelectedTabIndex">
                    <Tabs>
                        @foreach (var tab in Configuration.Tabs.Where(t => t.IsVisible))
                        {
                            <RadzenTabsItem Text="@tab.Title">
                                @RenderTabContent(tab)
                            </RadzenTabsItem>
                        }
                    </Tabs>
                </RadzenTabs>
            </div>
        </div>
    </div>
</div>

@implements IDisposable

@code {
    [Parameter, EditorRequired] public QuestionnairePageConfiguration Configuration { get; set; } = default!;
    [Parameter, EditorRequired] public IQuestionnaireDataService DataService { get; set; } = default!;
    [Parameter] public EventCallback<QuestionnaireAssignment> OnStartQuestionnaire { get; set; }
    [Parameter] public Func<Guid, bool>? HasProgressChecker { get; set; }

    private List<QuestionnaireAssignment> allAssignments = new();
    private List<EmployeeDto> employees = new();
    private object? additionalData = null;

    // Lazy loading state
    private int currentPage = 1;
    private const int pageSize = 20;
    private bool hasMoreData = true;
    private bool isLoadingMore = false;

    // Centralized filter state managed by QuestionnaireFilterBar component
    private QuestionnaireFilterBar.FilterState filterState = new();
    private int _lastFilterStateHash;

    private bool CheckFilterStateChanged()
    {
        var currentHash = filterState?.GetHashCode() ?? 0;
        if (_lastFilterStateHash != currentHash)
        {
            _lastFilterStateHash = currentHash;
            return true;
        }
        return false;
    }

    // Search debouncing
    private CancellationTokenSource? searchCancellationTokenSource;
    private const int SearchDebounceMs = 300; // Wait 300ms after last keystroke

    // Department expansion state
    private HashSet<Guid> expandedDepartments = new();

    private int _selectedTabIndex = 0;
    private int SelectedTabIndex
    {
        get => _selectedTabIndex;
        set
        {
            if (_selectedTabIndex != value)
            {
                _selectedTabIndex = value;
                // Save tab state immediately
                _ = SaveFilterStateAsync(); // Fire and forget - don't block UI
                StateHasChanged();
            }
        }
    }
    private bool isLoading = false;

    // Team view specific state
    private string teamMemberSortBy = "Name";
    private readonly List<string> teamSortOptions = new() { "Name", "Progress", "Overdue", "Assignments" };
    private List<EmployeeDto> filteredTeamMembers = new();
    private Dictionary<Guid, List<QuestionnaireAssignment>> memberAssignmentsCache = new();

    // Questionnaire view specific state
    private string questionnaireSortBy = "Name";
    private readonly List<string> questionnaireSortOptions = new() { "Name", "Completion", "Overdue", "Assignments" };

    protected override async Task OnInitializedAsync()
    {
        // Load persisted filter state first
        await LoadFilterStateAsync();

        // Then load data with the restored filters
        await LoadData();
    }

    protected override bool HasStateChanged()
    {
        // For filteredTeamMembers, track the actual list to detect order changes during sorting
        // (tracking count alone won't detect sort order changes)
        var filteredMembersIdentity = filteredTeamMembers.Count > 0
            ? string.Join(",", filteredTeamMembers.Select(m => m.Id))
            : "";

        // Track expanded departments state
        var expandedDepartmentsState = expandedDepartments.Count > 0
            ? string.Join(",", expandedDepartments.OrderBy(x => x))
            : "";

        return HasParameterChanged(nameof(allAssignments), allAssignments.Count) ||
               HasParameterChanged(nameof(isLoading), isLoading) ||
               HasParameterChanged(nameof(isLoadingMore), isLoadingMore) ||
               HasParameterChanged(nameof(_selectedTabIndex), _selectedTabIndex) ||
               HasParameterChanged(nameof(filteredTeamMembers), filteredMembersIdentity) ||
               HasParameterChanged(nameof(teamMemberSortBy), teamMemberSortBy) ||
               HasParameterChanged(nameof(memberAssignmentsCache), memberAssignmentsCache.Count) ||
               HasParameterChanged(nameof(expandedDepartments), expandedDepartmentsState) ||
               // Filter state is now managed by QuestionnaireFilterBar component
               CheckFilterStateChanged();
    }

    private async Task LoadData()
    {
        // For employee view, data is already pre-categorized and passed via Configuration
        // No need to reload from API - this prevents overwriting the correct categorization
        if (Configuration != null && Configuration.PageType == QuestionnairePageType.Employee)
        {
            // Just populate allAssignments for backward compatibility with filters
            // Combine all categorized lists
            allAssignments = Configuration.CurrentAssignments
                .Concat(Configuration.UpcomingAssignments)
                .Concat(Configuration.CompletedAssignments)
                .Concat(Configuration.OverdueAssignments)
                .Distinct()
                .ToList();

            return;
        }

        // For Manager/HR views, load data from API as before
        isLoading = true;
        NotifyStateChanged();

        try
        {
            await ExecuteSafelyAsync(async () =>
            {
                // Load ALL data in parallel for Manager/HR views
                // These views need complete data to calculate department/team stats
                var assignmentsTask = DataService.GetAssignmentsAsync();
                var employeesTask = DataService.GetEmployeesAsync();
                var additionalDataTask = DataService.GetAdditionalDataAsync();

                await Task.WhenAll(assignmentsTask, employeesTask, additionalDataTask);

                allAssignments = assignmentsTask.Result;
                employees = employeesTask.Result;
                additionalData = additionalDataTask.Result;

                // Initialize filtered lists after data is loaded
                UpdateFilteredTeamMembers();
            }, "LoadData");
        }
        finally
        {
            isLoading = false;
            NotifyStateChanged();
        }
    }

    private List<StatsCardGrid.StatCard> GetStatsCards()
    {
        return Configuration.StatsConfig.StatCards.Select(config => new StatsCardGrid.StatCard
        {
            Label = config.Label,
            Value = config.ValueCalculator().ToString() ?? "0",
            Icon = config.Icon,
            IconClass = config.IconClass,
            CssClass = config.CssClass
        }).ToList();
    }


    private RenderFragment RenderTabContent(QuestionnairePageTab tab) => __builder =>
    {
        @switch (tab.Type)
        {
            case QuestionnaireTabType.Current:
                @RenderQuestionnaireList(GetCurrentAssignments())
                break;

            case QuestionnaireTabType.Upcoming:
                @RenderQuestionnaireList(GetUpcomingAssignments())
                break;

            case QuestionnaireTabType.Completed:
                @RenderQuestionnaireList(GetCompletedAssignments())
                break;

            case QuestionnaireTabType.Overdue:
                @RenderQuestionnaireList(GetOverdueAssignments())
                break;

            case QuestionnaireTabType.TeamView:
                @RenderTeamView()
                break;

            case QuestionnaireTabType.QuestionnaireView:
                @RenderQuestionnaireView()
                break;

            case QuestionnaireTabType.Analytics:
                @RenderAnalyticsView()
                break;

            case QuestionnaireTabType.DepartmentOverview:
                @RenderDepartmentOverview()
                break;

            case QuestionnaireTabType.EmployeeStatus:
                @RenderEmployeeStatus()
                break;

            case QuestionnaireTabType.QuestionnairePerformance:
                @RenderQuestionnairePerformance()
                break;

            default:
                <div class="text-center p-5">
                    <RadzenText TextStyle="TextStyle.Body1" Class="text-muted">Content for @tab.Title is not yet implemented.</RadzenText>
                </div>
                break;
        }
    };

    private RenderFragment RenderQuestionnaireList(List<QuestionnaireAssignment> assignments) => __builder =>
    {
        @if (isLoading)
        {
            <div class="text-center p-5">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
                <RadzenText TextStyle="TextStyle.Body1" Class="text-muted mt-3">Loading questionnaires...</RadzenText>
            </div>
        }
        else if (!assignments.Any())
        {
            @RenderEnhancedEmptyState("No questionnaires found", GetQuestionnaireEmptyStateMessage(), "quiz", GetQuestionnaireEmptyStateActions())
        }
        else
        {
            <!-- Use VirtualizedQuestionnaireList for high-performance rendering -->
            <VirtualizedQuestionnaireList AllAssignments="@assignments"
                                        ContainerHeight="600px"
                                        OnItemClick="@((assignment) => NavigateToQuestionnaire(assignment))"
                                        DataLoader="@GetAssignmentsPaginated"
                                        ItemTemplate="@RenderQuestionnaireCard" />
        }
    };

    private RenderFragment<QuestionnaireAssignment> RenderQuestionnaireCard => assignment => __builder =>
    {
        var isOverdue = IsOverdue(assignment);
        var dueDateColor = isOverdue ? "var(--rz-danger)" : "var(--rz-text-secondary-color)";
        var dueDateTextColor = isOverdue ? "var(--rz-danger)" : "inherit";

        <RadzenCard Class="@($"questionnaire-card mb-3 {GetCardCssClass(assignment)}")" Style="border-left: 4px solid var(--rz-primary);">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <!-- Questionnaire Title -->
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <RadzenIcon Icon="quiz" Style="color: var(--rz-primary);" />
                        <RadzenText TextStyle="TextStyle.H6" Class="mb-0" Style="font-weight: 600;">
                            @GetTemplateName(assignment)
                        </RadzenText>
                    </div>

                    <!-- Workflow State Badge (if not default) -->
                    @if (assignment.WorkflowState != WorkflowState.Assigned)
                    {
                        <div class="mt-2">
                            <RadzenBadge Text="@WorkflowStateHelper.GetStateDisplayName(assignment.WorkflowState)"
                                        BadgeStyle="BadgeStyle.Light"
                                        Style="@($"font-size: 0.75rem; background-color: {WorkflowStateHelper.GetStateColor(assignment.WorkflowState)}; color: white;")" />
                        </div>
                    }

                    <!-- Assignment Details Grid -->
                    <div class="row g-3 mt-2">
                        <div class="col-md-4">
                            <div class="d-flex align-items-center gap-2">
                                <RadzenIcon Icon="person" Style="font-size: 1rem; color: var(--rz-text-secondary-color);" />
                                <div>
                                    <RadzenText TextStyle="TextStyle.Caption" Class="text-muted mb-0" Style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                        Assigned By
                                    </RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body2" Class="mb-0" Style="font-weight: 500;">
                                        @assignment.AssignedBy
                                    </RadzenText>
                                </div>
                            </div>
                        </div>

                        @if (assignment.DueDate.HasValue)
                        {
                            <div class="col-md-4">
                                <div class="d-flex align-items-center gap-2">
                                    <RadzenIcon Icon="event" Style="@($"font-size: 1rem; color: {dueDateColor};")" />
                                    <div>
                                        <RadzenText TextStyle="TextStyle.Caption" Class="text-muted mb-0" Style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                            Due Date
                                        </RadzenText>
                                        <RadzenText TextStyle="TextStyle.Body2" Class="mb-0" Style="@($"font-weight: 500; color: {dueDateTextColor};")">
                                            @assignment.DueDate.Value.ToString("MMM dd, yyyy")
                                            @if (isOverdue)
                                            {
                                                <span style="font-size: 0.75rem; color: var(--rz-danger);"> (Overdue)</span>
                                            }
                                        </RadzenText>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Action Button -->
                <div class="ms-3">
                    @if (Configuration.PageType == QuestionnairePageType.Employee)
                    {
                        @if (IsQuestionnaireCompleted(assignment))
                        {
                            <RadzenButton Text="VIEW"
                                         Icon="visibility"
                                         ButtonStyle="ButtonStyle.Success"
                                         Size="ButtonSize.Medium"
                                         Style="min-width: 120px; font-weight: 600;"
                                         Click="@(() => NavigateToQuestionnaire(assignment))" />
                        }
                        else if (WorkflowStateHelper.CanEmployeeEdit(assignment))
                        {
                            // Can edit if: Assigned, EmployeeInProgress, BothInProgress, or InReview
                            var hasProgress = assignment.WorkflowState != WorkflowState.Assigned;
                            <RadzenButton Text="@(hasProgress ? "CONTINUE" : "START")"
                                         Icon="@(hasProgress ? "play_circle" : "play_arrow")"
                                         ButtonStyle="ButtonStyle.Primary"
                                         Size="ButtonSize.Medium"
                                         Style="min-width: 120px; font-weight: 600;"
                                         Click="@(() => NavigateToQuestionnaire(assignment))" />
                        }
                        else
                        {
                            // Employee has submitted, waiting for manager or in review confirmation states
                            <RadzenButton Text="VIEW"
                                         Icon="visibility"
                                         ButtonStyle="ButtonStyle.Info"
                                         Size="ButtonSize.Medium"
                                         Style="min-width: 120px; font-weight: 600;"
                                         Disabled="@(!WorkflowStateHelper.CanEmployeeEdit(assignment))"
                                         Click="@(() => NavigateToQuestionnaire(assignment))" />
                        }
                    }
                    else
                    {
                        <RadzenButton Text="DETAILS"
                                     Icon="info"
                                     ButtonStyle="ButtonStyle.Light"
                                     Size="ButtonSize.Medium"
                                     Style="min-width: 120px;"
                                     Click="@(() => ViewAssignmentDetails(assignment))" />
                    }
                </div>
            </div>
        </RadzenCard>
    };

    private RenderFragment RenderTeamView() => __builder =>
    {
        @if (isLoading)
        {
            <div class="text-center p-5">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
                <RadzenText TextStyle="TextStyle.Body1" Class="text-muted mt-3">Loading team data...</RadzenText>
            </div>
        }
        else if (!employees.Any())
        {
            @RenderEnhancedEmptyState("No team members found", GetTeamMembersEmptyStateMessage(), "groups", GetTeamMembersEmptyStateActions())
        }
        else
        {
            <div class="team-view-container">
                <div class="mb-3 d-flex justify-content-between align-items-center">
                    <RadzenText TextStyle="TextStyle.Subtitle1">
                        Showing @filteredTeamMembers.Count of @employees.Count team members
                    </RadzenText>
                    <div class="d-flex align-items-center gap-2">
                        <RadzenText TextStyle="TextStyle.Body2" Class="text-muted mb-0">Sort by:</RadzenText>
                        <RadzenDropDown TValue="string"
                                       Value="@teamMemberSortBy"
                                       Data="@teamSortOptions"
                                       ValueChanged="@OnTeamMemberSortChanged"
                                       Placeholder="Name"
                                       Class="w-auto"
                                       Style="min-width: 150px;" />
                    </div>
                </div>

                @foreach (var member in filteredTeamMembers)
                {
                    var memberAssignments = memberAssignmentsCache.TryGetValue(member.Id, out var assignments)
                        ? assignments
                        : new List<QuestionnaireAssignment>();
                    <TeamMemberCard @key="@member.Id"
                                   TeamMember="@member"
                                   Assignments="@memberAssignments"
                                   OnSendReminder="@HandleSendReminder"
                                   OnAssignmentClick="@HandleAssignmentClick"
                                   OnReopenClick="@HandleReopenAssignment" />
                }
            </div>
        }
    };

    private RenderFragment RenderQuestionnaireView() => __builder =>
    {
        @if (isLoading)
        {
            <div class="text-center p-5">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
                <RadzenText TextStyle="TextStyle.Body1" Class="text-muted mt-3">Loading questionnaire data...</RadzenText>
            </div>
        }
        else if (!allAssignments.Any())
        {
            <div class="text-center p-5">
                <RadzenIcon Icon="quiz" Size="4rem" Class="text-muted mb-3" />
                <RadzenText TextStyle="TextStyle.H5" Class="text-muted mb-2">No questionnaires assigned</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1" Class="text-muted">Questionnaires assigned to your team will appear here.</RadzenText>
            </div>
        }
        else
        {
            <div class="questionnaire-view-container">
                <div class="mb-3 d-flex justify-content-between align-items-center">
                    <RadzenText TextStyle="TextStyle.Subtitle1">
                        Showing @GetGroupedQuestionnaires().Count questionnaire @(GetGroupedQuestionnaires().Count == 1 ? "template" : "templates")
                    </RadzenText>
                    <div class="d-flex align-items-center gap-2">
                        <RadzenText TextStyle="TextStyle.Body2" Class="text-muted mb-0">Sort by:</RadzenText>
                        <RadzenDropDown @bind-Value="questionnaireSortBy"
                                       Data="@questionnaireSortOptions"
                                       Change="@OnQuestionnaireSortChanged"
                                       Placeholder="Name"
                                       Class="w-auto"
                                       Style="min-width: 150px;" />
                    </div>
                </div>

                @foreach (var questionnaireGroup in GetGroupedQuestionnaires())
                {
                    <QuestionnaireTemplateCard TemplateId="@questionnaireGroup.TemplateId"
                                              TemplateName="@questionnaireGroup.TemplateName"
                                              CategoryName="@questionnaireGroup.CategoryName"
                                              Assignments="@questionnaireGroup.Assignments"
                                              OnSendReminders="@HandleSendQuestionnaireReminders"
                                              OnViewAnalytics="@HandleViewQuestionnaireAnalytics"
                                              OnAssignmentClick="@HandleAssignmentClick" />
                }
            </div>
        }
    };

    private RenderFragment RenderAnalyticsView() => __builder =>
    {
        @if (isLoading)
        {
            <div class="text-center p-5">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
                <RadzenText TextStyle="TextStyle.Body1" Class="text-muted mt-3">Loading analytics data...</RadzenText>
            </div>
        }
        else
        {
            <div class="analytics-dashboard">
                <!-- Analytics Header -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <RadzenText TextStyle="TextStyle.H5" Class="mb-1">Analytics & Insights</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Class="text-muted">Comprehensive view of questionnaire performance and trends</RadzenText>
                            </div>
                            <div>
                                <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="@($"Last Updated: {DateTime.Now:MMM dd, HH:mm}")" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Key Metrics Cards Row -->
                <div class="row mb-4">
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="metric-card">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <RadzenText TextStyle="TextStyle.Caption" Class="text-muted mb-1">Overall Completion Rate</RadzenText>
                                    <RadzenText TextStyle="TextStyle.H5" Class="text-success mb-0">@($"{GetOverallCompletionRate():F1}%")</RadzenText>
                                </div>
                                <RadzenIcon Icon="trending_up" Size="2rem" Class="text-success opacity-75" />
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="metric-card">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <RadzenText TextStyle="TextStyle.Caption" Class="text-muted mb-1">Average Response Time</RadzenText>
                                    <RadzenText TextStyle="TextStyle.H5" Class="text-primary mb-0">@($"{GetAverageResponseTime():F1} days")</RadzenText>
                                </div>
                                <RadzenIcon Icon="schedule" Size="2rem" Class="text-primary opacity-75" />
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="metric-card">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <RadzenText TextStyle="TextStyle.Caption" Class="text-muted mb-1">Participation Rate</RadzenText>
                                    <RadzenText TextStyle="TextStyle.H5" Class="text-info mb-0">@($"{GetParticipationRate():F1}%")</RadzenText>
                                </div>
                                <RadzenIcon Icon="people" Size="2rem" Class="text-info opacity-75" />
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="metric-card">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <RadzenText TextStyle="TextStyle.Caption" Class="text-muted mb-1">Overdue Items</RadzenText>
                                    <RadzenText TextStyle="TextStyle.H5" Class="@((GetOverdueCount() > 0 ? "text-danger" : "text-muted") + " mb-0")">@GetOverdueCount()</RadzenText>
                                </div>
                                <RadzenIcon Icon="warning" Size="2rem" Class="@((GetOverdueCount() > 0 ? "text-danger" : "text-muted") + " opacity-75")" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="row mb-4">
                    <!-- Status Distribution Pie Chart -->
                    <div class="col-lg-6 mb-4">
                        <div class="chart-card">
                            <div class="chart-header">
                                <RadzenText TextStyle="TextStyle.H6" Class="mb-3">Assignment Status Distribution</RadzenText>
                            </div>
                            <div class="chart-container">
                                <RadzenChart>
                                    <RadzenDonutSeries Data="@GetStatusDistributionData()" CategoryProperty="Status" ValueProperty="Count">
                                        <RadzenSeriesDataLabels Visible="true" />
                                    </RadzenDonutSeries>
                                </RadzenChart>
                            </div>
                        </div>
                    </div>

                    <!-- Department Performance Bar Chart -->
                    <div class="col-lg-6 mb-4">
                        <div class="chart-card">
                            <div class="chart-header">
                                <RadzenText TextStyle="TextStyle.H6" Class="mb-3">Department Performance Comparison</RadzenText>
                            </div>
                            <div class="chart-container">
                                <RadzenChart>
                                    <RadzenColumnSeries Data="@GetDepartmentPerformanceData()" CategoryProperty="Department" ValueProperty="CompletionRate">
                                        <RadzenSeriesDataLabels Visible="true" />
                                    </RadzenColumnSeries>
                                    <RadzenCategoryAxis Padding="20" />
                                    <RadzenValueAxis>
                                        <RadzenGridLines Visible="true" />
                                        <RadzenAxisTitle Text="Completion Rate %" />
                                    </RadzenValueAxis>
                                </RadzenChart>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Template Performance & Trends Row -->
                <div class="row mb-4">
                    <!-- Template Popularity -->
                    <div class="col-lg-8 mb-4">
                        <div class="chart-card">
                            <div class="chart-header">
                                <RadzenText TextStyle="TextStyle.H6" Class="mb-3">Questionnaire Template Performance</RadzenText>
                            </div>
                            <div class="table-responsive">
                                <RadzenDataGrid Data="@GetTemplatePerformanceData()"
                                               TItem="TemplatePerformanceData"
                                               AllowSorting="true"
                                               GridLines="DataGridGridLines.Both"
                                               PageSize="10"
                                               AllowPaging="true">
                                    <Columns>
                                        <RadzenDataGridColumn TItem="TemplatePerformanceData" Property="TemplateName" Title="Template" Width="200px">
                                            <Template Context="template">
                                                <div>
                                                    <div class="fw-semibold">@template.TemplateName</div>
                                                    <div class="text-muted small">@template.CategoryName</div>
                                                </div>
                                            </Template>
                                        </RadzenDataGridColumn>
                                        <RadzenDataGridColumn TItem="TemplatePerformanceData" Property="TotalAssignments" Title="Assignments" Width="100px" TextAlign="TextAlign.Center" />
                                        <RadzenDataGridColumn TItem="TemplatePerformanceData" Property="CompletedCount" Title="Completed" Width="100px" TextAlign="TextAlign.Center">
                                            <Template Context="template">
                                                <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="@template.CompletedCount.ToString()" />
                                            </Template>
                                        </RadzenDataGridColumn>
                                        <RadzenDataGridColumn TItem="TemplatePerformanceData" Property="CompletionRate" Title="Rate" Width="100px" TextAlign="TextAlign.Center">
                                            <Template Context="template">
                                                <div class="d-flex align-items-center justify-content-center gap-2">
                                                    <RadzenProgressBarCircular Size="ProgressBarCircularSize.Small" Value="@template.CompletionRate" ShowValue="false" />
                                                    <span class="small fw-semibold">@($"{template.CompletionRate:F1}%")</span>
                                                </div>
                                            </Template>
                                        </RadzenDataGridColumn>
                                        <RadzenDataGridColumn TItem="TemplatePerformanceData" Property="AverageResponseTime" Title="Avg Response" Width="120px" TextAlign="TextAlign.Center">
                                            <Template Context="template">
                                                <span class="small">@($"{template.AverageResponseTime:F1} days")</span>
                                            </Template>
                                        </RadzenDataGridColumn>
                                    </Columns>
                                </RadzenDataGrid>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="col-lg-4 mb-4">
                        <div class="chart-card">
                            <div class="chart-header">
                                <RadzenText TextStyle="TextStyle.H6" Class="mb-3">Quick Insights</RadzenText>
                            </div>
                            <div class="quick-stats">
                                <div class="stat-item mb-3 p-3 border-start border-primary border-4">
                                    <div class="d-flex align-items-center mb-2">
                                        <RadzenIcon Icon="star" Class="text-warning me-2" />
                                        <RadzenText TextStyle="TextStyle.Subtitle2" Class="mb-0">Top Performer</RadzenText>
                                    </div>
                                    <RadzenText TextStyle="TextStyle.Body2" Class="text-muted">@GetTopPerformingDepartment()</RadzenText>
                                </div>
                                <div class="stat-item mb-3 p-3 border-start border-success border-4">
                                    <div class="d-flex align-items-center mb-2">
                                        <RadzenIcon Icon="speed" Class="text-success me-2" />
                                        <RadzenText TextStyle="TextStyle.Subtitle2" Class="mb-0">Fastest Response</RadzenText>
                                    </div>
                                    <RadzenText TextStyle="TextStyle.Body2" Class="text-muted">@GetFastestTemplate()</RadzenText>
                                </div>
                                <div class="stat-item mb-3 p-3 border-start border-info border-4">
                                    <div class="d-flex align-items-center mb-2">
                                        <RadzenIcon Icon="trending_up" Class="text-info me-2" />
                                        <RadzenText TextStyle="TextStyle.Subtitle2" Class="mb-0">Most Popular</RadzenText>
                                    </div>
                                    <RadzenText TextStyle="TextStyle.Body2" Class="text-muted">@GetMostPopularTemplate()</RadzenText>
                                </div>
                                <div class="stat-item p-3 border-start border-warning border-4">
                                    <div class="d-flex align-items-center mb-2">
                                        <RadzenIcon Icon="schedule" Class="text-warning me-2" />
                                        <RadzenText TextStyle="TextStyle.Subtitle2" Class="mb-0">Attention Needed</RadzenText>
                                    </div>
                                    <RadzenText TextStyle="TextStyle.Body2" Class="text-muted">@GetAttentionNeededCount() overdue items</RadzenText>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <style>
                .analytics-dashboard {
                    padding: 1rem 0;
                }

                .metric-card, .chart-card {
                    background: white;
                    border-radius: 8px;
                    padding: 1.5rem;
                    border: 1px solid #e2e8f0;
                    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                    height: 100%;
                }

                .metric-card {
                    transition: transform 0.2s ease;
                }

                .metric-card:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                }

                .chart-header {
                    border-bottom: 1px solid #f1f5f9;
                    margin-bottom: 1rem;
                    padding-bottom: 0.75rem;
                }

                .chart-container {
                    height: 300px;
                }

                .quick-stats .stat-item {
                    background: #f8fafc;
                    border-radius: 6px;
                    transition: background-color 0.2s ease;
                }

                .quick-stats .stat-item:hover {
                    background: #f1f5f9;
                }

                @@media (max-width: 768px) {
                    .metric-card, .chart-card {
                        margin-bottom: 1rem;
                    }

                    .chart-container {
                        height: 250px;
                    }
                }
            </style>
        }
    };

    private RenderFragment RenderDepartmentOverview() => __builder =>
    {
        @if (isLoading)
        {
            <div class="text-center p-5">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
                <RadzenText TextStyle="TextStyle.Body1" Class="text-muted mt-3">Loading department data...</RadzenText>
            </div>
        }
        else
        {
            var departmentGroups = GetDepartmentGroups();

            @if (!departmentGroups.Any())
            {
                @RenderEnhancedEmptyState("No departments found", GetDepartmentsEmptyStateMessage(), "corporate_fare", GetDepartmentsEmptyStateActions())
            }
            else
            {
                <div class="department-overview-container">
                    @foreach (var dept in departmentGroups)
                    {
                        <div class="department-container rz-background-color-base-100 rz-p-4 rz-mb-4 rz-border-radius-3" style="border: 1px solid var(--rz-base-300);">
                            <!-- Department Header -->
                            <div class="d-flex justify-content-between align-items-start mb-3 pb-3 border-bottom">
                                <div>
                                    <RadzenText TextStyle="TextStyle.H5" Class="text-primary mb-2">
                                        <RadzenIcon Icon="corporate_fare" Class="me-2" />
                                        @dept.OrganizationName
                                    </RadzenText>
                                    <RadzenText TextStyle="TextStyle.Subtitle2" Class="text-muted">
                                        @dept.EmployeeCount team @(dept.EmployeeCount == 1 ? "member" : "members") â€¢ @dept.TotalAssignments @(dept.TotalAssignments == 1 ? "assignment" : "assignments")
                                    </RadzenText>
                                </div>
                                <div class="d-flex flex-wrap gap-2 align-items-center">
                                    <RadzenBadge Text="@($"{dept.CompletedCount}/{dept.TotalAssignments}")"
                                                BadgeStyle="BadgeStyle.Success"
                                                Class="px-2 py-1" />
                                    @if (dept.InProgressCount > 0)
                                    {
                                        <RadzenBadge Text="@($"{dept.InProgressCount} in progress")"
                                                    BadgeStyle="BadgeStyle.Info"
                                                    Class="px-2 py-1" />
                                    }
                                    @if (dept.OverdueCount > 0)
                                    {
                                        <RadzenBadge Text="@($"{dept.OverdueCount} overdue")"
                                                    BadgeStyle="BadgeStyle.Danger"
                                                    Class="px-2 py-1" />
                                    }
                                    @if (dept.NotStartedCount > 0)
                                    {
                                        <RadzenBadge Text="@($"{dept.NotStartedCount} not started")"
                                                    BadgeStyle="BadgeStyle.Light"
                                                    Class="px-2 py-1" />
                                    }
                                </div>
                            </div>

                            <!-- Department Team Members -->
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <RadzenText TextStyle="TextStyle.Subtitle2" Class="text-primary mb-0">Team Members</RadzenText>
                                @if (dept.Members.Count > 5)
                                {
                                    <RadzenButton Text="@(expandedDepartments.Contains(dept.OrganizationId) ? "Show Less" : $"Show All ({dept.Members.Count})")"
                                                 Icon="@(expandedDepartments.Contains(dept.OrganizationId) ? "expand_less" : "expand_more")"
                                                 ButtonStyle="ButtonStyle.Light"
                                                 Size="ButtonSize.Small"
                                                 Click="@(() => ToggleDepartmentExpansion(dept.OrganizationId))" />
                                }
                            </div>
                            @{
                                var membersToShow = expandedDepartments.Contains(dept.OrganizationId)
                                    ? dept.Members
                                    : dept.Members.Take(5);
                            }
                            @foreach (var member in membersToShow)
                            {
                                var memberAssignments = memberAssignmentsCache.TryGetValue(member.Id, out var assignments)
                                    ? assignments
                                    : dept.Assignments.Where(a => a.EmployeeId == member.Id).ToList();
                                <TeamMemberCard @key="@member.Id"
                                               TeamMember="@member"
                                               Assignments="@memberAssignments"
                                               OnSendReminder="@HandleSendReminder"
                                               OnAssignmentClick="@HandleAssignmentClick" />
                            }
                            @if (dept.Members.Count > 5 && !expandedDepartments.Contains(dept.OrganizationId))
                            {
                                <div class="text-center p-3 border rounded bg-light">
                                    <RadzenText TextStyle="TextStyle.Body2" Class="text-muted mb-0">
                                        <RadzenIcon Icon="expand_more" Style="font-size: 1.25rem;" Class="me-1" />
                                        +@(dept.Members.Count - 5) more team member@(dept.Members.Count - 5 == 1 ? "" : "s")
                                    </RadzenText>
                                    <RadzenText TextStyle="TextStyle.Caption" Class="text-muted">
                                        Click "Show All" button above to view all members
                                    </RadzenText>
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        }
    };

    private RenderFragment RenderEmployeeStatus() => __builder =>
    {
        @if (isLoading)
        {
            <div class="text-center p-5">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
                <RadzenText TextStyle="TextStyle.Body1" Class="text-muted mt-3">Loading employee data...</RadzenText>
            </div>
        }
        else if (!employees.Any())
        {
            @RenderEnhancedEmptyState("No employees found", GetEmployeesEmptyStateMessage(), "people", GetEmployeesEmptyStateActions())
        }
        else
        {
            <div class="employee-status-container">
                <div class="mb-3 d-flex justify-content-between align-items-center">
                    <RadzenText TextStyle="TextStyle.Subtitle1">
                        Showing @filteredTeamMembers.Count of @employees.Count employees
                    </RadzenText>
                </div>

                <div class="employee-status-grid">
                    <RadzenDataGrid @ref="employeeDataGrid"
                                   Data="@GetEmployeeStatusData()"
                                   TItem="EmployeeStatusRow"
                                   AllowSorting="true"
                                   AllowFiltering="false"
                                   GridLines="DataGridGridLines.Both"
                                   Class="mt-3"
                                   EmptyText="No employees found"
                                   PageSize="25"
                                   AllowPaging="true"
                                   ShowPagingSummary="true"
                                   PagingSummaryFormat="Displaying {0} - {1} of {2} employees">
                        <Columns>
                            <RadzenDataGridColumn TItem="EmployeeStatusRow" Property="EmployeeName" Title="Employee">
                                <Template Context="employee">
                                    <div class="d-flex align-items-center">
                                        <div class="me-2">
                                            <RadzenIcon Icon="person" Size="1.2rem" Class="text-primary" />
                                        </div>
                                        <div>
                                            <div class="fw-semibold">@employee.EmployeeName</div>
                                            <div class="text-muted small">@employee.Email</div>
                                        </div>
                                    </div>
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="EmployeeStatusRow" Property="Department" Title="Department" Width="150px">
                                <Template Context="employee">
                                    <RadzenBadge BadgeStyle="BadgeStyle.Light" Text="@employee.Department" Class="text-primary" />
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="EmployeeStatusRow" Property="Role" Title="Role" Width="120px">
                                <Template Context="employee">
                                    <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text="@employee.Role" />
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="EmployeeStatusRow" Property="TotalAssignments" Title="Total" Width="80px" TextAlign="TextAlign.Center">
                                <Template Context="employee">
                                    <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="@employee.TotalAssignments.ToString()" />
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="EmployeeStatusRow" Property="CompletedAssignments" Title="Completed" Width="100px" TextAlign="TextAlign.Center">
                                <Template Context="employee">
                                    <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="@employee.CompletedAssignments.ToString()" />
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="EmployeeStatusRow" Property="PendingAssignments" Title="Pending" Width="90px" TextAlign="TextAlign.Center">
                                <Template Context="employee">
                                    <RadzenBadge BadgeStyle="BadgeStyle.Warning" Text="@employee.PendingAssignments.ToString()" />
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="EmployeeStatusRow" Property="OverdueAssignments" Title="Overdue" Width="90px" TextAlign="TextAlign.Center">
                                <Template Context="employee">
                                    @if (employee.OverdueAssignments > 0)
                                    {
                                        <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="@employee.OverdueAssignments.ToString()" />
                                    }
                                    else
                                    {
                                        <span class="text-muted">0</span>
                                    }
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="EmployeeStatusRow" Property="CompletionPercentage" Title="Progress" Width="120px">
                                <Template Context="employee">
                                    <div class="d-flex align-items-center gap-2">
                                        <RadzenProgressBarCircular Size="ProgressBarCircularSize.Small"
                                                                 Value="@employee.CompletionPercentage"
                                                                 ShowValue="false" />
                                        <span class="small fw-semibold">@($"{employee.CompletionPercentage:F0}%")</span>
                                    </div>
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="EmployeeStatusRow" Property="LastActivity" Title="Last Activity" Width="130px">
                                <Template Context="employee">
                                    @if (employee.LastActivity.HasValue)
                                    {
                                        <div class="small">
                                            <div>@employee.LastActivity.Value.ToString("MMM dd, yyyy")</div>
                                            <div class="text-muted">@employee.LastActivity.Value.ToString("HH:mm")</div>
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="text-muted small">No activity</span>
                                    }
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="EmployeeStatusRow" Property="Actions" Title="Actions" Width="120px" Sortable="false">
                                <Template Context="employee">
                                    <div class="d-flex gap-1">
                                        @if (employee.TotalAssignments > 0)
                                        {
                                            <RadzenButton Size="ButtonSize.Small"
                                                        ButtonStyle="ButtonStyle.Light"
                                                        Icon="visibility"
                                                        Click="@(() => HandleViewEmployeeDetails(employee.EmployeeId))"
                                                        Title="View assignments" />
                                        }
                                        @if (employee.PendingAssignments > 0)
                                        {
                                            <RadzenButton Size="ButtonSize.Small"
                                                        ButtonStyle="ButtonStyle.Primary"
                                                        Icon="send"
                                                        Click="@(() => HandleSendEmployeeReminder(employee.EmployeeId))"
                                                        Title="Send reminder" />
                                        }
                                    </div>
                                </Template>
                            </RadzenDataGridColumn>
                        </Columns>
                    </RadzenDataGrid>
                </div>
            </div>
        }
    };

    private RenderFragment RenderQuestionnairePerformance() => __builder =>
    {
        @if (isLoading)
        {
            <div class="text-center p-5">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
                <RadzenText TextStyle="TextStyle.Body1" Class="text-muted mt-3">Loading questionnaire data...</RadzenText>
            </div>
        }
        else if (!allAssignments.Any())
        {
            <div class="text-center p-5">
                <RadzenIcon Icon="quiz" Size="4rem" Class="text-muted mb-3" />
                <RadzenText TextStyle="TextStyle.H5" Class="text-muted mb-2">No questionnaires assigned</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1" Class="text-muted">Questionnaire assignments will appear here once available.</RadzenText>
            </div>
        }
        else
        {
            <div class="questionnaire-performance-container">
                <div class="mb-3 d-flex justify-content-between align-items-center">
                    <RadzenText TextStyle="TextStyle.Subtitle1">
                        Showing @GetGroupedQuestionnaires().Count questionnaire @(GetGroupedQuestionnaires().Count == 1 ? "template" : "templates")
                    </RadzenText>
                    <div class="d-flex align-items-center gap-2">
                        <RadzenText TextStyle="TextStyle.Body2" Class="text-muted mb-0">Sort by:</RadzenText>
                        <RadzenDropDown @bind-Value="questionnaireSortBy"
                                       Data="@questionnaireSortOptions"
                                       Change="@OnQuestionnaireSortChanged"
                                       Placeholder="Name"
                                       Class="w-auto"
                                       Style="min-width: 150px;" />
                    </div>
                </div>

                @foreach (var questionnaireGroup in GetGroupedQuestionnaires())
                {
                    <QuestionnaireTemplateCard TemplateId="@questionnaireGroup.TemplateId"
                                              TemplateName="@questionnaireGroup.TemplateName"
                                              CategoryName="@questionnaireGroup.CategoryName"
                                              Assignments="@questionnaireGroup.Assignments"
                                              OnSendReminders="@HandleSendQuestionnaireReminders"
                                              OnViewAnalytics="@HandleViewQuestionnaireAnalytics"
                                              OnAssignmentClick="@HandleAssignmentClick" />
                }
            </div>
        }
    };

    // Filter and data manipulation methods
    private List<QuestionnaireAssignment> GetCurrentAssignments()
    {
        // For employee view, use pre-categorized lists (they've already been filtered correctly)
        // For manager/HR views, use allAssignments with fallback filtering
        var baseAssignments = Configuration.PageType == QuestionnairePageType.Employee
            ? Configuration.CurrentAssignments
            : allAssignments.Where(a => a.WorkflowState != WorkflowState.Finalized).ToList();

        return ApplyFilteringToAssignments(baseAssignments);
    }

    private List<QuestionnaireAssignment> GetUpcomingAssignments()
    {
        // For employee view, use pre-categorized lists (they've already been filtered correctly)
        // For manager/HR views, use allAssignments with fallback filtering
        var baseAssignments = Configuration.PageType == QuestionnairePageType.Employee
            ? Configuration.UpcomingAssignments
            : allAssignments.Where(a =>
                a.WorkflowState == WorkflowState.Assigned &&
                a.AssignedDate > DateTime.Now.AddDays(-1)).ToList();
        return ApplyFilteringToAssignments(baseAssignments);
    }

    private List<QuestionnaireAssignment> GetCompletedAssignments()
    {
        // For employee view, use pre-categorized lists (they've already been filtered correctly)
        // For manager/HR views, use allAssignments with fallback filtering
        var baseAssignments = Configuration.PageType == QuestionnairePageType.Employee
            ? Configuration.CompletedAssignments
            : allAssignments.Where(a => a.WorkflowState == WorkflowState.Finalized).ToList();

        return ApplyFilteringToAssignments(baseAssignments);
    }

    private List<QuestionnaireAssignment> GetOverdueAssignments()
    {
        // For employee view, use pre-categorized lists (they've already been filtered correctly)
        // For manager/HR views, use allAssignments with fallback filtering
        var baseAssignments = Configuration.PageType == QuestionnairePageType.Employee
            ? Configuration.OverdueAssignments
            : allAssignments.Where(a =>
                a.DueDate.HasValue &&
                a.DueDate.Value < DateTime.Now &&
                a.WorkflowState != WorkflowState.Finalized).ToList();
        return ApplyFilteringToAssignments(baseAssignments);
    }

    // UI Helper methods
    private string GetCardCssClass(QuestionnaireAssignment assignment)
    {
        if (assignment.DueDate.HasValue && assignment.DueDate.Value < DateTime.Now && assignment.WorkflowState != WorkflowState.Finalized)
            return "overdue-card";

        return assignment.WorkflowState switch
        {
            WorkflowState.EmployeeInProgress or WorkflowState.ManagerInProgress or WorkflowState.BothInProgress => "inprogress-card",
            WorkflowState.Finalized => "completed-card",
            _ => "assigned-card"
        };
    }

    private bool IsOverdue(QuestionnaireAssignment assignment)
    {
        return assignment.DueDate.HasValue &&
               assignment.DueDate.Value < DateTime.Now &&
               assignment.WorkflowState != WorkflowState.Finalized;
    }

    private ButtonStyle GetButtonStyle(string buttonStyle)
    {
        return buttonStyle switch
        {
            "ButtonStyle.Primary" => ButtonStyle.Primary,
            "ButtonStyle.Info" => ButtonStyle.Info,
            "ButtonStyle.Light" => ButtonStyle.Light,
            _ => ButtonStyle.Light
        };
    }

    private BadgeStyle GetOverallStatusBadge()
    {
        var overdueCount = GetOverdueAssignments().Count;
        return overdueCount > 0 ? BadgeStyle.Danger : BadgeStyle.Success;
    }

    private string GetOverallStatusText()
    {
        var overdueCount = GetOverdueAssignments().Count;
        return overdueCount > 0 ? $"{overdueCount} Overdue" : "On Track";
    }

    // Event handlers
    private async Task HandleActionClick(QuestionnairePageAction action)
    {
        if (action.OnClick != null)
        {
            await action.OnClick.Invoke();
        }
        else
        {
            // Default implementations
            switch (action.Id)
            {
                case "refresh":
                    await LoadData();
                    break;
                case "export":
                    ShowInfo("Export functionality would be implemented here");
                    break;
                case "analytics":
                    ShowInfo("Analytics dashboard would be implemented here");
                    break;
            }
        }
    }

    private async Task LoadMoreData()
    {
        if (isLoadingMore || !hasMoreData) return;

        isLoadingMore = true;
        NotifyStateChanged();

        try
        {
            await ExecuteSafelyAsync(async () =>
            {
                var pagedResult = await PerformanceOptimizer.LazyLoader.LoadPagedDataAsync(
                    async (page, size) => await GetAssignmentsPaginated(page, size),
                    currentPage + 1,
                    pageSize,
                    async () => await GetAssignmentsTotalCount()
                );

                if (pagedResult.IsSuccess)
                {
                    allAssignments.AddRange(pagedResult.Data);
                    hasMoreData = pagedResult.HasNextPage;
                    currentPage++;
                }
            }, "LoadMoreData");
        }
        finally
        {
            isLoadingMore = false;
            NotifyStateChanged();
        }
    }


    private void ClearSearch()
    {
        filterState.SearchFilter = "";
        ApplyFilters();
        StateHasChanged();
    }

    private void ToggleDepartmentExpansion(Guid departmentId)
    {
        if (expandedDepartments.Contains(departmentId))
        {
            expandedDepartments.Remove(departmentId);
        }
        else
        {
            expandedDepartments.Add(departmentId);
        }

        // Force state update
        NotifyStateChanged();
    }


    private void ApplyFilters()
    {
        // Recompute filtered/sorted lists when filters change
        UpdateFilteredTeamMembers();

        // Save filter state to localStorage
        _ = SaveFilterStateAsync(); // Fire and forget - don't block UI

        // Force immediate synchronous state change
        StateHasChanged();
    }

    private void UpdateFilteredTeamMembers()
    {
        filteredTeamMembers = ComputeFilteredTeamMembers();

        // Pre-compute assignments for all filtered members
        memberAssignmentsCache.Clear();
        foreach (var member in filteredTeamMembers)
        {
            var assignments = GetFilteredAssignmentsForMember(member);
            memberAssignmentsCache[member.Id] = assignments;
        }
    }

    private List<EmployeeDto> ComputeFilteredTeamMembers()
    {
        var filteredMembers = employees.AsEnumerable();

        // Apply search filter
        if (!string.IsNullOrEmpty(filterState.SearchFilter))
        {
            filteredMembers = filteredMembers.Where(e =>
                $"{e.FirstName} {e.LastName}".Contains(filterState.SearchFilter, StringComparison.OrdinalIgnoreCase) ||
                e.EMail.Contains(filterState.SearchFilter, StringComparison.OrdinalIgnoreCase));
        }

        // Apply department filter
        if (filterState.DepartmentFilter.Any())
        {
            var selectedOrgNumbers = filterState.DepartmentFilter.Select(ExtractOrganizationNumber).Where(x => x.HasValue).Select(x => x!.Value).ToList();
            if (selectedOrgNumbers.Any())
            {
                filteredMembers = filteredMembers.Where(e => selectedOrgNumbers.Contains(e.OrganizationNumber));
            }
        }


        // Apply sorting
        var sortedMembers = teamMemberSortBy switch
        {
            "Name" => filteredMembers.OrderBy(e => e.LastName).ThenBy(e => e.FirstName),
            "Progress" => filteredMembers.OrderByDescending(e => GetMemberProgressPercentage(e)),
            "Overdue" => filteredMembers.OrderByDescending(e => GetMemberOverdueCount(e)),
            "Assignments" => filteredMembers.OrderByDescending(e => GetMemberAssignmentCount(e)),
            _ => filteredMembers.OrderBy(e => e.LastName)
        };

        return sortedMembers.ToList();
    }

    private List<QuestionnaireAssignment> ApplyFilteringToAssignments(List<QuestionnaireAssignment> assignments)
    {
        var filteredAssignments = assignments.AsEnumerable();

        // Apply search filter
        if (!string.IsNullOrEmpty(filterState.SearchFilter))
        {
            filteredAssignments = filteredAssignments.Where(a =>
                a.EmployeeName.Contains(filterState.SearchFilter, StringComparison.OrdinalIgnoreCase) ||
                GetTemplateName(a).Contains(filterState.SearchFilter, StringComparison.OrdinalIgnoreCase));
        }

        // Apply department filter (organization-based)
        if (filterState.DepartmentFilter.Any())
        {
            // Parse the selected organizations from "Number - Name" format
            var selectedOrgNumbers = filterState.DepartmentFilter.Select(ExtractOrganizationNumber).Where(x => x.HasValue).Select(x => x!.Value).ToList();
            if (selectedOrgNumbers.Any())
            {
                // Get employee IDs that belong to the selected organizations
                var employeeIdsInOrganizations = employees
                    .Where(e => selectedOrgNumbers.Contains(e.OrganizationNumber))
                    .Select(e => e.Id)
                    .ToHashSet();

                filteredAssignments = filteredAssignments.Where(a =>
                    employeeIdsInOrganizations.Contains(a.EmployeeId));
            }
        }

        // Apply category filter
        if (filterState.CategoryFilter.Any())
        {
            // Get category options from configuration
            var categoryFilterConfig = Configuration.Filters.FirstOrDefault(f => f.Type == QuestionnaireFilterType.Category);
            if (categoryFilterConfig?.CategoryOptions != null)
            {
                // Create lookup from category name to category ID
                var categoryLookup = categoryFilterConfig.CategoryOptions.ToDictionary(c => c.NameEn, c => c.Id);

                // Get the category IDs for the selected category names
                var selectedCategoryIds = filterState.CategoryFilter
                    .Where(categoryName => categoryLookup.ContainsKey(categoryName))
                    .Select(categoryName => categoryLookup[categoryName])
                    .ToHashSet();

                filteredAssignments = filteredAssignments.Where(a =>
                    a.TemplateCategoryId.HasValue &&
                    selectedCategoryIds.Contains(a.TemplateCategoryId.Value));
            }
        }

        // Apply template filter
        if (filterState.TemplateFilter.Any())
        {
            filteredAssignments = filteredAssignments.Where(a =>
                filterState.TemplateFilter.Contains(a.TemplateId));
        }

        // Apply status filter
        if (filterState.StatusFilters.Any())
        {
            filteredAssignments = filteredAssignments.Where(a =>
                filterState.StatusFilters.Contains(a.WorkflowState.ToString()));
        }

        // Apply date range filter
        if (filterState.DateRangeFrom.HasValue)
        {
            filteredAssignments = filteredAssignments.Where(a =>
                a.DueDate.HasValue && a.DueDate.Value >= filterState.DateRangeFrom.Value);
        }
        if (filterState.DateRangeTo.HasValue)
        {
            filteredAssignments = filteredAssignments.Where(a =>
                a.DueDate.HasValue && a.DueDate.Value <= filterState.DateRangeTo.Value);
        }

        return filteredAssignments.ToList();
    }

    private int? ExtractOrganizationNumber(string organizationFilter)
    {
        // Parse organization number from "Number - Name" format
        var dashIndex = organizationFilter.IndexOf(" - ");
        if (dashIndex > 0)
        {
            var numberPart = organizationFilter.Substring(0, dashIndex);
            if (int.TryParse(numberPart, out var orgNumber))
            {
                return orgNumber;
            }
        }
        return null;
    }


    private async Task NavigateToQuestionnaire(QuestionnaireAssignment assignment)
    {
        if (OnStartQuestionnaire.HasDelegate)
        {
            await OnStartQuestionnaire.InvokeAsync(assignment);
        }
        else
        {
            // Use new assignment-based route
            NavigationManager.NavigateTo($"/questionnaire/{assignment.Id}");
        }
    }

    private async Task ViewResults(QuestionnaireAssignment assignment)
    {
        ShowInfo("Results view would be implemented here");
    }

    private async Task ViewAssignmentDetails(QuestionnaireAssignment assignment)
    {
        ShowInfo("Assignment details would be implemented here");
    }

    private string GetTemplateName(QuestionnaireAssignment assignment)
    {
        // Use denormalized template name from assignment
        return !string.IsNullOrWhiteSpace(assignment.TemplateName)
            ? assignment.TemplateName
            : "Questionnaire";
    }

    // Helper methods that were in BasePageComponent
    private void NavigateToPage(string url)
    {
        NavigationManager.NavigateTo(url);
    }

    private async Task HandleAssignmentClick(Guid assignmentId)
    {
        NavigationManager.NavigateTo($"/questionnaire/{assignmentId}");
    }

    private void ShowInfo(string message)
    {
        // Info notification would be implemented here
        Console.WriteLine($"Info: {message}");
    }

    private bool IsQuestionnaireCompleted(QuestionnaireAssignment assignment)
    {
        if (assignment == null) return false;

        // For employees: questionnaire is "completed" (read-only VIEW button) when:
        // - Employee has submitted (EmployeeSubmitted, BothSubmitted)
        // - In review phase (InReview, EmployeeReviewConfirmed, ManagerReviewConfirmed)
        // - Finalized
        return assignment.WorkflowState is WorkflowState.EmployeeSubmitted or WorkflowState.BothSubmitted
            or WorkflowState.InReview or WorkflowState.EmployeeReviewConfirmed or WorkflowState.ManagerReviewConfirmed
            or WorkflowState.Finalized;
    }

    private async Task<List<QuestionnaireAssignment>> GetAssignmentsPaginated(int page, int size)
    {
        // Simulate paginated data loading
        var assignments = await DataService.GetAssignmentsAsync();
        return assignments.Skip((page - 1) * size).Take(size).ToList();
    }

    private async Task<int> GetAssignmentsTotalCount()
    {
        // Simulate total count
        var assignments = await DataService.GetAssignmentsAsync();
        return assignments.Count;
    }

    // Team view helper methods

    private List<QuestionnaireAssignment> GetFilteredAssignmentsForMember(EmployeeDto member)
    {
        // Get all assignments for this member and apply all filters
        var memberAssignments = allAssignments
            .Where(a => a.EmployeeId.ToString() == member.Id.ToString())
            .ToList();

        // Apply all advanced filters using the centralized filtering method
        return ApplyFilteringToAssignments(memberAssignments);
    }

    private int GetMemberAssignmentCount(EmployeeDto member)
    {
        return allAssignments.Count(a => a.EmployeeId.ToString() == member.Id.ToString());
    }

    private int GetMemberOverdueCount(EmployeeDto member)
    {
        return allAssignments.Count(a =>
            a.EmployeeId.ToString() == member.Id.ToString() &&
            a.DueDate.HasValue &&
            a.DueDate.Value < DateTime.Now &&
            a.WorkflowState != WorkflowState.Finalized);
    }

    private double GetMemberProgressPercentage(EmployeeDto member)
    {
        var memberAssignments = allAssignments.Where(a => a.EmployeeId.ToString() == member.Id.ToString()).ToList();
        if (!memberAssignments.Any()) return 0;

        var completed = memberAssignments.Count(a => a.WorkflowState == WorkflowState.Finalized);
        return (double)completed / memberAssignments.Count * 100;
    }

    private async Task HandleSendReminder(EmployeeDto member)
    {
        ShowInfo($"Sending reminder to {member.FirstName} {member.LastName}...");
        // TODO: Implement actual reminder sending logic
    }

    private async Task HandleReopenAssignment(QuestionnaireAssignment assignment)
    {
        try
        {
            // Open the reopen dialog
            var result = await DialogService.OpenAsync<ReopenQuestionnaireDialog>(
                "Reopen Questionnaire",
                new Dictionary<string, object>
                {
                    { "Assignment", assignment }
                },
                new DialogOptions
                {
                    Width = "700px",
                    Height = "auto",
                    Resizable = true,
                    Draggable = true
                });

            if (result is ReopenQuestionnaireDialog.ReopenQuestionnaireResult reopenResult)
            {
                // Call the API to reopen
                var success = await AssignmentService.ReopenQuestionnaireAsync(
                    assignment.Id,
                    reopenResult.TargetState,
                    reopenResult.ReopenReason);

                if (success)
                {
                    NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Success,
                        Summary = "Questionnaire Reopened",
                        Detail = $"Successfully reopened questionnaire for {assignment.EmployeeName}. Email notification has been sent.",
                        Duration = 5000
                    });

                    // Reload the assignments
                    await LoadData();
                }
                else
                {
                    NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Error,
                        Summary = "Error",
                        Detail = "Failed to reopen questionnaire. Please try again or contact support.",
                        Duration = 5000
                    });
                }
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = $"Failed to reopen questionnaire: {ex.Message}",
                Duration = 5000
            });
        }
    }

    // Questionnaire view helper methods
    private List<QuestionnaireGroup> GetGroupedQuestionnaires()
    {
        // Apply all filters first using the centralized filtering logic
        var filteredAssignments = ApplyFilteringToAssignments(allAssignments);

        // Group filtered assignments by template
        var grouped = filteredAssignments
            .GroupBy(a => new { a.TemplateId, a.TemplateName, a.TemplateCategoryId })
            .Select(g => new QuestionnaireGroup
            {
                TemplateId = g.Key.TemplateId,
                TemplateName = g.Key.TemplateName,
                CategoryId = g.Key.TemplateCategoryId ?? Guid.Empty,
                Assignments = g.ToList()
            })
            .ToList();


        // Apply sorting
        grouped = questionnaireSortBy switch
        {
            "Name" => grouped.OrderBy(q => q.TemplateName).ToList(),
            "Completion" => grouped.OrderByDescending(q => q.CompletionPercentage).ToList(),
            "Overdue" => grouped.OrderByDescending(q => q.OverdueCount).ToList(),
            "Assignments" => grouped.OrderByDescending(q => q.Assignments.Count).ToList(),
            _ => grouped.OrderBy(q => q.TemplateName).ToList()
        };

        return grouped;
    }


    private async Task HandleSendQuestionnaireReminders(Guid templateId)
    {
        var questionnaire = GetGroupedQuestionnaires().FirstOrDefault(q => q.TemplateId == templateId);
        if (questionnaire != null)
        {
            ShowInfo($"Sending reminders for '{questionnaire.TemplateName}' to {questionnaire.OverdueCount} team members...");
            // TODO: Implement actual reminder sending logic
        }
    }

    private async Task HandleViewQuestionnaireAnalytics(Guid templateId)
    {
        var questionnaire = GetGroupedQuestionnaires().FirstOrDefault(q => q.TemplateId == templateId);
        if (questionnaire != null)
        {
            ShowInfo($"Viewing analytics for '{questionnaire.TemplateName}'...");
            // TODO: Implement analytics view
        }
    }

    // Department overview helper methods
    private List<DepartmentGroup> GetDepartmentGroups()
    {
        // Get organizations from additionalData if available
        var organizations = new List<Organization>();
        if (additionalData is List<Organization> orgList)
        {
            organizations = orgList;
        }

        if (!organizations.Any())
        {
            // No organizations, return empty list
            return new List<DepartmentGroup>();
        }

        // Apply filters to get the filtered assignments
        var filteredAssignments = ApplyFilteringToAssignments(allAssignments);

        // Get employees who have filtered assignments (respect filters)
        var employeesWithFilteredAssignments = filteredTeamMembers;

        // Group employees by organization
        var departmentGroups = organizations
            .Where(org => !org.IsDeleted && !org.IsIgnored)
            .Select(org =>
            {
                // Parse organization number - handle both int and string formats
                int orgNumber;
                if (!int.TryParse(org.Number, out orgNumber))
                {
                    // If parsing fails, skip this organization
                    return null;
                }

                // Use filtered employees instead of all employees
                var orgEmployees = employeesWithFilteredAssignments
                    .Where(e => e.OrganizationNumber == orgNumber)
                    .ToList();

                // Use filtered assignments instead of all assignments
                var orgAssignments = filteredAssignments
                    .Where(a => orgEmployees.Any(e => e.Id == a.EmployeeId))
                    .ToList();

                return new DepartmentGroup
                {
                    OrganizationId = org.Id,
                    OrganizationName = org.DisplayName,
                    Members = orgEmployees,
                    Assignments = orgAssignments
                };
            })
            .Where(dg => dg != null && dg.Members.Any()) // Only include departments with employees
            .Cast<DepartmentGroup>()
            .OrderBy(dg => dg.OrganizationName)
            .ToList();

        return departmentGroups;
    }

    // Helper class for department grouping
    private class DepartmentGroup
    {
        public Guid OrganizationId { get; set; }
        public string OrganizationName { get; set; } = string.Empty;
        public List<EmployeeDto> Members { get; set; } = new();
        public List<QuestionnaireAssignment> Assignments { get; set; } = new();

        public int EmployeeCount => Members.Count;
        public int TotalAssignments => Assignments.Count;

        public int NotStartedCount => Assignments.Count(a => a.WorkflowState == WorkflowState.Assigned);

        public int InProgressCount => Assignments.Count(a =>
            a.WorkflowState is WorkflowState.EmployeeInProgress
            or WorkflowState.ManagerInProgress
            or WorkflowState.BothInProgress
            or WorkflowState.EmployeeSubmitted
            or WorkflowState.ManagerSubmitted
            or WorkflowState.BothSubmitted
            or WorkflowState.InReview
            or WorkflowState.EmployeeReviewConfirmed
            or WorkflowState.ManagerReviewConfirmed);

        public int CompletedCount => Assignments.Count(a => a.WorkflowState == WorkflowState.Finalized);

        public int OverdueCount => Assignments.Count(a =>
            a.DueDate.HasValue &&
            a.DueDate.Value < DateTime.Now &&
            a.WorkflowState != WorkflowState.Finalized);

        public double CompletionPercentage =>
            TotalAssignments > 0
                ? Math.Round((double)CompletedCount / TotalAssignments * 100, 1)
                : 0;
    }

    // Helper class for questionnaire grouping
    private class QuestionnaireGroup
    {
        public Guid TemplateId { get; set; }
        public string TemplateName { get; set; } = string.Empty;
        public Guid CategoryId { get; set; }
        public List<QuestionnaireAssignment> Assignments { get; set; } = new();

        public string CategoryName
        {
            get
            {
                // TODO: Get actual category name from category service
                return string.Empty;
            }
        }

        public double CompletionPercentage =>
            Assignments.Count > 0
                ? Math.Round((double)Assignments.Count(a => a.WorkflowState == WorkflowState.Finalized) / Assignments.Count * 100, 1)
                : 0;

        public int OverdueCount =>
            Assignments.Count(a =>
                a.DueDate.HasValue &&
                a.DueDate.Value < DateTime.Now &&
                a.WorkflowState != WorkflowState.Finalized);
    }

    // Employee Status DataGrid
    private RadzenDataGrid<EmployeeStatusRow>? employeeDataGrid;

    private IEnumerable<EmployeeStatusRow> GetEmployeeStatusData()
    {
        return filteredTeamMembers.Select(employee =>
        {
            var assignments = memberAssignmentsCache.TryGetValue(employee.Id, out var assignmentList)
                ? assignmentList
                : new List<QuestionnaireAssignment>();

            var completed = assignments.Count(a => a.WorkflowState == WorkflowState.Finalized);
            var pending = assignments.Count(a => a.WorkflowState != WorkflowState.Finalized &&
                                                  (!a.DueDate.HasValue || a.DueDate.Value >= DateTime.Now));
            var overdue = assignments.Count(a => a.DueDate.HasValue &&
                                                  a.DueDate.Value < DateTime.Now &&
                                                  a.WorkflowState != WorkflowState.Finalized);
            var total = assignments.Count;
            var completionPercentage = total > 0 ? Math.Round((double)completed / total * 100, 1) : 0;
            var lastActivity = assignments
                .SelectMany(a => new DateTime?[]
                {
                    a.FinalizedDate,
                    a.CompletedDate,
                    a.EmployeeSubmittedDate,
                    a.ManagerSubmittedDate,
                    a.StartedDate
                })
                .Where(d => d.HasValue)
                .OrderByDescending(d => d)
                .FirstOrDefault();

            return new EmployeeStatusRow
            {
                EmployeeId = employee.Id,
                EmployeeName = $"{employee.FirstName} {employee.LastName}",
                Email = employee.EMail,
                Department = employee.Organization ?? "Unknown",
                Role = employee.ApplicationRole.ToString(),
                TotalAssignments = total,
                CompletedAssignments = completed,
                PendingAssignments = pending,
                OverdueAssignments = overdue,
                CompletionPercentage = completionPercentage,
                LastActivity = lastActivity
            };
        }).OrderBy(e => e.EmployeeName);
    }

    private async Task HandleViewEmployeeDetails(Guid employeeId)
    {
        var employee = filteredTeamMembers.FirstOrDefault(e => e.Id == employeeId);
        if (employee != null && memberAssignmentsCache.TryGetValue(employeeId, out var assignments))
        {
            // Navigate to employee detail view or show modal
            // For now, we'll trigger the existing assignment click handler for the first assignment
            var firstAssignment = assignments.FirstOrDefault();
            if (firstAssignment != null)
            {
                await HandleAssignmentClick(firstAssignment.Id);
            }
        }
    }

    private async Task HandleSendEmployeeReminder(Guid employeeId)
    {
        var employee = filteredTeamMembers.FirstOrDefault(e => e.Id == employeeId);
        if (employee != null)
        {
            await HandleSendReminder(employee);
        }
    }

    public class EmployeeStatusRow
    {
        public Guid EmployeeId { get; set; }
        public string EmployeeName { get; set; } = "";
        public string Email { get; set; } = "";
        public string Department { get; set; } = "";
        public string Role { get; set; } = "";
        public int TotalAssignments { get; set; }
        public int CompletedAssignments { get; set; }
        public int PendingAssignments { get; set; }
        public int OverdueAssignments { get; set; }
        public double CompletionPercentage { get; set; }
        public DateTime? LastActivity { get; set; }
    }

    // Analytics Methods
    private double GetOverallCompletionRate()
    {
        var totalAssignments = allAssignments.Count;
        if (totalAssignments == 0) return 0;

        var completedAssignments = allAssignments.Count(a => a.WorkflowState == WorkflowState.Finalized);
        return Math.Round((double)completedAssignments / totalAssignments * 100, 1);
    }

    private double GetAverageResponseTime()
    {
        var completedAssignments = allAssignments
            .Where(a => a.WorkflowState == WorkflowState.Finalized &&
                       a.FinalizedDate.HasValue)
            .ToList();

        if (!completedAssignments.Any()) return 0;

        var totalDays = completedAssignments
            .Sum(a => (a.FinalizedDate!.Value - a.AssignedDate).TotalDays);

        return Math.Round(totalDays / completedAssignments.Count, 1);
    }

    private double GetParticipationRate()
    {
        if (!employees.Any()) return 0;

        var employeesWithAssignments = employees.Count(e =>
            allAssignments.Any(a => a.EmployeeId == e.Id));

        return Math.Round((double)employeesWithAssignments / employees.Count * 100, 1);
    }

    private int GetOverdueCount()
    {
        return allAssignments.Count(a =>
            a.DueDate.HasValue &&
            a.DueDate.Value < DateTime.Now &&
            a.WorkflowState != WorkflowState.Finalized);
    }

    private IEnumerable<StatusDistributionData> GetStatusDistributionData()
    {
        var completed = allAssignments.Count(a => a.WorkflowState == WorkflowState.Finalized);
        var inProgress = allAssignments.Count(a => a.WorkflowState != WorkflowState.Finalized &&
                                                  (!a.DueDate.HasValue || a.DueDate.Value >= DateTime.Now));
        var overdue = GetOverdueCount();

        return new[]
        {
            new StatusDistributionData { Status = "Completed", Count = completed },
            new StatusDistributionData { Status = "In Progress", Count = inProgress },
            new StatusDistributionData { Status = "Overdue", Count = overdue }
        };
    }

    private IEnumerable<DepartmentPerformanceData> GetDepartmentPerformanceData()
    {
        var departmentGroups = GetDepartmentGroups();

        return departmentGroups.Select(dept =>
        {
            var totalAssignments = dept.Assignments.Count;
            var completedAssignments = dept.Assignments.Count(a => a.WorkflowState == WorkflowState.Finalized);
            var completionRate = totalAssignments > 0
                ? Math.Round((double)completedAssignments / totalAssignments * 100, 1)
                : 0;

            return new DepartmentPerformanceData
            {
                Department = dept.OrganizationName,
                CompletionRate = completionRate
            };
        });
    }

    private IEnumerable<TemplatePerformanceData> GetTemplatePerformanceData()
    {
        var templateGroups = GetGroupedQuestionnaires();

        return templateGroups.Select(template =>
        {
            var totalAssignments = template.Assignments.Count;
            var completedCount = template.Assignments.Count(a => a.WorkflowState == WorkflowState.Finalized);
            var completionRate = totalAssignments > 0
                ? Math.Round((double)completedCount / totalAssignments * 100, 1)
                : 0;

            var completedAssignments = template.Assignments
                .Where(a => a.WorkflowState == WorkflowState.Finalized &&
                           a.FinalizedDate.HasValue)
                .ToList();

            var avgResponseTime = completedAssignments.Any()
                ? completedAssignments.Average(a => (a.FinalizedDate!.Value - a.AssignedDate).TotalDays)
                : 0;

            return new TemplatePerformanceData
            {
                TemplateName = template.TemplateName,
                CategoryName = template.CategoryName,
                TotalAssignments = totalAssignments,
                CompletedCount = completedCount,
                CompletionRate = completionRate,
                AverageResponseTime = Math.Round(avgResponseTime, 1)
            };
        }).OrderByDescending(t => t.CompletionRate);
    }

    private string GetTopPerformingDepartment()
    {
        var departmentData = GetDepartmentPerformanceData().OrderByDescending(d => d.CompletionRate).FirstOrDefault();
        return departmentData?.Department ?? "No data";
    }

    private string GetFastestTemplate()
    {
        var templateData = GetTemplatePerformanceData()
            .Where(t => t.AverageResponseTime > 0)
            .OrderBy(t => t.AverageResponseTime)
            .FirstOrDefault();
        return templateData?.TemplateName ?? "No data";
    }

    private string GetMostPopularTemplate()
    {
        var templateData = GetTemplatePerformanceData()
            .OrderByDescending(t => t.TotalAssignments)
            .FirstOrDefault();
        return templateData?.TemplateName ?? "No data";
    }

    private int GetAttentionNeededCount()
    {
        return GetOverdueCount();
    }

    public class StatusDistributionData
    {
        public string Status { get; set; } = "";
        public int Count { get; set; }
    }

    public class DepartmentPerformanceData
    {
        public string Department { get; set; } = "";
        public double CompletionRate { get; set; }
    }

    public class TemplatePerformanceData
    {
        public string TemplateName { get; set; } = "";
        public string CategoryName { get; set; } = "";
        public int TotalAssignments { get; set; }
        public int CompletedCount { get; set; }
        public double CompletionRate { get; set; }
        public double AverageResponseTime { get; set; }
    }

    // Enhanced Empty State Methods
    private RenderFragment RenderEnhancedEmptyState(string title, string message, string iconName, List<EmptyStateAction> actions) => __builder =>
    {
        <div class="text-center p-5">
            <RadzenIcon Icon="@iconName" Size="4rem" Class="text-muted mb-3" />
            <RadzenText TextStyle="TextStyle.H5" Class="text-muted mb-2">@title</RadzenText>
            <RadzenText TextStyle="TextStyle.Body1" Class="text-muted mb-4">@message</RadzenText>

            @if (actions.Any())
            {
                <div class="d-flex flex-wrap justify-content-center gap-2 mt-4">
                    @foreach (var action in actions)
                    {
                        <RadzenButton Text="@action.Text"
                                     Icon="@action.Icon"
                                     ButtonStyle="@action.Style"
                                     Size="ButtonSize.Medium"
                                     Click="@action.OnClick"
                                     Class="px-4" />
                    }
                </div>
            }
        </div>
    };

    private string GetQuestionnaireEmptyStateMessage()
    {
        var hasFilters = filterState.HasActiveFilters();

        if (hasFilters)
        {
            return "No questionnaires match your current filters. Try adjusting your search criteria or clearing filters to see all available questionnaires.";
        }

        return Configuration.PageType switch
        {
            QuestionnairePageType.Employee => "You don't have any questionnaires assigned yet. Check back later or contact your manager if you expected assignments.",
            QuestionnairePageType.Manager => "No questionnaires have been assigned to your team yet. You can assign questionnaires from the questionnaire builder.",
            QuestionnairePageType.HR => "No questionnaires have been created yet. Start by creating questionnaire templates in the questionnaire builder.",
            _ => "No questionnaires are available at this time."
        };
    }

    private List<EmptyStateAction> GetQuestionnaireEmptyStateActions()
    {
        var actions = new List<EmptyStateAction>();

        var hasFilters = filterState.HasActiveFilters();

        if (hasFilters)
        {
            actions.Add(new EmptyStateAction
            {
                Text = "Clear Filters",
                Icon = "clear",
                Style = ButtonStyle.Light,
                OnClick = ClearAllFilters
            });
        }

        // Add role-specific actions
        switch (Configuration.PageType)
        {
            case QuestionnairePageType.Manager:
            case QuestionnairePageType.HR:
                actions.Add(new EmptyStateAction
                {
                    Text = "Create Questionnaire",
                    Icon = "add",
                    Style = ButtonStyle.Primary,
                    OnClick = () => NavigateToQuestionnaireBuilder()
                });
                break;
        }

        actions.Add(new EmptyStateAction
        {
            Text = "Refresh",
            Icon = "refresh",
            Style = ButtonStyle.Light,
            OnClick = async () => await LoadData()
        });

        return actions;
    }

    private string GetTeamMembersEmptyStateMessage()
    {
        return "No team members are currently assigned to you. Team members will appear here once they are added to your organization.";
    }

    private List<EmptyStateAction> GetTeamMembersEmptyStateActions()
    {
        return new List<EmptyStateAction>
        {
            new EmptyStateAction
            {
                Text = "Refresh Data",
                Icon = "refresh",
                Style = ButtonStyle.Light,
                OnClick = async () => await LoadData()
            }
        };
    }

    private string GetDepartmentsEmptyStateMessage()
    {
        var hasFilters = filterState.HasActiveFilters();

        if (hasFilters)
        {
            return "No departments match your current filters. Try adjusting your search criteria to see department data.";
        }

        return "No departments have been set up yet. Department data will appear here once organizational structure is configured.";
    }

    private List<EmptyStateAction> GetDepartmentsEmptyStateActions()
    {
        var actions = new List<EmptyStateAction>();

        var hasFilters = filterState.HasActiveFilters();

        if (hasFilters)
        {
            actions.Add(new EmptyStateAction
            {
                Text = "Clear Filters",
                Icon = "clear",
                Style = ButtonStyle.Light,
                OnClick = ClearAllFilters
            });
        }

        actions.Add(new EmptyStateAction
        {
            Text = "Refresh Data",
            Icon = "refresh",
            Style = ButtonStyle.Light,
            OnClick = async () => await LoadData()
        });

        return actions;
    }

    private string GetEmployeesEmptyStateMessage()
    {
        var hasFilters = filterState.HasActiveFilters();

        if (hasFilters)
        {
            return "No employees match your current filters. Try adjusting your search criteria to see employee data.";
        }

        return "No employees are available in the system yet. Employee data will appear here once user accounts are set up.";
    }

    private List<EmptyStateAction> GetEmployeesEmptyStateActions()
    {
        var actions = new List<EmptyStateAction>();

        var hasFilters = filterState.HasActiveFilters();

        if (hasFilters)
        {
            actions.Add(new EmptyStateAction
            {
                Text = "Clear Filters",
                Icon = "clear",
                Style = ButtonStyle.Light,
                OnClick = ClearAllFilters
            });
        }

        actions.Add(new EmptyStateAction
        {
            Text = "Refresh Data",
            Icon = "refresh",
            Style = ButtonStyle.Light,
            OnClick = async () => await LoadData()
        });

        return actions;
    }


    // Event handlers for filter component
    private async Task OnSearchChanged(string searchValue)
    {
        // Handle search with debouncing
        searchCancellationTokenSource?.Cancel();
        searchCancellationTokenSource?.Dispose();
        searchCancellationTokenSource = new CancellationTokenSource();

        try
        {
            // Wait for the debounce delay
            await Task.Delay(SearchDebounceMs, searchCancellationTokenSource.Token);

            // If we get here, the delay completed without cancellation
            // Save search state immediately
            await SaveFilterStateAsync();

            // Apply filters on the UI thread
            await InvokeAsync(() =>
            {
                ApplyFilters();
                StateHasChanged();
            });
        }
        catch (TaskCanceledException)
        {
            // Expected when user types again before delay completes
            // Do nothing - the new keystroke will start a new delay
        }
    }

    private void ClearAllFilters()
    {
        filterState.Clear();
        ApplyFilters();
    }


    private void NavigateToQuestionnaireBuilder()
    {
        NavigationManager.NavigateTo("/questionnaire-builder");
    }

    // Advanced Filtering Methods
    private List<DateRangePreset> GetDateRangePresets()
    {
        var today = DateTime.Today;
        return new List<DateRangePreset>
        {
            new DateRangePreset { Label = "Today", From = today, To = today },
            new DateRangePreset { Label = "Yesterday", From = today.AddDays(-1), To = today.AddDays(-1) },
            new DateRangePreset { Label = "Last 7 days", From = today.AddDays(-7), To = today },
            new DateRangePreset { Label = "Last 30 days", From = today.AddDays(-30), To = today },
            new DateRangePreset { Label = "This week", From = GetStartOfWeek(today), To = GetEndOfWeek(today) },
            new DateRangePreset { Label = "Last week", From = GetStartOfWeek(today.AddDays(-7)), To = GetEndOfWeek(today.AddDays(-7)) },
            new DateRangePreset { Label = "This month", From = new DateTime(today.Year, today.Month, 1), To = new DateTime(today.Year, today.Month, DateTime.DaysInMonth(today.Year, today.Month)) },
            new DateRangePreset { Label = "Last month", From = GetFirstDayOfPreviousMonth(today), To = GetLastDayOfPreviousMonth(today) },
            new DateRangePreset { Label = "This quarter", From = GetStartOfQuarter(today), To = GetEndOfQuarter(today) }
        };
    }

    private DateTime GetStartOfWeek(DateTime date)
    {
        var diff = (7 + (date.DayOfWeek - DayOfWeek.Monday)) % 7;
        return date.AddDays(-1 * diff).Date;
    }

    private DateTime GetEndOfWeek(DateTime date)
    {
        return GetStartOfWeek(date).AddDays(6);
    }

    private DateTime GetFirstDayOfPreviousMonth(DateTime date)
    {
        var firstDayOfCurrentMonth = new DateTime(date.Year, date.Month, 1);
        return firstDayOfCurrentMonth.AddMonths(-1);
    }

    private DateTime GetLastDayOfPreviousMonth(DateTime date)
    {
        var firstDayOfCurrentMonth = new DateTime(date.Year, date.Month, 1);
        return firstDayOfCurrentMonth.AddDays(-1);
    }

    private DateTime GetStartOfQuarter(DateTime date)
    {
        var quarterNumber = (date.Month - 1) / 3 + 1;
        var firstMonthOfQuarter = (quarterNumber - 1) * 3 + 1;
        return new DateTime(date.Year, firstMonthOfQuarter, 1);
    }

    private DateTime GetEndOfQuarter(DateTime date)
    {
        var quarterNumber = (date.Month - 1) / 3 + 1;
        var firstMonthOfQuarter = (quarterNumber - 1) * 3 + 1;
        var lastMonthOfQuarter = firstMonthOfQuarter + 2;
        return new DateTime(date.Year, lastMonthOfQuarter, DateTime.DaysInMonth(date.Year, lastMonthOfQuarter));
    }


    private string GetFilterColumnClass(QuestionnaireFilterType filterType)
    {
        return filterType switch
        {
            QuestionnaireFilterType.DateRange => "col-md-4 col-lg-4", // Give date range more space
            QuestionnaireFilterType.Search => "col-md-3 col-lg-3",     // Search gets standard space
            _ => "col-md-2 col-lg-2 col-xl-2"                          // Other filters get less space
        };
    }

    private class DateRangePreset
    {
        public string Label { get; set; } = "";
        public DateTime From { get; set; }
        public DateTime To { get; set; }
    }

    private class EmptyStateAction
    {
        public string Text { get; set; } = "";
        public string Icon { get; set; } = "";
        public ButtonStyle Style { get; set; } = ButtonStyle.Light;
        public Action OnClick { get; set; } = () => { };
    }

    // Filter Persistence Methods
    private class FilterState
    {
        public string SearchFilter { get; set; } = "";
        public string? CategoryFilter { get; set; }
        public List<string> MultiCategoryFilter { get; set; } = new();
        public string? TemplateFilter { get; set; }
        public List<Guid> MultiTemplateFilter { get; set; } = new();
        public string StatusFilter { get; set; } = "";
        public List<string> MultiStatusFilter { get; set; } = new();
        public string DepartmentFilter { get; set; } = "";
        public List<string> MultiDepartmentFilter { get; set; } = new();
        public string? DateRangeFrom { get; set; }
        public string? DateRangeTo { get; set; }
        public int SelectedTabIndex { get; set; } = 0;
        public string TeamMemberSortBy { get; set; } = "Name";
        public string QuestionnaireSortBy { get; set; } = "Name";
    }

    private async Task SaveFilterStateAsync()
    {
        try
        {
            var persistenceState = new FilterState
            {
                SearchFilter = filterState.SearchFilter,
                MultiDepartmentFilter = filterState.DepartmentFilter.ToList(),
                MultiCategoryFilter = filterState.CategoryFilter.ToList(),
                MultiTemplateFilter = filterState.TemplateFilter.ToList(),
                SelectedTabIndex = _selectedTabIndex,
                TeamMemberSortBy = teamMemberSortBy,
                QuestionnaireSortBy = questionnaireSortBy
            };

            var json = System.Text.Json.JsonSerializer.Serialize(persistenceState);
            var storageKey = $"questionnaire_filters_{Configuration.PageType}";

            await JSRuntime.InvokeVoidAsync("localStorage.setItem", storageKey, json);
        }
        catch (Exception)
        {
            // Silently ignore localStorage errors (e.g., in private browsing mode)
        }
    }

    private async Task LoadFilterStateAsync()
    {
        try
        {
            var storageKey = $"questionnaire_filters_{Configuration.PageType}";
            var json = await JSRuntime.InvokeAsync<string>("localStorage.getItem", storageKey);

            if (!string.IsNullOrEmpty(json))
            {
                var loadedFilterState = System.Text.Json.JsonSerializer.Deserialize<FilterState>(json);
                if (loadedFilterState != null)
                {
                    // Update the existing filterState object
                    filterState.SearchFilter = loadedFilterState.SearchFilter ?? "";
                    filterState.DepartmentFilter = loadedFilterState.MultiDepartmentFilter ?? new List<string>();
                    filterState.CategoryFilter = loadedFilterState.MultiCategoryFilter ?? new List<string>();
                    filterState.TemplateFilter = loadedFilterState.MultiTemplateFilter ?? new List<Guid>();

                    _selectedTabIndex = loadedFilterState.SelectedTabIndex;
                    teamMemberSortBy = loadedFilterState.TeamMemberSortBy ?? "Name";
                    questionnaireSortBy = loadedFilterState.QuestionnaireSortBy ?? "Name";
                }
            }
        }
        catch (Exception)
        {
            // Silently ignore localStorage errors or JSON parsing errors
        }
    }

    private void OnTeamMemberSortChanged(string value)
    {
        teamMemberSortBy = value;
        ApplyFilters();
    }

    private async void OnQuestionnaireSortChanged()
    {
        await SaveFilterStateAsync();
        NotifyStateChanged();
    }

    // IDisposable implementation - override base to add cancellation token cleanup
    public override void Dispose()
    {
        searchCancellationTokenSource?.Cancel();
        searchCancellationTokenSource?.Dispose();
        base.Dispose();
    }
}